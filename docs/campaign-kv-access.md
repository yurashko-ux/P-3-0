# Чому сторінка тестів не бачить V1/V2 кампаній

Під час виконання кроку «Пошук кампанії» ми покладаємося на утиліту `kvRead.listCampaigns`. Вона спочатку намагається читати індекси та елементи через REST API Vercel KV (`KV_REST_API_URL` + токени). Якщо ж цих токенів немає, то відбувається перехід на локальний биндинг `@vercel/kv`. Коли обидва канали недоступні або налаштовані не для того середовища, метод повертає порожній масив, і ми просто не отримуємо самі об'єкти кампаній.

Через це V1/V2 не «зчитуються» — до нас не доходить жоден запис кампанії, отже, немає з чого витягти правила. Це не проблема формату самих правил: список `cmp:ids` та відповідні `cmp:item:*` зчитуються коректно, щойно доступ до KV працює. Поки з'єднання з KV немає, будь-які пошуки V1/V2 будуть безрезультатними.

Щоб пересвідчитись, достатньо в тому ж середовищі виконати запит на `kvRead.getRaw('cmp:item:<ID>')` або `kvRead.lrange('cmp:ids')`. Якщо відповідь порожня — значить, проблема у відсутності доступу до KV, а не в логіці обробки V1/V2.

> ⚠️ Наявність змінних `KV_REST_API_URL` і `KV_REST_API_TOKEN` не гарантує доступу: токен може бути простроченим, без потрібних прав або прив'язаним до іншого середовища/простору. У такій ситуації `fetch` повертає 401/403 (або порожній JSON), і клієнт так само бачить «порожні» кампанії.

## Режим офлайн-снепшоту

Коли доступу до Upstash/Vercel KV немає (локальна розробка без інтернету тощо), можна підкласти дамп кампаній через один із параметрів середовища:

- `KV_CAMPAIGNS_SNAPSHOT_JSON` — рядок із JSON-масивом кампаній або об'єктом `{ index, items }`.
- `KV_CAMPAIGNS_SNAPSHOT_FILE` — шлях до файлу з таким самим JSON.

`kvRead.listCampaigns` автоматично підхопить ці дані, додасть їх до списку індексів і поверне ті самі об'єкти, ніби вони прийшли з KV. Це дозволяє тестеру V1/V2 і вебхукам ManyChat працювати навіть у середовищах без мережі. Щойно з'єднання з KV доступне, фактичні дані мають пріоритет над снепшотом.
