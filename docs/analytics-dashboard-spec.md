# Технічне завдання — Аналітичний дашборд та CRM-інструменти для мережі салонів

## 1. Огляд

**Мета.** Розширити існуючу адмін-панель (деплой на Vercel) новим модулем «Аналітика», який автоматично синхронізує дані з Alteg.io, нормалізує їх у внутрішній базі та надає власнику мережі салонів огляд ключових показників, планів і взаємодій із клієнтами. Модуль має працювати поряд з наявним проектом по роботі з лідами (ManiChat → KeyCRM) і використовувати спільні механізми автентифікації та деплой.

**Результат.** Керівник отримує інтегровану систему, яка:
- Показує фактичні та планові показники в розрізі салонів, майстрів, послуг і товарних груп.
- Забезпечує контроль складу волосся за вагою по кожній прийомці.
- Підтримує створення й автоматизацію нагадувальних повідомлень через ManiChat (Instagram Direct).
- Готує фундамент для подальших розширень (наприклад, власні «закупки» волосся та фінансові звіти).

## 2. Бізнес-цілі
1. Зменшити ручну роботу менеджерів при формуванні звітів та планів.
2. Забезпечити прозорість у наявних запасах волосся (по вазі) та плануванні завантаження майстрів.
3. Автоматизувати комунікації з постійними клієнтами (нагадування, реактивації).
4. Надати власнику мережі інструменти для оперативних рішень щодо реклами та персоналу.

## 3. Обсяг робіт (Scope)
- **Інтеграція з Alteg.io API** для збору клієнтів, записів, послуг, майстрів, платежів, складу.
- **ETL та сховище даних** для нормалізованих сутностей, історичних показників та агрегатів.
- **Аналітичний дашборд** із ключовими метриками, графіками, фільтрами, експортом.
- **Контроль складу волосся** з урахуванням ваги та прийомок.
- **Панель нагадувань через ManiChat** з шаблонами, сегментацією клієнтів та інтеграцією з Instagram Direct.
- **Модуль планування** (план/факт) для салонів, майстрів і товарних груп.
- **Підтримка мережевої структури** (кілька салонів, декілька Instagram-акаунтів).
- **Фінансова звітність** для аналізу доходів/витрат та прибутковості.
- **Нефункціональні вимоги**: безпека, продуктивність, масштабованість, логування.

## 4. Функціональні вимоги

### 4.1. Інтеграція з Alteg.io
- Авторизація через офіційний механізм Alteg.io (OAuth/token).
- Регулярна синхронізація даних (full sync + incremental по `updated_at`).
- Обробка сутностей: клієнти, записи, послуги, майстри, платежі, складські позиції (хвости волосся).
- Підтримка пагінації, ретраїв та обробки помилок.
- Логування усіх імпортів із мітками часу та статусами.

### 4.2. Сховище та ETL
- Вибір СУБД (PostgreSQL / інший сумісний з Vercel бекенд).
- ER-модель включає: `clients`, `appointments`, `services`, `employees`, `payments`, `inventory_intakes`, `inventory_items`, `hair_intakes`, `hair_items`, `plans`, `plan_items`, `reminder_templates`, `reminder_runs`, `salons`, `salon_accounts` та агрегатні таблиці.
- ETL-пайплайн: сирі дані → нормалізовані таблиці → денні/тижневі агрегати (виручка, кількість записів, середній чек, LTV, завантаженість).
- Кешування часто запитуваних даних (Redis/edge cache) для швидкої видачі у фронтенді.
- Журнал ETL (успішні/невдалі рани, кількість оновлених записів).

### 4.3. Аналітичний дашборд (UI)
- Нова вкладка `admin/analytics` у поточній Next.js адмінці.
- Компоненти: KPI cards (виручка, кількість записів, середній чек), графіки трендів (line/area), графіки порівнянь (bar), таблиці деталізації.
- Фільтри: період (день/тиждень/місяць/кастом), салон, майстер, послуга, товарна група.
- Експорт вибірок (CSV/PDF) для ключових звітів.
- Перемикання між рівнями: мережа → конкретний салон → конкретний майстер.

### 4.4. Контроль складу волосся
- Імпорт ваги хвостів з Alteg.io (код, вага, дата прийомки, посилання на прийомку).
- Нормалізація у таблицях `hair_intakes` (метадані прийомки) та `hair_items` (окремі хвости з вагою).
- Агрегати по прийомках: загальна вага, залишок, списання.
- UI-розділ «Склад волосся» з переліком прийомок, вагою по кожній, деталями хвостів.
- Підготовка до майбутніх «закупок» (місце в БД/адмінці, але без інтеграції наразі).

### 4.5. Панель нагадувань через ManiChat
- Поле для Instagram ID у картці клієнта Alteg.io (вибір або створення кастомного поля) з мапінгом у нашій БД.
- Конструктор шаблонів: назва, текст (з плейсхолдерами `{first_name}`, `{last_name}`), кількість нагадувань, інтервал (дні/години), тип тригера (нагадування про запис, фоллоу-ап, реактивація).
- Список майбутніх записів (30 днів, фільтри за салоном/майстром) для вибору отримувачів.
- Планувальник/черга (cron/worker) для запуску нагадувань у визначений час.
- Інтеграція з ManiChat API: надсилання повідомлень, контроль статусів (успіх/помилка), логування.
- UI для перегляду історії нагадувань та ручного запуску/відміни.

### 4.6. Модуль планування (план/факт)
- Імпорт майбутніх записів (наступний місяць, 30 днів, тижневий розріз) для побудови «плану».
- Імпорт фактичної виручки, продажів послуг та товарів (окремо волосся та інші товари).
- Моделі планових показників: по майстру, послузі, салону, товарній групі.
- Розрахунок KPI план/факт у реальному часі з можливістю вибору періоду.
- Відображення недовантаження/перевантаження з рекомендаціями (наприклад, «додати рекламу»).

### 4.7. Підтримка мережі салонів
- Зберігання структури мережі: `salons` (місто, адреса, графік), зв’язок з Instagram акаунтами (`salon_accounts`).
- Можливість агрегувати дані по мережі загалом, по місту, по конкретному салону.
- Прив’язка нагадувань та планових показників до відповідних салонів/акаунтів.

### 4.8. Фінансова звітність
- Побудова фінансових звітів (P&L, рух коштів, маржинальність) на базі даних Alteg.io та ручних коригувань.
- Облік категорій доходів (послуги, продаж товарів, волосся) та витрат (оренда, зарплати, маркетинг, закупки).
- Можливість імпортувати/вводити додаткові витрати, що не фігурують у Alteg.io.
- Генерація звітів у розрізі салонів, періодів, майстрів, категорій послуг/товарів.
- Експорт фінансових звітів у CSV/PDF та можливість коментування менеджером.

## 5. Нефункціональні вимоги
- **Безпека:** зберігання секретів у ENV, шифрування чутливих даних, RBAC для адмінки.
- **Продуктивність:** кешування ключових API-відповідей, lazy-оновлення агрегатів, час відповіді UI < 1 секунди.
- **Масштабованість:** модульна архітектура, можливість додавання нових метрик/каналів.
- **Надійність:** планувальники та черги мають підтримувати повторний запуск при збої, логування ETL/нагадувань із моніторингом (Sentry/Logflare).
- **Документування:** README/Playbook із кроками розгортання, доступами, описом полів.

## 6. Залежності та інтеграції
- **Alteg.io API** — основне джерело даних (необхідні токени, права доступу, обмеження по rate limit).
- **ManiChat (Instagram Direct)** — наявна інтеграція, використати API для відправки повідомлень.
- **Існуюча адмін-панель** — Next.js + Vercel + KV/Redis; новий модуль має використовувати ту ж систему логіну (`ADMIN_PASS`).
- **База даних** — обрати сервіс (Supabase/PlanetScale/RDS) з урахуванням об’єму даних та частоти оновлення.

## 7. Критерії приймання
1. Дані з Alteg.io регулярно синхронізуються, у UI доступні ключові метрики та графіки за вибраний період.
2. Склад волосся відображає актуальну вагу по кожній прийомці, доступна деталізація до окремого хвоста.
3. Панель нагадувань дозволяє створювати шаблони, запускати нагадування за графіком та бачити статуси від ManiChat.
4. Модуль планування показує план/факт по салонах і майстрах, окремо для товарної групи «волосся».
5. Система підтримує кілька салонів та Instagram-акаунтів; фільтри та агрегати працюють відповідно.
6. Фінансові звіти формуються за вибраний період, відображають доходи/витрати/прибутковість і доступні для експорту.
7. Всі нефункціональні вимоги дотримані (безпека, продуктивність, логування).

## 8. Орієнтовний Roadmap / Етапи

1. **Підготовка інфраструктури**: вибір БД, налаштування доступів, базова схема.
2. **Інтеграція з Alteg.io**: клієнт API, перший full sync, журнал.
3. **ETL + сховище**: нормалізація, агрегати, кеш.
4. **UI дашборду**: базові KPI, графіки, фільтри.
5. **Склад волосся**: імпорт ваги, UI залишків, підготовка до «закупок».
6. **Панель нагадувань (ManiChat)**: шаблони, планувальник, відправка, історія.
7. **Модуль планування**: планові показники, план/факт, мережеві зрізи.
8. **Фінансова звітність**: моделі доходів/витрат, UI звітів, експорти.
9. **Тестування + документування**: інтеграційні тести, інструкції, моніторинг.

## 9. Відкриті питання / наступні рішення
- Визначити точний механізм авторизації та можливі ліміти Alteg.io API.
- Підтвердити, яке поле у картці клієнта Alteg.io буде використано для Instagram ID, та забезпечити його масове заповнення.
- Обрати та налаштувати БД (Supabase/PostgreSQL/інше) для довготривалого зберігання даних.
- Прийняти рішення щодо майбутньої функції «закупок» волосся (чи потрібна окрема таблиця/статус «чернетка»).
- Уточнити вимоги до експорту (формат PDF, локалізація, брендований шаблон).
- Визначити джерела даних для витрат (ручне введення, імпорт з бухгалтерії) та узгодити процес затвердження.

---

Документ слугуватиме базою для розробки. По мірі реалізації можна доповнювати деталізацією схем БД, API-контрактів та макетів UI.
