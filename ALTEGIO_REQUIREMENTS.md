# Технічне завдання: Інтеграція з Altegio

## Завершені функції

### 1. Пошук клієнтів за Instagram username ✅
- Механізм пошуку клієнта за Instagram username через поле email
- Формат: `instagram_username@gmail.com` → витягується `instagram_username`
- Endpoint: `/api/altegio/test/clients/by-instagram?instagram=username`
- Адмін-панель з полем пошуку

## Заплановані функції

### 2. Календар записів (Appointments/Visits)
**Статус:** В розробці

**Що потрібно:**
- Отримання всіх записів за період (тиждень, місяць)
- Всі доступні поля з API:
  - ПІБ клієнта (client name)
  - Дата запису (datetime)
  - Статус запису (status: pending, completed, cancelled)
  - Оплата послуг (payment status, amount - для минулих записів/візитів)
  - Типи послуг (service name, service type)
  - Майстер (staff name)
  - Додаткова інформація про запис

**Майбутні записи:**
- Планові записи (upcoming appointments)
- Для відправки нагадувань майстрам про фото

**Минулі записи (візити):**
- Завершені візити (completed visits)
- Для аналітики та відправки опитувань

### 3. Механізм зворотного зв'язку (Client Feedback Survey)
**Статус:** Заплановано

**Опис:**
Автоматична відправка опитування про якість послуг клієнтам через Instagram Direct на наступний день після відвідування салону.

**Функціонал:**

1. **Автоматичне визначення завершених візитів**
   - Система відстежує записи (appointments) з календаря Altegio
   - Визначає завершені візити (статус "completed" або дата в минулому)
   - Зберігає інформацію про завершені візити

2. **Таймер для відправки опитування**
   - На наступний день після відвідування (через 24 години після завершення візиту)
   - Перевірка, чи вже було відправлено опитування для цього візиту
   - Cron job або scheduled task для перевірки та відправки

3. **Відправка опитування через Instagram Direct**
   - Знайти Instagram username клієнта (з поля email або custom_fields)
   - Якщо Instagram username є - відправити повідомлення в Instagram Direct
   - Якщо немає Instagram - пропустити або відправити через інший канал
   - Зберегти факт відправки, щоб не дублювати

4. **Питання в опитуванні** (текст визначити пізніше):
   - Загальна оцінка якості послуг (1-5 зірок або 1-10)
   - Коментар про якість обслуговування (опціонально)
   - Чи рекомендували б салон іншим (так/ні)
   - Додаткові питання про конкретні аспекти обслуговування

**Технічні деталі:**
- Використовувати Instagram Graph API або Instagram Basic Display API для відправки повідомлень
- Зберігати історію відправлених опитувань в базі даних (Vercel KV Store)
- Зберігати відповіді клієнтів на опитування
- Налаштування через адмін-панель:
  - Включити/вимкнути автоматичну відправку
  - Час відправки (через скільки годин після візиту)
  - Текст опитування
  - Шаблони повідомлень

**Структура даних для зберігання:**
```typescript
type VisitFeedback = {
  visitId: string; // ID візиту з Altegio
  clientId: number;
  clientName: string;
  instagramUsername: string;
  visitDate: string; // ISO date
  serviceName: string;
  masterName: string;
  feedbackSentAt: string; // ISO datetime
  feedbackReceivedAt?: string; // ISO datetime
  feedbackResponse?: {
    rating?: number;
    comment?: string;
    wouldRecommend?: boolean;
  };
};
```

## Відомі проблеми та обмеження API

1. **Custom fields не повертаються через API**
   - Поле `custom_fields` не доступне в API відповідях
   - Потрібно звернутися до підтримки Altegio
   - Тимчасове рішення: використовувати поле email для зберігання Instagram username

2. **Права доступу до клієнтів**
   - Потрібні права "Клієнтська база" та "Журнал запису"
   - Після надання прав потрібно перегенерувати USER_TOKEN

3. **Обмеження кількості клієнтів**
   - API може повертати обмежену кількість клієнтів
   - Використовується пагінація для отримання більшої кількості

