// web/prisma/schema.prisma
// Prisma схема для Direct Manager розділу

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Для Prisma Postgres в Vercel використовується PRISMA_DATABASE_URL
  // Якщо PRISMA_DATABASE_URL не встановлено, використовуємо DATABASE_URL
  url      = env("PRISMA_DATABASE_URL")
}

// Статуси клієнтів (Новий, Консультація, Записався, тощо)
model DirectStatus {
  id        String   @id // UUID або string ID (зберігаємо як є з KV)
  name      String // Назва статусу (напр. "Новий", "Консультація", "Записався")
  color     String   @default("#6b7280") // Колір для відображення (hex)
  order     Int      @default(0) // Порядок сортування
  isDefault Boolean  @default(false) // Чи це статус за замовчуванням для нових клієнтів
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Зв'язок з клієнтами
  clients DirectClient[]

  @@index([order])
  @@index([isDefault])
  @@map("direct_statuses")
}

// Клієнти Direct Manager
model DirectClient {
  id                     String    @id // UUID або timestamp-based ID (зберігаємо як є з KV)
  instagramUsername      String // Нікнейм в Instagram (унікальний)
  firstName              String? // Ім'я
  lastName               String? // Прізвище
  source                 String    @default("instagram") // Джерело: 'instagram' | 'tiktok' | 'other'
  state                  String? // Системний стан: 'lead' | 'client' | 'consultation'
  firstContactDate       DateTime // Дата першого контакту
  statusId               String // ID статусу (foreign key)
  masterId               String? // ID майстра (відповідальний)
  masterManuallySet      Boolean   @default(false) // Чи був відповідальний вибраний вручну
  consultationDate       DateTime? // Дата консультації
  visitedSalon           Boolean   @default(false) // Чи прийшов клієнт в салон на консультацію
  visitDate              DateTime? // Дата візиту в салон
  signedUpForPaidService Boolean   @default(false) // Чи записався на платну послугу
  paidServiceDate        DateTime? // Дата запису на платну послугу
  signupAdmin            String? // Хто записав (ім'я адміна)
  comment                String? // Коментар/нотатки
  altegioClientId        Int? // ID клієнта в Altegio (якщо знайдено)
  lastMessageAt          DateTime? // Останнє повідомлення
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Зв'язок зі статусом
  status DirectStatus @relation(fields: [statusId], references: [id], onDelete: Restrict)

  // Зв'язок з відповідальним (майстром)
  master DirectMaster? @relation(fields: [masterId], references: [id], onDelete: SetNull)

  // Зв'язок з історією станів
  stateLogs DirectClientStateLog[]

  // Індекси для швидкого пошуку
  @@unique([instagramUsername])
  @@index([statusId])
  @@index([masterId])
  @@index([altegioClientId])
  @@index([state])
  @@index([source])
  @@index([firstContactDate])
  @@index([createdAt])
  @@map("direct_clients")
}

// Відповідальні (майстри та дірект-менеджери)
model DirectMaster {
  id               String   @id @default(uuid())
  name             String // Ім'я відповідального
  telegramUsername String? // Telegram username
  telegramChatId   Int? // Telegram chat ID (для відправки повідомлень)
  role             String   @default("master") // 'master' | 'direct-manager' | 'admin'
  altegioStaffId   Int? // ID майстра в Altegio (якщо є)
  isActive         Boolean  @default(true) // Чи активний
  order            Int      @default(0) // Порядок сортування
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Зв'язок з клієнтами
  clients DirectClient[]

  @@index([role])
  @@index([isActive])
  @@index([order])
  @@index([telegramChatId])
  @@map("direct_masters")
}

// Історія змін станів клієнтів
model DirectClientStateLog {
  id            String   @id @default(uuid())
  clientId      String // ID клієнта
  state         String? // Новий стан (може бути null для початкового стану)
  previousState String? // Попередній стан
  reason        String? // Причина зміни (напр. "webhook", "manual", "cron", "record")
  metadata      String? // Додаткові дані (JSON)
  createdAt     DateTime @default(now())

  // Зв'язок з клієнтом
  client DirectClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([state])
  @@index([createdAt])
  @@map("direct_client_state_logs")
}

// Записи з Altegio (для хронології послуг)
model AltegioRecord {
  id              String   @id @default(uuid())
  visitId         Int? // ID візиту в Altegio
  recordId        Int? // ID запису в Altegio
  altegioClientId Int // ID клієнта в Altegio
  directClientId  String? // ID клієнта в нашій системі (якщо знайдено)
  status          String? // Статус: 'create', 'update', 'delete'
  datetime        DateTime // Дата та час візиту
  receivedAt      DateTime @default(now()) // Коли отримали вебхук
  staffId         Int? // ID майстра
  staffName       String? // Ім'я майстра
  services        String // JSON масив послуг
  attendance      Int? // Чи прийшов (0 або 1)
  rawData         String? // Повні дані вебхука (JSON)

  @@index([altegioClientId])
  @@index([directClientId])
  @@index([visitId])
  @@index([recordId])
  @@index([datetime])
  @@index([receivedAt])
  @@map("altegio_records")
}
