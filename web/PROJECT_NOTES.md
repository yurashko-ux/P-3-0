# PROJECT NOTES — ManyChat → KeyCRM

## Поточний стан
- Пошук карток у KeyCRM працює за JSON:API-фільтрами та fallback’ами, показує усі переглянуті картки та збіги.
- Ручний тестовий переміщувач (на тестовій сторінці) успішно переміщує картки за заданими pipeline/status.

## На чому зупинилися
- Автоматичне переміщення карток під час ManyChat-автоматизації завершується `keycrm_move_failed`: KeyCRM приймає запити, але після 20 перевірок картка залишається в базовому статусі.
- Потрібно звірити, які саме `pipeline_status_id`/`status_id` ідуть у фінальний запит з автоматизації, та порівняти з ручним віджетом (який працює через прямий виклик `moveKeycrmCard`).
- Підозра: у кампанії збережено коректні `pipeline_status_id`, але автоматизація все ще відправляє інший набір alias’ів або неправильний payload.
- Наступний крок: порівняти payload/response з тестового віджета і ManyChat-автоматизації, уніфікувати побудову запиту в `routeManychatMessage` з тією, що використовує ручний тест.

## Корисні посилання та маршрути
- ManyChat webhook: `POST /api/mc/manychat`.
- Тестова ManyChat-сторінка: `/admin/debug` → «ManyChat інтеграція».
- Кампанії: `/admin/campaigns`, `POST /api/campaigns`.
- Пошук карток: `GET /api/keycrm/card/find`.
- Переміщення (ручне/автоматичне): `POST /api/keycrm/card/move`.

## Конфігурація середовища
- ManyChat: `MC_TOKEN` (для webhook), `MANYCHAT_API_KEY` (REST, нині вимкнено), `MANYCHAT_INBOX_LIMIT` (опційно).
- KeyCRM: `KEYCRM_BASE_URL` або `KEYCRM_API_URL`, `KEYCRM_API_TOKEN` (bearer), за потреби читальні токени.
- Vercel KV: `KV_REST_API_URL`, `KV_REST_API_TOKEN`, `KV_REST_API_READ_ONLY_TOKEN`.

## Примітки для продовження
- Зберегти лог останнього невдалого переміщення з таймлайна (payload + history) для порівняння.
- Переконатися, що автоматизація передає ті самі заголовки (авторизація, protection bypass), що й ручні запити.
- Після виправлення — протестувати повний цикл на новій кампанії (із унікальним V1/V2) і підтвердити, що картка змінює статус у KeyCRM.

## Швидкий старт у новому чаті
1. Розгорни репозиторій `P-3-0`, перейди у директорію `web`.
2. Перевір змінні середовища (особливо `KEYCRM_*`, `KV_*`, `MC_*`). Без них автоматизація повністю не працює.
3. Проглянь `/admin/debug` — блок ManyChat показує останній webhook, знайдену кампанію, картку та історію переміщення.
4. Якщо потрібно вручну відтворити переміщення, скористайся виджетом пошуку/переміщення на тій же сторінці, щоб зафіксувати payload, який точно працює.
5. Далі внеси зміни у `web/lib/manychat-routing.ts` або `web/lib/keycrm-move.ts`, аби автоматизація використовувала той самий payload, і повторно перевір таймлайн.
