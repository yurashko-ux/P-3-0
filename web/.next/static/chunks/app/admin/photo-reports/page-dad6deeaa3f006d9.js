(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[164],{5872:function(e,t,s){Promise.resolve().then(s.bind(s,7363))},7363:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return d}});var l=s(7437),a=s(2265),r=s(9260),n=s(6246);function d(){var e;let[t,s]=(0,a.useState)(null),[d,c]=(0,a.useState)(!1),[i,o]=(0,a.useState)("Mykolay007"),[x,m]=(0,a.useState)(null),[h,u]=(0,a.useState)(!1),[p,b]=(0,a.useState)(null),[j,f]=(0,a.useState)(!1),[N,g]=(0,a.useState)(null),[v,y]=(0,a.useState)([]),[w,k]=(0,a.useState)("prod"),[S,C]=(0,a.useState)(!1);(0,a.useEffect)(()=>{fetch("/api/photo-reports/masters").then(e=>e.json()).then(e=>{e.ok&&e.masters&&y(e.masters)}).catch(e=>console.error("Failed to load masters:",e))},[]);let D=async()=>{c(!0),s(null);try{let e=await fetch("/api/telegram/test-reminder",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({telegramUsername:i,clientName:"Тестовий клієнт",serviceName:"Тестова послуга",minutesUntilEnd:15})}),t=await e.json();s(t)}catch(e){s({ok:!1,error:e instanceof Error?e.message:String(e)})}finally{c(!1)}},M=async()=>{u(!0);try{let e=await fetch("/api/telegram/debug"),t=await e.json();if(t.ok&&t.recentReports){let e={};t.recentReports.forEach(t=>{e[t.masterId]=(e[t.masterId]||0)+1}),m({totalReports:t.recentReports.length,reportsByMaster:e,recentReports:t.recentReports.slice(0,20)})}}catch(e){console.error("Failed to load analytics:",e)}finally{u(!1)}},E=async()=>{f(!0),g(null);try{let e=await fetch("/api/photo-reports/services-stats?daysBack=30&includeFuture=".concat("test"===w?"true":"false")),t=await e.json();if(console.log("[photo-reports] Services stats response:",t),t.ok&&t.statsByMaster)b(t),g(null);else{let e=t.error||"Невідома помилка";g(e),console.error("Failed to load services stats:",t)}}catch(e){g(e instanceof Error?e.message:String(e)),console.error("Failed to load services stats:",e)}finally{f(!1)}},I=async()=>{if(!confirm("Ви впевнені, що хочете очистити всі фото-звіти? Цю дію неможливо скасувати."))return;let e=prompt("Введіть секретний ключ для підтвердження:");if(e){C(!0);try{let t=await fetch("/api/photo-reports/clear?secret=".concat(encodeURIComponent(e)),{method:"POST"}),s=await t.json();s.ok?(alert("✅ Очищено ".concat(s.deletedCount," фото-звітів")),await M()):alert("❌ Помилка: ".concat(s.error))}catch(e){alert("❌ Помилка: ".concat(e instanceof Error?e.message:String(e)))}finally{C(!1)}}},R=e=>{let t=e.id.toLowerCase(),s=e.name.toLowerCase(),l=(e.telegramUsername||"").toLowerCase();return t.includes("test")||s.includes("тест")||l.includes("test")||l.includes("mykolay007")},[B,A]=(0,a.useState)(!1),F="photo-reports-dashboard-layout",U=e=>{};return(0,l.jsxs)("main",{className:"mx-auto max-w-7xl px-6 py-8",children:[(0,l.jsx)("header",{className:"mb-8",children:(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h1",{className:"text-3xl font-bold tracking-tight",children:"Фото-звіти"}),(0,l.jsx)("p",{className:"mt-2 text-sm text-slate-500",children:"Тестування нагадувань та аналітика по майстрах."})]}),(0,l.jsx)(n.G,{storageKey:F,onEditModeChange:A,onSave:U})]})}),(0,l.jsx)(r.R,{storageKey:F,layoutVersion:"7",defaultLayout:[{i:"test-section",x:0,y:0,w:12,h:80},{i:"analytics",x:0,y:80,w:12,h:120},{i:"masters",x:0,y:200,w:12,h:60}],editMode:B,onSave:U,children:{"test-section":(0,l.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm h-full",children:[(0,l.jsxs)("div",{className:"drag-handle mb-4 flex cursor-move items-center justify-between",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-slate-800",children:"\uD83E\uDDEA Тестове нагадування"}),(0,l.jsx)("span",{className:"text-xs text-slate-400",children:"Перетягніть за заголовок"})]}),(0,l.jsx)("p",{className:"mb-4 text-sm text-slate-600",children:"Відправ тестове нагадування про фото-звіт в Telegram. Користувач має бути зареєстрований (надіслати /start боту)."}),(0,l.jsxs)("div",{className:"mb-4 flex gap-4",children:[(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsx)("label",{htmlFor:"username",className:"mb-2 block text-sm font-medium text-slate-700",children:"Telegram Username"}),(0,l.jsx)("input",{id:"username",type:"text",value:i,onChange:e=>o(e.target.value),placeholder:"Mykolay007",className:"w-full rounded-lg border border-slate-300 px-4 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"})]}),(0,l.jsx)("div",{className:"flex items-end",children:(0,l.jsx)("button",{onClick:D,disabled:d||!i,className:"rounded-lg bg-blue-600 px-6 py-2 font-semibold text-white shadow-md transition-colors hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50",children:d?"Відправка...":"Відправити тест"})})]}),t&&(0,l.jsx)("div",{className:"rounded-lg border p-4 ".concat(t.ok?"border-green-200 bg-green-50":"border-red-200 bg-red-50"),children:t.ok?(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-semibold text-green-800",children:"✅ Успішно!"}),(0,l.jsx)("p",{className:"mt-1 text-sm text-green-700",children:t.message}),t.chatId&&(0,l.jsxs)("p",{className:"mt-1 text-xs text-green-600",children:["Chat ID: ",t.chatId]})]}):(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-semibold text-red-800",children:"❌ Помилка"}),(0,l.jsx)("p",{className:"mt-1 text-sm text-red-700",children:t.error||"Невідома помилка"}),(null===(e=t.error)||void 0===e?void 0:e.includes("chatId not found"))&&(0,l.jsx)("p",{className:"mt-2 text-xs text-red-600",children:"\uD83D\uDCA1 Підказка: Надішли /start боту в Telegram, щоб зареєструватися"})]})})]}),analytics:(0,l.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm h-full",children:[(0,l.jsxs)("div",{className:"drag-handle mb-4 flex cursor-move items-center justify-between",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-slate-800",children:"\uD83D\uDCCA Аналітика по майстрах"}),(0,l.jsx)("span",{className:"text-xs text-slate-400",children:"Перетягніть за заголовок"})]}),(0,l.jsx)("div",{className:"mb-4 flex items-center justify-between",children:(0,l.jsxs)("div",{className:"flex items-center gap-3",children:[(0,l.jsxs)("div",{className:"inline-flex rounded-full bg-slate-100 p-1 text-xs",children:[(0,l.jsx)("button",{onClick:()=>k("prod"),className:"rounded-full px-3 py-1 font-medium transition-colors ".concat("prod"===w?"bg-white text-slate-900 shadow-sm":"text-slate-500 hover:text-slate-700"),children:"Робочий режим"}),(0,l.jsx)("button",{onClick:()=>k("test"),className:"rounded-full px-3 py-1 font-medium transition-colors ".concat("test"===w?"bg-white text-slate-900 shadow-sm":"text-slate-500 hover:text-slate-700"),children:"Тестовий"})]}),(0,l.jsxs)("div",{className:"flex gap-2",children:[(0,l.jsx)("button",{onClick:E,disabled:j,className:"rounded-lg bg-slate-100 px-4 py-2 text-sm font-medium text-slate-700 transition-colors hover:bg-slate-200 disabled:cursor-not-allowed disabled:opacity-50",children:j?"Завантаження...":"Завантажити послуги"}),(0,l.jsx)("button",{onClick:M,disabled:h,className:"rounded-lg bg-slate-100 px-4 py-2 text-sm font-medium text-slate-700 transition-colors hover:bg-slate-200 disabled:cursor-not-allowed disabled:opacity-50",children:h?"Завантаження...":"Оновити звіти"}),(0,l.jsx)("button",{onClick:I,disabled:S,className:"rounded-lg bg-red-100 px-4 py-2 text-sm font-medium text-red-700 transition-colors hover:bg-red-200 disabled:cursor-not-allowed disabled:opacity-50",children:S?"Очищення...":"Очистити фото-звіти"})]})]})}),N&&(0,l.jsxs)("div",{className:"mb-4 rounded-lg border border-red-200 bg-red-50 p-4",children:[(0,l.jsx)("p",{className:"font-semibold text-red-800",children:"❌ Помилка завантаження послуг"}),(0,l.jsx)("p",{className:"mt-1 text-sm text-red-700",children:N}),(0,l.jsx)("p",{className:"mt-2 text-xs text-red-600",children:"Перевір логи в консолі браузера (F12) або логи Vercel для деталей."})]}),x?(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsx)("div",{className:"rounded-lg bg-slate-50 p-4",children:p&&(0,l.jsxs)("div",{className:"grid grid-cols-4 gap-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs text-slate-500",children:"Виконані послуги"}),(0,l.jsx)("p",{className:"mt-1 text-xl font-bold text-green-600",children:p.statsByMaster.reduce((e,t)=>e+(t.count||0),0)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs text-slate-500",children:"Планові послуги"}),(0,l.jsx)("p",{className:"mt-1 text-xl font-bold text-slate-600",children:p.statsByMaster.reduce((e,t)=>e+(t.plannedCount||0),0)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs text-slate-500",children:"Всього фото-звітів"}),(0,l.jsx)("p",{className:"mt-1 text-xl font-bold text-blue-600",children:"prod"===w?v.filter(e=>"master"===e.role&&!R(e)).reduce((e,t)=>e+(x.reportsByMaster[t.id]||0),0):x.totalReports})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-xs text-slate-500",children:"% фото-звітів"}),(()=>{let e=p.statsByMaster.reduce((e,t)=>e+(t.count||0),0),t=p.statsByMaster.reduce((e,t)=>e+(x.reportsByMaster[t.masterId]||0),0),s=e>0?Math.round(t/e*100):0;return(0,l.jsxs)("p",{className:"mt-1 text-xl font-bold ".concat(s>=80?"text-green-600":s>=50?"text-yellow-600":"text-red-600"),children:[s,"%"]})})()]})]})}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"mb-2 text-base font-semibold text-slate-800",children:"По майстрах"}),p&&(0,l.jsxs)("p",{className:"mb-2 text-xs text-slate-600",children:['Всього послуг "Нарощування волосся": ',p.hairExtensionAppointments,p.completedAppointments>0&&(0,l.jsxs)("span",{className:"ml-1 text-slate-400",children:["(з ",p.completedAppointments," завершених)"]})]}),(0,l.jsx)("div",{className:"space-y-1.5",children:v.filter(e=>"master"===e.role).filter(e=>"prod"!==w||!R(e)).map(e=>{let t=x.reportsByMaster[e.id]||0,s=null==p?void 0:p.statsByMaster.find(t=>t.masterId===e.id),a=(null==s?void 0:s.count)||0,r=(null==s?void 0:s.plannedCount)||0,n=a>0?Math.round(t/a*100):0;return(0,l.jsxs)("div",{className:"rounded border border-slate-200 bg-white p-2",children:[(0,l.jsx)("div",{className:"mb-1.5 flex items-center justify-between",children:(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-sm font-semibold text-slate-800",children:e.name}),(0,l.jsx)("p",{className:"text-[10px] text-slate-400",children:e.telegramUsername||"—"})]})}),(0,l.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsxs)("p",{className:"text-lg font-bold text-green-600",children:[a,(0,l.jsxs)("span",{className:"text-sm font-normal text-slate-400",children:["/",r]})]}),(0,l.jsx)("p",{className:"text-[10px] text-slate-500",children:"послуг"})]}),(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("p",{className:"text-lg font-bold text-blue-600",children:t}),(0,l.jsx)("p",{className:"text-[10px] text-slate-500",children:"фото"})]}),a>0?(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsxs)("p",{className:"text-sm font-bold ".concat(n>=80?"text-green-600":n>=50?"text-yellow-600":"text-red-600"),children:[n,"%"]}),(0,l.jsx)("p",{className:"text-[10px] text-slate-500",children:"покриття"}),(0,l.jsx)("div",{className:"mt-0.5 h-1 w-full overflow-hidden rounded-full bg-slate-200",children:(0,l.jsx)("div",{className:"h-full transition-all ".concat(n>=80?"bg-green-500":n>=50?"bg-yellow-500":"bg-red-500"),style:{width:"".concat(n,"%")}})})]}):(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("p",{className:"text-sm font-bold text-slate-400",children:"—"}),(0,l.jsx)("p",{className:"text-[10px] text-slate-400",children:"покриття"})]})]})]},e.id)})})]}),x.recentReports.length>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"mb-3 text-lg font-semibold text-slate-800",children:"Останні звіти"}),(0,l.jsx)("div",{className:"space-y-2",children:x.recentReports.map(e=>{var t;return(0,l.jsx)("div",{className:"rounded-lg border border-slate-200 bg-white p-3 text-sm",children:(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsxs)("p",{className:"font-medium text-slate-800",children:[e.clientName," • ",e.serviceName]}),(0,l.jsxs)("p",{className:"text-xs text-slate-500",children:[e.masterName," •"," ",new Date(e.createdAt).toLocaleString("uk-UA")]})]}),(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:[(null===(t=e.telegramFileIds)||void 0===t?void 0:t.length)||0," фото"]})]})},e.id)})})]})]}):(0,l.jsx)("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-8 text-center",children:(0,l.jsx)("p",{className:"text-slate-500",children:'Натисни "Оновити", щоб завантажити аналітику'})})]}),masters:(0,l.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm h-full",children:[(0,l.jsxs)("div",{className:"drag-handle mb-4 flex cursor-move items-center justify-between",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-slate-800",children:"\uD83D\uDC65 Зареєстровані майстри"}),(0,l.jsx)("span",{className:"text-xs text-slate-400",children:"Перетягніть за заголовок"})]}),(0,l.jsx)("div",{className:"space-y-2",children:v.map(e=>(0,l.jsx)("div",{className:"flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 p-3",children:(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-medium text-slate-800",children:e.name}),(0,l.jsxs)("p",{className:"text-xs text-slate-500",children:[e.telegramUsername||"—"," • ",e.role,e.altegioStaffId&&(0,l.jsxs)("span",{children:[" • Altegio ID: ",e.altegioStaffId]})]})]})},e.id))})]})}})]})}}},function(e){e.O(0,[902,971,23,744],function(){return e(e.s=5872)}),_N_E=e.O()}]);