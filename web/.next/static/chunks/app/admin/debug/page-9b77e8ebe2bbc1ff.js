(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[585],{7751:function(e,t,s){Promise.resolve().then(s.bind(s,6286)),Promise.resolve().then(s.bind(s,1823)),Promise.resolve().then(s.bind(s,2669)),Promise.resolve().then(s.bind(s,4663)),Promise.resolve().then(s.bind(s,4892))},6286:function(e,t,s){"use strict";s.d(t,{CampaignsMaintenanceCard:function(){return n}});var l=s(7437),a=s(2265);let r={loading:!1,status:null,result:null,error:null};function n(){let[e,t]=(0,a.useState)(r),s=async()=>{t({loading:!0,status:null,result:null,error:null});try{var e,s;let l=await fetch("/api/campaigns/cleanup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:!0})}),a=await l.json();if(!l.ok||(null==a?void 0:a.ok)===!1){let e=(null==a?void 0:a.error)?String(a.error):"HTTP ".concat(l.status);t({loading:!1,status:l.status,result:null,error:e});return}let r={ok:!!a.ok,deletedIds:Number(null!==(e=a.deletedIds)&&void 0!==e?e:0),deletedKeys:Number(null!==(s=a.deletedKeys)&&void 0!==s?s:0),sampleIds:Array.isArray(a.sampleIds)?a.sampleIds:[],sources:a.sources&&"object"==typeof a.sources?a.sources:{}};t({loading:!1,status:l.status,result:r,error:null})}catch(e){t({loading:!1,status:null,result:null,error:e instanceof Error?e.message:String(e)})}};return(0,l.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,l.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-slate-800",children:"Очищення кампаній у KV"}),(0,l.jsx)("p",{className:"mt-2 text-sm text-slate-500",children:"Видаляє всі збережені кампанії з Vercel KV і очищає кеш у пам'яті. Використовуйте, коли потрібно створити кампанії з нуля."})]}),(0,l.jsx)("button",{type:"button",onClick:s,disabled:e.loading,className:"inline-flex items-center rounded-lg border border-rose-200 bg-rose-50 px-3 py-1.5 text-sm font-medium text-rose-700 transition hover:bg-rose-100 disabled:cursor-wait disabled:opacity-50",children:e.loading?"Очищення…":"Видалити всі"})]}),(0,l.jsx)("p",{className:"mt-4 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700",children:"Операція незворотна. Після очищення потрібно заново створити кампанії в адмінці."}),e.error&&(0,l.jsxs)("div",{className:"mt-4 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:["Помилка: ",e.error]}),e.result&&(0,l.jsxs)("div",{className:"mt-4 space-y-3 text-sm text-slate-700",children:[(0,l.jsxs)("div",{className:"grid gap-3 sm:grid-cols-2",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-800",children:"Видалено карток:"})," ",e.result.deletedIds]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-800",children:"Очищено ключів:"})," ",e.result.deletedKeys]})]}),e.result.sampleIds.length>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-800",children:"Приклади ID:"}),(0,l.jsx)("pre",{className:"mt-1 max-h-32 overflow-auto rounded-md bg-slate-900 p-3 text-xs text-slate-100",children:JSON.stringify(e.result.sampleIds,null,2)})]}),Object.keys(e.result.sources).length>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-800",children:"Джерела ID:"}),(0,l.jsx)("pre",{className:"mt-1 max-h-32 overflow-auto rounded-md bg-slate-900 p-3 text-xs text-slate-100",children:JSON.stringify(e.result.sources,null,2)})]})]})]})}},1823:function(e,t,s){"use strict";s.d(t,{KeycrmCardSearchWidget:function(){return r}});var l=s(7437),a=s(2265);function r(){var e,t,s,r,n;let[i,d]=(0,a.useState)(""),[o,c]=(0,a.useState)(""),[u,m]=(0,a.useState)(""),[x,p]=(0,a.useState)([]),[h,v]=(0,a.useState)({state:"idle"}),[g,b]=(0,a.useState)({state:"idle"}),[j,y]=(0,a.useState)({state:"loading"}),[f,N]=(0,a.useState)({status:"idle",message:"Введіть повне ім'я або social_id (наприклад, instagram логін) чи залиште поле порожнім і оберіть воронку/статус."}),[k,w]=(0,a.useState)(""),[_,I]=(0,a.useState)(""),[C,S]=(0,a.useState)(null),[M,R]=(0,a.useState)({status:"idle"}),A=(0,a.useRef)(null),K=(0,a.useRef)(null),q=(0,a.useRef)(null),T=(0,a.useRef)(null),E=(0,a.useRef)(null),U=(0,a.useRef)(new Set),P=(0,a.useRef)(""),O=(0,a.useRef)("");(0,a.useEffect)(()=>()=>{var e,t,s;null===(e=A.current)||void 0===e||e.abort(),null===(t=K.current)||void 0===t||t.abort(),null===(s=q.current)||void 0===s||s.abort()},[]),(0,a.useEffect)(()=>{let e=!1;return async function(){y({state:"loading"});try{let t=await fetch("/api/keycrm/pipelines",{headers:{accept:"application/json"}}),s=await t.json().catch(()=>null);if(!s){e||y({state:"error",message:"Не вдалося прочитати список воронок"});return}if(s.ok){e||(p(s.pipelines),y({state:"loaded",source:s.source,fetchedAt:s.fetchedAt}));return}e||(p(s.pipelines),s.pipelines.length?y({state:"loaded",source:"stale",fetchedAt:s.fetchedAt,note:"keycrm_env_missing"===s.error?"KeyCRM не налаштовано. Показуємо останній кешований список.":"Не вдалося оновити воронки. Показуємо кешований список."}):y({state:"error",message:"keycrm_env_missing"===s.error?"KeyCRM не налаштовано":"Не вдалося отримати воронки"}))}catch(t){e||y({state:"error",message:t instanceof Error?t.message:String(t)})}}(),()=>{e=!0}},[]);let F=(0,a.useCallback)(async function(e){var t,s,l,a,r;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=e.trim(),d=null!==(a=null===(t=n.pipelineId)||void 0===t?void 0:t.trim())&&void 0!==a?a:"",o=null!==(r=null===(s=n.statusId)||void 0===s?void 0:s.trim())&&void 0!==r?r:"";if(!i&&!d){N({status:"error",error:{ok:!1,error:"filters_required",details:"Щоб показати картки без пошукового запиту, оберіть воронку або задайте статус."}});return}null===(l=A.current)||void 0===l||l.abort();let c=new AbortController;A.current=c,R({status:"idle"}),N({status:"loading",message:i?"Шукаємо у KeyCRM…":"Збираємо картки з обраної воронки…"});try{let e=new URLSearchParams;i&&e.set("needle",i),d&&e.set("pipeline_id",d),o&&e.set("status_id",o);let t=await fetch("/api/keycrm/card/find?".concat(e.toString()),{signal:c.signal,headers:{accept:"application/json"}}),s=await t.json().catch(()=>null);if(!s){N({status:"error",error:{ok:!1,error:"invalid_response",details:"Відповідь API не JSON"}});return}if("ok"in s&&!0===s.ok){N({status:"success",result:s});return}N({status:"error",error:s})}catch(e){if((null==e?void 0:e.name)==="AbortError")return;N({status:"error",error:{ok:!1,error:"network_error",details:e instanceof Error?e.message:String(e)}})}finally{A.current===c&&(A.current=null)}},[]),J=(0,a.useCallback)(e=>{var t,s,l;e.preventDefault();let a=new FormData(e.currentTarget);F(String(null!==(t=a.get("needle"))&&void 0!==t?t:""),{pipelineId:String(null!==(s=a.get("pipeline_id"))&&void 0!==s?s:""),statusId:String(null!==(l=a.get("status_id"))&&void 0!==l?l:"")})},[F]),V=(0,a.useMemo)(()=>{if("success"!==f.status)return null;let e=f.result;return{cardsChecked:e.cardsChecked,pagesScanned:e.pagesScanned,pipelineId:e.filters.pipelineId,statusId:e.filters.statusId,perPage:e.filters.perPage,maxPages:e.filters.maxPages,itemsCount:e.items.length}},[f]),D="success"===f.status?f.result.match:null,H="success"===f.status?f.result.items:[],L="success"===f.status?f.result.needle.trim():"",B="error"===f.status?f.error.details:void 0,Y=(0,a.useMemo)(()=>{var e;if(!o)return null;let t=Number(o);return Number.isFinite(t)&&null!==(e=x.find(e=>e.id===t))&&void 0!==e?e:null},[o,x]),z=(0,a.useMemo)(()=>{var e;if(!k)return null;let t=Number(k);return Number.isFinite(t)&&null!==(e=x.find(e=>e.id===t))&&void 0!==e?e:null},[x,k]);(0,a.useEffect)(()=>{var e;if("success"!==f.status){S(null);return}if(f.result.items.some(e=>e.cardId===C))return;if(f.result.match){S(f.result.match.cardId);return}let t=null===(e=f.result.items[0])||void 0===e?void 0:e.cardId;S(Number.isFinite(t)?t:null)},[C,f]),(0,a.useEffect)(()=>{if(!z){I("");return}if(!_)return;let e=Number(_);if(!Number.isFinite(e)){I("");return}z.statuses.some(t=>t.id===e)||I("")},[z,_]),(0,a.useEffect)(()=>{if(!Y){m("");return}if(!u)return;let e=Number(u);if(!Number.isFinite(e)){m("");return}Y.statuses.some(t=>t.id===e)||m("")},[Y,u]),(0,a.useEffect)(()=>{var e;let t=o.trim();if(t!==P.current&&(P.current=t,t)){let e=Number(t);Number.isFinite(e)&&U.current.delete(e)}if(!t){K.current&&(K.current.abort(),K.current=null),T.current=null,"idle"!==h.state&&v({state:"idle"});return}let s=Number(t);if(!Number.isFinite(s)||s<=0){("error"!==h.state||"Некоректний pipeline_id"!==h.message)&&v({state:"error",message:"Некоректний pipeline_id"});return}let l=null!==(e=x.find(e=>e.id===s))&&void 0!==e?e:null;if(l&&l.statuses.length>0){K.current&&(K.current.abort(),K.current=null),T.current=null,U.current.delete(s),"idle"!==h.state&&v({state:"idle"});return}if(U.current.has(s)&&!K.current||T.current===s&&K.current)return;let a=new AbortController;return K.current&&K.current.abort(),K.current=a,T.current=s,v({state:"loading"}),(async()=>{try{let e=await fetch("/api/keycrm/pipelines?pipeline_id=".concat(s),{signal:a.signal,headers:{accept:"application/json"}}),t=await e.json().catch(()=>null);if(!t){U.current.add(s),v({state:"error",message:"KeyCRM повернув порожню відповідь"});return}if(t.ok){p(e=>{let s=e.findIndex(e=>e.id===t.pipeline.id);return -1===s?[...e,t.pipeline].sort((e,t)=>{var s,l;let a=null!==(s=e.position)&&void 0!==s?s:Number.MAX_SAFE_INTEGER,r=null!==(l=t.position)&&void 0!==l?l:Number.MAX_SAFE_INTEGER;return a===r?e.id-t.id:a-r}):e.map((e,l)=>l===s?t.pipeline:e)}),U.current.delete(s),v({state:"idle"});return}t.pipeline&&p(e=>{let s=e.findIndex(e=>e.id===t.pipeline.id);return -1===s?[...e,t.pipeline]:e.map((e,l)=>l===s?t.pipeline:e)}),v({state:"error",message:"keycrm_env_missing"===t.error?"KeyCRM не налаштовано":"keycrm_pipeline_not_found"===t.error?"Таку воронку не знайдено":"Не вдалося завантажити статуси цієї воронки"}),U.current.add(s)}catch(e){if((null==e?void 0:e.name)==="AbortError")return;U.current.add(s),v({state:"error",message:e instanceof Error?e.message:String(e)})}finally{K.current===a&&(K.current=null),T.current===s&&(T.current=null)}})(),()=>{a.abort()}},[o,x,h.state]),(0,a.useEffect)(()=>{var e;let t=k.trim();if(t!==O.current&&(O.current=t,t)){let e=Number(t);Number.isFinite(e)&&U.current.delete(e)}if(!t){q.current&&(q.current.abort(),q.current=null),E.current=null,"idle"!==g.state&&b({state:"idle"});return}let s=Number(t);if(!Number.isFinite(s)||s<=0){("error"!==g.state||"Некоректний pipeline_id"!==g.message)&&b({state:"error",message:"Некоректний pipeline_id"});return}let l=null!==(e=x.find(e=>e.id===s))&&void 0!==e?e:null;if(l&&l.statuses.length>0){q.current&&(q.current.abort(),q.current=null),E.current=null,U.current.delete(s),"idle"!==g.state&&b({state:"idle"});return}if(U.current.has(s)&&!q.current||E.current===s&&q.current)return;let a=new AbortController;return q.current&&q.current.abort(),q.current=a,E.current=s,b({state:"loading"}),(async()=>{try{let e=await fetch("/api/keycrm/pipelines?pipeline_id=".concat(s),{signal:a.signal,headers:{accept:"application/json"}}),t=await e.json().catch(()=>null);if(!t){U.current.add(s),b({state:"error",message:"KeyCRM повернув порожню відповідь"});return}if(t.ok){p(e=>{let s=e.findIndex(e=>e.id===t.pipeline.id);return -1===s?[...e,t.pipeline].sort((e,t)=>{var s,l;let a=null!==(s=e.position)&&void 0!==s?s:Number.MAX_SAFE_INTEGER,r=null!==(l=t.position)&&void 0!==l?l:Number.MAX_SAFE_INTEGER;return a===r?e.id-t.id:a-r}):e.map((e,l)=>l===s?t.pipeline:e)}),U.current.delete(s),b({state:"idle"});return}t.pipeline&&p(e=>{let s=e.findIndex(e=>e.id===t.pipeline.id);return -1===s?[...e,t.pipeline]:e.map((e,l)=>l===s?t.pipeline:e)}),b({state:"error",message:"keycrm_env_missing"===t.error?"KeyCRM не налаштовано":"keycrm_pipeline_not_found"===t.error?"Таку воронку не знайдено":"Не вдалося завантажити статуси цієї воронки"}),U.current.add(s)}catch(e){if((null==e?void 0:e.name)==="AbortError")return;U.current.add(s),b({state:"error",message:e instanceof Error?e.message:String(e)})}finally{q.current===a&&(q.current=null),E.current===s&&(E.current=null)}})(),()=>{a.abort()}},[x,k,g.state]);let G=(0,a.useMemo)(()=>{var e;return C&&"success"===f.status&&null!==(e=f.result.items.find(e=>e.cardId===C))&&void 0!==e?e:null},[C,f]),X=(0,a.useCallback)(async()=>{if(!C){R({status:"error",message:"Оберіть картку для переміщення"});return}let e=k.trim(),t=_.trim();if(!e||!t){R({status:"error",message:"Оберіть цільову воронку та статус"});return}R({status:"loading"});try{var s;let l=await fetch("/api/keycrm/card/move",{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({card_id:String(C),to_pipeline_id:e,to_status_id:t})}),a=await l.json().catch(()=>null);if(!a){R({status:"error",message:"KeyCRM повернув неочікувану відповідь"});return}if(a.ok){R({status:"success",message:"Картку успішно переміщено",response:a});return}R({status:"error",message:null!==(s=a.error)&&void 0!==s?s:"KeyCRM відхилив переміщення",details:a})}catch(e){R({status:"error",message:e instanceof Error?e.message:String(e)})}},[C,k,_]),W=!C||!k.trim()||!_.trim()||"loading"===M.status,$=(0,a.useMemo)(()=>{if("loading"===j.state)return"Завантажуємо воронки з KeyCRM…";if("error"===j.state)return"Не вдалося отримати воронки: ".concat(j.message);if("loaded"===j.state){if(j.note)return j.note;if("stale"===j.source)return"Показуємо кешований список воронок (оновлення наразі недоступне)"}return null},[j]);return(0,l.jsxs)("div",{className:"space-y-4",children:[(0,l.jsxs)("form",{className:"flex flex-col gap-4 rounded-xl bg-slate-50 p-4 shadow-inner",onSubmit:J,children:[(0,l.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-end",children:[(0,l.jsxs)("label",{className:"flex-1 text-sm text-slate-700",children:[(0,l.jsx)("span",{className:"mb-1 block font-medium",children:"Пошук у KeyCRM"}),(0,l.jsx)("input",{className:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-base text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200",type:"text",name:"needle",value:i,placeholder:"Наприклад: Viktoria Kolachnyk або kolachnyk.v",onChange:e=>d(e.target.value),autoComplete:"off"})]}),(0,l.jsx)("button",{type:"submit",className:"inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-200",children:"loading"===f.status?"Шукаємо…":"Знайти картку"})]}),(0,l.jsxs)("div",{className:"grid gap-3 text-sm text-slate-700 sm:grid-cols-2",children:[(0,l.jsxs)("label",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"mb-1 font-medium",children:"Воронка"}),(0,l.jsxs)("select",{className:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-base text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200",name:"pipeline_id",value:o,onChange:e=>{c(e.target.value),m("")},disabled:"loading"===j.state&&!x.length,children:[(0,l.jsx)("option",{value:"",children:"Усі воронки"}),x.map(e=>(0,l.jsx)("option",{value:e.id,children:e.title},e.id))]})]}),(0,l.jsxs)("label",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"mb-1 font-medium",children:"Статус"}),(0,l.jsxs)("select",{className:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-base text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200",name:"status_id",value:u,onChange:e=>m(e.target.value),disabled:!Y||"loading"===h.state||0===Y.statuses.length,children:[(0,l.jsx)("option",{value:"",children:"Усі статуси"}),null==Y?void 0:Y.statuses.map(e=>(0,l.jsx)("option",{value:e.id,children:e.title},e.id))]}),"loading"===h.state&&(0,l.jsx)("span",{className:"mt-1 text-xs text-slate-500",children:"Завантажуємо статуси…"}),"error"===h.state&&(0,l.jsx)("span",{className:"mt-1 text-xs text-red-600",children:h.message})]})]}),(0,l.jsxs)("div",{className:"grid gap-3 rounded-lg border border-indigo-100 bg-indigo-50/70 p-3 text-sm text-indigo-900 sm:grid-cols-2",children:[(0,l.jsxs)("div",{className:"space-y-1",children:[(0,l.jsx)("span",{className:"block text-xs font-semibold uppercase tracking-wide text-indigo-700",children:"Цільова воронка"}),(0,l.jsxs)("select",{className:"w-full rounded border border-indigo-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100",name:"target_pipeline_id",value:k,onChange:e=>{w(e.target.value),I("")},children:[(0,l.jsx)("option",{value:"",children:"Не обрано"}),x.map(e=>(0,l.jsxs)("option",{value:e.id,children:[e.title," (#",e.id,")"]},"target-".concat(e.id)))]}),"loading"===g.state&&(0,l.jsx)("span",{className:"text-xs text-indigo-700",children:"Завантажуємо статуси цієї воронки…"}),"error"===g.state&&(0,l.jsx)("span",{className:"text-xs text-red-600",children:g.message})]}),(0,l.jsxs)("div",{className:"space-y-1",children:[(0,l.jsx)("span",{className:"block text-xs font-semibold uppercase tracking-wide text-indigo-700",children:"Цільовий статус"}),(0,l.jsxs)("select",{className:"w-full rounded border border-indigo-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100",name:"target_status_id",value:_,onChange:e=>I(e.target.value),disabled:!z||"loading"===g.state,children:[(0,l.jsx)("option",{value:"",children:"Не обрано"}),(null!==(e=null==z?void 0:z.statuses)&&void 0!==e?e:[]).map(e=>(0,l.jsxs)("option",{value:e.id,children:[e.title," (#",e.id,")"]},"target-status-".concat(e.id)))]}),z&&0===z.statuses.length&&"idle"===g.state&&(0,l.jsx)("span",{className:"text-xs text-indigo-700",children:"Для цієї воронки статуси ще не завантажені."})]})]}),$&&(0,l.jsx)("p",{className:"text-xs text-slate-500",children:$})]}),"idle"===f.status&&(0,l.jsx)("p",{className:"text-sm text-slate-500",children:f.message}),"loading"===f.status&&(0,l.jsx)("p",{className:"text-sm text-slate-500",children:f.message}),"error"===f.status&&(0,l.jsxs)("div",{className:"rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700",children:[(0,l.jsx)("p",{className:"font-semibold",children:"Помилка пошуку"}),(0,l.jsxs)("p",{className:"mt-1 break-words",children:["Код: ",f.error.error]}),"keycrm_rate_limited"===f.error.error&&(0,l.jsx)("p",{className:"mt-2 text-xs text-red-600",children:"KeyCRM повернув обмеження 429. Задайте воронку та статус або повторіть спробу пізніше."}),null!=B&&(0,l.jsx)("pre",{className:"mt-2 max-h-40 overflow-auto rounded bg-white/70 p-3 text-xs text-red-800",children:"string"==typeof B?B:JSON.stringify(B,null,2)})]}),"success"===f.status&&(0,l.jsxs)("div",{className:"space-y-4",children:[(D||L)&&(0,l.jsx)("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800",children:D?(0,l.jsxs)("div",{className:"space-y-1",children:[(0,l.jsxs)("p",{className:"text-base font-semibold text-emerald-900",children:["Знайдено картку #",D.cardId]}),D.title&&(0,l.jsxs)("p",{className:"text-sm",children:["Назва: ",D.title]}),(0,l.jsxs)("p",{className:"text-sm",children:["Збіг у полі ",(0,l.jsx)("code",{children:D.matchedField}),' зі значенням "',null!==(t=D.matchedValue)&&void 0!==t?t:"",'".']})]}):(0,l.jsx)("p",{className:"font-semibold",children:"Збігів не знайдено."})}),V&&(0,l.jsxs)("div",{className:"grid gap-3 rounded-xl border border-slate-200 bg-white p-4 text-sm text-slate-700 sm:grid-cols-3",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-900",children:"Перевірено карток:"})," ",V.cardsChecked]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-900",children:"Сторінок проглянуто:"})," ",V.pagesScanned]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-900",children:"Запит (per_page \xd7 max_pages):"})," ",V.perPage," \xd7 ",V.maxPages]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-900",children:"pipeline_id:"})," ",null!==(s=V.pipelineId)&&void 0!==s?s:"—"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-900",children:"status_id:"})," ",null!==(r=V.statusId)&&void 0!==r?r:"—"]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-900",children:"Отримано карток:"})," ",V.itemsCount]})]}),H.length>0&&(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:L?"Картки, що відповідали фільтрам":"Картки у вибраній воронці та статусі"}),(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"min-w-full divide-y divide-slate-200 text-left text-sm text-slate-700",children:[(0,l.jsx)("thead",{className:"bg-slate-100 text-xs uppercase tracking-wide text-slate-500",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"px-3 py-2",children:"Обрати"}),(0,l.jsx)("th",{className:"px-3 py-2",children:"ID"}),(0,l.jsx)("th",{className:"px-3 py-2",children:"Назва"}),(0,l.jsx)("th",{className:"px-3 py-2",children:"Контакт"}),(0,l.jsx)("th",{className:"px-3 py-2",children:"Соцмережа"}),(0,l.jsx)("th",{className:"px-3 py-2",children:"Воронка"}),(0,l.jsx)("th",{className:"px-3 py-2",children:"Статус"})]})}),(0,l.jsx)("tbody",{className:"divide-y divide-slate-100 bg-white",children:H.map(e=>{var t,s,a,r,n;return(0,l.jsxs)("tr",{className:"cursor-pointer hover:bg-slate-50 ".concat(C===e.cardId?"bg-indigo-50/70":""),onClick:()=>S(e.cardId),children:[(0,l.jsx)("td",{className:"px-3 py-2 align-middle",children:(0,l.jsx)("input",{type:"radio",name:"selected_card",className:"h-4 w-4 accent-indigo-600",checked:C===e.cardId,onChange:()=>S(e.cardId)})}),(0,l.jsxs)("td",{className:"px-3 py-2 font-mono text-xs text-slate-500",children:["#",e.cardId]}),(0,l.jsx)("td",{className:"px-3 py-2 text-slate-900",children:null!==(t=e.title)&&void 0!==t?t:"—"}),(0,l.jsx)("td",{className:"px-3 py-2",children:null!==(a=null!==(s=e.contactName)&&void 0!==s?s:e.clientName)&&void 0!==a?a:"—"}),(0,l.jsx)("td",{className:"px-3 py-2",children:null!==(n=null!==(r=e.contactSocialId)&&void 0!==r?r:e.clientSocialId)&&void 0!==n?n:"—"}),(0,l.jsx)("td",{className:"px-3 py-2",children:(()=>{var t;if(e.pipelineTitle)return e.pipelineTitle;let s=x.find(t=>t.id===e.pipelineId);return null!==(t=null==s?void 0:s.title)&&void 0!==t?t:"—"})()}),(0,l.jsx)("td",{className:"px-3 py-2",children:(()=>{var t;if(e.statusTitle)return e.statusTitle;let s=x.find(t=>t.id===e.pipelineId);if(!s)return"—";let l=s.statuses.find(t=>t.id===e.statusId);return null!==(t=null==l?void 0:l.title)&&void 0!==t?t:"—"})()})]},e.cardId)})})]})})]}),(0,l.jsxs)("div",{className:"space-y-3 rounded-xl border border-indigo-200 bg-white p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-indigo-900",children:"Переміщення картки"}),(0,l.jsx)("p",{className:"text-xs text-slate-600",children:"Оберіть картку у таблиці вище та цільову воронку зі статусом. Після переміщення картка з’явиться у вибраній колонці KeyCRM."}),(0,l.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[(0,l.jsx)("div",{className:"text-sm text-slate-700",children:G?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("span",{className:"font-medium text-slate-900",children:"Вибрана картка:"})," ","#",G.cardId," \xb7 ",null!==(n=G.title)&&void 0!==n?n:"Без назви"]}):(0,l.jsx)("span",{className:"text-slate-500",children:"Картку не обрано"})}),(0,l.jsx)("button",{type:"button",onClick:X,disabled:W,className:"inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ".concat(W?"cursor-not-allowed bg-indigo-200 text-indigo-500":"bg-indigo-600 text-white hover:bg-indigo-700"),children:"loading"===M.status?"Переміщуємо…":"Перемістити картку"})]}),"error"===M.status&&(0,l.jsxs)("div",{className:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[(0,l.jsx)("p",{className:"font-semibold",children:"Не вдалося перемістити"}),(0,l.jsx)("p",{className:"mt-1 text-xs text-red-600",children:M.message}),M.details&&(0,l.jsx)("pre",{className:"mt-2 max-h-40 overflow-auto rounded bg-white/70 p-2 text-xs text-red-800",children:JSON.stringify(M.details,null,2)})]}),"success"===M.status&&(0,l.jsxs)("div",{className:"rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-800",children:[(0,l.jsx)("p",{className:"font-semibold",children:M.message}),(0,l.jsx)("pre",{className:"mt-2 max-h-40 overflow-auto rounded bg-white/70 p-2 text-xs text-emerald-900",children:JSON.stringify(M.response,null,2)})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"Сира відповідь API"}),(0,l.jsx)("pre",{className:"mt-2 max-h-72 overflow-auto rounded-xl bg-slate-900 p-4 text-xs text-slate-100",children:JSON.stringify(f.result,null,2)})]})]})]})}},2669:function(e,t,s){"use strict";s.d(t,{KeycrmEnvCard:function(){return n}});var l=s(7437),a=s(2265);let r={loading:!1,error:null,status:null};function n(){var e,t,s,n,i,d;let[o,c]=(0,a.useState)(r),u=(0,a.useCallback)(async()=>{c(e=>({...e,loading:!0,error:null}));try{let e=await fetch("/api/admin/status",{method:"GET",cache:"no-store"}),t=await e.json();c({loading:!1,error:e.ok?null:"HTTP ".concat(e.status),status:t})}catch(e){c({loading:!1,error:e instanceof Error?e.message:String(e),status:null})}},[]);(0,a.useEffect)(()=>{u()},[u]);let m=null===(e=o.status)||void 0===e?void 0:e.keycrm.ping,x=(0,a.useMemo)(()=>(null==m?void 0:m.attempted)?m.ok?"text-emerald-600":"text-amber-600":"text-slate-600",[m]);return(0,l.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,l.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-slate-800",children:"Статус KeyCRM API"}),(0,l.jsx)("p",{className:"mt-2 text-sm text-slate-500",children:"Перевіряємо наявність обов'язкових змінних середовища і робимо тестовий запит до KeyCRM, щоб впевнитися, що ми можемо виконувати операції переміщення карток."})]}),(0,l.jsx)("button",{type:"button",onClick:u,disabled:o.loading,className:"inline-flex items-center rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 disabled:cursor-wait disabled:opacity-50",children:o.loading?"Оновлення…":"Оновити"})]}),o.error&&(0,l.jsxs)("div",{className:"mt-4 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:["Помилка запиту: ",o.error]}),(0,l.jsxs)("dl",{className:"mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"font-medium text-slate-700",children:"KEYCRM_API_URL / KEYCRM_BASE_URL"}),(0,l.jsx)("dd",{children:(null===(t=o.status)||void 0===t?void 0:t.keycrm.hasBaseUrl)?"налаштовано":"не задано"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"font-medium text-slate-700",children:"KEYCRM_API_TOKEN / KEYCRM_BEARER"}),(0,l.jsx)("dd",{children:(null===(s=o.status)||void 0===s?void 0:s.keycrm.hasToken)?"налаштовано":"не задано"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"font-medium text-slate-700",children:"Остання перевірка"}),(0,l.jsx)("dd",{children:(null===(n=o.status)||void 0===n?void 0:n.timestamp)?new Date(o.status.timestamp).toLocaleString():"—"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("dt",{className:"font-medium text-slate-700",children:"Результат ping"}),(0,l.jsx)("dd",{className:x,children:(null==m?void 0:m.attempted)?m.ok?"OK (".concat(null!==(i=m.status)&&void 0!==i?i:"?",")"):"Помилка ".concat(null!==(d=m.status)&&void 0!==d?d:""):"не виконувався"})]})]}),(0,l.jsxs)("div",{className:"mt-4 space-y-2 text-xs text-slate-600",children:[(null==m?void 0:m.endpoint)&&(0,l.jsxs)("p",{children:[(0,l.jsx)("span",{className:"font-medium text-slate-700",children:"URL перевірки:"})," ",m.endpoint]}),(null==m?void 0:m.error)&&(0,l.jsx)("p",{className:"whitespace-pre-wrap rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-amber-700",children:m.error}),!(null==m?void 0:m.attempted)&&(0,l.jsx)("p",{className:"rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-amber-700",children:"Щоб виконати перевірку, заповніть KEYCRM_API_URL та KEYCRM_API_TOKEN у середовищі. Після цього натисніть \xabОновити\xbb."})]})]})}},4663:function(e,t,s){"use strict";s.d(t,{ManychatCampaignRouter:function(){return c}});var l=s(7437),a=s(2265);let r={success:{dot:"bg-emerald-500",border:"border-emerald-200",title:"text-emerald-700",text:"text-emerald-700"},warning:{dot:"bg-amber-500",border:"border-amber-200",title:"text-amber-700",text:"text-amber-700"},error:{dot:"bg-rose-500",border:"border-rose-200",title:"text-rose-700",text:"text-rose-700"},info:{dot:"bg-slate-400",border:"border-slate-200",title:"text-slate-700",text:"text-slate-600"}};function n(e){let{index:t,title:s,status:a,children:n}=e,i=r[a];return(0,l.jsxs)("li",{className:"relative ml-0 list-none pl-6",children:[(0,l.jsx)("span",{className:"absolute -left-[32px] top-2 flex h-7 w-7 items-center justify-center rounded-full text-xs font-semibold text-white shadow-sm ".concat(i.dot),children:t+1}),(0,l.jsxs)("div",{className:"rounded-xl border bg-white px-4 py-3 shadow-sm ".concat(i.border),children:[(0,l.jsx)("div",{className:"text-sm font-semibold ".concat(i.title),children:s}),(0,l.jsx)("div",{className:"mt-1 space-y-1 text-sm ".concat(i.text),children:n})]})]})}function i(e){let{target:t,label:s}=e,a=t.pipelineName||t.pipelineId||"—",r=t.statusName||t.statusId||"—";return(0,l.jsxs)("div",{className:"rounded-xl bg-slate-50 px-3 py-2 text-sm",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:s}),(0,l.jsx)("div",{className:"font-medium text-slate-700",children:a}),(0,l.jsxs)("div",{className:"text-slate-500",children:["Статус: ",r]})]})}function d(e){let{attempt:t}=e,s=t.result.ok;return(0,l.jsxs)("div",{className:"flex items-start justify-between rounded-lg border px-3 py-2 text-sm",children:[(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"font-medium text-slate-700",children:[t.kind,": ",(0,l.jsx)("span",{className:"text-slate-500",children:t.value})]}),!s&&(0,l.jsxs)("div",{className:"text-xs text-red-500",children:["Помилка: ",t.result.error]}),s&&!t.result.match&&(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:["Без точного збігу, карток перевірено: ",t.result.cardsChecked]})]}),(0,l.jsx)("span",{className:"text-sm font-semibold ".concat(s?"text-emerald-600":"text-red-500"),children:s?"✓":"✕"})]})}function o(e){let{value:t}=e;try{return(0,l.jsx)("pre",{className:"max-h-64 overflow-auto rounded-lg bg-slate-900/90 p-3 text-xs text-slate-100",children:JSON.stringify(t,null,2)})}catch(e){return(0,l.jsxs)("div",{className:"text-sm text-red-500",children:["JSON error: ",String(e)]})}}function c(){var e,t,s,r,c,u,m,x,p,h,v,g,b,j;let[y,f]=(0,a.useState)(""),[N,k]=(0,a.useState)(""),[w,_]=(0,a.useState)(""),[I,C]=(0,a.useState)({status:"idle",message:"Вставте ManyChat-повідомлення: username, повне ім'я та текст, щоб знайти кампанію та перемістити картку."}),S="success"===I.status?I.payload:null,M=[];if(S){let e=null===(c=S.match)||void 0===c?void 0:c.campaign,t=(null===(u=S.search.selected)||void 0===u?void 0:u.match)||null,s=(null===(m=S.search.selected)||void 0===m?void 0:m.summary)||null,a=S.move,r=(()=>{let e=(a.response&&"object"==typeof a.response&&Array.isArray(a.response.history)?a.response.history:null)||(a.details&&"object"==typeof a.details&&Array.isArray(a.details.history)?a.details.history:null);return Array.isArray(e)?e:[]})(),n=r.find(e=>null!=e&&"object"==typeof e),i=a.requestUrl&&a.requestUrl.trim().length?a.requestUrl:"string"==typeof(null==n?void 0:n.url)?n.url:null,d=a.requestMethod&&a.requestMethod.trim().length?a.requestMethod:"string"==typeof(null==n?void 0:n.method)?n.method:null,j=null!==(p=a.sent)&&void 0!==p?p:n&&"sent"in n?n.sent:null,y=null!==(h=a.attempted)&&void 0!==h?h:!!(i||j||r.length>0),f=y&&a.ok,N=e=>{if("string"!=typeof e)return null;let t=e.trim();return t.length?t:null},k=null!==(v=null==e?void 0:e.base)&&void 0!==v?v:null,w=null!==(g=null===(x=S.search.selected)||void 0===x?void 0:x.summary)&&void 0!==g?g:null,_=(()=>{if(!k)return[];let e=[],t=N(k.pipelineStatusId);if(t&&e.push(t),!e.length){let t=N(k.statusId);t&&e.push(t)}return e})(),I=!(null==k?void 0:k.pipelineId)||(null==w?void 0:w.pipelineId)===k.pipelineId,C=0===_.length||_.some(e=>e===N(null==w?void 0:w.pipelineStatusId)||e===N(null==w?void 0:w.statusId)),R=!!w&&(!I||!C);M=[{key:"message",title:"Отримано повідомлення ManyChat",status:"success",content:(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{children:["Текст: ",(0,l.jsx)("span",{className:"font-medium",children:S.normalized.text||"—"})]}),(0,l.jsxs)("div",{children:["Username: ",S.normalized.handle||"—"]}),(0,l.jsxs)("div",{children:["Ім'я: ",S.normalized.fullName||"—"]})]})},{key:"campaign",title:"Підібрана кампанія",status:e?"success":"error",content:e?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{children:["Назва: ",(0,l.jsx)("span",{className:"font-medium",children:e.name||e.id||"—"})]}),(0,l.jsxs)("div",{children:["Правило: ",S.match.rule.op,' → "',S.match.rule.value,'"']}),(0,l.jsxs)("div",{children:["Базова пара: ",e.base.pipelineName||e.base.pipelineId||"—"," /"," ",e.base.statusName||e.base.statusId||"—"]}),(0,l.jsxs)("div",{children:["Цільова пара: ",e.target.pipelineName||e.target.pipelineId||"—"," /"," ",e.target.statusName||e.target.statusId||"—"]})]}):(0,l.jsx)("div",{children:"Відповідну кампанію не знайдено."})},{key:"card",title:"Знайдена картка в KeyCRM",status:t?R?"error":"success":"warning",content:t?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{children:["Картка #",t.cardId,": ",(0,l.jsx)("span",{className:"font-medium",children:t.title})]}),(0,l.jsxs)("div",{children:["Збіг за ",t.matchedField,": ",t.matchedValue]}),s&&(0,l.jsxs)("div",{children:["Поточна пара: ",s.pipelineName||s.pipelineId||"—"," /"," ",s.statusName||s.statusId||"—"]}),R&&k?(0,l.jsxs)("div",{className:"text-sm text-rose-600",children:["Картка не знаходиться у базовій парі. Очікували ",k.pipelineName||k.pipelineId||"—"," → ",k.statusName||k.statusId||k.pipelineStatusId||"—",", а зараз вона в"," ",(null==s?void 0:s.pipelineName)||(null==s?void 0:s.pipelineId)||"—"," → ",(null==s?void 0:s.statusName)||(null==s?void 0:s.statusId)||(null==s?void 0:s.pipelineStatusId)||"—","."]}):null]}):(0,l.jsx)("div",{children:"Картку не знайдено у базовій воронці. Перевірте вхідні дані або налаштування кампанії."})},{key:"move",title:"Переміщення картки",status:y?f?"success":"error":"info",content:(0,l.jsx)(l.Fragment,{children:y?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{children:f?"Переміщення підтверджено.":"Переміщення не підтверджено."}),(0,l.jsxs)("div",{children:["HTTP статус: ",null!==(b=a.status)&&void 0!==b?b:"—"]}),a.baseUrl&&(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:["Базова адреса KeyCRM: ",a.baseUrl]}),a.error&&(0,l.jsxs)("div",{className:"text-sm text-rose-600",children:["Код помилки: ",a.error]}),!f&&a.skippedReason&&(0,l.jsxs)("div",{className:"text-sm text-rose-600",children:["Причина: ",a.skippedReason]}),d&&i&&(0,l.jsxs)("div",{className:"text-sm text-slate-600",children:["Запит: ",d," ",i]}),j&&(0,l.jsxs)("div",{className:"space-y-1",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"Тіло запиту"}),(0,l.jsx)(o,{value:j})]}),Array.isArray(a.attempts)&&a.attempts.length>0&&(0,l.jsxs)("div",{className:"space-y-1",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"Спроби перевірки"}),(0,l.jsx)(o,{value:a.attempts})]})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{children:"Переміщення не виконувалось."}),a.skippedReason&&(0,l.jsxs)("div",{className:"text-sm text-slate-600",children:["Причина: ",a.skippedReason]}),d&&i&&(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:["Потенційний запит: ",d," ",i]}),j&&(0,l.jsxs)("div",{className:"space-y-1",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"Очікуване тіло запиту"}),(0,l.jsx)(o,{value:j})]})]})})},{key:"raw",title:"Сира відповідь KeyCRM",status:y?f?"success":"error":"info",content:y?a.response?(0,l.jsx)(o,{value:a.response}):(0,l.jsx)("div",{children:"Відповідь KeyCRM порожня."}):a.response||a.details||a.error||a.skippedReason?(0,l.jsx)(o,{value:{move:a}}):(0,l.jsx)("div",{children:"Переміщення не запускалось, відповідь відсутня."})}]}async function R(e){e.preventDefault();let t={message:{username:y.trim()||void 0,full_name:N.trim()||void 0,text:w.trim()}};C({status:"loading"});try{let e=await fetch("/api/admin/test/manychat",{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify(t)}),s=await e.json().catch(()=>null);if(!s){C({status:"error",statusCode:e.status,payload:{ok:!1,error:"invalid_response"}});return}if(!e.ok){let t=!1===s.ok?s:{ok:!1,error:"http_".concat(e.status)};C({status:"error",statusCode:e.status,payload:t});return}if(!s.ok){C({status:"error",statusCode:e.status,payload:s});return}C({status:"success",payload:s,statusCode:e.status})}catch(e){C({status:"error",statusCode:0,payload:{ok:!1,error:"network_error",details:e instanceof Error?e.message:String(e)}})}}return(0,l.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,l.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-slate-800",children:"ManyChat → KeyCRM тест"}),(0,l.jsx)("p",{className:"text-sm text-slate-500",children:"Порівнює текст повідомлення з правилами V1/V2 кампаній, шукає картку в базовій воронці та переносить її у цільову пару."})]}),(0,l.jsxs)("form",{onSubmit:R,className:"mt-4 space-y-4",children:[(0,l.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,l.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:[(0,l.jsx)("span",{className:"text-slate-600",children:"IG username"}),(0,l.jsx)("input",{value:y,onChange:e=>f(e.target.value),placeholder:"@username",className:"rounded-lg border px-3 py-2 text-sm outline-none focus:border-indigo-500"})]}),(0,l.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:[(0,l.jsx)("span",{className:"text-slate-600",children:"Повне ім'я"}),(0,l.jsx)("input",{value:N,onChange:e=>k(e.target.value),placeholder:"Viktoria Kolachnyk",className:"rounded-lg border px-3 py-2 text-sm outline-none focus:border-indigo-500"})]})]}),(0,l.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:[(0,l.jsx)("span",{className:"text-slate-600",children:"Текст повідомлення"}),(0,l.jsx)("textarea",{value:w,onChange:e=>_(e.target.value),placeholder:"Наприклад: хочу записатись на процедуру v1",className:"min-h-[100px] rounded-lg border px-3 py-2 text-sm outline-none focus:border-indigo-500",required:!0})]}),(0,l.jsx)("button",{type:"submit",className:"inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500 disabled:cursor-not-allowed disabled:bg-indigo-300",disabled:"loading"===I.status,children:"loading"===I.status?"Опрацьовуємо…":"Запустити пошук"})]}),"idle"===I.status&&(0,l.jsx)("p",{className:"mt-4 rounded-lg bg-slate-50 px-3 py-2 text-sm text-slate-500",children:I.message}),"error"===I.status&&(0,l.jsxs)("div",{className:"mt-4 space-y-3 rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700",children:[(0,l.jsxs)("div",{className:"font-semibold",children:["Помилка (",I.statusCode||"—","): ",I.payload.error]}),I.payload.details&&(0,l.jsx)(o,{value:I.payload.details})]}),"success"===I.status&&(0,l.jsxs)("div",{className:"mt-6 space-y-6",children:[M.length>0&&(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"Послідовність автоматизації"}),(0,l.jsx)("ol",{className:"relative space-y-4 border-l border-slate-200 pl-6",children:M.map((e,t)=>(0,l.jsx)(n,{index:t,title:e.title,status:e.status,children:e.content},e.key))})]}),(0,l.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,l.jsx)(i,{target:I.payload.match.campaign.base,label:"Базова воронка"}),(0,l.jsx)(i,{target:I.payload.match.campaign.target,label:"Цільова воронка"})]}),(0,l.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,l.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"Кампанія"}),(0,l.jsx)("div",{className:"font-semibold text-slate-800",children:I.payload.match.campaign.name||I.payload.match.campaign.id||"Без назви"}),(0,l.jsxs)("div",{className:"text-slate-500",children:["Маршрут: ",I.payload.match.route.toUpperCase()]}),(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:["Правило: ",I.payload.match.rule.op,' → "',I.payload.match.rule.value,'"']})]}),(0,l.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"ManyChat"}),(0,l.jsxs)("div",{className:"text-slate-600",children:["handle: ",I.payload.normalized.handle||"—"]}),(0,l.jsxs)("div",{className:"text-slate-600",children:["full name: ",I.payload.normalized.fullName||"—"]}),(0,l.jsxs)("div",{className:"text-slate-500",children:["text: ",I.payload.normalized.text||"—"]})]})]}),(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"Спроби пошуку"}),(0,l.jsx)("div",{className:"space-y-2",children:I.payload.search.attempts.map(e=>(0,l.jsx)(d,{attempt:e},"".concat(e.kind,":").concat(e.value)))})]}),I.payload.search.selected&&(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"Результат пошуку"}),(0,l.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[(0,l.jsxs)("div",{className:"font-medium text-slate-800",children:["Картка #",null===(e=I.payload.search.selected.match)||void 0===e?void 0:e.cardId]}),(0,l.jsx)("div",{className:"text-slate-600",children:(null===(t=I.payload.search.selected.match)||void 0===t?void 0:t.title)||"Без назви"}),(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:["Збіг: ",null===(s=I.payload.search.selected.match)||void 0===s?void 0:s.matchedField," →"," ",null===(r=I.payload.search.selected.match)||void 0===r?void 0:r.matchedValue]})]})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"Переміщення"}),(0,l.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[I.payload.move.attempted?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"font-medium text-slate-800",children:"Виконано через API"}),(0,l.jsxs)("div",{className:"text-slate-500",children:["HTTP статус: ",null!==(j=I.payload.move.status)&&void 0!==j?j:"—"]}),I.payload.move.requestMethod&&I.payload.move.requestUrl&&(0,l.jsxs)("div",{className:"text-xs text-slate-500",children:["Запит: ",I.payload.move.requestMethod," ",I.payload.move.requestUrl]}),I.payload.move.error&&(0,l.jsxs)("div",{className:"text-xs text-rose-600",children:["Код помилки: ",I.payload.move.error]})]}):(0,l.jsxs)("div",{className:"text-slate-500",children:["Пропущено: ",I.payload.move.skippedReason||"невідомо"]}),I.payload.move.sent&&(0,l.jsxs)("div",{className:"mt-2 space-y-1",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"Тіло запиту"}),(0,l.jsx)(o,{value:I.payload.move.sent})]}),I.payload.move.response&&(0,l.jsxs)("div",{className:"mt-2 space-y-1",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"Сира відповідь"}),(0,l.jsx)(o,{value:I.payload.move.response})]}),Array.isArray(I.payload.move.attempts)&&I.payload.move.attempts.length>0&&(0,l.jsxs)("div",{className:"mt-2 space-y-1",children:[(0,l.jsx)("div",{className:"text-xs uppercase text-slate-400",children:"Спроби перевірки"}),(0,l.jsx)(o,{value:I.payload.move.attempts})]})]})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"Сира відповідь автоматизації"}),(0,l.jsx)(o,{value:I.payload})]})]})]})}},4892:function(e,t,s){"use strict";s.d(t,{ManychatMessageInbox:function(){return S}});var l=s(7437),a=s(2265);let r=(e,t)=>{var s,l,a;if(!e)return null;let r={},n=(()=>{if("number"==typeof t&&Number.isFinite(t))return String(t);if("string"==typeof t){let e=t.trim();return e.length?e:null}return null})();n&&(r.card_id=n);let i=null!==(s=e.pipelineId)&&void 0!==s?s:null;i&&(r.pipeline_id=i,r.to_pipeline_id=i);let d=null!==(a=null!==(l=e.pipelineStatusId)&&void 0!==l?l:e.statusId)&&void 0!==a?a:null;return d&&(r.pipeline_status_id=d,r.status_id=d,r.to_status_id=d),Array.isArray(e.statusAliases)&&e.statusAliases.length&&(r.status_aliases=e.statusAliases),Object.keys(r).length?r:null},n=e=>{if("number"==typeof e&&Number.isFinite(e))return String(e);if("string"==typeof e){let t=e.trim();if(t.length)return t}return null},i=e=>{var t,s,l,a,r,i,o,c,u;let{details:m,target:x,cardId:p,defaultMethod:h="POST"}=e,v=d(m)?m:null,g=null!==(s=null!==(t=w(null==v?void 0:v.requestUrl))&&void 0!==t?t:w(null==v?void 0:v.url))&&void 0!==s?s:null,b=null!==(a=null!==(l=w(null==v?void 0:v.requestMethod))&&void 0!==l?l:w(null==v?void 0:v.method))&&void 0!==a?a:h,j=null!==(i=null!==(r=w(null==v?void 0:v.baseUrl))&&void 0!==r?r:w(null==v?void 0:v.base))&&void 0!==i?i:null,y=null!==(o=null==x?void 0:x.pipelineId)&&void 0!==o?o:null,f=null!==(u=null!==(c=null==x?void 0:x.pipelineStatusId)&&void 0!==c?c:null==x?void 0:x.statusId)&&void 0!==u?u:null,N=n(p);if(g)return{requestUrl:g,requestMethod:b,baseUrl:j,exact:!0};let k=j?j.replace(/\/+$/,""):null,_=null!=k?k:"https://openapi.keycrm.app/api/v1",I="".concat(_).concat(N?"/pipelines/cards/".concat(N):"/pipelines/cards/{id}");return N?f&&y&&(I="".concat(_,"/pipelines/cards/").concat(N)):I="".concat(_,"/pipelines/cards/move"),{requestUrl:I,requestMethod:b,baseUrl:j,exact:!1}},d=e=>"object"==typeof e&&null!==e&&!Array.isArray(e),o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:240;if(null==e)return"—";if("string"==typeof e){let s=e.trim();return s?s.length>t?"".concat(s.slice(0,t),"…"):s:"—"}try{let s=JSON.stringify(e);if(!s)return"—";return s.length>t?"".concat(s.slice(0,t),"…"):s}catch(l){let s=String(e);return s.length>t?"".concat(s.slice(0,t),"…"):s}},c=e=>{switch(e){case"already_in_target":return"Картка вже у цільовій воронці та статусі";case"move_handler_missing":return"На сервері недоступна функція переміщення";case"campaign_target_status_missing":return"Кампанія не містить цільового статусу для переміщення";case"card_not_in_base":return"Картка знаходиться поза базовою парою кампанії";default:return e}},u=e=>!!(e&&e.ok),m=(e,t,s)=>{if(null==s)return null;let a=null;if("string"==typeof s)a=s.trim();else try{a=JSON.stringify(s,null,2)}catch(e){a=String(e instanceof Error?e.message:s)}return a?(0,l.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[(0,l.jsx)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:t}),(0,l.jsx)("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:a})]},e):null},x=(e,t,s)=>{if(!s)return null;let a=s.trim();return a.length?(0,l.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[(0,l.jsx)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:t}),(0,l.jsx)("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:a})]},e):null},p=e=>{if(!d(e))return[];let t=e.history;if(!Array.isArray(t))return[];let s=[];for(let e of t){if(!d(e))continue;let t=Array.isArray(e.verification)?e.verification:void 0;s.push({attempt:"string"==typeof e.attempt?e.attempt:void 0,status:"number"==typeof e.status?e.status:void 0,ok:"boolean"==typeof e.ok?e.ok:void 0,sent:d(e.sent)?e.sent:null,verification:t,body:e.body,error:"string"==typeof e.error?e.error:void 0})}return s},h=e=>e&&0!==e.length?e.slice(0,4).map((e,t)=>{var s,l,a,r;let n=null!==(a=null===(s=e.snapshot)||void 0===s?void 0:s.pipelineId)&&void 0!==a?a:"—",i=null!==(r=null===(l=e.snapshot)||void 0===l?void 0:l.statusId)&&void 0!==r?r:"—",d=e.pipelineMatches?"✅":"⚠️",o=e.statusMatches?"✅":"⚠️";return"#".concat(t+1,": воронка ").concat(n," ").concat(d," \xb7 статус ").concat(i," ").concat(o)}):[],v=e=>{if(null==e)return null;if("string"==typeof e){let t=e.trim();return t.length?t:null}return"number"==typeof e&&Number.isFinite(e)?String(e):null},g=e=>{let t=new Set,s=[];for(let l of e){let e=v(l);!e||t.has(e)||(t.add(e),s.push(e))}return s},b=e=>{let t=g(e);return t.length?t.join(", "):"—"},j=e=>{var t,s,l,a,r,n;if(!e)return"—";let i=null!==(s=null!==(t=e.pipelineName)&&void 0!==t?t:e.pipelineId)&&void 0!==s?s:"—",d=null!==(r=null!==(a=null!==(l=e.statusName)&&void 0!==l?l:e.statusId)&&void 0!==a?a:e.pipelineStatusId)&&void 0!==r?r:"—",o=b([e.statusId,e.pipelineStatusId,...null!==(n=e.statusAliases)&&void 0!==n?n:[]]);return"—"===o?"".concat(i," → ").concat(d):"".concat(i," → ").concat(d," (ID: ").concat(o,")")},y=e=>{var t,s;if(!(null==e?void 0:e.snapshot))return"—";let l=null!==(t=e.snapshot.pipelineId)&&void 0!==t?t:"—",a=null!==(s=e.snapshot.statusId)&&void 0!==s?s:"—";return"".concat(l," → ").concat(a)},f={invalid_json:{stage:"message",step:1,title:"Отримання повідомлення",module:"web/app/api/mc/manychat/route.ts → normalizeManyChat",hint:"ManyChat надіслав невалідний JSON або тіло вебхука порожнє."},identity_missing:{stage:"message",step:1,title:"Пошук ідентифікаторів",module:"web/lib/manychat-routing.ts → resolveIdentityCandidates",hint:"У повідомленні нема username/full name для пошуку картки."},campaign_not_found:{stage:"campaign",step:2,title:"Визначення кампанії",module:"web/lib/manychat-routing.ts → matchCampaignByRules",hint:"Перевірте правила V1/V2 та значення в KV."},campaign_base_missing:{stage:"campaign",step:2,title:"Перевірка базової пари",module:"web/lib/manychat-routing.ts → normaliseCampaignBase",hint:"У кампанії не вказано базову воронку чи статус."},campaign_target_missing:{stage:"campaign",step:2,title:"Перевірка цільової пари",module:"web/lib/manychat-routing.ts → normaliseCampaignTarget",hint:"У кампанії відсутні цільові воронка/статус."},campaign_target_status_missing:{stage:"campaign",step:2,title:"Статус цільової пари",module:"web/lib/manychat-routing.ts → resolveTargetStatus",hint:"Кеш воронок KeyCRM не повернув pipeline_status_id для обраного статусу."},keycrm_search_failed:{stage:"search",step:3,title:"Пошук картки у KeyCRM",module:"web/lib/keycrm-card-search.ts",hint:"KeyCRM повернув помилку під час пошуку картки."},card_not_found:{stage:"search",step:3,title:"Пошук картки у KeyCRM",module:"web/lib/manychat-routing.ts → pickCardMatch",hint:"Немає картки у базовій воронці, що відповідає критеріям."},card_match_missing:{stage:"search",step:3,title:"Валідація збігу картки",module:"web/lib/manychat-routing.ts → ensureCardMatch"},card_not_in_base:{stage:"search",step:3,title:"Перевірка базової пари",module:"web/lib/manychat-routing.ts → ensureCardInBase",hint:"Картку знайдено, але вона вже не у стартовому статусі кампанії."},keycrm_move_failed:{stage:"move",step:4,title:"Переміщення картки",module:"web/lib/keycrm-move.ts",hint:"KeyCRM повернув помилку або не підтвердив зміну статусу."},keycrm_not_configured:{stage:"move",step:4,title:"Переміщення картки",module:"web/app/api/mc/manychat/route.ts → performMove",hint:"Не налаштовані KEYCRM_API_URL чи KEYCRM_API_TOKEN."},automation_exception:{stage:"move",step:4,title:"Виконання автоматизації",module:"web/app/api/mc/manychat/route.ts"}},N={message:"message",campaign:"campaign",search:"card",move:"move"},k=e=>{var t;return null!==(t=f[e])&&void 0!==t?t:{stage:"move",step:4,title:"Переміщення картки",module:"web/lib/manychat-routing.ts"}},w=e=>{if("string"==typeof e){let t=e.trim();return t.length?t:null}return"number"==typeof e&&Number.isFinite(e)?String(e):null},_=e=>{var t,s,l,a,r,n,i,d,o,c;return e&&"object"==typeof e?{pipelineId:null!==(s=null!==(t=w(e.pipelineId))&&void 0!==t?t:w(e.pipeline_id))&&void 0!==s?s:w(e.pipeline),statusId:null!==(a=null!==(l=w(e.statusId))&&void 0!==l?l:w(e.status_id))&&void 0!==a?a:w(e.status),pipelineStatusId:null!==(n=null!==(r=w(e.pipelineStatusId))&&void 0!==r?r:w(e.pipeline_status_id))&&void 0!==n?n:w(null==e?void 0:e.pipeline_status),pipelineName:null!==(d=null!==(i=w(e.pipelineName))&&void 0!==i?i:w(e.pipeline_name))&&void 0!==d?d:w(e.pipelineTitle),statusName:null!==(c=null!==(o=w(e.statusName))&&void 0!==o?o:w(e.status_name))&&void 0!==c?c:w(e.statusTitle),statusAliases:Array.isArray(null==e?void 0:e.statusAliases)?e.statusAliases.map(e=>w(e)).filter(e=>!!e):null}:{pipelineId:null,statusId:null,pipelineStatusId:null,pipelineName:null,statusName:null,statusAliases:null}},I={success:{dot:"bg-emerald-500",border:"border-emerald-200",title:"text-emerald-700",text:"text-emerald-700"},warning:{dot:"bg-amber-500",border:"border-amber-200",title:"text-amber-700",text:"text-amber-700"},error:{dot:"bg-rose-500",border:"border-rose-200",title:"text-rose-700",text:"text-rose-700"},info:{dot:"bg-slate-400",border:"border-slate-200",title:"text-slate-700",text:"text-slate-600"}};function C(e){let{steps:t}=e;return t.length?(0,l.jsx)("ol",{className:"space-y-3",children:t.map((e,t)=>{let s=I[e.status];return(0,l.jsxs)("li",{className:"relative ml-0 list-none pl-10",children:[(0,l.jsx)("span",{className:"absolute left-0 top-2 flex h-7 w-7 items-center justify-center rounded-full text-xs font-semibold text-white shadow-sm ".concat(s.dot),children:t+1}),(0,l.jsxs)("div",{className:"rounded-xl border bg-white px-4 py-3 shadow-sm ".concat(s.border),children:[(0,l.jsx)("div",{className:"text-sm font-semibold ".concat(s.title),children:e.title}),(0,l.jsx)("div",{className:"mt-1 space-y-1 text-sm ".concat(s.text),children:e.details.map((t,s)=>(0,l.jsx)("div",{children:t},"".concat(e.key,"-").concat(s)))})]})]},e.key)})}):null}function S(){var e,t,s,n,g,b,f,I,S,M,R,A,K,q,T,E,U,P,O,F,J,V,D,H,L,B,Y,z,G,X,W,$,Q,Z,ee,et,es,el,ea,er,en,ei,ed,eo,ec,eu,em,ex,ep,eh,ev,eg,eb,ej,ey,ef,eN,ek,ew,e_,eI,eC,eS,eM,eR,eA,eK,eq,eT,eE,eU,eP,eO,eF,eJ,eV,eD,eH,eL,eB,eY,ez,eG,eX,eW,e$,eQ,eZ,e0,e2,e7,e1,e6,e3,e5,e8,e4,e9,te,tt,ts,tl,ta,tr,tn,ti,td,to,tc,tu,tm,tx,tp,th,tv,tg,tb,tj,ty,tf,tN,tk,tw,t_,tI,tC,tS,tM,tR,tA,tK,tq,tT,tE,tU,tP,tO,tF,tJ,tV,tD,tH,tL,tB,tY,tz,tG,tX,tW,t$,tQ,tZ,t0,t2,t7,t1,t6,t3,t5,t8,t4,t9,se,st,ss,sl,sa,sr,sn,si,sd,so,sc,su,sm,sx,sp,sh,sv,sg,sb,sj,sy,sf,sN,sk,sw,s_,sI,sC,sS,sM,sR,sA,sK,sq,sT,sE,sU,sP,sO,sF,sJ,sV,sD,sH,sL,sB,sY,sz,sG,sX,sW,s$,sQ,sZ,s0;let[s2,s7]=(0,a.useState)({status:"loading",trace:null,diagnostics:null,automation:null,automationAnalysis:null}),s1=(0,a.useRef)(null),[s6,s3]=(0,a.useState)(!1);async function s5(){try{var e,t,s,l,a,r,n,i,d,o,c,u,m,x,p,h;s3(!0);let v=await fetch("/api/mc/manychat",{cache:"no-store"}),g=await v.json().catch(()=>null),b=null!==(e=null==g?void 0:g.automationAnalysis)&&void 0!==e?e:null;if(!g||!v.ok){s7({status:"error",message:"Помилка завантаження (".concat(v.status,")"),trace:null!==(t=null==g?void 0:g.trace)&&void 0!==t?t:null,diagnostics:null!==(s=null==g?void 0:g.diagnostics)&&void 0!==s?s:null,automation:null!==(l=null==g?void 0:g.automation)&&void 0!==l?l:null,automationAnalysis:b});return}let j=Array.isArray(g.feed)?g.feed:Array.isArray(g.messages)?g.messages:null,y=j&&j.length>0?j:g.latest?[g.latest]:[],f=(!y||0===y.length)&&g.trace?[{id:null!==(a=g.trace.receivedAt)&&void 0!==a?a:Date.now(),receivedAt:null!==(r=g.trace.receivedAt)&&void 0!==r?r:Date.now(),source:"trace:webhook",title:"ManyChat Webhook",handle:null!==(n=g.trace.handle)&&void 0!==n?n:null,fullName:null!==(i=g.trace.fullName)&&void 0!==i?i:null,text:null!==(d=g.trace.messagePreview)&&void 0!==d?d:"",raw:null}]:[],N=y&&y.length>0?y:f,k=N&&N.length>0?N[0]:g.latest?g.latest:f.length>0?f[0]:null,w=g.requestSnapshot?{rawText:null!==(o=g.requestSnapshot.rawText)&&void 0!==o?o:null,receivedAt:"number"==typeof g.requestSnapshot.receivedAt?g.requestSnapshot.receivedAt:g.requestSnapshot.receivedAt?Number(g.requestSnapshot.receivedAt):null,source:null!==(c=g.requestSnapshot.source)&&void 0!==c?c:null}:null;s7({status:"ready",messages:N,lastMessage:k,updatedAt:new Date,source:null!==(u=g.source)&&void 0!==u?u:null,trace:null!==(m=g.trace)&&void 0!==m?m:null,diagnostics:null!==(x=g.diagnostics)&&void 0!==x?x:null,rawSnapshot:null!==(p=g.rawSnapshot)&&void 0!==p?p:null,requestSnapshot:w,automation:null!==(h=g.automation)&&void 0!==h?h:null,automationAnalysis:b})}catch(e){s7({status:"error",message:e instanceof Error?e.message:String(e),trace:null,diagnostics:null,automation:null,automationAnalysis:null})}finally{s3(!1)}}(0,a.useEffect)(()=>{let e=!1;async function t(t){try{var s,l,a,r,n,i,d,o,c,u,m,x;let e=await fetch("/api/mc/manychat",{cache:"no-store",signal:t}),p=await e.json().catch(()=>null),h=null!==(s=null==p?void 0:p.automationAnalysis)&&void 0!==s?s:null;if(!p||!e.ok){s7({status:"error",message:"Помилка завантаження (".concat(e.status,")"),trace:null!==(l=null==p?void 0:p.trace)&&void 0!==l?l:null,diagnostics:null!==(a=null==p?void 0:p.diagnostics)&&void 0!==a?a:null,automation:null!==(r=null==p?void 0:p.automation)&&void 0!==r?r:null,automationAnalysis:h});return}let v=Array.isArray(p.feed)?p.feed:Array.isArray(p.messages)?p.messages:[],g=v&&v.length>0?v[0]:null!==(n=p.latest)&&void 0!==n?n:null,b=p.requestSnapshot?{rawText:null!==(i=p.requestSnapshot.rawText)&&void 0!==i?i:null,receivedAt:"number"==typeof p.requestSnapshot.receivedAt?p.requestSnapshot.receivedAt:p.requestSnapshot.receivedAt?Number(p.requestSnapshot.receivedAt):null,source:null!==(d=p.requestSnapshot.source)&&void 0!==d?d:null}:null;s7({status:"ready",messages:v,lastMessage:g,updatedAt:new Date,source:null!==(o=p.source)&&void 0!==o?o:null,trace:null!==(c=p.trace)&&void 0!==c?c:null,diagnostics:null!==(u=p.diagnostics)&&void 0!==u?u:null,rawSnapshot:null!==(m=p.rawSnapshot)&&void 0!==m?m:null,requestSnapshot:b,automation:null!==(x=p.automation)&&void 0!==x?x:null,automationAnalysis:h})}catch(t){if(e||(null==t?void 0:t.name)==="AbortError")return;s7({status:"error",message:t instanceof Error?t.message:String(t),trace:null,diagnostics:null,automation:null,automationAnalysis:null})}}let s=new AbortController;return t(s.signal),s1.current=setInterval(()=>{t()},5e3),()=>{e=!0,s.abort(),s1.current&&(clearInterval(s1.current),s1.current=null)}},[]);let s8=null!==(f=s2.trace)&&void 0!==f?f:null,s4=null!==(I=s2.diagnostics)&&void 0!==I?I:null,s9=null!==(S=null==s4?void 0:s4.api)&&void 0!==S?S:null,le=null!==(M=null==s4?void 0:s4.kvConfig)&&void 0!==M?M:null,lt=null!==(R=null==s4?void 0:s4.kv)&&void 0!==R?R:null,ls=null!==(A=null==s4?void 0:s4.kvTrace)&&void 0!==A?A:null,ll=null!==(K=null==s4?void 0:s4.kvRaw)&&void 0!==K?K:null,la=null!==(q=null==s4?void 0:s4.kvRequest)&&void 0!==q?q:null,lr=null!==(T=null==s4?void 0:s4.kvFeed)&&void 0!==T?T:null,ln=null!==(E=null==s4?void 0:s4.traceFallback)&&void 0!==E?E:null,li="ready"===s2.status?s2.automation:null!==(U=s2.automation)&&void 0!==U?U:null,ld="ready"===s2.status?null!==(P=s2.automationAnalysis)&&void 0!==P?P:null:null!==(O=s2.automationAnalysis)&&void 0!==O?O:null,lo=null!==(F=null!=li?li:ld)&&void 0!==F?F:null,lc="ready"===s2.status?s2.lastMessage:null,lu="ready"===s2.status&&null!==(J=s2.rawSnapshot)&&void 0!==J?J:null,lm="ready"===s2.status&&null!==(V=s2.requestSnapshot)&&void 0!==V?V:null,lx=null!==(L=null!==(H=null!==(D=null==lm?void 0:lm.rawText)&&void 0!==D?D:null==lu?void 0:lu.rawText)&&void 0!==H?H:null==lu?void 0:lu.text)&&void 0!==L?L:null,lp=(null==lc?void 0:null===(t=lc.text)||void 0===t?void 0:null===(e=t.trim())||void 0===e?void 0:e.length)?lc.text:(null==lx?void 0:null===(s=lx.trim())||void 0===s?void 0:s.length)?lx:null,lh=[],lv=li&&!1===li.ok?li:ld&&!1===ld.ok?ld:null,lg=lv?k(lv.error):null,lb=lv&&"object"==typeof lv&&null!==(B=lv.details)&&void 0!==B?B:null,lj=s8?"accepted"===s8.status?"success":"warning":lc?"success":"info";if(lc||s8||lp){let e=[];(null==lc?void 0:lc.fullName)||(null==lc?void 0:lc.handle)?e.push((0,l.jsxs)("span",{children:["Контакт: ",(null==lc?void 0:lc.fullName)||"—",(null==lc?void 0:lc.handle)?(0,l.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",lc.handle,")"]}):null]},"contact")):((null==s8?void 0:s8.fullName)||(null==s8?void 0:s8.handle))&&e.push((0,l.jsxs)("span",{children:["Контакт: ",(null==s8?void 0:s8.fullName)||"—",(null==s8?void 0:s8.handle)?(0,l.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",s8.handle,")"]}):null]},"contact-trace")),e.push((0,l.jsxs)("span",{children:["Текст: ",null!=lp?lp:"(порожній текст повідомлення)"]},"text")),e.push((0,l.jsxs)("span",{children:["Час: ",new Date(null!==(Y=null==s8?void 0:s8.receivedAt)&&void 0!==Y?Y:"number"==typeof(null==lc?void 0:lc.receivedAt)?lc.receivedAt:"string"==typeof(null==lc?void 0:lc.receivedAt)?Number.parseInt(lc.receivedAt,10):Date.now()).toLocaleString()]},"time")),lh.push({key:"message",title:"1. Отримане повідомлення з ManyChat",status:lj,details:e})}else lh.push({key:"message",title:"1. Очікуємо ManyChat повідомлення",status:"info",details:[(0,l.jsx)("span",{children:"Надішліть ключове слово в Instagram, щоб ManyChat надіслав вебхук у це середовище."},"pending")]});if(li||ld){let e=li&&!1===li.ok?li:null,t=ld&&!1===ld.ok?ld:null,s=li&&li.ok?{result:li,origin:"automation"}:ld&&ld.ok?{result:ld,origin:"analysis"}:null;if(s){let t=s.result,a="automation"===s.origin,n=t.match.campaign,d=n.base,u=n.target,v=[(0,l.jsxs)("span",{children:["Кампанія: ",null!==(ti=n.name)&&void 0!==ti?ti:"(без назви)"]},"name"),(0,l.jsxs)("span",{children:["Маршрут: ",t.match.route.toUpperCase()," \xb7 Правило: ","equals"===t.match.rule.op?"точний збіг":"містить"]},"route"),(0,l.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",null!==(to=null!==(td=d.pipelineName)&&void 0!==td?td:d.pipelineId)&&void 0!==to?to:"—"," → статус ",null!==(tu=null!==(tc=d.statusName)&&void 0!==tc?tc:d.statusId)&&void 0!==tu?tu:"—"," \xb7 Ціль: ",null!==(tx=null!==(tm=u.pipelineName)&&void 0!==tm?tm:u.pipelineId)&&void 0!==tx?tx:"—"," → ",null!==(th=null!==(tp=u.statusName)&&void 0!==tp?tp:u.statusId)&&void 0!==th?th:"—"]},"targets")];!a&&e&&v.push((0,l.jsxs)("span",{className:"text-xs text-amber-600/80",children:["Автоматизація завершилась з помилкою: ",e.error,". Показано аналітичний підбір кампанії."]},"analysis-note")),lh.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:v});let g=null!==(tv=t.search.selected)&&void 0!==tv?tv:null,b=null!==(tg=null==g?void 0:g.match)&&void 0!==tg?tg:null,f=null!==(tb=null==g?void 0:g.summary)&&void 0!==tb?tb:null,N=b?"success":"warning",k=e=>{if("string"==typeof e){let t=e.trim();return t.length?t:null}return"number"==typeof e&&Number.isFinite(e)?String(e):null},w=[];if(b?(w.push((0,l.jsxs)("span",{children:["Картка #",b.cardId,b.title?" • ".concat(b.title):""]},"card")),w.push((0,l.jsxs)("span",{className:"text-xs text-slate-600",children:["Збіг за: ",b.matchedField,b.matchedValue?" → ".concat(b.matchedValue):""]},"field"))):w.push((0,l.jsx)("span",{children:"Картку не знайдено. Перевірте кампанію або ключові слова."},"missing")),t.search.usedNeedle&&w.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Використаний ідентифікатор: ",t.search.usedNeedle]},"needle")),f){let e=null!==(ty=null!==(tj=f.pipelineName)&&void 0!==tj?tj:f.pipelineId)&&void 0!==ty?ty:"—",t=null!==(tk=null!==(tN=null!==(tf=f.statusName)&&void 0!==tf?tf:f.statusId)&&void 0!==tN?tN:f.pipelineStatusId)&&void 0!==tk?tk:"—";w.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Поточна позиція: ",e," → ",t]},"summary"));let s=[k(d.pipelineStatusId),k(d.statusId),...Array.isArray(d.statusAliases)?d.statusAliases.map(e=>k(e)):[]].filter(e=>!!e),a=!k(d.pipelineId)||k(d.pipelineId)===k(f.pipelineId),r=0===s.length||s.some(e=>e===k(f.pipelineStatusId)||e===k(f.statusId));if(!a||!r){N="error";let s=null!==(t_=null!==(tw=d.pipelineName)&&void 0!==tw?tw:d.pipelineId)&&void 0!==t_?t_:"—",a=null!==(tS=null!==(tC=null!==(tI=d.statusName)&&void 0!==tI?tI:d.statusId)&&void 0!==tC?tC:d.pipelineStatusId)&&void 0!==tS?tS:"—";w.push((0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Картка не знаходиться у базовій парі. Очікували ",s," → ",a,", а отримали ",e," → ",t,"."]},"base-mismatch"))}}!a&&e&&w.push((0,l.jsxs)("span",{className:"text-xs text-amber-600/80",children:["Автоматичне переміщення зупинилось з помилкою: ",e.error,"."]},"automation-error")),lh.push({key:"card",title:"3. Пошук картки у KeyCRM",status:N,details:w});let _=li&&li.ok?li:ld&&ld.ok?ld:null,I=_&&li&&li.ok&&_===li?"automation":_?"analysis":null,C=null!==(tM=null==_?void 0:_.move)&&void 0!==tM?tM:null;if(C){if(_&&_.ok){let e=[],t=C.ok?"success":"warning";if(C.attempted){let s=null!==(t5=null===(t$=_.match)||void 0===t$?void 0:null===(tW=t$.campaign)||void 0===tW?void 0:tW.target)&&void 0!==t5?t5:null,a=null!==(t8=null===(tZ=_.match)||void 0===tZ?void 0:null===(tQ=tZ.campaign)||void 0===tQ?void 0:tQ.base)&&void 0!==t8?t8:null,n=null!==(t9=null!==(t4=null===(t7=_.search)||void 0===t7?void 0:null===(t2=t7.selected)||void 0===t2?void 0:null===(t0=t2.match)||void 0===t0?void 0:t0.cardId)&&void 0!==t4?t4:null===(t6=_.search)||void 0===t6?void 0:null===(t1=t6.selected)||void 0===t1?void 0:t1.cardId)&&void 0!==t9?t9:null;e.push((0,l.jsxs)("span",{children:["Переміщення: ",C.ok?"✅ успішно":"⚠️ не підтверджено"]},"attempt")),a&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова пара (очікували, що картка тут): ",j(a)]},"base")),s&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Цільова пара (переміщуємо сюди): ",j(s)]},"target"));let i=(Array.isArray(null===(t3=C.response)||void 0===t3?void 0:t3.history)?C.response.history:[]).find(e=>null==e?void 0:e.url),d=null==i?void 0:i.url,c=null==i?void 0:i.method,u=null!==(st=null!==(se=C.requestUrl)&&void 0!==se?se:d)&&void 0!==st?st:null,v=null!==(sl=null!==(ss=C.requestMethod)&&void 0!==ss?ss:c)&&void 0!==sl?sl:null,g=null!==(sa=C.sent)&&void 0!==sa?sa:r(s,n),b=m("payload",C.sent?"JSON запиту до KeyCRM":"Очікуваний JSON запиту",g);b?e.push(b):e.push((0,l.jsx)("span",{className:"text-xs text-amber-600/80",children:"Параметри запиту не зафіксовані — перевірте серверні логи."},"payload-missing")),C.baseUrl&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова адреса KeyCRM:"," ",(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:C.baseUrl})]},"base-url")),(u||v)&&e.push((0,l.jsxs)("div",{className:"text-xs text-slate-600/80",children:["URL запиту:"," ",u?(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:u}):"н/д",v?(0,l.jsxs)("span",{className:"ml-1 text-slate-500",children:["(метод ",v,")"]}):null]},"request-url"));let f=null!==(sr=C.attempts)&&void 0!==sr?sr:[];if(f.length){let t=f[f.length-1];e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/70",children:["Перевірка KeyCRM: воронка ",t.pipelineMatches?"✅":"⚠️"," \xb7 статус ",t.statusMatches?"✅":"⚠️"]},"verify")),e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/70",children:["Поточний стан картки за останньою перевіркою: ",y(t)]},"snapshot")),e.push((0,l.jsxs)("div",{className:"mt-1 space-y-1 rounded-lg border border-slate-200/70 bg-white/70 p-2 text-[0.7rem] text-slate-700",children:[(0,l.jsx)("div",{className:"font-semibold text-slate-800",children:"Перевірки API KeyCRM:"}),f.map((e,t)=>(0,l.jsxs)("div",{className:"leading-tight",children:["#",t+1,": ",y(e)," \xb7 воронка ",e.pipelineMatches?"✅":"⚠️"," \xb7 статус ",e.statusMatches?"✅":"⚠️"]},"attempt-".concat(t)))]},"attempt-list"))}else e.push((0,l.jsx)("span",{className:"text-xs text-amber-600/80",children:"KeyCRM не повернув жодної перевірки стану — запит міг завершитись помилкою до застосування змін."},"no-attempts"));C.status&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/70",children:["Код відповіді KeyCRM: ",C.status]},"status")),!C.ok&&C.error&&e.push((0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Помилка: ",C.error]},"error"));let N=m("details","Деталі помилки",C.details);N&&e.push(N);let k=p(C.response);k.length&&e.push((0,l.jsxs)("div",{className:"mt-2 space-y-2 rounded-lg border border-emerald-100 bg-emerald-50/60 p-2 text-left text-[0.72rem] text-slate-700",children:[(0,l.jsx)("div",{className:"font-semibold text-emerald-800",children:"Деталі спроб:"}),k.map((e,t)=>{var s,a,r;let n=h(e.verification),i=e.sent?o(e.sent):null,d=null!=e.body?o(e.body):null;return(0,l.jsxs)("div",{className:"rounded border border-emerald-200/80 bg-white/80 p-2",children:[(0,l.jsxs)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-emerald-700",children:["Спроба #",t+1,": ",null!==(s=e.attempt)&&void 0!==s?s:"(невідомий ендпоінт)"]}),(0,l.jsxs)("div",{className:"mt-1",children:["HTTP ",null!==(a=e.status)&&void 0!==a?a:"—"," \xb7 ",e.ok?"✅ підтверджено":"⚠️ не підтверджено"]}),e.error?(0,l.jsxs)("div",{className:"mt-1 text-rose-600/80",children:["Помилка запиту: ",e.error]}):null,i?(0,l.jsxs)("div",{className:"mt-1 text-slate-600",children:["Надіслано: ",(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:i})]}):null,d?(0,l.jsxs)("div",{className:"mt-1 text-slate-600",children:["Відповідь: ",(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:d})]}):null,n.length?(0,l.jsxs)("div",{className:"mt-1 space-y-1 text-slate-600",children:[(0,l.jsx)("div",{className:"font-medium text-emerald-800",children:"Перевірки:"}),n.map((e,s)=>(0,l.jsx)("div",{className:"text-[0.7rem]",children:e},"verify-".concat(t,"-").concat(s))),e.verification&&e.verification.length>n.length?(0,l.jsxs)("div",{className:"text-[0.7rem] text-slate-500",children:["…іще ",e.verification.length-n.length," перевірок"]}):null]}):null]},"".concat(null!==(r=e.attempt)&&void 0!==r?r:"attempt","-").concat(t))})]},"history")),"analysis"===I&&e.push((0,l.jsx)("span",{className:"text-xs text-amber-600/80",children:"Показано результати аналізу — фактична автоматизація ще не запускалась."},"analysis-note")),lh.push({key:"move",title:"4. Переміщення картки",status:t,details:e});let w=[],S=C.ok?"success":C.response?"warning":"info",M=m("response","Сира відповідь KeyCRM",C.response);M?w.push(M):C.attempted?w.push((0,l.jsx)("span",{className:"text-xs text-amber-600/80",children:"KeyCRM не повернув тіло відповіді — перевірте логи API."},"no-response")):w.push((0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Запит до KeyCRM не виконувався, тому відповіді немає."},"response-skipped")),lh.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:S,details:w});let R=[];if(C.baseUrl&&R.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова адреса: ",(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:C.baseUrl})]},"req-base")),(u||v)&&R.push((0,l.jsxs)("div",{className:"text-xs text-slate-600/80",children:["HTTP ",null!=v?v:"—"," ",(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:null!=u?u:"(URL не зафіксовано)"})]},"req-url")),C.requestHeaders&&Object.keys(C.requestHeaders).length){let e=m("request-headers-step6","HTTP заголовки",C.requestHeaders);e&&R.push(e)}let A=x("request-body-raw-step6","Тіло запиту (raw)",C.requestBodyRaw);if(A)R.push(A);else if(C.sent){let e=m("request-body-json-step6","JSON запиту",C.sent);e&&R.push(e)}let K=x("request-response-raw-step6","Відповідь KeyCRM (raw)",C.responseRaw);if(K)R.push(K);else if(C.response&&!C.ok){let e=m("request-response-json-step6","JSON відповіді KeyCRM",C.response);e&&R.push(e)}R.length||R.push((0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Параметри запиту не зафіксовані — перевірте серверні логи."},"request-empty")),lh.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:C.attempted?C.ok?"success":C.status&&C.status>=400?"error":"warning":"info",details:R})}else"already_in_target"===C.skippedReason?(t="success",e.push((0,l.jsx)("span",{children:"Картка вже була у цільовій воронці/статусі."},"already")),lh.push({key:"move",title:"4. Переміщення картки",status:t,details:e}),lh.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"info",details:[(0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Відповідь KeyCRM не очікувалась, оскільки картка вже у цільовій парі."},"already-response")]}),lh.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"info",details:[(0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Запит не надсилався, бо картка вже знаходилась у цільовій парі."},"already-request")]})):(e.push((0,l.jsx)("span",{children:"Переміщення пропущено."},"skipped")),C.skippedReason&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Причина: ",c(C.skippedReason)]},"skipped-reason")),lh.push({key:"move",title:"4. Переміщення картки",status:t,details:e}),lh.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"warning",details:[(0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Відповідь KeyCRM відсутня, оскільки переміщення не запускалось."},"skipped-response")]}),lh.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"warning",details:[(0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Запит не надсилався через пропущене переміщення."},"skipped-request")]}))}else{let e=[],t="warning",s="object"==typeof li&&li&&"error"in li?li.error:void 0;"keycrm_move_failed"===s?(t="error",e.push((0,l.jsx)("span",{children:"Переміщення картки у KeyCRM не підтверджено."},"fail"))):s?(t="error",e.push((0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Автоматизація завершилась з помилкою: ",s]},"automation-error"))):e.push((0,l.jsx)("span",{children:"Переміщення не виконувалось через попередню помилку."},"skip"));let a="object"==typeof li&&li&&"details"in li?li.details:void 0,n=m("automation-details","Деталі помилки",a);n&&e.push(n);let d=(null==ld?void 0:ld.ok)?null!==(sy=null===(si=ld.match)||void 0===si?void 0:null===(sn=si.campaign)||void 0===sn?void 0:sn.target)&&void 0!==sy?sy:null:li&&li.ok&&null!==(sf=null===(so=li.match)||void 0===so?void 0:null===(sd=so.campaign)||void 0===sd?void 0:sd.target)&&void 0!==sf?sf:null,o=(null==ld?void 0:ld.ok)?null!==(sk=null!==(sN=null===(sm=ld.search)||void 0===sm?void 0:null===(su=sm.selected)||void 0===su?void 0:null===(sc=su.match)||void 0===sc?void 0:sc.cardId)&&void 0!==sN?sN:null===(sp=ld.search)||void 0===sp?void 0:null===(sx=sp.selected)||void 0===sx?void 0:sx.cardId)&&void 0!==sk?sk:null:li&&li.ok&&null!==(s_=null!==(sw=null===(sg=li.search)||void 0===sg?void 0:null===(sv=sg.selected)||void 0===sv?void 0:null===(sh=sv.match)||void 0===sh?void 0:sh.cardId)&&void 0!==sw?sw:null===(sj=li.search)||void 0===sj?void 0:null===(sb=sj.selected)||void 0===sb?void 0:sb.cardId)&&void 0!==s_?s_:null,c=r(d,o);if(c){let t=m("error-expected-payload","Очікуваний JSON запиту",c);t&&e.push(t)}let u=i({details:a,target:d,cardId:o});u&&e.push((0,l.jsxs)("div",{className:"text-xs text-slate-600/80",children:[u.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,l.jsxs)("code",{className:"break-all text-[0.7rem]",children:[u.requestMethod," ",u.requestUrl]}),u.exact?null:(0,l.jsx)("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"error-request")),lh.push({key:"move",title:"4. Переміщення картки",status:t,details:e}),lh.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"warning",details:[(0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Відповідь KeyCRM відсутня через попередню помилку автоматизації."},"error-response")]});let x=[];if(u?(x.push((0,l.jsxs)("div",{className:"text-xs text-slate-600/80",children:[u.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,l.jsxs)("code",{className:"break-all text-[0.7rem]",children:[u.requestMethod," ",u.requestUrl]}),u.exact?null:(0,l.jsx)("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"error-request-info")),u.baseUrl&&x.push((0,l.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Базова адреса: ",(0,l.jsx)("code",{className:"break-all",children:u.baseUrl})]},"error-base"))):x.push((0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Дані про запит до KeyCRM відсутні через помилку автоматизації."},"error-request-missing")),c){let e=m("error-request-expected","Очікуваний JSON запиту",c);e&&x.push(e)}lh.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"warning",details:x})}}else{let e=(null==li?void 0:li.ok)?null!==(tL=null===(tA=li.match)||void 0===tA?void 0:null===(tR=tA.campaign)||void 0===tR?void 0:tR.target)&&void 0!==tL?tL:null:(null==ld?void 0:ld.ok)&&null!==(tB=null===(tq=ld.match)||void 0===tq?void 0:null===(tK=tq.campaign)||void 0===tK?void 0:tK.target)&&void 0!==tB?tB:null,t=(null==li?void 0:li.ok)?null!==(tz=null!==(tY=null===(tU=li.search)||void 0===tU?void 0:null===(tE=tU.selected)||void 0===tE?void 0:null===(tT=tE.match)||void 0===tT?void 0:tT.cardId)&&void 0!==tY?tY:null===(tO=li.search)||void 0===tO?void 0:null===(tP=tO.selected)||void 0===tP?void 0:tP.cardId)&&void 0!==tz?tz:null:(null==ld?void 0:ld.ok)&&null!==(tX=null!==(tG=null===(tV=ld.search)||void 0===tV?void 0:null===(tJ=tV.selected)||void 0===tJ?void 0:null===(tF=tJ.match)||void 0===tF?void 0:tF.cardId)&&void 0!==tG?tG:null===(tH=ld.search)||void 0===tH?void 0:null===(tD=tH.selected)||void 0===tD?void 0:tD.cardId)&&void 0!==tX?tX:null,s=[(0,l.jsx)("span",{children:"Автоматизація ще не запускалась у цьому середовищі — відображено лише аналітичний пошук."},"pending")],a=r(e,t),n=i({details:li&&!1===li.ok?li.details:void 0,target:e,cardId:t});if(a){let e=m("expected-move-payload","Очікуваний JSON запиту",a);e&&s.push(e)}n&&s.push((0,l.jsxs)("div",{className:"text-xs text-slate-600/80",children:[n.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,l.jsxs)("code",{className:"break-all text-[0.7rem]",children:[n.requestMethod," ",n.requestUrl]}),n.exact?null:(0,l.jsx)("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"pending-request")),lh.push({key:"move",title:"4. Переміщення картки",status:"info",details:s}),lh.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"info",details:[(0,l.jsx)("span",{children:"Відповідь KeyCRM ще не отримано."},"response-missing")]});let d=[];n?(d.push((0,l.jsxs)("div",{className:"text-xs text-slate-600/80",children:[n.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,l.jsxs)("code",{className:"break-all text-[0.7rem]",children:[n.requestMethod," ",n.requestUrl]}),n.exact?null:(0,l.jsx)("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"pending-request")),n.baseUrl&&d.push((0,l.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Базова адреса: ",(0,l.jsx)("code",{className:"break-all",children:n.baseUrl})]},"pending-base"))):d.push((0,l.jsx)("span",{className:"text-xs text-slate-600/80",children:"Запит до KeyCRM ще не сформовано — очікуємо запуск автоматизації."},"pending-request-missing")),lh.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"info",details:d})}}else{let s=null!=e?e:t;if(s){let e=null!==(z=s.details)&&void 0!==z?z:{},a=e&&"object"==typeof e&&e.campaign&&"object"==typeof e.campaign?e.campaign:null,r=t&&t.details&&"object"==typeof t.details?t.details.campaign:void 0,n="string"==typeof s.error?s.error.trim():String(s.error),i=null!==(G=null!=a?a:r)&&void 0!==G?G:null;if(n.includes("keycrm_move_failed")){let t=null!==($=null!==(W=null!==(X=w(null==i?void 0:i.name))&&void 0!==X?X:w(null==i?void 0:i.title))&&void 0!==W?W:w(null==i?void 0:i.id))&&void 0!==$?$:"(без назви)",s=_(null!==(Q=null==i?void 0:i.base)&&void 0!==Q?Q:null),a=_(null!==(et=null==i?void 0:i.target)&&void 0!==et?et:null!==(ee=null!==(Z=null==i?void 0:i.t1)&&void 0!==Z?Z:null==i?void 0:i.t2)&&void 0!==ee?ee:null),r=d(e)?e:null,n=null!==(el=null!==(es=w(null==r?void 0:r.requestUrl))&&void 0!==es?es:w(null==r?void 0:r.url))&&void 0!==el?el:w(null==r?void 0:r.baseUrl),c=w(null==r?void 0:r.requestMethod),u=null!==(ea=null==r?void 0:r.sent)&&void 0!==ea?ea:null,x=null!==(er=null==r?void 0:r.response)&&void 0!==er?er:null,p=[(0,l.jsxs)("span",{children:["Кампанія: ",t]},"move-campaign"),(0,l.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",null!==(ei=null!==(en=s.pipelineName)&&void 0!==en?en:s.pipelineId)&&void 0!==ei?ei:"—"," → статус",s.statusName?" ".concat(s.statusName):s.statusId?" ".concat(s.statusId):" —"]},"move-route"),(0,l.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["Ціль: ",null!==(eo=null!==(ed=a.pipelineName)&&void 0!==ed?ed:a.pipelineId)&&void 0!==eo?eo:"—"," →",a.statusName?" ".concat(a.statusName):a.statusId?" ".concat(a.statusId):" —"]},"move-target")],h=e&&"object"==typeof e&&e.selected?e.selected:null,v=_(null!==(ec=e.summary)&&void 0!==ec?ec:h&&"summary"in h?h.summary:null),g=h&&"match"in h&&h.match&&"object"==typeof h.match?h.match:null,b=null==g?void 0:g.cardId,j="number"==typeof b?String(b):w(b),y=w(null==g?void 0:g.title),f=w(null==g?void 0:g.matchedField),N=w(null==g?void 0:g.matchedValue),k=[(0,l.jsx)("span",{children:"Картку знайдено, але переміщення не підтверджено (keycrm_move_failed)."},"move-failed")];if(j&&k.push((0,l.jsxs)("span",{children:["Картка #",j,y?" • ".concat(y):""]},"move-card")),f&&k.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Збіг за: ",f,N?" → ".concat(N):""]},"move-match")),v){let e=null!==(em=null!==(eu=v.pipelineName)&&void 0!==eu?eu:v.pipelineId)&&void 0!==em?em:"—",t=null!==(eh=null!==(ep=null!==(ex=v.statusName)&&void 0!==ex?ex:v.statusId)&&void 0!==ep?ep:v.pipelineStatusId)&&void 0!==eh?eh:"—";k.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Поточна позиція: ",e," → ",t]},"move-summary"))}let I=Array.isArray(null==r?void 0:r.attempts)&&null!==(ev=null==r?void 0:r.attempts)&&void 0!==ev?ev:[],C=I.length;C&&k.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Перевірок: ",C]},"move-attempts")),x&&k.push((0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Відповідь: ",o(x)]},"move-response")),lh.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:p},{key:"card",title:"3. Пошук картки у KeyCRM",status:"warning",details:k},{key:"move",title:"4. Переміщення картки",status:"error",details:(()=>{let e=[(0,l.jsx)("span",{children:"Переміщення не вдалося: keycrm_move_failed."},"error")];"number"==typeof(null==r?void 0:r.status)&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["HTTP статус KeyCRM: ",r.status]},"status")),(null==r?void 0:r.error)&&e.push((0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Код помилки: ",String(r.error)]},"error-code")),(null==r?void 0:r.baseUrl)&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова адреса KeyCRM:"," ",(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:String(r.baseUrl)})]},"base-url")),(n||c)&&e.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["URL запиту: ",n?(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:n}):"н/д",c?(0,l.jsxs)("span",{className:"ml-1",children:["(метод ",c,")"]}):null]},"request"));let t=m("move-error-payload","JSON запиту до KeyCRM",u);t&&e.push(t);let s=m("move-error-response","Сира відповідь KeyCRM",x);s&&e.push(s),I.length&&e.push((0,l.jsxs)("div",{className:"mt-1 space-y-1 rounded-lg border border-slate-200/70 bg-white/70 p-2 text-[0.7rem] text-slate-700",children:[(0,l.jsx)("div",{className:"font-semibold text-slate-800",children:"Перевірки API KeyCRM:"}),I.map((e,t)=>(0,l.jsxs)("div",{className:"leading-tight",children:["#",t+1,": ",o(e)]},"move-error-attempt-".concat(t)))]},"attempts"));let a=m("move-error-details","Деталі помилки",r);return a&&e.push(a),e})()})}else if("card_not_in_base"===n){let t=null!==(ej=null!==(eb=null!==(eg=w(null==i?void 0:i.name))&&void 0!==eg?eg:w(null==i?void 0:i.title))&&void 0!==eb?eb:w(null==i?void 0:i.id))&&void 0!==ej?ej:"(без назви)",s=_(null!==(ef=null!==(ey=null==i?void 0:i.base)&&void 0!==ey?ey:e.base)&&void 0!==ef?ef:null),a=_(null!==(e_=null!==(ew=null!==(ek=null!==(eN=null==i?void 0:i.target)&&void 0!==eN?eN:null==i?void 0:i.t1)&&void 0!==ek?ek:null==i?void 0:i.t2)&&void 0!==ew?ew:e.target)&&void 0!==e_?e_:null),r=_(null!==(eC=e.summary)&&void 0!==eC?eC:null!==(eI=e.selected&&"object"==typeof e.selected?e.selected.summary:null)&&void 0!==eI?eI:null),n=null!==(eS=e.mismatch)&&void 0!==eS?eS:{},d=[(0,l.jsxs)("span",{children:["Кампанія: ",t]},"campaign"),(0,l.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",null!==(eR=null!==(eM=s.pipelineName)&&void 0!==eM?eM:s.pipelineId)&&void 0!==eR?eR:"—"," →",s.statusName?" ".concat(s.statusName):s.statusId?" ".concat(s.statusId):s.pipelineStatusId?" ".concat(s.pipelineStatusId):" —"]},"base"),(0,l.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["Ціль: ",null!==(eK=null!==(eA=a.pipelineName)&&void 0!==eA?eA:a.pipelineId)&&void 0!==eK?eK:"—"," →",a.statusName?" ".concat(a.statusName):a.statusId?" ".concat(a.statusId):a.pipelineStatusId?" ".concat(a.pipelineStatusId):" —"]},"target")],o=null!==(eT=null!==(eq=r.pipelineName)&&void 0!==eq?eq:r.pipelineId)&&void 0!==eT?eT:"—",c=null!==(eP=null!==(eU=null!==(eE=r.statusName)&&void 0!==eE?eE:r.statusId)&&void 0!==eU?eU:r.pipelineStatusId)&&void 0!==eP?eP:"—",u=[(0,l.jsxs)("span",{children:["Картку знайдено, але вона зараз у ",o," → ",c,"."]},"mismatch"),(0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Очікувана базова пара: ",null!==(eF=null!==(eO=s.pipelineName)&&void 0!==eO?eO:s.pipelineId)&&void 0!==eF?eF:"—"," →",s.statusName?" ".concat(s.statusName):s.statusId?" ".concat(s.statusId):s.pipelineStatusId?" ".concat(s.pipelineStatusId):" —"]},"expected")];!1===n.pipelineMatches&&u.push((0,l.jsx)("span",{className:"text-xs text-rose-600/80",children:"Поточна воронка не збігається з базовою."},"pipeline-mismatch")),!1===n.statusMatches&&u.push((0,l.jsx)("span",{className:"text-xs text-rose-600/80",children:"Поточний статус не збігається з базовим."},"status-mismatch")),lh.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:d},{key:"card",title:"3. Пошук картки у KeyCRM",status:"error",details:u},{key:"move",title:"4. Переміщення картки",status:"info",details:[(0,l.jsx)("span",{children:"Переміщення пропущено, оскільки картка не у базовій воронці/статусі."},"skipped")]})}else if(i){let t=null!==(eD=null!==(eV=null!==(eJ=w(i.name))&&void 0!==eJ?eJ:w(i.title))&&void 0!==eV?eV:w(i.id))&&void 0!==eD?eD:"(без назви)",a=_(null!==(eH=i.base)&&void 0!==eH?eH:null),r=_(null!==(eY=null!==(eB=null!==(eL=i.target)&&void 0!==eL?eL:i.t1)&&void 0!==eB?eB:i.t2)&&void 0!==eY?eY:null),n=[(0,l.jsxs)("span",{children:["Кампанія: ",t]},"name")],d=null!==(eW=null!==(eX=null!==(eG=null!==(ez=a.pipelineName)&&void 0!==ez?ez:a.pipelineId)&&void 0!==eG?eG:w(i.base_pipeline_name))&&void 0!==eX?eX:w(i.base_pipeline_id))&&void 0!==eW?eW:"—",o=null!==(e0=null!==(eZ=null!==(eQ=null!==(e$=a.statusName)&&void 0!==e$?e$:a.statusId)&&void 0!==eQ?eQ:w(i.base_status_name))&&void 0!==eZ?eZ:w(i.base_status_id))&&void 0!==e0?e0:"—";n.push((0,l.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",d," → статус ",o]},"base"));let c=null!==(e4=null!==(e8=null!==(e5=null!==(e3=null!==(e6=null!==(e1=null!==(e7=null!==(e2=r.pipelineName)&&void 0!==e2?e2:r.pipelineId)&&void 0!==e7?e7:w(i.target_pipeline_name))&&void 0!==e1?e1:w(i.target_pipeline_id))&&void 0!==e6?e6:w(i.v1_to_pipeline_name))&&void 0!==e3?e3:w(i.v1_to_pipeline_id))&&void 0!==e5?e5:w(i.v2_to_pipeline_name))&&void 0!==e8?e8:w(i.v2_to_pipeline_id))&&void 0!==e4?e4:"—",u=null!==(tn=null!==(tr=null!==(ta=null!==(tl=null!==(ts=null!==(tt=null!==(te=null!==(e9=r.statusName)&&void 0!==e9?e9:r.statusId)&&void 0!==te?te:w(i.target_status_name))&&void 0!==tt?tt:w(i.target_status_id))&&void 0!==ts?ts:w(i.v1_to_status_name))&&void 0!==tl?tl:w(i.v1_to_status_id))&&void 0!==ta?ta:w(i.v2_to_status_name))&&void 0!==tr?tr:w(i.v2_to_status_id))&&void 0!==tn?tn:"—";n.push((0,l.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["Ціль: ",c," → ",u]},"target"));let m=[],x="warning";switch(s.error){case"card_not_found":m.push((0,l.jsx)("span",{children:"Картку не знайдено за обраними ідентифікаторами."},"card-missing"));break;case"keycrm_search_failed":x="error",m.push((0,l.jsx)("span",{children:"Пошук у KeyCRM завершився помилкою."},"search-failed")),e.error&&m.push((0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Деталі: ",JSON.stringify(e.error)]},"search-error"));break;default:m.push((0,l.jsxs)("span",{children:["Пошук картки зупинився з помилкою: ",s.error,"."]},"generic-error"))}Array.isArray(e.attempts)&&e.attempts.length&&m.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Спроб запиту: ",e.attempts.length]},"attempts")),lh.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:n},{key:"card",title:"3. Пошук картки у KeyCRM",status:x,details:m},{key:"move",title:"4. Переміщення картки",status:"warning",details:[(0,l.jsx)("span",{children:"Переміщення не виконувалось через попередню помилку."},"skipped-move")]})}else lh.push({key:"campaign",title:"2. Визначення кампанії",status:"error",details:[(0,l.jsxs)("span",{children:["Помилка: ",s.error]},"error"),e?(0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Деталі: ",JSON.stringify(e)]},"details"):null].filter(Boolean)},{key:"card",title:"3. Пошук картки у KeyCRM",status:"warning",details:[(0,l.jsx)("span",{children:"campaign_not_found"===s.error||"campaign_base_missing"===s.error||"campaign_target_missing"===s.error?"Пошук не виконувався через помилку під час визначення кампанії.":"Пошук не виконувався через помилку автоматизації (".concat(s.error,").")},"skipped")]},{key:"move",title:"4. Переміщення картки",status:"warning",details:[(0,l.jsx)("span",{children:"Переміщення пропущено."},"skipped")]})}}}else lh.push({key:"campaign",title:"2. Визначення кампанії",status:"info",details:[(0,l.jsx)("span",{children:"Очікуємо запуск автоматизації після отримання вебхука."},"pending")]},{key:"card",title:"3. Пошук картки у KeyCRM",status:"info",details:[(0,l.jsx)("span",{children:"Пошук картки почнеться, щойно буде підібрано кампанію."},"pending")]},{key:"move",title:"4. Переміщення картки",status:"info",details:[(0,l.jsx)("span",{children:"Переміщення відбудеться автоматично після успішного пошуку картки."},"pending")]});if(u(li)){let e=li.move,t=[],s=null!==(sR=null===(sI=li.search)||void 0===sI?void 0:sI.selected)&&void 0!==sR?sR:null,a=s&&"object"==typeof s?v(null!==(sK=null!==(sA=null===(sC=s.match)||void 0===sC?void 0:sC.cardId)&&void 0!==sA?sA:s.cardId)&&void 0!==sK?sK:null):null,n=null!==(sq=null===(sM=li.match)||void 0===sM?void 0:null===(sS=sM.campaign)||void 0===sS?void 0:sS.target)&&void 0!==sq?sq:null,d=r(n,a),o=i({details:{requestUrl:null!==(sT=e.requestUrl)&&void 0!==sT?sT:void 0,requestMethod:null!==(sE=e.requestMethod)&&void 0!==sE?sE:void 0,baseUrl:null!==(sU=e.baseUrl)&&void 0!==sU?sU:void 0},target:n,cardId:a,defaultMethod:null!==(sP=e.requestMethod)&&void 0!==sP?sP:"POST"}),u=null!==(sO=e.requestUrl)&&void 0!==sO?sO:o.requestUrl,x=null!==(sF=e.requestMethod)&&void 0!==sF?sF:o.requestMethod,p=null!==(sJ=e.baseUrl)&&void 0!==sJ?sJ:o.baseUrl,h=!!e.requestUrl;if(t.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Запит: ",x," ",(0,l.jsx)("code",{className:"break-all text-[0.7rem]",children:u}),h?null:(0,l.jsx)("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"trace-request")),p&&t.push((0,l.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Базова адреса: ",(0,l.jsx)("code",{className:"break-all",children:p})]},"trace-base")),e.requestHeaders&&Object.keys(e.requestHeaders).length){let s=m("trace-request-headers","HTTP заголовки",e.requestHeaders);s&&t.push(s)}let g="string"==typeof e.requestBodyRaw?e.requestBodyRaw.trim():"";if(g)t.push((0,l.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[(0,l.jsx)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Тіло запиту (raw)"}),(0,l.jsx)("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:g})]},"trace-request-body"));else if(e.sent){let s=m("trace-request-json","JSON запиту",e.sent);s&&t.push(s)}else if(d){let e=m("trace-request-fallback","Очікуваний JSON запиту",d);e&&t.push(e)}let b="string"==typeof e.responseRaw?e.responseRaw.trim():"";if(b)t.push((0,l.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[(0,l.jsx)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Відповідь KeyCRM (raw)"}),(0,l.jsx)("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:b})]},"trace-response-raw"));else if(e.response){let s=m("trace-response-json","JSON відповіді KeyCRM",e.response);s&&t.push(s)}Array.isArray(e.trace)&&e.trace.length&&t.push((0,l.jsxs)("div",{className:"mt-2 space-y-2 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[(0,l.jsx)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Внутрішній трейc виконання"}),(0,l.jsx)("div",{className:"space-y-2",children:e.trace.map((e,t)=>(0,l.jsxs)("div",{className:"rounded border border-slate-200/70 bg-white/90 p-2 text-[0.7rem] leading-tight text-slate-700",children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-1",children:[(0,l.jsxs)("span",{className:"font-semibold",children:["#",t+1," \xb7 ",e.step]}),(0,l.jsx)("span",{className:"text-[0.65rem] text-slate-400",children:new Date(e.timestamp).toLocaleString()})]}),e.info?(0,l.jsx)("div",{className:"mt-1 text-[0.7rem] text-slate-600",children:e.info}):null,null!=e.data?(0,l.jsx)("pre",{className:"mt-1 max-h-48 overflow-auto whitespace-pre-wrap break-words text-[0.65rem] leading-tight text-slate-700",children:(()=>{try{return JSON.stringify(e.data,null,2)}catch(t){return String(e.data)}})()}):null]},"trace-entry-".concat(t)))})]},"trace-entries")),"string"==typeof e.stack&&e.stack.trim()&&t.push((0,l.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[(0,l.jsx)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Stack-trace (web/lib/keycrm-move.ts)"}),(0,l.jsx)("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:e.stack})]},"trace-stack")),e.attempted||t.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Переміщення не запускалося: ",e.skippedReason?c(e.skippedReason):"причина не вказана","."]},"trace-skipped")),t.length||t.push((0,l.jsx)("span",{className:"text-xs text-slate-500",children:"Дані про запит до KeyCRM відсутні."},"trace-empty"));let j={key:"move-trace",title:"3.1 Трейс",status:e.attempted?e.ok?"success":"error":e.skippedReason?"warning":"info",details:t},y=lh.findIndex(e=>"move-trace"===e.key);-1!==y&&lh.splice(y,1);let f=lh.findIndex(e=>"card"===e.key);-1!==f?lh.splice(f+1,0,j):lh.push(j)}let ly=li&&li.ok?li.move.attempted?li.move.ok?"success":"failed":"already_in_target"===li.move.skippedReason?"already":"skipped":null;if(lg){let e=N[lg.stage],t=lh.find(t=>t.key===e),s=[(0,l.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Автоматизація зупинилась на кроці ",lg.step,": ",lg.title,"."]},"stage"),(0,l.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Код: ",(0,l.jsx)("code",{className:"break-all",children:lg.module})]},"module")];if(lg.hint&&s.push((0,l.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Підказка: ",lg.hint]},"hint")),lb){let e=m("automation-".concat(lg.stage,"-details"),"Деталі помилки",lb);e&&s.push(e)}t?(t.status="error",t.details=[...t.details,...s]):lh.push({key:e,title:"".concat(lg.step,". ").concat(lg.title),status:"error",details:s})}return(0,l.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,l.jsxs)("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-slate-800",children:"Журнал ManyChat-повідомлень"}),(0,l.jsx)("p",{className:"mt-1 text-sm text-slate-500",children:"Повідомлення з вебхука ManyChat автоматично з'являються у списку нижче."})]}),(0,l.jsx)("button",{type:"button",onClick:s5,disabled:s6,className:"inline-flex items-center justify-center rounded-lg border border-emerald-200 px-3 py-2 text-sm font-medium text-emerald-700 shadow-sm transition hover:border-emerald-300 hover:text-emerald-600 disabled:cursor-not-allowed disabled:border-slate-200 disabled:text-slate-400",children:s6?"Оновлення…":"Оновити"})]}),(0,l.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,l.jsxs)("div",{className:"rounded-2xl border border-dashed border-emerald-300/80 bg-emerald-50 p-4 shadow-sm",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-emerald-800",children:"Візуальна послідовність автоматизації"}),(0,l.jsx)("p",{className:"mt-1 text-xs text-emerald-700/80",children:"Кроки: отримуємо повідомлення з ManyChat, визначаємо кампанію, шукаємо картку в KeyCRM і переміщуємо її у ціль."}),(0,l.jsx)("div",{className:"mt-3",children:(0,l.jsx)(C,{steps:lh})})]}),le?(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-slate-200 bg-white/60 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-700",children:"Конфігурація Vercel KV"}),(0,l.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["URL: ",le.hasBaseUrl?"✅ задано":"⚠️ відсутній"," \xb7 Токен читання: ",le.hasReadToken?"✅":"⚠️"," \xb7 Токен запису: ",le.hasWriteToken?"✅":"⚠️"," \xb7 Кандидатів бази: ",le.candidates]})]}):null,(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-slate-200 bg-slate-50 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-slate-600",children:"Діагностика вебхука"}),s8?(0,l.jsxs)("div",{className:"mt-2 space-y-1 text-sm text-slate-600",children:[(0,l.jsxs)("p",{children:["Статус: ","accepted"===s8.status?"✅ Прийнято":"⚠️ Відхилено",s8.statusCode?" \xb7 Код ".concat(s8.statusCode):""]}),(0,l.jsxs)("p",{children:["Час: ",new Date(s8.receivedAt).toLocaleString()]}),s8.reason&&(0,l.jsxs)("p",{children:["Деталі: ",s8.reason]}),s8.fullName||s8.handle?(0,l.jsxs)("p",{children:["Контакт: ",null!==(sV=s8.fullName)&&void 0!==sV?sV:"—",s8.handle&&(0,l.jsxs)("span",{className:"ml-1",children:["(@",s8.handle,")"]})]}):null,s8.messagePreview&&(0,l.jsxs)("p",{children:["Текст: ",s8.messagePreview]})]}):(0,l.jsx)("p",{className:"mt-2 text-sm text-slate-500",children:"Вебхук ще не надходив у це середовище."})]}),(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-amber-200 bg-amber-50/60 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-amber-700",children:"Статус підключення ManyChat API"}),s9?(0,l.jsxs)("p",{className:"mt-2 text-sm text-amber-700",children:[s9.ok?"✅ Дані отримано (".concat(null!==(sD=s9.note)&&void 0!==sD?sD:"API активне",")"):"⚠️ ".concat(null!==(sH=s9.message)&&void 0!==sH?sH:"ManyChat API вимкнено"),s9.note?(0,l.jsx)("span",{className:"block text-xs text-amber-600/80",children:s9.note}):null]}):(0,l.jsx)("p",{className:"mt-2 text-sm text-amber-700/80",children:"Очікуємо перше звернення до ManyChat API…"})]}),(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-emerald-200 bg-emerald-50/80 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-emerald-700",children:"Автоматизація ManyChat → KeyCRM"}),li?li.ok?(0,l.jsxs)("div",{className:"mt-2 space-y-1 text-sm text-emerald-700",children:[(0,l.jsx)("p",{children:"success"===ly?"✅ Маршрут ".concat(li.match.route.toUpperCase()," → ").concat(null!==(sL=li.match.campaign.name)&&void 0!==sL?sL:"без назви"," виконано"):"already"===ly?"✅ Картка вже була у цілі для маршруту ".concat(li.match.route.toUpperCase()," → ").concat(null!==(sB=li.match.campaign.name)&&void 0!==sB?sB:"без назви"):"skipped"===ly?"⚠️ Маршрут ".concat(li.match.route.toUpperCase()," → ").concat(null!==(sY=li.match.campaign.name)&&void 0!==sY?sY:"без назви"," виконано без переміщення"):"⚠️ Маршрут ".concat(li.match.route.toUpperCase()," → ").concat(null!==(sz=li.match.campaign.name)&&void 0!==sz?sz:"без назви"," не завершив переміщення")}),(0,l.jsxs)("p",{children:["Ціль: ",li.match.campaign.target.pipelineName||li.match.campaign.target.pipelineId||"—",li.match.campaign.target.statusName||li.match.campaign.target.statusId?" \xb7 Статус: ".concat(li.match.campaign.target.statusName||li.match.campaign.target.statusId):""]}),(0,l.jsxs)("p",{children:["Переміщення: ",li.move.attempted?li.move.ok?"✅ виконано":"⚠️ не вдалося":"already_in_target"===li.move.skippedReason?"✅ картка вже у цілі":"⚠️ пропущено",li.move.error?" \xb7 Помилка: ".concat(li.move.error):""]})]}):(0,l.jsxs)("div",{className:"mt-2 text-sm text-red-600",children:["⚠️ Помилка автоматизації: ",li.error]}):(0,l.jsx)("p",{className:"mt-2 text-sm text-emerald-700/80",children:"Автоматизація ще не запускалася для цього середовища."})]}),lo?(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-emerald-200 bg-white/70 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-emerald-700",children:"Сира відповідь автоматизації"}),(0,l.jsx)("pre",{className:"mt-3 max-h-72 overflow-auto rounded-lg bg-emerald-900/5 p-3 text-xs text-slate-800",children:(()=>{try{return JSON.stringify(lo,null,2)}catch(e){return"<< неможливо серіалізувати: ".concat(e instanceof Error?e.message:String(e)," >>")}})()})]}):null,(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-sky-200 bg-sky-50/70 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-sky-700",children:"Сховище повідомлень (KV)"}),lt?(0,l.jsxs)("p",{className:"mt-2 text-sm text-sky-700",children:[lt.ok?"memory"===lt.source?"✅ Останній вебхук уже в пам'яті процесу":"✅ Повідомлення знайдено у Vercel KV":"⚠️ ".concat(null!==(sG=lt.message)&&void 0!==sG?sG:"Не вдалося отримати повідомлення з KV"),(0,l.jsxs)("span",{className:"block text-xs text-sky-600/80",children:["Ключ: ",lt.key,lt.source?" • джерело: ".concat(lt.source):""]})]}):(0,l.jsx)("p",{className:"mt-2 text-sm text-sky-700/80",children:"Очікуємо перший запис у KV…"})]}),lr?(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-emerald-200/70 bg-emerald-50/70 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-emerald-700",children:"Журнал повідомлень (KV)"}),(0,l.jsxs)("p",{className:"mt-2 text-sm text-emerald-700",children:[lr.ok?"✅ Завантажено ".concat(null!==(sX=lr.count)&&void 0!==sX?sX:0," запис(ів)"):"⚠️ ".concat(null!==(sW=lr.message)&&void 0!==sW?sW:"Журнал недоступний"),(0,l.jsxs)("span",{className:"block text-xs text-emerald-600/80",children:["Ключ: ",lr.key,lr.source?" • джерело: ".concat(lr.source):""]})]})]}):null,ls?(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-purple-200 bg-purple-50/70 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-purple-700",children:"Сховище трасування (KV)"}),(0,l.jsxs)("p",{className:"mt-2 text-sm text-purple-700",children:[ls.ok?"✅ Трасування вебхука знайдено":"error"===ls.source?"⚠️ ".concat(null!==(s$=ls.message)&&void 0!==s$?s$:"Помилка читання KV"):"⚠️ Трасування не знайдено у KV",(0,l.jsxs)("span",{className:"block text-xs text-purple-600/80",children:["Ключ: ",ls.key,ls.source?" • джерело: ".concat(ls.source):""]})]})]}):null,ll?(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-amber-200 bg-amber-50/70 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-amber-700",children:"Сирий payload (KV)"}),(0,l.jsxs)("p",{className:"mt-2 text-sm text-amber-700",children:[ll.ok?"✅ Сирий JSON збережено у KV":"error"===ll.source?"⚠️ ".concat(null!==(sQ=ll.message)&&void 0!==sQ?sQ:"Помилка читання KV"):"⚠️ Сирий payload відсутній у KV",(0,l.jsxs)("span",{className:"block text-xs text-amber-600/80",children:["Ключ: ",ll.key,ll.source?" • джерело: ".concat(ll.source):""]})]})]}):null,la?(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-blue-700",children:"Останній сирий запит (KV)"}),(0,l.jsxs)("p",{className:"mt-2 text-sm text-blue-700",children:[la.ok?"✅ Запит збережено у KV":"error"===la.source?"⚠️ ".concat(null!==(sZ=la.message)&&void 0!==sZ?sZ:"Помилка читання KV"):"⚠️ Запит відсутній у KV",(0,l.jsxs)("span",{className:"block text-xs text-blue-600/80",children:["Ключ: ",la.key,la.source?" • джерело: ".concat(la.source):""]})]})]}):null,ln?(0,l.jsxs)("div",{className:"rounded-xl border border-dashed border-indigo-200 bg-indigo-50/70 p-4",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-indigo-700",children:"Fallback із трасування"}),(0,l.jsx)("p",{className:"mt-2 text-sm text-indigo-700/90",children:ln.reason})]}):null]}),(0,l.jsxs)("div",{className:"mt-6 space-y-4",children:[lc?(0,l.jsxs)("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50/80 p-4 text-sm text-emerald-900",children:[(0,l.jsx)("h3",{className:"text-base font-semibold text-emerald-800",children:"Останній вебхук ManyChat"}),(0,l.jsxs)("p",{className:"mt-1 text-xs text-emerald-700/80",children:[new Date("string"==typeof lc.receivedAt?Number.parseInt(lc.receivedAt,10):null!==(s0=lc.receivedAt)&&void 0!==s0?s0:Date.now()).toLocaleString()," • ",lc.source]}),(0,l.jsxs)("div",{className:"mt-2 text-slate-700",children:[(0,l.jsxs)("div",{className:"font-medium",children:[lc.fullName||"—",lc.handle&&(0,l.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",lc.handle,")"]})]}),(0,l.jsx)("div",{className:"mt-1 whitespace-pre-wrap text-slate-600",children:(null===(g=lc.text)||void 0===g?void 0:null===(n=g.trim())||void 0===n?void 0:n.length)?lc.text:(null==lx?void 0:null===(b=lx.trim())||void 0===b?void 0:b.length)?lx:"(порожній текст повідомлення)"}),(0,l.jsxs)("div",{className:"mt-3",children:[(0,l.jsx)("h4",{className:"text-sm font-semibold text-emerald-800",children:"Сирий JSON вебхука"}),(0,l.jsx)("pre",{className:"mt-2 max-h-64 overflow-auto rounded-lg bg-emerald-900/5 p-3 text-xs text-emerald-900",children:(()=>{var e,t,s,l,a;let r=(null===(t=lc.rawText)||void 0===t?void 0:null===(e=t.trim())||void 0===e?void 0:e.length)?lc.rawText.trim():(null==lm?void 0:null===(l=lm.rawText)||void 0===l?void 0:null===(s=l.trim())||void 0===s?void 0:s.length)?lm.rawText.trim():(null==lx?void 0:null===(a=lx.trim())||void 0===a?void 0:a.length)?lx.trim():null;if(r)try{return JSON.stringify(JSON.parse(r),null,2)}catch(e){return r}let n=null!=lc.raw?lc.raw:(null==lu?void 0:lu.raw)!=null?lu.raw:null;try{return JSON.stringify(n,null,2)}catch(e){return"<< неможливо серіалізувати: ".concat(e instanceof Error?e.message:String(e)," >>")}})()}),lm?(0,l.jsxs)("p",{className:"mt-2 text-xs text-emerald-700/70",children:["Збережено: ",lm.receivedAt?new Date(lm.receivedAt).toLocaleString():"—",lm.source?" • джерело запиту: ".concat(lm.source):""]}):null,(null==lu?void 0:lu.source)?(0,l.jsxs)("p",{className:"mt-2 text-xs text-emerald-700/70",children:["Джерело: ",lu.source]}):null]})]})]}):null,(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-slate-700",children:"Останні повідомлення"}),"loading"===s2.status&&(0,l.jsx)("p",{className:"mt-3 text-sm text-slate-500",children:"Завантаження…"}),"error"===s2.status&&(0,l.jsx)("p",{className:"mt-3 text-sm text-red-500",children:s2.message}),"ready"===s2.status&&0===s2.messages.length&&(0,l.jsx)("p",{className:"mt-3 text-sm text-slate-500",children:"Повідомлень ще немає. Натисніть \xabОновити\xbb, щойно ManyChat надішле вебхук, або перевірте діагностику вище."}),"ready"===s2.status&&s2.messages.length>0&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("p",{className:"mt-2 text-xs text-slate-400",children:["Оновлено: ",s2.updatedAt.toLocaleTimeString()," (автооновлення кожні 5 секунд)",s2.source&&(0,l.jsxs)("span",{className:"ml-1",children:["• джерело: ",s2.source]})]}),(0,l.jsx)("div",{className:"mt-3 space-y-3",children:s2.messages.map((e,t)=>{var s,a,r,n;return(0,l.jsxs)("div",{className:"rounded-xl border border-slate-200 p-4 text-sm",children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2 text-xs text-slate-400",children:[(0,l.jsxs)("span",{children:["ID:"," ",(()=>{if("number"==typeof e.id&&Number.isFinite(e.id))return e.id;if("string"==typeof e.id){let t=Number(e.id.trim());if(Number.isFinite(t))return t;if(e.id.trim())return e.id.trim()}return"—"})()]}),(0,l.jsx)("span",{children:(()=>{let t="string"==typeof e.receivedAt?Number(e.receivedAt.trim()):e.receivedAt;return"number"==typeof t&&Number.isFinite(t)?new Date(t).toLocaleString():"Невідомо"})()})]}),(e.source||e.title)&&(0,l.jsxs)("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-400",children:[e.source&&(0,l.jsxs)("span",{children:["Джерело: ",e.source]}),e.title&&(0,l.jsxs)("span",{children:["Заголовок: ",e.title]})]}),(0,l.jsxs)("div",{className:"mt-2 text-slate-600",children:[(0,l.jsxs)("div",{className:"font-medium text-slate-700",children:[e.fullName||"—",e.handle&&(0,l.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",e.handle,")"]})]}),(0,l.jsx)("div",{className:"mt-1 whitespace-pre-wrap text-slate-500",children:(null===(a=e.text)||void 0===a?void 0:null===(s=a.trim())||void 0===s?void 0:s.length)?e.text:(null==lx?void 0:null===(r=lx.trim())||void 0===r?void 0:r.length)&&0===t?lx:"(порожній текст повідомлення)"})]})]},"".concat(null!==(n=e.id)&&void 0!==n?n:t,"-").concat(t))})})]})]})]})]})}}},function(e){e.O(0,[971,23,744],function(){return e(e.s=7751)}),_N_E=e.O()}]);