(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[870],{2409:function(e,i,l){Promise.resolve().then(l.bind(l,3204))},3204:function(e,i,l){"use strict";l.r(i),l.d(i,{default:function(){return p},dynamic:function(){return t}});var a=l(7437),n=l(2265),s=l(6463);let t="force-dynamic";function d(e){let{title:i,children:l}=e;return(0,a.jsxs)("div",{className:"rounded-2xl border p-4 md:p-6",children:[(0,a.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:i}),l]})}function r(e){let{label:i,children:l}=e;return(0,a.jsxs)("label",{className:"flex flex-col gap-1",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:i}),l]})}function o(e){return(0,a.jsx)("input",{...e,className:"rounded-lg border px-3 py-2 text-sm outline-none ".concat(e.className||"")})}function c(e){return(0,a.jsx)("select",{...e,className:"rounded-lg border px-3 py-2 text-sm outline-none ".concat(e.className||"")})}function u(e,i){for(let l of i){let i=null==e?void 0:e[l];if(Array.isArray(i))return i}return Array.isArray(e)?e:[]}function p(){var e;let{id:i}=(0,s.useParams)(),l=(0,s.useRouter)(),[t,p]=(0,n.useState)(!0),[v,x]=(0,n.useState)(!1),[m,h]=(0,n.useState)(null),[_,j]=(0,n.useState)([]),[g,b]=(0,n.useState)({}),[f,y]=(0,n.useState)(null),[N,S]=(0,n.useState)(null);async function C(){y(null);try{let e=await fetch("/api/keycrm/pipelines",{credentials:"include",cache:"no-store"}),i=await e.json().catch(()=>({})),l=u(i,["items","data","pipelines","result"]).map(e=>{var i,l,a,n,s,t;return{id:String(null!==(a=null!==(l=null!==(i=e.id)&&void 0!==i?i:e.ID)&&void 0!==l?l:e.value)&&void 0!==a?a:""),name:String(null!==(t=null!==(s=null!==(n=e.name)&&void 0!==n?n:e.title)&&void 0!==s?s:e.label)&&void 0!==t?t:"")}}).filter(e=>e.id&&e.name);!l.length&&(null==i?void 0:i.error)&&y("pipelines: ".concat(i.error)),j(l)}catch(e){y("pipelines: ".concat(String((null==e?void 0:e.message)||e))),j([])}}async function w(e){if(e&&!g[e])try{var i;let l=await fetch("/api/keycrm/statuses?pipeline_id=".concat(encodeURIComponent(e)),{credentials:"include",cache:"no-store"}),a=(i=await l.json().catch(()=>({})),u(i,["items","data","statuses","result"]).map(e=>{var i,l,a,n,s,t,d,r,o;return{id:String(null!==(a=null!==(l=null!==(i=e.id)&&void 0!==i?i:e.ID)&&void 0!==l?l:e.value)&&void 0!==a?a:""),name:String(null!==(t=null!==(s=null!==(n=e.name)&&void 0!==n?n:e.title)&&void 0!==s?s:e.label)&&void 0!==t?t:""),pipeline_id:String(null!==(o=null!==(r=null!==(d=e.pipeline_id)&&void 0!==d?d:e.pipelineId)&&void 0!==r?r:e.pid)&&void 0!==o?o:"")}}).filter(e=>e.id&&e.name));b(i=>({...i,[e]:a}))}catch(i){b(i=>({...i,[e]:[]}))}}let k=e=>g[String(e||"")]||[];async function P(){let e=await fetch("/api/campaigns",{credentials:"include",cache:"no-store"}),l=await e.json().catch(()=>({})),a=(Array.isArray(l.items)?l.items:[]).find(e=>e.id===i)||null;if(!a)throw Error("Campaign not found");S(a);let n=[a.base_pipeline_id,a.v1_to_pipeline_id||"",a.v2_to_pipeline_id||"",a.exp_to_pipeline_id||""].filter(Boolean);await Promise.allSettled(n.map(e=>w(e)))}(0,n.useEffect)(()=>{(async()=>{p(!0),h(null);try{await C(),await P()}catch(e){h(String((null==e?void 0:e.message)||e))}finally{p(!1)}})()},[i]);let q=(e,i)=>S(l=>l?{...l,[e]:i}:l);function E(e,i,l){q(e,l),q(i,""),w(l)}async function A(e){if(e.preventDefault(),N){x(!0),h(null);try{var i;let e={...N,updated_at:new Date().toISOString(),v1_field:"text",v2_field:"text",v2_enabled:!!N.v2_enabled&&!!(null===(i=N.v2_value)||void 0===i?void 0:i.trim())},a=await fetch("/api/campaigns",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await a.json();if(!(null==n?void 0:n.ok))throw Error((null==n?void 0:n.error)||"save failed");l.push("/admin/campaigns?updated=1")}catch(e){h(String((null==e?void 0:e.message)||e))}finally{x(!1)}}}return t?(0,a.jsx)("div",{className:"mx-auto max-w-4xl px-4 py-6",children:(0,a.jsx)("div",{className:"text-gray-600",children:"Завантаження…"})}):m||!N?(0,a.jsxs)("div",{className:"mx-auto max-w-4xl px-4 py-6",children:[(0,a.jsxs)("div",{className:"mb-3 text-red-600",children:["Помилка: ",m||"Не знайдено"]}),(0,a.jsx)("a",{href:"/admin/campaigns",className:"rounded-full border px-3 py-1.5 text-sm",children:"← До списку"})]}):(0,a.jsxs)("div",{className:"mx-auto max-w-4xl px-4 py-6",children:[(0,a.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:"Редагувати кампанію"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("a",{href:"/admin/campaigns",className:"rounded-full border px-3 py-1.5 text-sm",children:"← До списку"}),(0,a.jsx)("button",{type:"button",onClick:()=>{C().then(()=>{N.base_pipeline_id&&w(N.base_pipeline_id),N.v1_to_pipeline_id&&w(N.v1_to_pipeline_id),N.v2_to_pipeline_id&&w(N.v2_to_pipeline_id),N.exp_to_pipeline_id&&w(N.exp_to_pipeline_id)})},className:"rounded-full border px-3 py-1.5 text-sm",title:"Оновити довідники",children:"Оновити довідники"})]})]}),f&&(0,a.jsx)("div",{className:"mb-4 rounded-lg border border-amber-400 bg-amber-50 px-3 py-2 text-sm text-amber-800",children:f}),(0,a.jsxs)("form",{onSubmit:A,className:"grid gap-6",children:[(0,a.jsx)(d,{title:"Загальні",children:(0,a.jsxs)("div",{className:"grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Назва",children:(0,a.jsx)(o,{value:N.name||"",onChange:e=>q("name",e.target.value),placeholder:"Назва кампанії",required:!0})}),(0,a.jsx)(r,{label:"Увімкнено",children:(0,a.jsxs)(c,{value:N.enabled?"1":"0",onChange:e=>q("enabled","1"===e.target.value),children:[(0,a.jsx)("option",{value:"1",children:"yes"}),(0,a.jsx)("option",{value:"0",children:"no"})]})}),(0,a.jsx)("div",{})]})}),(0,a.jsx)(d,{title:"База",children:(0,a.jsxs)("div",{className:"grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Воронка (base_pipeline_id)",children:(0,a.jsxs)(c,{value:N.base_pipeline_id||"",onChange:e=>E("base_pipeline_id","base_status_id",e.target.value),required:!0,children:[(0,a.jsx)("option",{value:"",children:"—"}),_.map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)(r,{label:"Статус (base_status_id)",children:(0,a.jsxs)(c,{value:N.base_status_id||"",onChange:e=>q("base_status_id",e.target.value),required:!0,children:[(0,a.jsx)("option",{value:"",children:"—"}),k(N.base_pipeline_id).map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)("div",{})]})}),(0,a.jsxs)(d,{title:"Варіант V1 (обов’язковий)",children:[(0,a.jsxs)("div",{className:"grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Оператор",children:(0,a.jsxs)(c,{value:N.v1_op,onChange:e=>q("v1_op",e.target.value),children:[(0,a.jsx)("option",{value:"contains",children:"contains"}),(0,a.jsx)("option",{value:"equals",children:"equals"})]})}),(0,a.jsx)(r,{label:"Значення (v1_value)",children:(0,a.jsx)(o,{value:N.v1_value||"",onChange:e=>q("v1_value",e.target.value),placeholder:"ключове слово"})}),(0,a.jsx)("div",{})]}),(0,a.jsxs)("div",{className:"mt-3 grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Воронка призначення (v1)",children:(0,a.jsxs)(c,{value:N.v1_to_pipeline_id||"",onChange:e=>E("v1_to_pipeline_id","v1_to_status_id",e.target.value),children:[(0,a.jsx)("option",{value:"",children:"—"}),_.map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)(r,{label:"Статус призначення (v1)",children:(0,a.jsxs)(c,{value:N.v1_to_status_id||"",onChange:e=>q("v1_to_status_id",e.target.value),children:[(0,a.jsx)("option",{value:"",children:"—"}),k(N.v1_to_pipeline_id).map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)("div",{})]})]}),(0,a.jsxs)(d,{title:"Варіант V2 (опційний)",children:[(0,a.jsx)("div",{className:"mb-2 flex items-center gap-2",children:(0,a.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,a.jsx)("input",{type:"checkbox",checked:!!N.v2_enabled,onChange:e=>q("v2_enabled",e.target.checked)}),"Увімкнути V2"]})}),(0,a.jsxs)("div",{className:"grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Оператор",children:(0,a.jsxs)(c,{value:N.v2_op,onChange:e=>q("v2_op",e.target.value),disabled:!N.v2_enabled,children:[(0,a.jsx)("option",{value:"contains",children:"contains"}),(0,a.jsx)("option",{value:"equals",children:"equals"})]})}),(0,a.jsx)(r,{label:"Значення (v2_value)",children:(0,a.jsx)(o,{value:N.v2_value||"",onChange:e=>q("v2_value",e.target.value),placeholder:"ключове слово",disabled:!N.v2_enabled})}),(0,a.jsx)("div",{})]}),(0,a.jsxs)("div",{className:"mt-3 grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Воронка призначення (v2)",children:(0,a.jsxs)(c,{value:N.v2_to_pipeline_id||"",onChange:e=>E("v2_to_pipeline_id","v2_to_status_id",e.target.value),disabled:!N.v2_enabled,children:[(0,a.jsx)("option",{value:"",children:"—"}),_.map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)(r,{label:"Статус призначення (v2)",children:(0,a.jsxs)(c,{value:N.v2_to_status_id||"",onChange:e=>q("v2_to_status_id",e.target.value),disabled:!N.v2_enabled,children:[(0,a.jsx)("option",{value:"",children:"—"}),k(N.v2_to_pipeline_id).map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)("div",{})]})]}),(0,a.jsxs)(d,{title:"EXP (експірація)",children:[(0,a.jsxs)("div",{className:"grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Днів у базі (exp_days)",children:(0,a.jsx)(o,{type:"number",inputMode:"numeric",min:0,value:String(null!==(e=N.exp_days)&&void 0!==e?e:0),onChange:e=>q("exp_days",Number(e.target.value)||0)})}),(0,a.jsx)("div",{}),(0,a.jsx)("div",{})]}),(0,a.jsxs)("div",{className:"mt-3 grid gap-3 md:grid-cols-3",children:[(0,a.jsx)(r,{label:"Воронка призначення (exp)",children:(0,a.jsxs)(c,{value:N.exp_to_pipeline_id||"",onChange:e=>E("exp_to_pipeline_id","exp_to_status_id",e.target.value),children:[(0,a.jsx)("option",{value:"",children:"—"}),_.map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)(r,{label:"Статус призначення (exp)",children:(0,a.jsxs)(c,{value:N.exp_to_status_id||"",onChange:e=>q("exp_to_status_id",e.target.value),children:[(0,a.jsx)("option",{value:"",children:"—"}),k(N.exp_to_pipeline_id).map(e=>(0,a.jsx)("option",{value:String(e.id),children:e.name},e.id))]})}),(0,a.jsx)("div",{})]})]}),m&&(0,a.jsx)("div",{className:"text-sm text-red-600",children:m}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{type:"submit",disabled:v,className:"rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-60",children:"Зберегти"}),(0,a.jsx)("a",{href:"/admin/campaigns",className:"rounded-lg border px-4 py-2 text-sm",children:"Скасувати"})]})]})]})}},6463:function(e,i,l){"use strict";var a=l(1169);l.o(a,"useParams")&&l.d(i,{useParams:function(){return a.useParams}}),l.o(a,"useRouter")&&l.d(i,{useRouter:function(){return a.useRouter}}),l.o(a,"useSearchParams")&&l.d(i,{useSearchParams:function(){return a.useSearchParams}})}},function(e){e.O(0,[971,23,744],function(){return e(e.s=2409)}),_N_E=e.O()}]);