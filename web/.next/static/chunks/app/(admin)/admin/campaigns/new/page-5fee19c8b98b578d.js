(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[205],{3668:function(e,l,i){Promise.resolve().then(i.bind(i,8669))},8669:function(e,l,i){"use strict";i.r(l),i.d(l,{default:function(){return v}});var s=i(7437),t=i(2265),n=i(6463);function a(e){let{title:l,children:i}=e;return(0,s.jsxs)("div",{className:"rounded-xl border bg-white px-4 py-4 sm:px-5 sm:py-5",children:[(0,s.jsx)("h2",{className:"mb-3 text-lg font-semibold tracking-tight",children:l}),(0,s.jsx)("div",{className:"grid gap-3 sm:gap-4",children:i})]})}function d(e){let{children:l}=e;return(0,s.jsx)("div",{className:"text-sm text-slate-600 mb-1",children:l})}function u(e){let l=[];return(e.pipelineStatusId&&l.push("PS:".concat(e.pipelineStatusId)),e.statusId&&e.statusId!==e.pipelineStatusId&&l.push("S:".concat(e.statusId)),l.length)?"".concat(e.name," (").concat(l.join(" \xb7 "),")"):e.name}function r(e){let{target:l}=e;return l.pipeline&&l.status?l.pipelineStatusId?(0,s.jsxs)("p",{className:"text-xs text-slate-500 leading-relaxed",children:["pipeline_status_id: ",l.pipelineStatusId,l.statusId&&l.statusId!==l.pipelineStatusId?" \xb7 status_id: ".concat(l.statusId):""]}):(0,s.jsxs)("p",{className:"text-xs text-red-600 leading-relaxed",children:["KeyCRM не повернув ",(0,s.jsx)("code",{children:"pipeline_status_id"})," для обраного статусу. Оновіть довідник на сторінці \xabDebug\xbb або оберіть інший статус у цій воронці."]}):null}let p={pipeline:"",status:""};function o(e){return!!((null==e?void 0:e.pipeline)&&(null==e?void 0:e.status)&&!(null==e?void 0:e.pipelineStatusId))}function c(e){let l=[];return o(e.base)&&l.push("База"),o(e.t1)&&l.push("Варіант №1"),o(e.t2)&&l.push("Варіант №2"),o(e.texp)&&l.push("Expire"),l}function v(){var e;let l=(0,n.useRouter)(),[i,o]=(0,t.useState)([]),[v,x]=(0,t.useState)({}),[h,g]=(0,t.useState)(!1),[j,b]=(0,t.useState)(!1),[f,N]=(0,t.useState)(null),[y,S]=(0,t.useState)({name:"",base:{...p},v1:"1",v2:"2",expDays:7,t1:{...p},t2:{...p},texp:{...p}});(0,t.useEffect)(()=>{let e=!0;return(async()=>{try{g(!0),N(null);let p=await fetch("/api/keycrm/pipelines",{cache:"no-store"}),c=await p.json().catch(()=>null);if(!e)return;if(!c||!1===c.ok)throw Error((null==c?void 0:c.details)||(null==c?void 0:c.error)||"Не вдалося завантажити воронки");let v=Array.isArray(c.pipelines)?c.pipelines:Array.isArray(c.data)?c.data:[],m=[],h={};for(let e of v){var l,i,s,t,n,a,d,u,r;let p=null!==(a=null!==(n=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:null==e?void 0:e.pipeline_id)&&void 0!==n?n:null==e?void 0:e.uuid)&&void 0!==a?a:null==e?void 0:e.ID,o=null!=p?String(p):"";if(!o)continue;let c=String(null!==(r=null!==(u=null!==(d=null==e?void 0:e.title)&&void 0!==d?d:null==e?void 0:e.name)&&void 0!==u?u:null==e?void 0:e.label)&&void 0!==r?r:"Воронка #".concat(o));m.push({id:o,name:c});let v=[];for(let t of[null==e?void 0:e.statuses,null==e?void 0:e.pipeline_statuses,null==e?void 0:null===(l=e.statuses)||void 0===l?void 0:l.data,null==e?void 0:null===(i=e.statuses)||void 0===i?void 0:i.items,null==e?void 0:null===(s=e.statuses)||void 0===s?void 0:s.list])Array.isArray(t)&&v.push(...t);if(v.length){let e=v.map(e=>{var l,i,s,t,n,a,d,u,r,p,o,c,v,m,x,h,g,j,b,f;let N=null!==(r=null!==(u=null!==(d=null!==(a=null!==(n=null==e?void 0:e.pipeline_status_id)&&void 0!==n?n:null==e?void 0:null===(l=e.pivot)||void 0===l?void 0:l.pipeline_status_id)&&void 0!==a?a:null==e?void 0:null===(i=e.pivot)||void 0===i?void 0:i.status_id)&&void 0!==d?d:null==e?void 0:e.pipelineStatusId)&&void 0!==u?u:null==e?void 0:e.pipeline_statusId)&&void 0!==r?r:null,y=null!==(v=null!==(c=null!==(o=null!==(p=null==e?void 0:e.status_id)&&void 0!==p?p:null==e?void 0:null===(s=e.status)||void 0===s?void 0:s.id)&&void 0!==o?o:null==e?void 0:e.statusId)&&void 0!==c?c:null==e?void 0:null===(t=e.pivot)||void 0===t?void 0:t.status_id)&&void 0!==v?v:null,S=null!==(h=null!==(x=null!==(m=null==e?void 0:e.id)&&void 0!==m?m:null==e?void 0:e.uuid)&&void 0!==x?x:null==e?void 0:e.ID)&&void 0!==h?h:null,I=null!=N&&""!==N?String(N):void 0,_=null!=y&&""!==y?String(y):void 0,w=null!==(g=null!=I?I:_)&&void 0!==g?g:null!=S?String(S):void 0;if(!w)return null;let C=String(null!==(f=null!==(b=null!==(j=null==e?void 0:e.title)&&void 0!==j?j:null==e?void 0:e.name)&&void 0!==b?b:null==e?void 0:e.label)&&void 0!==f?f:"Статус #".concat(w));return{id:w,name:C,pipelineStatusId:null!=I?I:null,statusId:null!=_?_:null}}).filter(e=>!!e);if(e.length){let l=Array.from(new Map(e.map(e=>[e.id,e])).values());h[o]=l}}}o(m),Object.keys(h).length&&x(e=>({...e,...h}))}catch(l){e&&N((null==l?void 0:l.message)||"Помилка завантаження воронок")}finally{e&&g(!1)}})(),()=>{e=!1}},[]);let I=async e=>{if(e&&!v[e])try{let l=await fetch("/api/keycrm/statuses/".concat(encodeURIComponent(e)),{cache:"no-store"}),i=await l.json();if(!(null==i?void 0:i.ok))throw Error("Не вдалося завантажити статуси");let s=Array.isArray(i.data)?i.data.map(e=>{var l,i,s;return{id:String(null!==(l=null==e?void 0:e.id)&&void 0!==l?l:""),name:String(null!==(s=null==e?void 0:e.name)&&void 0!==s?s:"Статус #".concat(null!==(i=null==e?void 0:e.id)&&void 0!==i?i:"")),pipelineStatusId:(null==e?void 0:e.pipelineStatusId)!=null&&""!==e.pipelineStatusId?String(e.pipelineStatusId):(null==e?void 0:e.pipeline_status_id)!=null&&""!==e.pipeline_status_id?String(e.pipeline_status_id):null,statusId:(null==e?void 0:e.statusId)!=null&&""!==e.statusId?String(e.statusId):(null==e?void 0:e.status_id)!=null&&""!==e.status_id?String(e.status_id):null}}):[];x(l=>({...l,[e]:s}))}catch(e){}},_=(0,t.useMemo)(()=>y.base.pipeline&&v[y.base.pipeline]||[],[y.base.pipeline,v]),w=(0,t.useMemo)(()=>y.t1.pipeline&&v[y.t1.pipeline]||[],[y.t1.pipeline,v]),C=(0,t.useMemo)(()=>y.t2.pipeline&&v[y.t2.pipeline]||[],[y.t2.pipeline,v]),k=(0,t.useMemo)(()=>y.texp.pipeline&&v[y.texp.pipeline]||[],[y.texp.pipeline,v]),D=(e,l)=>{S(s=>{var t,n,a,d;let u={...s[e],...l};if(void 0!==l.pipeline&&(l.pipeline&&I(l.pipeline),u.status="",u.statusId=void 0,u.pipelineStatusId=void 0,u.statusName="",u.pipelineName=(null===(t=i.find(e=>e.id===l.pipeline))||void 0===t?void 0:t.name)||""),void 0!==l.status&&l.status){let e=(u.pipeline&&v[u.pipeline]?v[u.pipeline]:[]).find(e=>e.id===l.status);u.status=l.status,u.statusName=(null==e?void 0:e.name)||"",u.pipelineStatusId=null!==(n=null==e?void 0:e.pipelineStatusId)&&void 0!==n?n:void 0,u.statusId=null!==(d=null!==(a=null==e?void 0:e.statusId)&&void 0!==a?a:null==e?void 0:e.pipelineStatusId)&&void 0!==d?d:l.status}return{...s,[e]:u}})},A=async e=>{if(e.preventDefault(),!y.name.trim()){N("Назва обовʼязкова");return}let i=c(y);if(i.length){N("Не вдалось зберегти: KeyCRM не повернув pipeline_status_id для секцій ".concat(i.join(", "),". Оновіть довідник статусів у розділі Debug або оберіть інші статуси."));return}b(!0),N(null);let s={name:y.name.trim(),v1:y.v1||void 0,v2:y.v2||void 0,expDays:""===y.expDays?void 0:Number.isFinite(Number(y.expDays))?Number(y.expDays):void 0,base:m(y.base),t1:m(y.t1),t2:m(y.t2),texp:m(y.texp)};try{let e=await fetch("/api/campaigns",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){let l=await e.text().catch(()=>"");throw Error(l||"Не вдалося зберегти кампанію")}l.push("/admin/campaigns"),l.refresh()}catch(e){N((null==e?void 0:e.message)||"Помилка збереження")}finally{b(!1)}},E=h||j,M=(0,t.useMemo)(()=>c(y),[y]),P=M.length>0;return(0,s.jsxs)("div",{className:"mx-auto max-w-4xl p-4 sm:p-6",children:[(0,s.jsxs)("div",{className:"mb-3 sm:mb-4 flex items-center justify-between",children:[(0,s.jsx)("h1",{className:"text-2xl sm:text-3xl font-extrabold tracking-tight",children:"Нова кампанія"}),(0,s.jsx)("button",{type:"button",onClick:()=>l.push("/admin/campaigns"),className:"rounded-lg border px-3 py-1.5 text-sm shadow-sm",children:"Скасувати"})]}),(0,s.jsxs)("form",{onSubmit:A,className:"space-y-4 sm:space-y-5",children:[(0,s.jsx)(a,{title:"База",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-12 gap-3",children:[(0,s.jsxs)("div",{className:"sm:col-span-5",children:[(0,s.jsx)(d,{children:"Назва кампанії"}),(0,s.jsx)("input",{value:y.name,onChange:e=>S(l=>({...l,name:e.target.value})),className:"w-full rounded-lg border px-3 py-2",placeholder:"Назва",disabled:E})]}),(0,s.jsxs)("div",{className:"sm:col-span-3",children:[(0,s.jsx)(d,{children:"Базова воронка"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.base.pipeline||"",onChange:e=>D("base",{pipeline:e.target.value}),disabled:E,children:[(0,s.jsx)("option",{value:"",children:"—"}),i.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsxs)("div",{className:"sm:col-span-4",children:[(0,s.jsx)(d,{children:"Базовий статус"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.base.status||"",onChange:e=>D("base",{status:e.target.value}),disabled:E||!y.base.pipeline,children:[(0,s.jsx)("option",{value:"",children:"—"}),_.map(e=>(0,s.jsx)("option",{value:e.id,children:u(e)},e.id))]}),(0,s.jsx)(r,{target:y.base})]})]})}),(0,s.jsx)(a,{title:"Варіант №1",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-12 gap-3",children:[(0,s.jsxs)("div",{className:"sm:col-span-2",children:[(0,s.jsx)(d,{children:"Значення"}),(0,s.jsx)("input",{className:"w-full rounded-lg border px-3 py-2",value:y.v1,onChange:e=>S(l=>({...l,v1:e.target.value})),disabled:E,placeholder:"1"})]}),(0,s.jsxs)("div",{className:"sm:col-span-5",children:[(0,s.jsx)(d,{children:"Воронка"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.t1.pipeline||"",onChange:e=>D("t1",{pipeline:e.target.value}),disabled:E,children:[(0,s.jsx)("option",{value:"",children:"—"}),i.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsxs)("div",{className:"sm:col-span-5",children:[(0,s.jsx)(d,{children:"Статус"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.t1.status||"",onChange:e=>D("t1",{status:e.target.value}),disabled:E||!y.t1.pipeline,children:[(0,s.jsx)("option",{value:"",children:"—"}),w.map(e=>(0,s.jsx)("option",{value:e.id,children:u(e)},e.id))]}),(0,s.jsx)(r,{target:y.t1})]})]})}),(0,s.jsx)(a,{title:"Варіант №2",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-12 gap-3",children:[(0,s.jsxs)("div",{className:"sm:col-span-2",children:[(0,s.jsx)(d,{children:"Значення"}),(0,s.jsx)("input",{className:"w-full rounded-lg border px-3 py-2",value:y.v2,onChange:e=>S(l=>({...l,v2:e.target.value})),disabled:E,placeholder:"2"})]}),(0,s.jsxs)("div",{className:"sm:col-span-5",children:[(0,s.jsx)(d,{children:"Воронка"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.t2.pipeline||"",onChange:e=>D("t2",{pipeline:e.target.value}),disabled:E,children:[(0,s.jsx)("option",{value:"",children:"—"}),i.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsxs)("div",{className:"sm:col-span-5",children:[(0,s.jsx)(d,{children:"Статус"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.t2.status||"",onChange:e=>D("t2",{status:e.target.value}),disabled:E||!y.t2.pipeline,children:[(0,s.jsx)("option",{value:"",children:"—"}),C.map(e=>(0,s.jsx)("option",{value:e.id,children:u(e)},e.id))]}),(0,s.jsx)(r,{target:y.t2})]})]})}),(0,s.jsx)(a,{title:"Expire",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-12 gap-3",children:[(0,s.jsxs)("div",{className:"sm:col-span-2",children:[(0,s.jsx)(d,{children:"Кількість днів до експірації"}),(0,s.jsx)("input",{type:"number",min:0,className:"w-full rounded-lg border px-3 py-2",value:null!==(e=y.expDays)&&void 0!==e?e:"",onChange:e=>S(l=>({...l,expDays:""===e.target.value?"":Number(e.target.value)})),disabled:E,placeholder:"7"})]}),(0,s.jsxs)("div",{className:"sm:col-span-5",children:[(0,s.jsx)(d,{children:"Воронка"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.texp.pipeline||"",onChange:e=>D("texp",{pipeline:e.target.value}),disabled:E,children:[(0,s.jsx)("option",{value:"",children:"—"}),i.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsxs)("div",{className:"sm:col-span-5",children:[(0,s.jsx)(d,{children:"Статус"}),(0,s.jsxs)("select",{className:"w-full rounded-lg border px-3 py-2",value:y.texp.status||"",onChange:e=>D("texp",{status:e.target.value}),disabled:E||!y.texp.pipeline,children:[(0,s.jsx)("option",{value:"",children:"—"}),k.map(e=>(0,s.jsx)("option",{value:e.id,children:u(e)},e.id))]}),(0,s.jsx)(r,{target:y.texp})]})]})}),P&&(0,s.jsxs)("div",{className:"rounded-lg border border-amber-300 bg-amber-50 px-3 py-2 text-sm text-amber-800",children:["KeyCRM не повернув ",(0,s.jsx)("code",{children:"pipeline_status_id"})," для секцій ",M.join(", "),". Оновіть довідник статусів у розділі \xabDebug\xbb або оберіть інші статуси перед збереженням."]}),f&&(0,s.jsx)("div",{className:"rounded-lg border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700",children:f}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("button",{type:"submit",disabled:E||P,className:"rounded-lg bg-blue-600 text-white px-4 py-2 font-medium shadow hover:bg-blue-700 disabled:opacity-60",children:j?"Збереження…":"Зберегти"}),(0,s.jsx)("button",{type:"button",onClick:()=>l.push("/admin/campaigns"),className:"rounded-lg border px-4 py-2 shadow-sm",children:"Скасувати"})]})]})]})}function m(e){if(!(null==e?void 0:e.pipeline)&&!(null==e?void 0:e.status))return;let l={};return e.pipeline&&(l.pipeline=e.pipeline),e.statusId?l.status=e.statusId:e.pipelineStatusId?l.status=e.pipelineStatusId:e.status&&(l.status=e.status),e.pipelineStatusId&&(l.pipelineStatusId=e.pipelineStatusId),e.pipelineName&&(l.pipelineName=e.pipelineName),e.statusName&&(l.statusName=e.statusName),l}},6463:function(e,l,i){"use strict";var s=i(1169);i.o(s,"useParams")&&i.d(l,{useParams:function(){return s.useParams}}),i.o(s,"useRouter")&&i.d(l,{useRouter:function(){return s.useRouter}}),i.o(s,"useSearchParams")&&i.d(l,{useSearchParams:function(){return s.useSearchParams}})}},function(e){e.O(0,[971,23,744],function(){return e(e.s=3668)}),_N_E=e.O()}]);