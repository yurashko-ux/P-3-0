"use strict";exports.id=4332,exports.ids=[4332],exports.modules={3903:(e,t,r)=>{r.d(t,{b:()=>o});let n=new Set(["id","name","base","rules","v1","v2","texp"]),i=["value","result","data","payload","item","campaign"];function o(e){if(null==e)return null;let t=[e],r=new Set;for(;t.length;){let e=t.pop();if(!(null==e||r.has(e))){if("string"==typeof e){let r=e.trim();if(!r)continue;try{t.push(JSON.parse(r))}catch{}continue}if(Array.isArray(e)){for(let n of(r.add(e),e))t.push(n);continue}if("object"==typeof e){for(let t of(r.add(e),n))if(Object.prototype.hasOwnProperty.call(e,t)){let t=String(e.id||"");return t&&(void 0!==e.v1_count||void 0!==e.movedV1||e.counters)&&console.log(`[campaign-shape] Normalized campaign ${t}:`,{hasV1Count:"v1_count"in e,hasV2Count:"v2_count"in e,hasExpCount:"exp_count"in e,hasMovedV1:"movedV1"in e,hasMovedV2:"movedV2"in e,hasMovedExp:"movedExp"in e,hasCounters:"counters"in e,v1_count:e.v1_count,v2_count:e.v2_count,exp_count:e.exp_count,movedV1:e.movedV1,movedV2:e.movedV2,movedExp:e.movedExp,counters:e.counters}),e}for(let r of i)void 0!==e[r]&&t.push(e[r])}}}return null}},1964:(e,t,r)=>{r.d(t,{Ls:()=>E,Nd:()=>p,Qv:()=>c,Rv:()=>_,SJ:()=>h,_P:()=>R,hC:()=>f,w6:()=>s,xD:()=>u});let n="https://openapi.keycrm.app/v1",i="M2EwMjAwMGE1ZWY4ODhkMzlkYzRiNTU2MDY4ZjZmZDc3ZGJkZjQ3MA",o={KEYCRM_API_URL:n,KEYCRM_API_BASE:n,KEYCRM_BASE_URL:n,KEYCRM_API_TOKEN:i,KEYCRM_TOKEN:i,KEYCRM_BEARER:i,KEYCRM_API_BEARER:i},a={KEYCRM_API_URL:process.env.KEYCRM_API_URL?.trim()||n,KEYCRM_API_TOKEN:process.env.KEYCRM_API_TOKEN?.trim()||process.env.KEYCRM_BEARER?.trim()||i,KEYCRM_BEARER:process.env.KEYCRM_BEARER?.trim()||process.env.KEYCRM_API_TOKEN?.trim()||i,ALTEGIO_API_URL:process.env.ALTEGIO_API_URL?.trim()||"",ALTEGIO_APPLICATION_ID:process.env.ALTEGIO_APPLICATION_ID?.trim()||"",ALTEGIO_PARTNER_ID:process.env.ALTEGIO_PARTNER_ID?.trim()||"",ALTEGIO_PARTNER_TOKEN:process.env.ALTEGIO_PARTNER_TOKEN?.trim()||"",ALTEGIO_USER_TOKEN:process.env.ALTEGIO_USER_TOKEN?.trim()||"",ALTEGIO_COMPANY_ID:process.env.ALTEGIO_COMPANY_ID?.trim()||""};function s(){if(!a.KEYCRM_API_URL)throw Error("Missing env KEYCRM_API_URL");if(!a.KEYCRM_API_TOKEN)throw Error("Missing env KEYCRM_API_TOKEN")}function l(e){return e.toLowerCase().startsWith("bearer ")?e:`Bearer ${e}`}function u(){return{Accept:"application/json","Content-Type":"application/json",Authorization:l(a.KEYCRM_BEARER)}}function c(e){let t=a.KEYCRM_API_URL.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}function _(){return a.KEYCRM_API_URL}function f(){return l(a.KEYCRM_BEARER)}function E(){return a.KEYCRM_API_TOKEN}let p={API_URL:n,API_TOKEN:i},d=new Map;for(let[e,t]of Object.entries(process.env))d.set(e.toLowerCase(),t);function m(e){if("string"!=typeof e)return;let t=e.trim();return t.length>0?t:void 0}function h(...e){for(let t of e){let e=m(process.env[t]);if(void 0!==e)return e}for(let t of e){let e=m(d.get(t.toLowerCase()));if(void 0!==e)return e}for(let t of e){let e=o[t.toUpperCase()];if(e)return e}}function R(...e){return void 0!==h(...e)}},4332:(e,t,r)=>{r.r(t),r.d(t,{campaignKeys:()=>o,expTrackingKeys:()=>s,getKvConfigStatus:()=>u,keycrmKeys:()=>a,kvRead:()=>d,kvWrite:()=>m});var n=r(1964),i=r(3903);let o={INDEX_KEY:"campaign:index",ITEM_KEY:e=>`campaign:${e}`,LEGACY_INDEX_KEY:"campaigns:index",LEGACY_ITEM_KEY:e=>`campaigns:${e}`,CMP_INDEX_KEY:"cmp:ids",CMP_INDEX_LIST_KEY:"cmp:ids:list",CMP_ITEM_KEY:e=>`cmp:item:${e}`},a={PIPELINES_SNAPSHOT_KEY:"keycrm:pipelines:snapshot"},s={TRACK_KEY:(e,t)=>`exp:track:${e}:${t}`};function l(){let e=n.SJ("KV_REST_API_URL","VERCEL_KV_REST_API_URL","VERCEL_KV_URL","KV_URL")?.trim()??"",t=n.SJ("KV_REST_API_TOKEN","VERCEL_KV_REST_API_TOKEN","KV_REST_API_WRITE_ONLY_TOKEN","KV_WRITE_ONLY_TOKEN","KV_TOKEN")?.trim()??null,r=n.SJ("KV_REST_API_READ_ONLY_TOKEN","VERCEL_KV_REST_API_READ_ONLY_TOKEN","KV_READ_ONLY_TOKEN","KV_REST_API_TOKEN","VERCEL_KV_REST_API_TOKEN","KV_TOKEN")?.trim()??t,i=function(e){let t=[],r=new Set,n=e=>{if(!e)return;let n=e.replace(/\s+$/,"").replace(/\/+$/,"");n&&(r.has(n)||(r.add(n),t.push(n)))},i=function(e){if(!e)return null;let t=e.trim();if(!t)return null;try{return new URL(t).origin}catch{}if(!/^https?:\/\//i.test(t))return null;let r=t.replace(/\s+$/,"");r=r.replace(/\/+$/,"");let n=[/\/v0\/kv$/i,/\/kv$/i,/\/v0$/i],i=!0;for(;i;)for(let e of(i=!1,n))e.test(r)&&(r=r.replace(e,""),i=!0);return r||null}(e);n(i),i&&n(`${i}/v0/kv`);let o=e.trim();if(o){let e=o.replace(/\s+$/,"").replace(/\/+$/,"");n(e),/\/v0\/kv$/i.test(e)||n(`${e}/v0/kv`);let t=e.toLowerCase();t.endsWith("/v0/kv")&&n(e.slice(0,-6)),t.endsWith("/kv")&&n(e.slice(0,-3)),t.endsWith("/v0")&&n(e.slice(0,-3))}return t}(e);return{rawBase:e,baseCandidates:i,writeToken:t,readToken:r??null}}function u(){let{baseCandidates:e,writeToken:t,readToken:r}=l();return{hasBaseUrl:e.length>0,baseCandidates:e.slice(),hasWriteToken:!!t,hasReadToken:!!r}}async function c(e,t={},r=!1,n=!1){let{baseCandidates:i,writeToken:o,readToken:a}=l();if(!i.length)throw Error("KV_REST_API_URL missing");let s=r?a:o;if(!s)throw Error(r?"KV_REST_API_READ_ONLY_TOKEN missing":"KV_REST_API_TOKEN missing");let u={"Content-Type":"application/json",Authorization:`Bearer ${s}`},c=null,_=null;for(let r=0;r<i.length;r+=1){let o;let a=i[r],s=a.endsWith("/")?a:`${a}/`,l=new URL(e.replace(/^\/+/,""),s).toString();try{o=await fetch(l,{...t,headers:u,cache:"no-store"})}catch(e){c=Error(`KV request failed for ${l}: ${e instanceof Error?e.message:String(e)}`);continue}if(o.ok)return o;if(404===o.status){n&&!_&&(_=o.clone()),c=Error(`KV responded with 404 at ${l}`);continue}let f=Error(`KV responded with ${o.status} at ${l}`);throw f.status=o.status,f}if(n)return _??new Response(null,{status:404});throw c??Error("KV request failed")}async function _(e){let{baseCandidates:t,readToken:r}=l();if(!t.length||!r)return null;let n=await c(`get/${encodeURIComponent(e)}`,{},!0,!0).catch(()=>null);if(!n||404===n.status)return null;let i="";try{i=await n.text()}catch{return null}if(!i)return null;try{let e=JSON.parse(i);if("string"==typeof e)return e;if(e&&"object"==typeof e){let t=e.result??e.value??e.data??null;if("string"==typeof t)return t;if(t&&"object"==typeof t){let e=t.value??t.result??null;if("string"==typeof e)return e;if(e&&"object"==typeof e)try{return JSON.stringify(e)}catch{}try{return JSON.stringify(t)}catch{}}}}catch{}if(/^[A-Za-z0-9+/=]+$/.test(i)&&i.length%4==0)try{let e=Buffer.from(i,"base64").toString("utf8");if(e)return e}catch{}return i}async function f(e,t){let{baseCandidates:r,writeToken:n}=l();if(!r.length)throw Error("KV_REST_API_URL missing");if(!n)throw Error("KV_REST_API_TOKEN missing");let i=JSON.stringify({value:t});try{await c(`set/${encodeURIComponent(e)}`,{method:"POST",body:i});return}catch(t){let e="number"==typeof t?.status?t.status:null;if(405!==e&&400!==e&&501!==e)throw t}await c(`set/${encodeURIComponent(e)}`,{method:"PUT",body:i})}async function E(e,t=0,r=-1){let{baseCandidates:n,readToken:i}=l();if(!n.length||!i)return[];let o=await c(`lrange/${encodeURIComponent(e)}/${t}/${r}`,{},!0,!0).catch(()=>null);if(!o)return[];let a="";try{a=await o.text()}catch{return[]}let s=null;try{s=JSON.parse(a)}catch{s=a}let u=[];if(Array.isArray(s))u=s;else if(s&&Array.isArray(s.result))u=s.result;else if(s&&Array.isArray(s.data))u=s.data;else if("string"==typeof s)try{let e=JSON.parse(s);Array.isArray(e)?u=e:e&&Array.isArray(e.result)?u=e.result:e&&Array.isArray(e.data)&&(u=e.data)}catch{}return u.map(e=>{if("string"==typeof e)return e;let t=e?.value??e?.member??e?.id??"";if(!t)return"";if("string"==typeof t)return t;try{return JSON.stringify(t)}catch{return""}}).filter(e=>!!e&&"[object Object]"!==e).map(String)}function p(e){if(null==e)return null;let t="string"==typeof e?e.trim():"number"==typeof e&&Number.isFinite(e)?String(e):"";return t?function e(t,r=6){if(null==t||r<=0)return"";if("number"==typeof t)return String(t);if("string"==typeof t){let n=t.trim();for(let t=0;t<5;t++)try{let t=JSON.parse(n);if("string"==typeof t||"number"==typeof t)return e(t,r-1);if(t&&"object"==typeof t){let n=t.value??t.id??t.member??"";if(n)return e(n,r-1)}break}catch{break}let i=(n=n.replace(/\\+/g,"").replace(/^"+|"+$/g,"")).match(/\d{10,}/);return i?i[0]:""}return"object"==typeof t?e(t.value??t.id??t.member??"",r-1):""}(t)||t:null}let d={getRaw:async e=>_(e),lrange:async(e,t=0,r=-1)=>E(e,t,r),keycrmPipelinesSnapshot:async()=>(function(e){if(!e)return null;try{let t=JSON.parse(e);if(!t||"object"!=typeof t)return null;let r=Array.isArray(t.pipelines)?t.pipelines:null;if(!r)return null;let n="string"==typeof t.fetchedAt?t.fetchedAt:new Date().toISOString(),i=t.storedAt,o="number"==typeof i&&Number.isFinite(i)?i:Date.now();return{pipelines:r,fetchedAt:n,storedAt:o}}catch{return null}})(await _(a.PIPELINES_SNAPSHOT_KEY)),async listCampaigns(){let e=[],t=new Map,r=r=>{let n=p(r);if(!n||/[\[\]\{\}]/.test(n))return;t.has(n)||(t.set(n,new Set),e.push(n));let i=t.get(n);if(i.add(n),"string"==typeof r){let e=r.trim();e&&e!==n&&!/[\[\]\{\}]/.test(e)&&i.add(e)}},n=async e=>{if(e!==o.CMP_INDEX_KEY)try{for(let t of(await E(e,0,-1)))r(t)}catch(t){let e=t instanceof Error?t.message:String(t);if(!/WRONGTYPE/i.test(e))throw t}let t=await _(e);if(t)for(let e of function(e){let t=[],r=[e],n=new Set;for(;r.length;){let e=r.pop();if(!(null==e||n.has(e))){if("string"==typeof e){let n=e.trim();if(!n)continue;t.push(n);try{r.push(JSON.parse(n))}catch{}continue}if("number"==typeof e&&Number.isFinite(e)){t.push(String(e));continue}if(Array.isArray(e)){for(let t of e)r.push(t);continue}if("object"==typeof e)for(let t of(n.add(e),["value","result","data","items","ids","list","members"]))t in e&&r.push(e[t])}}return t}(t))r(e)};for(let e of[o.CMP_INDEX_KEY,o.INDEX_KEY,o.LEGACY_INDEX_KEY,o.CMP_INDEX_LIST_KEY])await n(e);let a=[o.ITEM_KEY,o.CMP_ITEM_KEY,o.LEGACY_ITEM_KEY],s=[];for(let r of e){let e=Array.from(t.get(r)??new Set([r])),n=[],o=new Set,l=e=>{o.has(e)||(o.add(e),n.push(e))};for(let t of e)for(let e of a)l(e(t));for(let e of a)l(e(r));let u=null;for(let e of n){let t=await _(e);if("1763679050915"===r&&console.log(`[kv] listCampaigns: checking key ${e} (order ${n.indexOf(e)})`,{hasRaw:!!t,rawLength:t?t.length:0,rawPreview:t?t.slice(0,100):null}),!t)continue;let o=(0,i.b)(t);if(o){let r=String(o.id||"");"1763679050915"===r&&console.log(`[kv] listCampaigns: checking key ${e} (order ${n.indexOf(e)})`,{foundRaw:!!t,foundCandidate:!!o,v1_count:o.v1_count,movedV1:o.movedV1,movedTotal:o.movedTotal}),r&&(void 0!==o.v1_count||void 0!==o.movedV1||o.counters)&&console.log(`[kv] listCampaigns found campaign ${r}:`,{key:e,keyOrder:n.indexOf(e),allKeys:n,hasV1Count:"v1_count"in o,hasV2Count:"v2_count"in o,hasExpCount:"exp_count"in o,hasMovedV1:"movedV1"in o,hasMovedV2:"movedV2"in o,hasMovedExp:"movedExp"in o,hasCounters:"counters"in o,v1_count:o.v1_count,v2_count:o.v2_count,exp_count:o.exp_count,movedV1:o.movedV1,movedV2:o.movedV2,movedExp:o.movedExp,counters:o.counters}),u=o;break}}if(!u)continue;let c=p(u.id)??r;if(u.__index_id=r,u.id=c??r,!u.created_at){let e=Number(u.id);Number.isFinite(e)&&(u.created_at=e)}s.push(u)}return s}},m={setRaw:async(e,t)=>f(e,t),async lpush(e,t){let{baseCandidates:r,writeToken:n}=l();if(!r.length)throw Error("KV_REST_API_URL missing");if(!n)throw Error("KV_REST_API_TOKEN missing");let i=JSON.stringify({value:t});try{await c(`lpush/${encodeURIComponent(e)}`,{method:"POST",body:i});return}catch(t){let e="number"==typeof t?.status?t.status:null;if(405!==e&&400!==e&&501!==e)throw t}await c(`lpush/${encodeURIComponent(e)}`,{method:"PUT",body:i})},async ltrim(e,t,r){let{baseCandidates:n,writeToken:i}=l();if(!n.length)throw Error("KV_REST_API_URL missing");if(!i)throw Error("KV_REST_API_TOKEN missing");try{await c(`ltrim/${encodeURIComponent(e)}/${t}/${r}`,{method:"POST"});return}catch(t){let e="number"==typeof t?.status?t.status:null;if(405!==e&&400!==e&&501!==e)throw t}await c(`ltrim/${encodeURIComponent(e)}/${t}/${r}`,{method:"PUT"})},async createCampaign(e){let t=String(e?.id||Date.now()),r="number"==typeof e?.created_at?e.created_at:Number(t)&&Number.isFinite(Number(t))?Number(t):Date.now(),n={id:t,name:e?.name||"UI-created",created_at:r,active:!!e?.active,base_pipeline_id:e?.base_pipeline_id??null,base_status_id:e?.base_status_id??null,base_pipeline_name:e?.base_pipeline_name??null,base_status_name:e?.base_status_name??null,rules:e?.rules||{},exp:e?.exp||{},v1_count:Number(e?.v1_count??0),v2_count:Number(e?.v2_count??0),exp_count:Number(e?.exp_count??0),deleted:!1};return await f(o.ITEM_KEY(t),JSON.stringify(n)),await c(`lpush/${encodeURIComponent(o.INDEX_KEY)}`,{method:"POST",body:JSON.stringify({value:t})}).catch(()=>{}),n},async keycrmPipelinesSnapshot(e){let t=JSON.stringify({...e,storedAt:e.storedAt??Date.now()});await f(a.PIPELINES_SNAPSHOT_KEY,t)},async setExpTracking(e,t,r){let n=s.TRACK_KEY(e,t),i=JSON.stringify({campaignId:e,cardId:t,timestamp:r.timestamp,basePipelineId:r.basePipelineId,baseStatusId:r.baseStatusId});await f(n,i)},async getExpTracking(e,t){let r=s.TRACK_KEY(e,t),n=await d.getRaw(r);if(!n)return null;try{return JSON.parse(n)}catch{return null}},async deleteExpTracking(e,t){let r=s.TRACK_KEY(e,t),{baseCandidates:n,writeToken:i}=l();if(n.length&&i)try{await c(`del/${encodeURIComponent(r)}`,{method:"POST"})}catch{}}}}};