"use strict";exports.id=7985,exports.ids=[7985,1916,7560],exports.modules={7985:(e,t,a)=>{a.d(t,{X:()=>o,initializeCampaignStats:()=>u,updateCampaignBaseCardsCount:()=>l});var s=a(1964),r=a(4332),i=a(7560),n=a(3903);async function o(e,t){if(!e||!t)return 0;let a=Number(e),r=Number(t);if(!Number.isFinite(a)||!Number.isFinite(r))return 0;let i=0;try{for(let e=1;e<=20;e++){let t=new URLSearchParams;t.set("page[number]",String(e)),t.set("page[size]",String(50)),t.set("filter[pipeline_id]",String(a)),t.set("filter[status_id]",String(r)),t.set("pipeline_id",String(a)),t.set("status_id",String(r));let n=(0,s.Qv)(`/pipelines/cards?${t.toString()}`),o=await fetch(n,{headers:(0,s.xD)(),cache:"no-store"});if(!o.ok){if(404===o.status||e>1)break;let t=await o.text().catch(()=>"");throw Error(`KeyCRM API error: ${o.status} ${o.statusText} - ${t.slice(0,200)}`)}let l=await o.json(),u=Array.isArray(l)?l:Array.isArray(l?.data)?l.data:[];if(0===u.length)break;let d=u.filter(e=>{let t=e?.pipeline_id??e?.pipeline?.id??e?.pipeline_id??e?.attributes?.pipeline_id??e?.data?.pipeline_id,s=e?.status_id??e?.status?.id??e?.status_id??e?.attributes?.status_id??e?.data?.status_id,i="number"==typeof t?t:Number(t),n="number"==typeof s?s:Number(s),o=Number.isFinite(i)&&i===a,l=Number.isFinite(n)&&n===r;return o&&l});if(i+=d.length,!(l?.links?.next||l?.next_page_url||(l?.meta?.current_page??l?.current_page??e)<(l?.meta?.last_page??l?.last_page??e)))break}}catch(e){return 0}return i}async function l(e){try{let t=[r.campaignKeys.ITEM_KEY(e),r.campaignKeys.CMP_ITEM_KEY(e),r.campaignKeys.LEGACY_ITEM_KEY(e)],a=null,s=null;for(let e of t)try{if(a=await i.kv.get(e)){if(!(a=(0,n.b)(a)))continue;s=e;break}}catch{}if(!a){let e=null;for(let a of t)if(e=await r.kvRead.getRaw(a)){s=a;break}if(!e||!s)return null;let i=(0,n.b)(e);if(!i||!(a=i)||"object"!=typeof a||Array.isArray(a))return null}if(!a)return null;let l=a.base?.pipelineId||a.base?.pipeline_id||a.base?.pipeline||a.base_pipeline_id||a.base_pipelineId,u=a.base?.statusId||a.base?.status_id||a.base?.status||a.base_status_id||a.baseStatusId;if(!l||!u)return null;let d="number"==typeof a.counters?.v1?a.counters.v1:a.v1_count||0,p="number"==typeof a.counters?.v2?a.counters.v2:a.v2_count||0,c="number"==typeof a.counters?.exp?a.counters.exp:a.exp_count||0,_=d+p+c,b=await o(l,u);"number"!=typeof a.baseCardsCountInitial&&(a.baseCardsCountInitial=b),"number"!=typeof a.baseCardsTotalPassed&&(a.baseCardsTotalPassed=a.baseCardsCountInitial||0),"number"==typeof a.baseCardsCount?a.baseCardsCount:a.baseCardsCountInitial,a.baseCardsCount=b,a.baseCardsCountUpdatedAt=Date.now();let f=b+_,v="number"==typeof a.baseCardsTotalPassed?a.baseCardsTotalPassed:(a.baseCardsCountInitial||0)+_;if(a.baseCardsTotalPassed=Math.max(v,f),a.movedTotal=d+p+c,a.movedV1=d,a.movedV2=p,a.movedExp=c,s)try{await i.kv.set(s,a)}catch{await r.kvWrite.setRaw(s,JSON.stringify(a))}else for(let e of t)try{await i.kv.set(e,a);break}catch{try{await r.kvWrite.setRaw(e,JSON.stringify(a));break}catch{}}return b}catch(e){return null}}async function u(e){let t=e.base?.pipelineId||e.base?.pipeline_id||e.base?.pipeline||e.base_pipeline_id||e.base_pipelineId,a=e.base?.statusId||e.base?.status_id||e.base?.status||e.base_status_id||e.baseStatusId;if(!t||!a)return{...e,baseCardsCount:0,baseCardsCountInitial:0,baseCardsTotalPassed:0,baseCardsCountUpdatedAt:Date.now(),movedTotal:0,movedV1:0,movedV2:0,movedExp:0};let s=await o(t,a),r=e.counters?.v1||e.v1_count||0,i=e.counters?.v2||e.v2_count||0,n=e.counters?.exp||e.exp_count||0;return{...e,baseCardsCount:s,baseCardsCountInitial:s,baseCardsTotalPassed:s,baseCardsCountUpdatedAt:Date.now(),movedTotal:r+i+n,movedV1:r,movedV2:i,movedExp:n}}},7560:(e,t,a)=>{a.d(t,{kv:()=>o});var s=a(242),r=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var i=class extends s.Redis{async *scanIterator(e){let t,a=0;do for(let s of([a,t]=await this.scan(a,e),t))yield s;while(0!==a)}async *hscanIterator(e,t){let a,s=0;do for(let r of([s,a]=await this.hscan(e,s,t),a))yield r;while(0!==s)}async *sscanIterator(e,t){let a,s=0;do for(let r of([s,a]=await this.sscan(e,s,t),a))yield r;while(0!==s)}async *zscanIterator(e,t){let a,s=0;do for(let r of([s,a]=await this.zscan(e,s,t),a))yield r;while(0!==s)}};function n(e){return new i({cache:"default",...e})}new Proxy({},{get(e,t,a){if("then"===t||"parse"===t)return Reflect.get(e,t,a);if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}});var o=new Proxy({},{get(e,t){if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}})}};