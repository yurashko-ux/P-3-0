"use strict";exports.id=1916,exports.ids=[1916],exports.modules={7985:(e,t,a)=>{a.d(t,{X:()=>u,initializeCampaignStats:()=>o,updateCampaignBaseCardsCount:()=>d});var s=a(1964),i=a(4332),r=a(7560),n=a(3903);async function u(e,t){if(!e||!t)return 0;let a=Number(e),i=Number(t);if(!Number.isFinite(a)||!Number.isFinite(i))return 0;let r=0;try{for(let e=1;e<=20;e++){let t=new URLSearchParams;t.set("page[number]",String(e)),t.set("page[size]",String(50)),t.set("filter[pipeline_id]",String(a)),t.set("filter[status_id]",String(i)),t.set("pipeline_id",String(a)),t.set("status_id",String(i));let n=(0,s.Qv)(`/pipelines/cards?${t.toString()}`),u=await fetch(n,{headers:(0,s.xD)(),cache:"no-store"});if(!u.ok){if(404===u.status||e>1)break;let t=await u.text().catch(()=>"");throw Error(`KeyCRM API error: ${u.status} ${u.statusText} - ${t.slice(0,200)}`)}let d=await u.json(),o=Array.isArray(d)?d:Array.isArray(d?.data)?d.data:[];if(0===o.length)break;let l=o.filter(e=>{let t=e?.pipeline_id??e?.pipeline?.id??e?.pipeline_id??e?.attributes?.pipeline_id??e?.data?.pipeline_id,s=e?.status_id??e?.status?.id??e?.status_id??e?.attributes?.status_id??e?.data?.status_id,r="number"==typeof t?t:Number(t),n="number"==typeof s?s:Number(s),u=Number.isFinite(r)&&r===a,d=Number.isFinite(n)&&n===i;return u&&d});if(r+=l.length,!(d?.links?.next||d?.next_page_url||(d?.meta?.current_page??d?.current_page??e)<(d?.meta?.last_page??d?.last_page??e)))break}}catch(e){return 0}return r}async function d(e){try{let t=[i.campaignKeys.ITEM_KEY(e),i.campaignKeys.CMP_ITEM_KEY(e),i.campaignKeys.LEGACY_ITEM_KEY(e)],a=null,s=null;for(let e of t)try{if(a=await r.kv.get(e)){if(!(a=(0,n.b)(a)))continue;s=e;break}}catch{}if(!a){let e=null;for(let a of t)if(e=await i.kvRead.getRaw(a)){s=a;break}if(!e||!s)return null;let r=(0,n.b)(e);if(!r||!(a=r)||"object"!=typeof a||Array.isArray(a))return null}if(!a)return null;let d=a.base?.pipelineId||a.base?.pipeline_id||a.base?.pipeline||a.base_pipeline_id||a.base_pipelineId,o=a.base?.statusId||a.base?.status_id||a.base?.status||a.base_status_id||a.baseStatusId;if(!d||!o)return null;let l="number"==typeof a.counters?.v1?a.counters.v1:a.v1_count||0,p="number"==typeof a.counters?.v2?a.counters.v2:a.v2_count||0,b="number"==typeof a.counters?.exp?a.counters.exp:a.exp_count||0,c=l+p+b,C=await u(d,o);"number"!=typeof a.baseCardsCountInitial&&(a.baseCardsCountInitial=C),"number"!=typeof a.baseCardsTotalPassed&&(a.baseCardsTotalPassed=a.baseCardsCountInitial||0),"number"==typeof a.baseCardsCount?a.baseCardsCount:a.baseCardsCountInitial,a.baseCardsCount=C,a.baseCardsCountUpdatedAt=Date.now();let _=C+c,f="number"==typeof a.baseCardsTotalPassed?a.baseCardsTotalPassed:(a.baseCardsCountInitial||0)+c;if(a.baseCardsTotalPassed=Math.max(f,_),a.movedTotal=l+p+b,a.movedV1=l,a.movedV2=p,a.movedExp=b,s)try{await r.kv.set(s,a)}catch{await i.kvWrite.setRaw(s,JSON.stringify(a))}else for(let e of t)try{await r.kv.set(e,a);break}catch{try{await i.kvWrite.setRaw(e,JSON.stringify(a));break}catch{}}return C}catch(e){return null}}async function o(e){let t=e.base?.pipelineId||e.base?.pipeline_id||e.base?.pipeline||e.base_pipeline_id||e.base_pipelineId,a=e.base?.statusId||e.base?.status_id||e.base?.status||e.base_status_id||e.baseStatusId;if(!t||!a)return{...e,baseCardsCount:0,baseCardsCountInitial:0,baseCardsTotalPassed:0,baseCardsCountUpdatedAt:Date.now(),movedTotal:0,movedV1:0,movedV2:0,movedExp:0};let s=await u(t,a),i=e.counters?.v1||e.v1_count||0,r=e.counters?.v2||e.v2_count||0,n=e.counters?.exp||e.exp_count||0;return{...e,baseCardsCount:s,baseCardsCountInitial:s,baseCardsTotalPassed:s,baseCardsCountUpdatedAt:Date.now(),movedTotal:i+r+n,movedV1:i,movedV2:r,movedExp:n}}}};