"use strict";exports.id=6550,exports.ids=[6550],exports.modules={6195:(e,t,i)=>{function s(e){let t=String(e?.username??"").trim()||null,i=t?t.replace(/^@+/,"").toLowerCase():null,s=String(e?.first_name??"").trim(),r=String(e?.last_name??"").trim(),a=([String(e?.name??"").trim(),String(e?.full_name??"").trim(),[s,r].filter(Boolean).join(" ").trim()].filter(Boolean)[0]??"").trim();return{handle:i,handleRaw:t,text:String(e?.text??"").trim(),fullName:a}}i.d(t,{m:()=>s})},296:(e,t,i)=>{i.d(t,{l:()=>f});var s=i(1964);let r=(e,t,i)=>Math.max(t,Math.min(i,e)),a=e=>(e??"").trim().toLowerCase(),n=e=>{let t=a(e);if(!t||!(t=t.replace(/^@+/,"")))return"";let i=(t=(t=t.replace(/^https?:\/\//,"")).replace(/^www\./,"")).indexOf("#");-1!==i&&(t=t.slice(0,i));let s=t.indexOf("?");if(-1!==s&&(t=t.slice(0,s)),!(t=t.replace(/\/+$/,"")))return"";let r=t.split("/").filter(Boolean);return r.length>=2?r[r.length-1]:r[0]??t},l=e=>{if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){let t=e.trim();if(!t)return null;let i=Number(t);return Number.isFinite(i)?i:null}return null};class u extends Error{constructor(e,t,i,s){let r=`KeyCRM ${e} ${t}`.trim();super(i?`${r}: ${i}`:r),this.name="KeycrmHttpError",this.status=e,this.responseBody=i,this.retryAfter=s}}function o(e){let t=[],i=e?.contact??null,s=[];for(let[r,a]of(e?.client&&s.push(e.client),i?.client&&s.push(i.client),i&&(null!=i.full_name&&t.push({path:"contact.full_name",value:String(i.full_name)}),null!=i.social_id&&t.push({path:"contact.social_id",value:String(i.social_id)})),s.entries()))if(a){if(null!=a.full_name){let e=s.length>1?`#${r}`:"";t.push({path:`client${e}.full_name`,value:String(a.full_name)})}if(null!=a.social_id){let e=s.length>1?`#${r}`:"";t.push({path:`client${e}.social_id`,value:String(a.social_id)})}if(Array.isArray(a.profiles)){let e=s.length>1?`#${r}`:"";for(let i of a.profiles)if(i?.value!=null){let s=i?.id!=null?i.id:"?";t.push({path:`client${e}.profiles[${s}].value`,value:String(i.value)})}}}return t}function p(e,t){let i=a(e),s=n(e);if(!i&&!s)return null;for(let e of t){if(!e.path.includes("social_id"))continue;let t=e.value??"",i=n(t);if(s&&i&&i===s)return{field:e.path,value:t}}if(s)return null;for(let e of t){let t=e.value??"",s=a(t);if(i&&s&&s===i)return{field:e.path,value:t}}return null}async function c(e,t,i,r){let a=()=>{let i=new URLSearchParams;for(let s of(i.set("page[number]",String(e)),i.set("page[size]",String(t)),null!=r&&i.set("filter[status_id]",String(r)),["contact","contact.client","status"]))i.append("include[]",s),i.append("with[]",s);return i},n=[];null!=i&&n.push({path:`/pipelines/${encodeURIComponent(String(i))}/cards`}),n.push({path:"/pipelines/cards",configure:e=>{null!=i&&e.set("filter[pipeline_id]",String(i))}});let l=null;for(let r of n){let n=a();r.configure&&r.configure(n);let o=await fetch((0,s.Qv)(`${r.path}?${n.toString()}`),{headers:(0,s.xD)(),cache:"no-store"});if(!o.ok){let e=await o.text().catch(()=>""),t=new u(o.status,o.statusText,e,o.headers.get("retry-after"));if(null!=i&&"/pipelines/cards"!==r.path&&404===o.status){l=t;continue}throw t}let p=await o.json(),c=Array.isArray(p)?p:Array.isArray(p?.data)?p.data:[],d=(()=>{if(p?.links?.next||p?.next_page_url)return!0;let i=Number(p?.meta?.current_page??p?.current_page??e),s=Number(p?.meta?.last_page??p?.last_page??i);return Number.isFinite(i)&&Number.isFinite(s)?i<s:c.length===t})();return{data:c,hasNext:d}}throw l??new u(404,"Not Found","",null)}async function d(e){let t=await fetch((0,s.Qv)(`/pipelines/cards/${e}`),{headers:(0,s.xD)(),cache:"no-store"});if(!t.ok){let e=await t.text().catch(()=>"");throw new u(t.status,t.statusText,e,t.headers.get("retry-after"))}return await t.json()}async function f(e){let t=(e.needle??"").trim(),i=0===t.length;try{(0,s.w6)()}catch(e){return{ok:!1,error:"keycrm_env_missing",details:e instanceof Error?e.message:e}}let a=r(e.perPage??50,1,100),n=r(e.maxPages??20,1,100),f=l(e.pipelineId),m=l(e.statusId),h=0,g=0,y=[];try{for(let e=1;e<=n;e++){let{data:s,hasNext:r}=await c(e,a,f,m);for(let r of(h=e,s)){let e=l(r?.pipeline_id??r?.pipeline?.id),s=l(r?.status_id??r?.status?.id),u=null==f||e===f||null==e,c=null==m||s===m||null==s;if(!u||!c)continue;let _={cardId:Number(r?.id??NaN),title:r?.title??null,pipelineId:e,pipelineTitle:r?.pipeline?.title??r?.pipeline_title??null??null,statusId:s,statusTitle:r?.status?.title??r?.status_title??null??null,contactName:r?.contact?.full_name??null,contactSocialId:r?.contact?.social_id??null,clientName:r?.client?.full_name??r?.contact?.client?.full_name??(Array.isArray(r?.clients)&&r.clients[0]?.full_name)??null,clientSocialId:r?.client?.social_id??r?.contact?.client?.social_id??(Array.isArray(r?.clients)&&r.clients[0]?.social_id)??null};Number.isFinite(_.cardId)&&y.push(_);let w=o(r);if(g++,i)continue;let v=p(t,w);if(v)return v.field.includes("social_id"),{ok:!0,needle:t,pagesScanned:h,cardsChecked:g,match:{cardId:Number(r.id),title:r?.title??null,matchedField:v.field,matchedValue:v.value},items:y,filters:{pipelineId:f,statusId:m,perPage:a,maxPages:n}};let S=w.some(e=>e.path.startsWith("client")),I=r?.id!=null&&(0===w.length||!S&&!Array.isArray(r?.client?.profiles));if(!i&&I&&r?.id!=null){let e=await d(r.id),i=o(e),s=p(t,i);if(s)return{ok:!0,needle:t,pagesScanned:h,cardsChecked:g,match:{cardId:Number(e?.id??r?.id),title:e?.title??r?.title??null,matchedField:s.field,matchedValue:s.value},items:y,filters:{pipelineId:f,statusId:m,perPage:a,maxPages:n}}}}if(!r)break}}catch(e){if(e instanceof u){if(429===e.status){let t=e.responseBody;try{t=e.responseBody?JSON.parse(e.responseBody):e.responseBody}catch{t=e.responseBody}return{ok:!1,error:"keycrm_rate_limited",details:{status:e.status,message:e.message,retryAfter:e.retryAfter,response:t}}}return{ok:!1,error:"keycrm_request_failed",details:{status:e.status,message:e.message,response:(()=>{try{return e.responseBody?JSON.parse(e.responseBody):e.responseBody}catch{return e.responseBody}})()}}}return{ok:!1,error:"keycrm_request_failed",details:e instanceof Error?e.message:e}}return{ok:!0,needle:t,pagesScanned:h,cardsChecked:g,match:null,items:y,filters:{pipelineId:f,statusId:m,perPage:a,maxPages:n}}}},6755:(e,t,i)=>{i.d(t,{P:()=>y,w:()=>g});var s=i(1964),r=i(4332);let a=null,n=!1,l=new Map;async function u(){if(!n){n=!0;try{let e=await r.kvRead.keycrmPipelinesSnapshot();if(!e||!Array.isArray(e.pipelines)||0===e.pipelines.length)return;let t=e.fetchedAt??new Date(e.storedAt).toISOString(),i=Date.now()+3e5;for(let s of(a={data:e.pipelines,fetchedAt:t,expiresAt:i},e.pipelines))s?.id&&Array.isArray(s?.statuses)&&s.statuses.length&&c(s,{fetchedAt:t,expiresAt:i,source:"cache"})}catch(e){}}}async function o(e,t){try{await r.kvWrite.keycrmPipelinesSnapshot({pipelines:e,fetchedAt:t,storedAt:Date.now()})}catch(e){}}async function p(e){let t=null;for(let i of[{url:`/pipelines/${e}?with[]=statuses`,kind:"pipeline"},{url:`/pipelines/${e}/statuses`,kind:"statuses"},{url:`/pipeline-statuses?pipeline_id=${e}&per_page=100`,kind:"statuses"},{url:`/statuses?pipeline_id=${e}&per_page=100`,kind:"statuses"}])try{let t=await fetch((0,s.Qv)(i.url),{headers:(0,s.xD)(),cache:"no-store"});if(404===t.status)continue;if(!t.ok){let e=await t.text().catch(()=>""),i=e?`${t.status} ${t.statusText}: ${e}`:`${t.status} ${t.statusText}`;throw Error(`KeyCRM statuses request failed: ${i}`)}let r=await t.json().catch(()=>null);if("pipeline"===i.kind){let e=m(r?.data??r??{});if(e?.statuses.length)return e.statuses;continue}let a=m({id:e,statuses:r??[]});if(a?.statuses.length)return a.statuses}catch(e){t=e}if(t)throw t;return[]}function c(e,t){if(l.set(e.id,{pipeline:e,fetchedAt:t.fetchedAt,expiresAt:t.expiresAt,source:t.source}),!a){a={data:[e],fetchedAt:t.fetchedAt,expiresAt:t.expiresAt};return}let i=a.data.findIndex(t=>t.id===e.id);a={data:(-1===i?[...a.data,e]:a.data.map((t,s)=>s===i?e:t)).sort((e,t)=>{let i=e.position??Number.MAX_SAFE_INTEGER,s=t.position??Number.MAX_SAFE_INTEGER;return i===s?e.id-t.id:i-s}),fetchedAt:t.fetchedAt,expiresAt:t.expiresAt}}function d(e){let t=Number(e);return Number.isFinite(t)?t:null}function f(e){return e?Array.isArray(e)?e:"object"==typeof e?Array.isArray(e.data)?e.data:Array.isArray(e.items)?e.items:Array.isArray(e.list)?e.list:Object.values(e):[]:[]}function m(e){let t=d(e?.id);if(null===t)return null;let i=[...f(e?.statuses),...f(e?.pipeline_statuses),...f(e?.statuses?.data),...f(e?.statuses?.items),...f(e?.statuses?.list),...f(e?.pivot?.statuses)],s=new Set,r=i.map(t=>{let i=d(t?.pivot?.pipeline_status_id)??d(t?.pivot?.status_id)??d(t?.pipeline_status_id),r=d(t?.id),a=d(t?.status_id??t?.status?.id),n=[i,a,r].filter(e=>null!=e);if(!n.length)return null;let l=i??r??a??n[0],u=i??r??a??l,o=d(t?.pipeline_id??t?.pivot?.pipeline_id??e?.id)??null,p=`${l}:${o??""}`;if(s.has(p))return null;s.add(p);let c=Array.from(new Set(n.filter(e=>e!==l)));return{id:l,title:String(t?.title??t?.name??`Статус #${l}`),pipelineId:o,color:t?.color?String(t.color):null,isFinal:"boolean"==typeof t?.is_final?t.is_final:null,position:d(t?.position),statusId:a??(null==i&&null!=r?r:null),pipelineStatusId:u,aliases:c}}).filter(e=>null!==e).sort((e,t)=>(e.position??Number.MAX_SAFE_INTEGER)-(t.position??Number.MAX_SAFE_INTEGER)).filter(e=>null===e.pipelineId||e.pipelineId===t);return{id:t,title:String(e?.title??e?.name??`Воронка #${t}`),color:e?.color?String(e.color):null,isDefault:"boolean"==typeof e?.is_default?e.is_default:null,position:d(e?.position),statuses:r}}function h(e){return e instanceof Error?e.message:String(e)}async function g(e={}){let t=Date.now();if(await u(),!e.forceRefresh&&a&&a.expiresAt>t)return{ok:!0,pipelines:a.data,fetchedAt:a.fetchedAt,source:"cache"};try{(0,s.w6)()}catch(e){if(a)return{ok:!1,error:"keycrm_env_missing",details:h(e),pipelines:a.data,fetchedAt:a.fetchedAt,source:"stale"};return{ok:!1,error:"keycrm_env_missing",details:h(e),pipelines:[],fetchedAt:null,source:"none"}}try{let i=new URLSearchParams;i.append("with[]","statuses"),i.set("per_page","100");let r=await fetch((0,s.Qv)(`/pipelines?${i.toString()}`),{headers:(0,s.xD)(),cache:"no-store"});if(!r.ok){let e=await r.text().catch(()=>""),t=e?`${r.status} ${r.statusText}: ${e}`:`${r.status} ${r.statusText}`;throw Error(`KeyCRM pipelines request failed: ${t}`)}let n=await r.json().catch(()=>null),l=(Array.isArray(n)?n:Array.isArray(n?.data)?n.data:[]).map(m).filter(e=>null!==e).sort((e,t)=>{let i=e.position??Number.MAX_SAFE_INTEGER,s=t.position??Number.MAX_SAFE_INTEGER;return i===s?e.id-t.id:i-s}),u=new Map;for(let e of l)try{let t=await p(e.id);if(!t.length||!t.some(e=>null!==e.pipelineStatusId)&&e.statuses.length&&e.statuses.some(e=>null!==e.pipelineStatusId))continue;u.set(e.id,t)}catch(t){console.warn("Failed to load KeyCRM pipeline statuses",{pipelineId:e.id,error:h(t)})}u.size&&(l=l.map(e=>{let t=u.get(e.id);return t&&t.length?{...e,statuses:t}:e}));let d=new Date().toISOString(),f=t+3e5;for(let e of(a={data:l,fetchedAt:d,expiresAt:f},l))e.statuses.length&&c(e,{fetchedAt:d,expiresAt:f,source:"remote"});return!1!==e.persist&&await o(l,d),{ok:!0,pipelines:l,fetchedAt:d,source:"remote"}}catch(e){if(a)return{ok:!1,error:"keycrm_fetch_failed",details:h(e),pipelines:a.data,fetchedAt:a.fetchedAt,source:"stale"};return{ok:!1,error:"keycrm_fetch_failed",details:h(e),pipelines:[],fetchedAt:null,source:"none"}}}async function y(e,t={}){let i=Date.now();await u();let r=l.get(e);if(!t.forceRefresh&&r&&r.expiresAt>i)return{ok:!0,pipeline:r.pipeline,fetchedAt:r.fetchedAt,source:r.source};if(!t.forceRefresh&&a){let t=a.data.find(t=>t.id===e);if(t&&t.statuses.length){let i={pipeline:t,fetchedAt:a.fetchedAt,expiresAt:a.expiresAt,source:"cache"};return l.set(e,i),{ok:!0,pipeline:i.pipeline,fetchedAt:i.fetchedAt,source:i.source}}}try{(0,s.w6)()}catch(e){if(r)return{ok:!1,error:"keycrm_env_missing",details:h(e),pipeline:r.pipeline,fetchedAt:r.fetchedAt};return{ok:!1,error:"keycrm_env_missing",details:h(e),pipeline:null,fetchedAt:null}}let n=null,o=null;if(r)o=r.pipeline,n=r.fetchedAt;else if(a){let t=a.data.find(t=>t.id===e)??null;t&&(o=t,n=a.fetchedAt)}let d=null,f=[];try{let t=new URLSearchParams;t.append("with[]","statuses");let i=await fetch((0,s.Qv)(`/pipelines/${e}?${t.toString()}`),{headers:(0,s.xD)(),cache:"no-store"});if(404===i.status);else if(i.ok){let e=await i.json().catch(()=>null),t=m(e?.data??e??{});t&&(d=t,f=t.statuses)}else{let e=await i.text().catch(()=>""),t=e?`${i.status} ${i.statusText}: ${e}`:`${i.status} ${i.statusText}`;throw Error(`KeyCRM pipeline request failed: ${t}`)}}catch(t){console.warn("Failed to load KeyCRM pipeline detail",{pipelineId:e,error:h(t)})}if(!d&&o&&(d={...o}),d&&d.statuses.length&&0===f.length&&(f=d.statuses),0===f.length)try{f=await p(e)}catch(t){console.warn("Failed to load KeyCRM pipeline statuses via fallbacks",{pipelineId:e,error:h(t)})}if(!d&&f.length&&(d=o??{id:e,title:`Воронка #${e}`,color:null,isDefault:null,position:null,statuses:[]}),d){let e={...d,statuses:f},t=new Date().toISOString();return c(e,{fetchedAt:t,expiresAt:i+3e5,source:"remote"}),{ok:!0,pipeline:e,fetchedAt:t,source:"remote"}}return{ok:!1,error:"keycrm_pipeline_not_found",pipeline:o,fetchedAt:n}}},1089:(e,t,i)=>{i.d(t,{M:()=>S});var s=i(4332),r=i(6755),a=i(296);let n=e=>null==e?null:"number"==typeof e&&Number.isFinite(e)?String(e):"string"==typeof e&&e.trim()||null,l=e=>"string"==typeof e&&e.trim()||null,u=(e,t)=>{let i=e?.rules?.[t];if(i?.value)return{value:String(i.value),op:"equals"===i.op?"equals":"contains"};let s=e?.[t]?.value??e?.[t]??e?.[`${t}_value`]??e?.[`${t}Value`],r=e?.[`${t}_op`]??e?.[`${t}Op`],a=l(s);return a?{value:a,op:"equals"===r?"equals":"contains"}:null},o=(e,t,i,s,r,a,u)=>{let o=e?.[t]??{},p=n(o?.pipeline)??n(o?.pipeline_id)??n(o?.id)??n(e?.[i]),c=n(o?.status)??n(o?.status_id)??n(o?.id)??n(e?.[s]),d=n(o?.pipeline_status_id)??n(o?.pipelineStatusId)??n(o?.pipeline_status)??n(o?.pipelineStatus)??(u?n(e?.[u]):null)??n(e?.[`${s}_pipeline_status_id`])??n(e?.[`${s}PipelineStatusId`])??n(e?.[`${s}PipelineStatus`])??(u?n(e?.[`${u}Id`]):null),f=[],m=e=>{let t=n(e);t&&(f.includes(t)||f.push(t))};m(o?.status),m(o?.status_id),m(o?.pipeline_status_id),m(o?.pipelineStatusId),m(o?.pipeline_status),m(o?.pipelineStatus),u&&(m(e?.[u]),m(e?.[`${u}Id`]),m(e?.[`${u}_id`])),m(e?.[`${s}_pipeline_status_id`]),m(e?.[`${s}PipelineStatusId`]),m(e?.[`${s}PipelineStatus`]),m(e?.[`${s}_pipeline_status`]),m(e?.[`${s}_status_id`]),m(d);let h=l(o?.pipelineName)??l(o?.pipeline_name)??l(e?.[r??`${i}_name`]),g=l(o?.statusName)??l(o?.status_name)??l(e?.[a??`${s}_name`]),y=d;return!y&&c&&(y=c),y&&!f.includes(y)&&f.push(y),c&&!f.includes(c)&&f.push(c),{pipelineId:p,statusId:c,pipelineStatusId:y,pipelineName:h,statusName:g,statusAliases:f}},p=e=>!!e&&!0!==e.deleted&&!1!==e.active&&!1!==e.enabled,c=(e,t)=>{if(!t||!t.value)return!1;let i=e.toLowerCase(),s=t.value.toLowerCase();return!!s&&("equals"===t.op?i===s:i.includes(s))},d=e=>{if(!e)return;let t=Number(e);return Number.isFinite(t)?t:void 0},f=e=>{let t=new Set,i=[];for(let s of e){let e="string"==typeof s.value?s.value.trim():"";if(!e)continue;let r=`${s.kind}:${e.toLowerCase()}`;t.has(r)||(t.add(r),i.push({kind:s.kind,value:e}))}return i},m=e=>e??{pipelineId:null,statusId:null,pipelineStatusId:null,pipelineName:null,statusName:null,statusAliases:[]},h=e=>"string"!=typeof e?null:e.trim()||null,g=e=>[...e].sort((e,t)=>{let i=e.position??Number.MAX_SAFE_INTEGER,s=t.position??Number.MAX_SAFE_INTEGER;return i===s?e.id-t.id:i-s}),y=(e,t)=>!!e&&!!t&&e.trim().toLowerCase()===t.trim().toLowerCase(),_=(e,t)=>{let i=m(e),s={...i,pipelineStatusId:i.pipelineStatusId??null,statusAliases:Array.isArray(i.statusAliases)?[...i.statusAliases]:[]},r=e=>{let t=n(e);t&&(s.statusAliases.includes(t)||s.statusAliases.push(t))},a=Array.isArray(t)?t:[],l=h(i.pipelineId),u=h(i.pipelineName),o=h(i.statusId),p=h(i.statusName),c=null,d=null,f=e=>a.find(e)??null;if(l&&(c=f(e=>String(e.id)===l)),!c&&u&&(c=f(e=>y(e.title,u))),!c&&l&&(c=f(e=>y(e.title,l))),c&&(o&&(d=c.statuses.find(e=>String(e.id)===o||null!=e.statusId&&String(e.statusId)===o||e.aliases.some(e=>String(e)===o))??null),!d&&p&&(d=c.statuses.find(e=>y(e.title,p))??null)),!c&&(o||p)){let e=a.map(e=>({pipeline:e,status:e.statuses.find(e=>String(e.id)===o||null!=e.statusId&&String(e.statusId)===o||e.aliases.some(e=>String(e)===o))??e.statuses.find(e=>y(e.title,o))??e.statuses.find(e=>y(e.title,p))})).find(e=>e.status);e&&(c=e.pipeline,d=e.status??null)}if(c&&(s.pipelineId=String(c.id),s.pipelineName=c.title??u??i.pipelineName,!d&&o&&(d=c.statuses.find(e=>String(e.id)===o||null!=e.statusId&&String(e.statusId)===o||e.aliases.some(e=>String(e)===o))??null),!d&&p&&(d=c.statuses.find(e=>y(e.title,p))??null)),d&&(null==d.statusId||s.statusId||(s.statusId=String(d.statusId)),s.statusId||(s.statusId=String(d.id)),s.pipelineStatusId=String(d.pipelineStatusId??d.id),s.statusName=d.title??p??i.statusName,null!=d.statusId&&r(d.statusId),null!=d.pipelineStatusId&&r(d.pipelineStatusId),d.aliases.forEach(e=>r(e)),!c)){let e=a.find(e=>e.statuses.some(e=>String(e.id)===String(d?.id)));e&&(s.pipelineId=String(e.id),s.pipelineName=e.title??s.pipelineName)}return s.statusId&&!s.statusAliases.includes(s.statusId)&&s.statusAliases.push(s.statusId),s.pipelineStatusId&&!s.statusAliases.includes(s.pipelineStatusId)&&s.statusAliases.push(s.pipelineStatusId),s},w=e=>({ok:!0,...e}),v=(e,t)=>({ok:!1,error:e,...t?{details:t}:{}});async function S({normalized:e,identityCandidates:t=[],campaigns:i,performMove:n}){let h=(i??await s.kvRead.listCampaigns()).filter(p),y=e.text?.trim()??"",S=null,I=[];for(let e of h){let t=u(e,"v1"),i=u(e,"v2"),s=c(y,t),r=c(y,i);I.push({id:l(e?.id)??l(e?.__index_id)??null,name:l(e?.name),v1:s,v2:r}),!S&&(s&&t?S={campaign:e,route:"v1",rule:t}:r&&i&&(S={campaign:e,route:"v2",rule:i}))}if(!S)return v("campaign_not_found",{normalized:e,matches:I});let A=o(S.campaign,"base","base_pipeline_id","base_status_id","base_pipeline_name","base_status_name","base_pipeline_status_id"),k=o(S.campaign,"v1"===S.route?"t1":"t2","v1"===S.route?"v1_to_pipeline_id":"v2_to_pipeline_id","v1"===S.route?"v1_to_status_id":"v2_to_status_id","v1"===S.route?"v1_to_pipeline_name":"v2_to_pipeline_name","v1"===S.route?"v1_to_status_name":"v2_to_status_name","v1"===S.route?"v1_to_pipeline_status_id":"v2_to_pipeline_status_id"),N=[];try{let e=await (0,r.w)();(N=Array.isArray(e.pipelines)?e.pipelines:[]).length&&(A=_(A,N),!(k=_(k,N)).pipelineId&&A.pipelineId&&(k.pipelineId=A.pipelineId,k.pipelineName=k.pipelineName??A.pipelineName),!k.pipelineStatusId&&k.pipelineId&&(k=_(k,N)))}catch(e){console.warn("Failed to resolve KeyCRM pipelines for ManyChat automation",e)}A?.pipelineStatusId&&!A.statusId&&(A={...A,statusId:A.pipelineStatusId}),k?.pipelineStatusId&&!k.statusId&&(k={...k,statusId:k.pipelineStatusId});let R=new Set,b=e=>{let t=d(e??null);null!=t&&R.add(t)};b(A.pipelineId),b(k.pipelineId);let x=!1;for(let e of R){let t=N.find(t=>t.id===e)??null;if(!t||0===t.statuses.length||t.statuses.every(e=>null==e.pipelineStatusId))try{let t=await (0,r.P)(e);if(!t.ok||!t.pipeline)continue;N=g([...N.filter(e=>e.id!==t.pipeline.id),t.pipeline]),x=!0}catch(t){console.warn("Failed to hydrate KeyCRM pipeline detail for ManyChat automation",{pipelineId:e,error:t instanceof Error?t.message:String(t)})}}if(x&&(A=_(A,N),k=_(k,N)),!A.pipelineId)return v("campaign_base_missing",{normalized:e,match:I,campaign:{id:l(S.campaign?.id)??null,name:l(S.campaign?.name)??null}});if(!k.pipelineId&&!k.statusId)return v("campaign_target_missing",{normalized:e,match:I,campaign:{id:l(S.campaign?.id)??null,name:l(S.campaign?.name)??null}});let $=f([...t,{kind:"handle",value:e.handle},{kind:"handleRaw",value:e.handleRaw},{kind:"fullName",value:e.fullName}]);if(!$.length)return v("identity_missing",{normalized:e});let E=d(A.pipelineId),T=d(A.statusId??A.pipelineStatusId??null),q=[],M=null,O=null,P=null;for(let e of $){let t=await (0,a.l)({needle:e.value,pipelineId:E,statusId:T});if(q.push({kind:e.kind,value:e.value,result:t}),!t.ok){P=t;continue}if(t.match){O=e.value;let i=t.items.find(e=>e.cardId===t.match?.cardId);M={...t,summary:i?{pipelineId:null!=i.pipelineId?String(i.pipelineId):null,statusId:null!=i.statusId?String(i.statusId):null,pipelineStatusId:null,pipelineName:i.pipelineTitle??null,statusName:i.statusTitle??null,statusAliases:null!=i.statusId?[String(i.statusId)]:[]}:null};break}}M?.summary&&N.length&&(M={...M,summary:_(M.summary,N)});let U={id:l(S.campaign?.id)??null,name:l(S.campaign?.name)??null,base:m(A),target:m(k)};if(!U.target.pipelineStatusId&&!U.target.statusId)return v("campaign_target_status_missing",{normalized:e,campaign:U,pipelines:N.map(e=>({id:e.id,title:e.title,statuses:e.statuses.map(e=>({id:e.id,pipelineStatusId:e.pipelineStatusId,statusId:e.statusId,title:e.title}))}))});if(!M){if(P)return v("keycrm_search_failed",{attempts:q,error:P,campaign:U,message:"Помилка пошуку картки в KeyCRM"});let t=q.map(e=>"webhook_handle"===e.kind||e.kind.includes("username")?e.value:null).filter(e=>!!e);return v("card_not_found",{attempts:q,normalized:e,campaign:U,message:t.length>0?`Картка з social_id "${t[0]}" не знайдена в базовому статусі "${U.base.statusName||U.base.statusId}" воронки "${U.base.pipelineName||U.base.pipelineId}"`:"Картка не знайдена в базовому статусі",searchedSocialIds:t,baseStatus:U.base.statusName||U.base.statusId,basePipeline:U.base.pipelineName||U.base.pipelineId})}let F=M.match?.cardId??null;if(!F)return v("card_match_missing",{selected:M,campaign:U});let K=String(F).trim(),C=e=>{if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return String(e);if("string"==typeof e){let t=e.trim();return t.length?t:null}return null},J=C(k.pipelineId)??C(M.summary?.pipelineId)??C(A.pipelineId),B=C(k.pipelineStatusId),j=C(k.statusId),D=Array.from(new Set([k.pipelineStatusId,k.statusId,...k.statusAliases??[]].map(e=>C(e)).filter(e=>!!e).filter(e=>e!==B&&e!==j))),L={card_id:K};J&&(L.to_pipeline_id=J,L.pipeline_id=J),j&&(L.to_status_id=j,L.status_id=j),B&&(L.pipeline_status_id=B),D.length&&(L.status_aliases=D);let V=`/pipelines/cards/${encodeURIComponent(K)}`,H=[];if(A.pipelineStatusId){let e=A.pipelineStatusId.trim();e&&H.push(e)}if(!H.length&&A.statusId){let e=A.statusId.trim();e&&H.push(e)}let W=!A.pipelineId||M.summary?.pipelineId===A.pipelineId,X=0===H.length||H.some(e=>{let t=e.trim();return M.summary?.statusId&&M.summary.statusId===t||M.summary?.pipelineStatusId&&M.summary.pipelineStatusId===t});if(!W||!X)return v("card_not_in_base",{normalized:e,campaign:U,selected:M,summary:M.summary,mismatch:{pipelineMatches:W,statusMatches:X},base:m(A)});let G=[k.statusId,k.pipelineStatusId,...k.statusAliases??[]].filter(e=>"string"==typeof e&&e.trim().length>0),z=!k.pipelineId||M.summary?.pipelineId===k.pipelineId,Q=G.some(e=>{let t=e.trim();return M.summary?.statusId&&M.summary.statusId===t||M.summary?.pipelineStatusId&&M.summary.pipelineStatusId===t});if(z&&G.length>0&&Q)return w({normalized:e,match:{route:S.route,rule:S.rule,campaign:U},search:{usedNeedle:O,attempts:q,selected:M},move:{attempted:!1,skippedReason:"already_in_target",ok:!0,requestUrl:V,requestMethod:"PUT",sent:L,requestHeaders:null,requestBodyRaw:null,responseRaw:null,trace:[],stack:null}});if(!n)return w({normalized:e,match:{route:S.route,rule:S.rule,campaign:U},search:{usedNeedle:O,attempts:q,selected:M},move:{attempted:!1,skippedReason:"move_handler_missing",ok:!1,requestUrl:V,requestMethod:"PUT",sent:L,requestHeaders:null,requestBodyRaw:null,responseRaw:null,trace:[],stack:null}});let Y=(()=>{for(let e of[k.pipelineId,M.summary?.pipelineId,A.pipelineId]){if(null==e)continue;let t=String(e).trim();if(t)return t}return null})(),Z=[k.pipelineStatusId].map(e=>null==e?null:String(e).trim()).filter(e=>!!e),ee=[k.statusId,...k.statusAliases??[]].map(e=>null==e?null:String(e).trim()).filter(e=>!!e),et=Z.find(e=>e.length>0)??null,ei=("string"==typeof k.statusId&&k.statusId.trim()||null)??ee.find(e=>e.length>0)??null,es=et??ei??null,er=[...Z,...ee].map(e=>null==e?null:String(e).trim()).filter(e=>!!e),ea=new Set;for(let e of er)if(e){if(es&&e===es||et&&e===et)continue;ea.add(e)}let en=Array.from(ea);en.length&&(L.status_aliases=en);let el=await n({cardId:F,pipelineId:Y,statusId:es,pipelineStatusId:et,statusAliases:Array.from(ea)}),eu={normalized:e,match:{route:S.route,rule:S.rule,campaign:U},search:{usedNeedle:O,attempts:q,selected:M}};return el.ok?w({...eu,move:{attempted:!0,response:el.response,status:el.status,ok:!0,skippedReason:el.skippedReason??void 0,sent:el.sent??L,attempts:el.attempts,requestUrl:el.requestUrl??V,requestMethod:el.requestMethod??"PUT",baseUrl:el.baseUrl??null,requestHeaders:el.requestHeaders??null,requestBodyRaw:el.requestBodyRaw??null,responseRaw:el.responseRaw??null,trace:el.trace??[],stack:el.stack??null,details:{requestUrl:el.requestUrl??V,requestMethod:el.requestMethod??"PUT",baseUrl:el.baseUrl??null,sent:el.sent??L,requestHeaders:el.requestHeaders??null,requestBodyRaw:el.requestBodyRaw??null,responseRaw:el.responseRaw??null}}}):w({...eu,move:{attempted:!0,response:el.response,status:el.status,ok:!1,error:"keycrm_move_failed",details:{skippedReason:el.skippedReason??null,requestUrl:el.requestUrl??V,requestMethod:el.requestMethod??"PUT",baseUrl:el.baseUrl??null,sent:el.sent??L,requestHeaders:el.requestHeaders??null,requestBodyRaw:el.requestBodyRaw??null,responseRaw:el.responseRaw??null},skippedReason:el.skippedReason??void 0,sent:el.sent??L,attempts:el.attempts,requestUrl:el.requestUrl??V,requestMethod:el.requestMethod??"PUT",baseUrl:el.baseUrl??null,requestHeaders:el.requestHeaders??null,requestBodyRaw:el.requestBodyRaw??null,responseRaw:el.responseRaw??null,trace:el.trace??[],stack:el.stack??null}})}},239:(e,t,i)=>{i.d(t,{AY:()=>A,Ez:()=>o,JE:()=>u,OE:()=>a,Ow:()=>_,R5:()=>y,RF:()=>n,X$:()=>v,b3:()=>w,hk:()=>m,lW:()=>h,pm:()=>S,r6:()=>l,wm:()=>I});var s=i(4332);let r=null;try{let e=i(6649);e?.kv&&(r=e.kv)}catch{r=null}let a="manychat:last-message",n="manychat:last-trace",l="manychat:last-feed",u="manychat:last-raw",o="manychat:last-request",p="manychat:last-automation";function c(e){let t="number"==typeof e.receivedAt&&Number.isFinite(e.receivedAt)?e.receivedAt:Date.now(),i="number"==typeof e.id?e.id:"string"==typeof e.id&&e.id.trim().length?e.id.trim():t,s="string"==typeof e.text?e.text:null==e.text?"":String(e.text);if(!s||!s.trim().length){let t=function e(t,i=new WeakSet){if(null==t)return null;if("string"==typeof t){let e=t.trim();return e.length?e:null}if("number"==typeof t&&Number.isFinite(t))return String(t);if(Array.isArray(t)){for(let s of t){let t=e(s,i);if(t)return t}return null}if("object"!=typeof t||i.has(t))return null;i.add(t);let s=function(...e){for(let t of e){if("string"==typeof t){let e=t.trim();if(e.length)return e}if("number"==typeof t&&Number.isFinite(t))return String(t)}return null}(t.text,t.message,t.content,t.body,t.payload,t.preview,t.description);if(s)return s;for(let s of["text","message","content","body","payload","data","event","last_message","lastMessage","last_message_text","lastMessageText","last_message_preview","lastMessagePreview"]){if(null==t[s])continue;let r=e(t[s],i);if(r)return r}for(let s of Object.values(t)){let t=e(s,i);if(t)return t}return null}(e.raw);t&&(s=t)}let r=(()=>{if("string"==typeof e.rawText&&e.rawText.trim().length)return e.rawText;if("string"==typeof e.raw&&e.raw.trim().length)return e.raw;try{if(null!=e.raw)return JSON.stringify(e.raw)}catch{}return null})();return{...e,id:i,receivedAt:t,source:e.source??"manychat",title:e.title&&e.title.trim().length?e.title:"ManyChat",handle:e.handle??null,fullName:e.fullName??null,text:s,rawText:r}}function d(e){let t=new Set,i=[];for(let s of e){if(!s)continue;let e=c(s),r=`${"string"==typeof e.id?e.id:`#${e.id}`}@${e.receivedAt}`;t.has(r)||(t.add(r),i.push(e))}return i.slice(0,25)}async function f(e){let t=d(e);if(!t.length)return!1;let i=!1;if(r)try{await r.set(l,JSON.stringify(t)),i=!0}catch{}try{await s.kvWrite.setRaw(l,JSON.stringify(t)),i=!0}catch{if(!i)throw Error("Не вдалося зберегти журнал повідомлень у KV")}return i}async function m(e,t=null){let i=c(e),l=t?function(e,t){let i="number"==typeof e.receivedAt&&Number.isFinite(e.receivedAt)?e.receivedAt:t.receivedAt,s="rejected"===e.status?"rejected":"accepted",r="number"==typeof e.statusCode&&Number.isFinite(e.statusCode)?e.statusCode:"rejected"===s?401:200,a=null!=e.messagePreview?e.messagePreview:t.text?t.text.slice(0,180):null;return{...e,receivedAt:i,status:s,statusCode:r,handle:e.handle??t.handle??null,fullName:e.fullName??t.fullName??null,messagePreview:a}}(t,i):null,p=(()=>{if("string"==typeof i.rawText&&i.rawText.length)return i.rawText;if("string"==typeof e.rawText&&e.rawText.length)return e.rawText;if("string"==typeof i.raw&&i.raw.length)return i.raw;try{return JSON.stringify(i.raw??e.raw??null)}catch{try{return JSON.stringify(e.raw??null)}catch{return"null"}}})();i.rawText=p;let m={rawText:p,receivedAt:i.receivedAt,source:i.source??e.source??"webhook:/api/mc/manychat"},h=!1;if(r)try{await r.set(a,i),h=!0,l&&await r.set(n,l),await r.set(u,p),await r.set(o,m)}catch{h=!1}h||(await s.kvWrite.setRaw(a,JSON.stringify(i)),l&&await s.kvWrite.setRaw(n,JSON.stringify(l)),await s.kvWrite.setRaw(u,p),await s.kvWrite.setRaw(o,JSON.stringify(m)),h=!0);try{let{messages:e}=await I(24),t=d([i,...e]);await f(t)}catch{}}async function h(e){let t={receivedAt:Date.now(),result:e},i=!1;if(r)try{await r.set(p,t),i=!0}catch{i=!1}i||await s.kvWrite.setRaw(p,JSON.stringify(t))}async function g(e){if(!r)return null;try{let t=await r.get(e);if(!t)return null;if("string"==typeof t)try{return JSON.parse(t)}catch{return null}return t}catch{return null}}async function y(){let e=await g(a);if(e)return{message:c(e),source:"kv-client"};let t=await s.kvRead.getRaw(a);if(!t)return{message:null,source:null};try{let e=JSON.parse(t);if(e&&"object"==typeof e)return{message:c(e),source:"kv-rest"}}catch(e){return{message:null,source:"kv-rest",error:e instanceof Error?e.message:String(e)}}return{message:null,source:"kv-rest"}}async function _(){let e=await g(u);if(null!=e){if("string"==typeof e)try{return{raw:JSON.parse(e),text:e,source:"kv-client"}}catch{return{raw:e,text:e,source:"kv-client"}}try{let t=JSON.stringify(e);return{raw:e,text:t,source:"kv-client"}}catch{return{raw:e,text:null,source:"kv-client"}}}let t=await s.kvRead.getRaw(u);if(!t)return{raw:null,text:null,source:null};try{return{raw:JSON.parse(t),text:t,source:"kv-rest"}}catch{return{raw:t,text:t,source:"kv-rest"}}}async function w(){let e=await g(n);if(e)return{trace:e,source:"kv-client"};let t=await s.kvRead.getRaw(n);if(!t)return{trace:null,source:null};try{let e=JSON.parse(t);if(e&&"object"==typeof e)return{trace:e,source:"kv-rest"}}catch(e){return{trace:null,source:"kv-rest",error:e instanceof Error?e.message:String(e)}}return{trace:null,source:"kv-rest"}}async function v(){let e=await g(o);if(e){if("string"==typeof e)try{return{snapshot:JSON.parse(e),source:"kv-client"}}catch{return{snapshot:{rawText:e,receivedAt:Date.now(),source:"kv-client"},source:"kv-client"}}return{snapshot:e,source:"kv-client"}}let t=await s.kvRead.getRaw(o);if(!t)return{snapshot:null,source:null};try{let e=JSON.parse(t);if(e&&"object"==typeof e)return{snapshot:e,source:"kv-rest"}}catch(e){return{snapshot:{rawText:t,receivedAt:Date.now(),source:"kv-rest"},source:"kv-rest",error:e instanceof Error?e.message:String(e)}}return{snapshot:null,source:"kv-rest"}}async function S(){let e=await g(p);if(e){if("string"==typeof e)try{return{snapshot:JSON.parse(e),source:"kv-client"}}catch(e){return{snapshot:null,source:"kv-client",error:e instanceof Error?e.message:String(e)}}return{snapshot:e,source:"kv-client"}}let t=await s.kvRead.getRaw(p);if(!t)return{snapshot:null,source:null};try{let e=JSON.parse(t);if(e&&"object"==typeof e)return{snapshot:e,source:"kv-rest"}}catch(e){return{snapshot:null,source:"kv-rest",error:e instanceof Error?e.message:String(e)}}return{snapshot:null,source:"kv-rest"}}async function I(e=10){let t=Math.max(1,Math.min(e,50));if(r){try{let e=await r.lrange(l,0,t-1);if(Array.isArray(e)&&e.length){let i=e.map(e=>{if("string"==typeof e)try{return JSON.parse(e)}catch{return null}return e??null}).filter(e=>!!e).map(e=>c(e));if(i.length)return{messages:i.slice(0,t),source:"kv-client"}}}catch{}try{let e=await r.get(l);if(e){let i=(Array.isArray(e)?e:"string"==typeof e?(()=>{try{let t=JSON.parse(e);return Array.isArray(t)?t:t?[t]:[]}catch{return[]}})():[e]).map(e=>e?c(e):null).filter(e=>!!e);if(i.length)return{messages:i.slice(0,t),source:"kv-client"}}}catch{}}let i=await s.kvRead.lrange(l,0,t-1);if(i&&i.length>0){let e=[];for(let t of i)try{let i=JSON.parse(t);i&&"object"==typeof i&&e.push(c(i))}catch(t){return{messages:e,source:"kv-rest",error:t instanceof Error?t.message:String(t)}}if(e.length>0)return{messages:e.slice(0,t),source:"kv-rest"}}let a=await s.kvRead.getRaw(l);if(!a)return{messages:[],source:null};try{let e=JSON.parse(a);if(Array.isArray(e)&&e.length>0)return{messages:e.slice(0,t).map(e=>c(e)),source:"kv-rest"}}catch(e){return{messages:[],source:"kv-rest",error:e instanceof Error?e.message:String(e)}}return{messages:[],source:"kv-rest"}}async function A(e){try{return await f(e)}catch{return!1}}},6649:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=i(242),r=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var a=class extends s.Redis{async *scanIterator(e){let t,i=0;do for(let s of([i,t]=await this.scan(i,e),t))yield s;while(0!==i)}async *hscanIterator(e,t){let i,s=0;do for(let r of([s,i]=await this.hscan(e,s,t),i))yield r;while(0!==s)}async *sscanIterator(e,t){let i,s=0;do for(let r of([s,i]=await this.sscan(e,s,t),i))yield r;while(0!==s)}async *zscanIterator(e,t){let i,s=0;do for(let r of([s,i]=await this.zscan(e,s,t),i))yield r;while(0!==s)}};function n(e){return new a({cache:"default",...e})}var l=new Proxy({},{get(e,t,i){if("then"===t||"parse"===t)return Reflect.get(e,t,i);if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}}),u=new Proxy({},{get(e,t){if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}});t.VercelKV=a,t.createClient=n,t.default=l,t.kv=u}};