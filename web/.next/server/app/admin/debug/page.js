(()=>{var e={};e.id=7585,e.ids=[7585,7560],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},6113:e=>{"use strict";e.exports=require("crypto")},9505:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>n.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>c,routeModule:()=>p,tree:()=>o}),s(9337),s(2675),s(5866);var a=s(3191),r=s(8716),l=s(7922),n=s.n(l),i=s(5231),d={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>i[e]);s.d(t,d);let o=["",{children:["admin",{children:["debug",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,9337)),"/Users/mykolay/P-3-0/web/app/admin/debug/page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,2675)),"/Users/mykolay/P-3-0/web/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,5866,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/mykolay/P-3-0/web/app/admin/debug/page.tsx"],m="/admin/debug/page",u={require:s,loadChunk:()=>Promise.resolve()},p=new a.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/admin/debug/page",pathname:"/admin/debug",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},2145:(e,t,s)=>{Promise.resolve().then(s.bind(s,7832)),Promise.resolve().then(s.bind(s,2462)),Promise.resolve().then(s.bind(s,1367)),Promise.resolve().then(s.bind(s,7268)),Promise.resolve().then(s.bind(s,6105))},6847:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,2994,23)),Promise.resolve().then(s.t.bind(s,6114,23)),Promise.resolve().then(s.t.bind(s,9727,23)),Promise.resolve().then(s.t.bind(s,9671,23)),Promise.resolve().then(s.t.bind(s,1868,23)),Promise.resolve().then(s.t.bind(s,4759,23))},5800:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,4064,23))},7832:(e,t,s)=>{"use strict";s.d(t,{CampaignsMaintenanceCard:()=>n});var a=s(326),r=s(7577);let l={loading:!1,status:null,result:null,error:null};function n(){let[e,t]=(0,r.useState)(l),s=async()=>{t({loading:!0,status:null,result:null,error:null});try{let e=await fetch("/api/campaigns/cleanup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:!0})}),s=await e.json();if(!e.ok||s?.ok===!1){let a=s?.error?String(s.error):`HTTP ${e.status}`;t({loading:!1,status:e.status,result:null,error:a});return}let a={ok:!!s.ok,deletedIds:Number(s.deletedIds??0),deletedKeys:Number(s.deletedKeys??0),sampleIds:Array.isArray(s.sampleIds)?s.sampleIds:[],sources:s.sources&&"object"==typeof s.sources?s.sources:{}};t({loading:!1,status:e.status,result:a,error:null})}catch(e){t({loading:!1,status:null,result:null,error:e instanceof Error?e.message:String(e)})}};return(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,a.jsxs)("div",{children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Очищення кампаній у KV"}),a.jsx("p",{className:"mt-2 text-sm text-slate-500",children:"Видаляє всі збережені кампанії з Vercel KV і очищає кеш у пам'яті. Використовуйте, коли потрібно створити кампанії з нуля."})]}),a.jsx("button",{type:"button",onClick:s,disabled:e.loading,className:"inline-flex items-center rounded-lg border border-rose-200 bg-rose-50 px-3 py-1.5 text-sm font-medium text-rose-700 transition hover:bg-rose-100 disabled:cursor-wait disabled:opacity-50",children:e.loading?"Очищення…":"Видалити всі"})]}),a.jsx("p",{className:"mt-4 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700",children:"Операція незворотна. Після очищення потрібно заново створити кампанії в адмінці."}),e.error&&(0,a.jsxs)("div",{className:"mt-4 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:["Помилка: ",e.error]}),e.result&&(0,a.jsxs)("div",{className:"mt-4 space-y-3 text-sm text-slate-700",children:[(0,a.jsxs)("div",{className:"grid gap-3 sm:grid-cols-2",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-800",children:"Видалено карток:"})," ",e.result.deletedIds]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-800",children:"Очищено ключів:"})," ",e.result.deletedKeys]})]}),e.result.sampleIds.length>0&&(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-800",children:"Приклади ID:"}),a.jsx("pre",{className:"mt-1 max-h-32 overflow-auto rounded-md bg-slate-900 p-3 text-xs text-slate-100",children:JSON.stringify(e.result.sampleIds,null,2)})]}),Object.keys(e.result.sources).length>0&&(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-800",children:"Джерела ID:"}),a.jsx("pre",{className:"mt-1 max-h-32 overflow-auto rounded-md bg-slate-900 p-3 text-xs text-slate-100",children:JSON.stringify(e.result.sources,null,2)})]})]})]})}},2462:(e,t,s)=>{"use strict";s.d(t,{KeycrmCardSearchWidget:()=>l});var a=s(326),r=s(7577);function l(){let[e,t]=(0,r.useState)(""),[s,l]=(0,r.useState)(""),[n,i]=(0,r.useState)(""),[d,o]=(0,r.useState)([]),[c,m]=(0,r.useState)({state:"idle"}),[u,p]=(0,r.useState)({state:"idle"}),[x,h]=(0,r.useState)({state:"loading"}),[g,f]=(0,r.useState)({status:"idle",message:"Введіть повне ім'я або social_id (наприклад, instagram логін) чи залиште поле порожнім і оберіть воронку/статус."}),[y,b]=(0,r.useState)(""),[j,N]=(0,r.useState)(""),[v,k]=(0,r.useState)(null),[w,_]=(0,r.useState)({status:"idle"}),S=(0,r.useRef)(null);(0,r.useRef)(null),(0,r.useRef)(null),(0,r.useRef)(null),(0,r.useRef)(null),(0,r.useRef)(new Set),(0,r.useRef)(""),(0,r.useRef)("");let R=(0,r.useCallback)(async(e,t={})=>{let s=e.trim(),a=t.pipelineId?.trim()??"",r=t.statusId?.trim()??"";if(!s&&!a){f({status:"error",error:{ok:!1,error:"filters_required",details:"Щоб показати картки без пошукового запиту, оберіть воронку або задайте статус."}});return}S.current?.abort();let l=new AbortController;S.current=l,_({status:"idle"}),f({status:"loading",message:s?"Шукаємо у KeyCRM…":"Збираємо картки з обраної воронки…"});try{let e=new URLSearchParams;s&&e.set("needle",s),a&&e.set("pipeline_id",a),r&&e.set("status_id",r);let t=await fetch(`/api/keycrm/card/find?${e.toString()}`,{signal:l.signal,headers:{accept:"application/json"}}),n=await t.json().catch(()=>null);if(!n){f({status:"error",error:{ok:!1,error:"invalid_response",details:"Відповідь API не JSON"}});return}if("ok"in n&&!0===n.ok){f({status:"success",result:n});return}f({status:"error",error:n})}catch(e){if(e?.name==="AbortError")return;f({status:"error",error:{ok:!1,error:"network_error",details:e instanceof Error?e.message:String(e)}})}finally{S.current===l&&(S.current=null)}},[]),I=(0,r.useCallback)(e=>{e.preventDefault();let t=new FormData(e.currentTarget);R(String(t.get("needle")??""),{pipelineId:String(t.get("pipeline_id")??""),statusId:String(t.get("status_id")??"")})},[R]),C=(0,r.useMemo)(()=>{if("success"!==g.status)return null;let e=g.result;return{cardsChecked:e.cardsChecked,pagesScanned:e.pagesScanned,pipelineId:e.filters.pipelineId,statusId:e.filters.statusId,perPage:e.filters.perPage,maxPages:e.filters.maxPages,itemsCount:e.items.length}},[g]),A="success"===g.status?g.result.match:null,M="success"===g.status?g.result.items:[],P="success"===g.status?g.result.needle.trim():"",K="error"===g.status?g.error.details:void 0,$=(0,r.useMemo)(()=>{if(!s)return null;let e=Number(s);return Number.isFinite(e)?d.find(t=>t.id===e)??null:null},[s,d]),O=(0,r.useMemo)(()=>{if(!y)return null;let e=Number(y);return Number.isFinite(e)?d.find(t=>t.id===e)??null:null},[d,y]),q=(0,r.useMemo)(()=>v&&"success"===g.status?g.result.items.find(e=>e.cardId===v)??null:null,[v,g]),T=(0,r.useCallback)(async()=>{if(!v){_({status:"error",message:"Оберіть картку для переміщення"});return}let e=y.trim(),t=j.trim();if(!e||!t){_({status:"error",message:"Оберіть цільову воронку та статус"});return}_({status:"loading"});try{let s=await fetch("/api/keycrm/card/move",{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({card_id:String(v),to_pipeline_id:e,to_status_id:t})}),a=await s.json().catch(()=>null);if(!a){_({status:"error",message:"KeyCRM повернув неочікувану відповідь"});return}if(a.ok){_({status:"success",message:"Картку успішно переміщено",response:a});return}_({status:"error",message:a.error??"KeyCRM відхилив переміщення",details:a})}catch(e){_({status:"error",message:e instanceof Error?e.message:String(e)})}},[v,y,j]),E=!v||!y.trim()||!j.trim()||"loading"===w.status,U=(0,r.useMemo)(()=>{if("loading"===x.state)return"Завантажуємо воронки з KeyCRM…";if("error"===x.state)return`Не вдалося отримати воронки: ${x.message}`;if("loaded"===x.state){if(x.note)return x.note;if("stale"===x.source)return"Показуємо кешований список воронок (оновлення наразі недоступне)"}return null},[x]);return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("form",{className:"flex flex-col gap-4 rounded-xl bg-slate-50 p-4 shadow-inner",onSubmit:I,children:[(0,a.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-end",children:[(0,a.jsxs)("label",{className:"flex-1 text-sm text-slate-700",children:[a.jsx("span",{className:"mb-1 block font-medium",children:"Пошук у KeyCRM"}),a.jsx("input",{className:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-base text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200",type:"text",name:"needle",value:e,placeholder:"Наприклад: Viktoria Kolachnyk або kolachnyk.v",onChange:e=>t(e.target.value),autoComplete:"off"})]}),a.jsx("button",{type:"submit",className:"inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-200",children:"loading"===g.status?"Шукаємо…":"Знайти картку"})]}),(0,a.jsxs)("div",{className:"grid gap-3 text-sm text-slate-700 sm:grid-cols-2",children:[(0,a.jsxs)("label",{className:"flex flex-col",children:[a.jsx("span",{className:"mb-1 font-medium",children:"Воронка"}),(0,a.jsxs)("select",{className:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-base text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200",name:"pipeline_id",value:s,onChange:e=>{l(e.target.value),i("")},disabled:"loading"===x.state&&!d.length,children:[a.jsx("option",{value:"",children:"Усі воронки"}),d.map(e=>a.jsx("option",{value:e.id,children:e.title},e.id))]})]}),(0,a.jsxs)("label",{className:"flex flex-col",children:[a.jsx("span",{className:"mb-1 font-medium",children:"Статус"}),(0,a.jsxs)("select",{className:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-base text-slate-900 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200",name:"status_id",value:n,onChange:e=>i(e.target.value),disabled:!$||"loading"===c.state||0===$.statuses.length,children:[a.jsx("option",{value:"",children:"Усі статуси"}),$?.statuses.map(e=>a.jsx("option",{value:e.id,children:e.title},e.id))]}),"loading"===c.state&&a.jsx("span",{className:"mt-1 text-xs text-slate-500",children:"Завантажуємо статуси…"}),"error"===c.state&&a.jsx("span",{className:"mt-1 text-xs text-red-600",children:c.message})]})]}),(0,a.jsxs)("div",{className:"grid gap-3 rounded-lg border border-indigo-100 bg-indigo-50/70 p-3 text-sm text-indigo-900 sm:grid-cols-2",children:[(0,a.jsxs)("div",{className:"space-y-1",children:[a.jsx("span",{className:"block text-xs font-semibold uppercase tracking-wide text-indigo-700",children:"Цільова воронка"}),(0,a.jsxs)("select",{className:"w-full rounded border border-indigo-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100",name:"target_pipeline_id",value:y,onChange:e=>{b(e.target.value),N("")},children:[a.jsx("option",{value:"",children:"Не обрано"}),d.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.title," (#",e.id,")"]},`target-${e.id}`))]}),"loading"===u.state&&a.jsx("span",{className:"text-xs text-indigo-700",children:"Завантажуємо статуси цієї воронки…"}),"error"===u.state&&a.jsx("span",{className:"text-xs text-red-600",children:u.message})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[a.jsx("span",{className:"block text-xs font-semibold uppercase tracking-wide text-indigo-700",children:"Цільовий статус"}),(0,a.jsxs)("select",{className:"w-full rounded border border-indigo-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100",name:"target_status_id",value:j,onChange:e=>N(e.target.value),disabled:!O||"loading"===u.state,children:[a.jsx("option",{value:"",children:"Не обрано"}),(O?.statuses??[]).map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.title," (#",e.id,")"]},`target-status-${e.id}`))]}),O&&0===O.statuses.length&&"idle"===u.state&&a.jsx("span",{className:"text-xs text-indigo-700",children:"Для цієї воронки статуси ще не завантажені."})]})]}),U&&a.jsx("p",{className:"text-xs text-slate-500",children:U})]}),"idle"===g.status&&a.jsx("p",{className:"text-sm text-slate-500",children:g.message}),"loading"===g.status&&a.jsx("p",{className:"text-sm text-slate-500",children:g.message}),"error"===g.status&&(0,a.jsxs)("div",{className:"rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700",children:[a.jsx("p",{className:"font-semibold",children:"Помилка пошуку"}),(0,a.jsxs)("p",{className:"mt-1 break-words",children:["Код: ",g.error.error]}),"keycrm_rate_limited"===g.error.error&&a.jsx("p",{className:"mt-2 text-xs text-red-600",children:"KeyCRM повернув обмеження 429. Задайте воронку та статус або повторіть спробу пізніше."}),null!=K&&a.jsx("pre",{className:"mt-2 max-h-40 overflow-auto rounded bg-white/70 p-3 text-xs text-red-800",children:"string"==typeof K?K:JSON.stringify(K,null,2)})]}),"success"===g.status&&(0,a.jsxs)("div",{className:"space-y-4",children:[(A||P)&&a.jsx("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800",children:A?(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("p",{className:"text-base font-semibold text-emerald-900",children:["Знайдено картку #",A.cardId]}),A.title&&(0,a.jsxs)("p",{className:"text-sm",children:["Назва: ",A.title]}),(0,a.jsxs)("p",{className:"text-sm",children:["Збіг у полі ",a.jsx("code",{children:A.matchedField}),' зі значенням "',A.matchedValue??"",'".']})]}):a.jsx("p",{className:"font-semibold",children:"Збігів не знайдено."})}),C&&(0,a.jsxs)("div",{className:"grid gap-3 rounded-xl border border-slate-200 bg-white p-4 text-sm text-slate-700 sm:grid-cols-3",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-900",children:"Перевірено карток:"})," ",C.cardsChecked]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-900",children:"Сторінок проглянуто:"})," ",C.pagesScanned]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-900",children:"Запит (per_page \xd7 max_pages):"})," ",C.perPage," \xd7 ",C.maxPages]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-900",children:"pipeline_id:"})," ",C.pipelineId??"—"]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-900",children:"status_id:"})," ",C.statusId??"—"]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-900",children:"Отримано карток:"})," ",C.itemsCount]})]}),M.length>0&&(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:P?"Картки, що відповідали фільтрам":"Картки у вибраній воронці та статусі"}),a.jsx("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-slate-200 text-left text-sm text-slate-700",children:[a.jsx("thead",{className:"bg-slate-100 text-xs uppercase tracking-wide text-slate-500",children:(0,a.jsxs)("tr",{children:[a.jsx("th",{className:"px-3 py-2",children:"Обрати"}),a.jsx("th",{className:"px-3 py-2",children:"ID"}),a.jsx("th",{className:"px-3 py-2",children:"Назва"}),a.jsx("th",{className:"px-3 py-2",children:"Контакт"}),a.jsx("th",{className:"px-3 py-2",children:"Соцмережа"}),a.jsx("th",{className:"px-3 py-2",children:"Воронка"}),a.jsx("th",{className:"px-3 py-2",children:"Статус"})]})}),a.jsx("tbody",{className:"divide-y divide-slate-100 bg-white",children:M.map(e=>(0,a.jsxs)("tr",{className:`cursor-pointer hover:bg-slate-50 ${v===e.cardId?"bg-indigo-50/70":""}`,onClick:()=>k(e.cardId),children:[a.jsx("td",{className:"px-3 py-2 align-middle",children:a.jsx("input",{type:"radio",name:"selected_card",className:"h-4 w-4 accent-indigo-600",checked:v===e.cardId,onChange:()=>k(e.cardId)})}),(0,a.jsxs)("td",{className:"px-3 py-2 font-mono text-xs text-slate-500",children:["#",e.cardId]}),a.jsx("td",{className:"px-3 py-2 text-slate-900",children:e.title??"—"}),a.jsx("td",{className:"px-3 py-2",children:e.contactName??e.clientName??"—"}),a.jsx("td",{className:"px-3 py-2",children:e.contactSocialId??e.clientSocialId??"—"}),a.jsx("td",{className:"px-3 py-2",children:(()=>{if(e.pipelineTitle)return e.pipelineTitle;let t=d.find(t=>t.id===e.pipelineId);return t?.title??"—"})()}),a.jsx("td",{className:"px-3 py-2",children:(()=>{if(e.statusTitle)return e.statusTitle;let t=d.find(t=>t.id===e.pipelineId);if(!t)return"—";let s=t.statuses.find(t=>t.id===e.statusId);return s?.title??"—"})()})]},e.cardId))})]})})]}),(0,a.jsxs)("div",{className:"space-y-3 rounded-xl border border-indigo-200 bg-white p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-indigo-900",children:"Переміщення картки"}),a.jsx("p",{className:"text-xs text-slate-600",children:"Оберіть картку у таблиці вище та цільову воронку зі статусом. Після переміщення картка з’явиться у вибраній колонці KeyCRM."}),(0,a.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[a.jsx("div",{className:"text-sm text-slate-700",children:q?(0,a.jsxs)(a.Fragment,{children:[a.jsx("span",{className:"font-medium text-slate-900",children:"Вибрана картка:"})," ","#",q.cardId," \xb7 ",q.title??"Без назви"]}):a.jsx("span",{className:"text-slate-500",children:"Картку не обрано"})}),a.jsx("button",{type:"button",onClick:T,disabled:E,className:`inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ${E?"cursor-not-allowed bg-indigo-200 text-indigo-500":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:"loading"===w.status?"Переміщуємо…":"Перемістити картку"})]}),"error"===w.status&&(0,a.jsxs)("div",{className:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:[a.jsx("p",{className:"font-semibold",children:"Не вдалося перемістити"}),a.jsx("p",{className:"mt-1 text-xs text-red-600",children:w.message}),w.details&&a.jsx("pre",{className:"mt-2 max-h-40 overflow-auto rounded bg-white/70 p-2 text-xs text-red-800",children:JSON.stringify(w.details,null,2)})]}),"success"===w.status&&(0,a.jsxs)("div",{className:"rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-800",children:[a.jsx("p",{className:"font-semibold",children:w.message}),a.jsx("pre",{className:"mt-2 max-h-40 overflow-auto rounded bg-white/70 p-2 text-xs text-emerald-900",children:JSON.stringify(w.response,null,2)})]})]}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Сира відповідь API"}),a.jsx("pre",{className:"mt-2 max-h-72 overflow-auto rounded-xl bg-slate-900 p-4 text-xs text-slate-100",children:JSON.stringify(g.result,null,2)})]})]})]})}},1367:(e,t,s)=>{"use strict";s.d(t,{KeycrmEnvCard:()=>n});var a=s(326),r=s(7577);let l={loading:!1,error:null,status:null};function n(){let[e,t]=(0,r.useState)(l),s=(0,r.useCallback)(async()=>{t(e=>({...e,loading:!0,error:null}));try{let e=await fetch("/api/admin/status",{method:"GET",cache:"no-store"}),s=await e.json();t({loading:!1,error:e.ok?null:`HTTP ${e.status}`,status:s})}catch(e){t({loading:!1,error:e instanceof Error?e.message:String(e),status:null})}},[]),n=e.status?.keycrm.ping,i=(0,r.useMemo)(()=>n?.attempted?n.ok?"text-emerald-600":"text-amber-600":"text-slate-600",[n]);return(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,a.jsxs)("div",{children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Статус KeyCRM API"}),a.jsx("p",{className:"mt-2 text-sm text-slate-500",children:"Перевіряємо наявність обов'язкових змінних середовища і робимо тестовий запит до KeyCRM, щоб впевнитися, що ми можемо виконувати операції переміщення карток."})]}),a.jsx("button",{type:"button",onClick:s,disabled:e.loading,className:"inline-flex items-center rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-medium text-slate-700 transition hover:bg-slate-50 disabled:cursor-wait disabled:opacity-50",children:e.loading?"Оновлення…":"Оновити"})]}),e.error&&(0,a.jsxs)("div",{className:"mt-4 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:["Помилка запиту: ",e.error]}),(0,a.jsxs)("dl",{className:"mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2",children:[(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"font-medium text-slate-700",children:"KEYCRM_API_URL / KEYCRM_BASE_URL"}),a.jsx("dd",{children:e.status?.keycrm.hasBaseUrl?"налаштовано":"не задано"})]}),(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"font-medium text-slate-700",children:"KEYCRM_API_TOKEN / KEYCRM_BEARER"}),a.jsx("dd",{children:e.status?.keycrm.hasToken?"налаштовано":"не задано"})]}),(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"font-medium text-slate-700",children:"Остання перевірка"}),a.jsx("dd",{children:e.status?.timestamp?new Date(e.status.timestamp).toLocaleString():"—"})]}),(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"font-medium text-slate-700",children:"Результат ping"}),a.jsx("dd",{className:i,children:n?.attempted?n.ok?`OK (${n.status??"?"})`:`Помилка ${n.status??""}`:"не виконувався"})]})]}),(0,a.jsxs)("div",{className:"mt-4 space-y-2 text-xs text-slate-600",children:[n?.endpoint&&(0,a.jsxs)("p",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"URL перевірки:"})," ",n.endpoint]}),n?.error&&a.jsx("p",{className:"whitespace-pre-wrap rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-amber-700",children:n.error}),!n?.attempted&&a.jsx("p",{className:"rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-amber-700",children:"Щоб виконати перевірку, заповніть KEYCRM_API_URL та KEYCRM_API_TOKEN у середовищі. Після цього натисніть \xabОновити\xbb."})]})]})}},7268:(e,t,s)=>{"use strict";s.d(t,{ManychatCampaignRouter:()=>c});var a=s(326),r=s(7577);let l={success:{dot:"bg-emerald-500",border:"border-emerald-200",title:"text-emerald-700",text:"text-emerald-700"},warning:{dot:"bg-amber-500",border:"border-amber-200",title:"text-amber-700",text:"text-amber-700"},error:{dot:"bg-rose-500",border:"border-rose-200",title:"text-rose-700",text:"text-rose-700"},info:{dot:"bg-slate-400",border:"border-slate-200",title:"text-slate-700",text:"text-slate-600"}};function n({index:e,title:t,status:s,children:r}){let n=l[s];return(0,a.jsxs)("li",{className:"relative ml-0 list-none pl-6",children:[a.jsx("span",{className:`absolute -left-[32px] top-2 flex h-7 w-7 items-center justify-center rounded-full text-xs font-semibold text-white shadow-sm ${n.dot}`,children:e+1}),(0,a.jsxs)("div",{className:`rounded-xl border bg-white px-4 py-3 shadow-sm ${n.border}`,children:[a.jsx("div",{className:`text-sm font-semibold ${n.title}`,children:t}),a.jsx("div",{className:`mt-1 space-y-1 text-sm ${n.text}`,children:r})]})]})}function i({target:e,label:t}){let s=e.pipelineName||e.pipelineId||"—",r=e.statusName||e.statusId||"—";return(0,a.jsxs)("div",{className:"rounded-xl bg-slate-50 px-3 py-2 text-sm",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:t}),a.jsx("div",{className:"font-medium text-slate-700",children:s}),(0,a.jsxs)("div",{className:"text-slate-500",children:["Статус: ",r]})]})}function d({attempt:e}){let t=e.result.ok;return(0,a.jsxs)("div",{className:"flex items-start justify-between rounded-lg border px-3 py-2 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-medium text-slate-700",children:[e.kind,": ",a.jsx("span",{className:"text-slate-500",children:e.value})]}),!t&&(0,a.jsxs)("div",{className:"text-xs text-red-500",children:["Помилка: ",e.result.error]}),t&&!e.result.match&&(0,a.jsxs)("div",{className:"text-xs text-slate-500",children:["Без точного збігу, карток перевірено: ",e.result.cardsChecked]})]}),a.jsx("span",{className:`text-sm font-semibold ${t?"text-emerald-600":"text-red-500"}`,children:t?"✓":"✕"})]})}function o({value:e}){try{return a.jsx("pre",{className:"max-h-64 overflow-auto rounded-lg bg-slate-900/90 p-3 text-xs text-slate-100",children:JSON.stringify(e,null,2)})}catch(e){return(0,a.jsxs)("div",{className:"text-sm text-red-500",children:["JSON error: ",String(e)]})}}function c(){let[e,t]=(0,r.useState)(""),[s,l]=(0,r.useState)(""),[c,m]=(0,r.useState)(""),[u,p]=(0,r.useState)({status:"idle",message:"Вставте ManyChat-повідомлення: username, повне ім'я та текст, щоб знайти кампанію та перемістити картку."}),x="success"===u.status?u.payload:null,h=[];if(x){let e=x.match?.campaign,t=x.search.selected?.match||null,s=x.search.selected?.summary||null,r=x.move,l=(()=>{let e=(r.response&&"object"==typeof r.response&&Array.isArray(r.response.history)?r.response.history:null)||(r.details&&"object"==typeof r.details&&Array.isArray(r.details.history)?r.details.history:null);return Array.isArray(e)?e:[]})(),n=l.find(e=>null!=e&&"object"==typeof e),i=r.requestUrl&&r.requestUrl.trim().length?r.requestUrl:"string"==typeof n?.url?n.url:null,d=r.requestMethod&&r.requestMethod.trim().length?r.requestMethod:"string"==typeof n?.method?n.method:null,c=r.sent??(n&&"sent"in n?n.sent:null),m=r.attempted??!!(i||c||l.length>0),u=m&&r.ok,p=e=>{if("string"!=typeof e)return null;let t=e.trim();return t.length?t:null},g=e?.base??null,f=x.search.selected?.summary??null,y=(()=>{if(!g)return[];let e=[],t=p(g.pipelineStatusId);if(t&&e.push(t),!e.length){let t=p(g.statusId);t&&e.push(t)}return e})(),b=!g?.pipelineId||f?.pipelineId===g.pipelineId,j=0===y.length||y.some(e=>e===p(f?.pipelineStatusId)||e===p(f?.statusId)),N=!!f&&(!b||!j);h=[{key:"message",title:"Отримано повідомлення ManyChat",status:"success",content:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:["Текст: ",a.jsx("span",{className:"font-medium",children:x.normalized.text||"—"})]}),(0,a.jsxs)("div",{children:["Username: ",x.normalized.handle||"—"]}),(0,a.jsxs)("div",{children:["Ім'я: ",x.normalized.fullName||"—"]})]})},{key:"campaign",title:"Підібрана кампанія",status:e?"success":"error",content:e?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:["Назва: ",a.jsx("span",{className:"font-medium",children:e.name||e.id||"—"})]}),(0,a.jsxs)("div",{children:["Правило: ",x.match.rule.op,' → "',x.match.rule.value,'"']}),(0,a.jsxs)("div",{children:["Базова пара: ",e.base.pipelineName||e.base.pipelineId||"—"," /"," ",e.base.statusName||e.base.statusId||"—"]}),(0,a.jsxs)("div",{children:["Цільова пара: ",e.target.pipelineName||e.target.pipelineId||"—"," /"," ",e.target.statusName||e.target.statusId||"—"]})]}):a.jsx("div",{children:"Відповідну кампанію не знайдено."})},{key:"card",title:"Знайдена картка в KeyCRM",status:t?N?"error":"success":"warning",content:t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:["Картка #",t.cardId,": ",a.jsx("span",{className:"font-medium",children:t.title})]}),(0,a.jsxs)("div",{children:["Збіг за ",t.matchedField,": ",t.matchedValue]}),s&&(0,a.jsxs)("div",{children:["Поточна пара: ",s.pipelineName||s.pipelineId||"—"," /"," ",s.statusName||s.statusId||"—"]}),N&&g?(0,a.jsxs)("div",{className:"text-sm text-rose-600",children:["Картка не знаходиться у базовій парі. Очікували ",g.pipelineName||g.pipelineId||"—"," → ",g.statusName||g.statusId||g.pipelineStatusId||"—",", а зараз вона в"," ",s?.pipelineName||s?.pipelineId||"—"," → ",s?.statusName||s?.statusId||s?.pipelineStatusId||"—","."]}):null]}):a.jsx("div",{children:"Картку не знайдено у базовій воронці. Перевірте вхідні дані або налаштування кампанії."})},{key:"move",title:"Переміщення картки",status:m?u?"success":"error":"info",content:a.jsx(a.Fragment,{children:m?(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{children:u?"Переміщення підтверджено.":"Переміщення не підтверджено."}),(0,a.jsxs)("div",{children:["HTTP статус: ",r.status??"—"]}),r.baseUrl&&(0,a.jsxs)("div",{className:"text-xs text-slate-500",children:["Базова адреса KeyCRM: ",r.baseUrl]}),r.error&&(0,a.jsxs)("div",{className:"text-sm text-rose-600",children:["Код помилки: ",r.error]}),!u&&r.skippedReason&&(0,a.jsxs)("div",{className:"text-sm text-rose-600",children:["Причина: ",r.skippedReason]}),d&&i&&(0,a.jsxs)("div",{className:"text-sm text-slate-600",children:["Запит: ",d," ",i]}),c&&(0,a.jsxs)("div",{className:"space-y-1",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"Тіло запиту"}),a.jsx(o,{value:c})]}),Array.isArray(r.attempts)&&r.attempts.length>0&&(0,a.jsxs)("div",{className:"space-y-1",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"Спроби перевірки"}),a.jsx(o,{value:r.attempts})]})]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{children:"Переміщення не виконувалось."}),r.skippedReason&&(0,a.jsxs)("div",{className:"text-sm text-slate-600",children:["Причина: ",r.skippedReason]}),d&&i&&(0,a.jsxs)("div",{className:"text-xs text-slate-500",children:["Потенційний запит: ",d," ",i]}),c&&(0,a.jsxs)("div",{className:"space-y-1",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"Очікуване тіло запиту"}),a.jsx(o,{value:c})]})]})})},{key:"raw",title:"Сира відповідь KeyCRM",status:m?u?"success":"error":"info",content:m?r.response?a.jsx(o,{value:r.response}):a.jsx("div",{children:"Відповідь KeyCRM порожня."}):r.response||r.details||r.error||r.skippedReason?a.jsx(o,{value:{move:r}}):a.jsx("div",{children:"Переміщення не запускалось, відповідь відсутня."})}]}async function g(t){t.preventDefault();let a={message:{username:e.trim()||void 0,full_name:s.trim()||void 0,text:c.trim()}};p({status:"loading"});try{let e=await fetch("/api/admin/test/manychat",{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify(a)}),t=await e.json().catch(()=>null);if(!t){p({status:"error",statusCode:e.status,payload:{ok:!1,error:"invalid_response"}});return}if(!e.ok){let s=!1===t.ok?t:{ok:!1,error:`http_${e.status}`};p({status:"error",statusCode:e.status,payload:s});return}if(!t.ok){p({status:"error",statusCode:e.status,payload:t});return}p({status:"success",payload:t,statusCode:e.status})}catch(e){p({status:"error",statusCode:0,payload:{ok:!1,error:"network_error",details:e instanceof Error?e.message:String(e)}})}}return(0,a.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"ManyChat → KeyCRM тест"}),a.jsx("p",{className:"text-sm text-slate-500",children:"Порівнює текст повідомлення з правилами V1/V2 кампаній, шукає картку в базовій воронці та переносить її у цільову пару."})]}),(0,a.jsxs)("form",{onSubmit:g,className:"mt-4 space-y-4",children:[(0,a.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,a.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:[a.jsx("span",{className:"text-slate-600",children:"IG username"}),a.jsx("input",{value:e,onChange:e=>t(e.target.value),placeholder:"@username",className:"rounded-lg border px-3 py-2 text-sm outline-none focus:border-indigo-500"})]}),(0,a.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:[a.jsx("span",{className:"text-slate-600",children:"Повне ім'я"}),a.jsx("input",{value:s,onChange:e=>l(e.target.value),placeholder:"Viktoria Kolachnyk",className:"rounded-lg border px-3 py-2 text-sm outline-none focus:border-indigo-500"})]})]}),(0,a.jsxs)("label",{className:"flex flex-col gap-1 text-sm",children:[a.jsx("span",{className:"text-slate-600",children:"Текст повідомлення"}),a.jsx("textarea",{value:c,onChange:e=>m(e.target.value),placeholder:"Наприклад: хочу записатись на процедуру v1",className:"min-h-[100px] rounded-lg border px-3 py-2 text-sm outline-none focus:border-indigo-500",required:!0})]}),a.jsx("button",{type:"submit",className:"inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500 disabled:cursor-not-allowed disabled:bg-indigo-300",disabled:"loading"===u.status,children:"loading"===u.status?"Опрацьовуємо…":"Запустити пошук"})]}),"idle"===u.status&&a.jsx("p",{className:"mt-4 rounded-lg bg-slate-50 px-3 py-2 text-sm text-slate-500",children:u.message}),"error"===u.status&&(0,a.jsxs)("div",{className:"mt-4 space-y-3 rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700",children:[(0,a.jsxs)("div",{className:"font-semibold",children:["Помилка (",u.statusCode||"—","): ",u.payload.error]}),u.payload.details&&a.jsx(o,{value:u.payload.details})]}),"success"===u.status&&(0,a.jsxs)("div",{className:"mt-6 space-y-6",children:[h.length>0&&(0,a.jsxs)("div",{className:"space-y-3",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Послідовність автоматизації"}),a.jsx("ol",{className:"relative space-y-4 border-l border-slate-200 pl-6",children:h.map((e,t)=>a.jsx(n,{index:t,title:e.title,status:e.status,children:e.content},e.key))})]}),(0,a.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[a.jsx(i,{target:u.payload.match.campaign.base,label:"Базова воронка"}),a.jsx(i,{target:u.payload.match.campaign.target,label:"Цільова воронка"})]}),(0,a.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,a.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"Кампанія"}),a.jsx("div",{className:"font-semibold text-slate-800",children:u.payload.match.campaign.name||u.payload.match.campaign.id||"Без назви"}),(0,a.jsxs)("div",{className:"text-slate-500",children:["Маршрут: ",u.payload.match.route.toUpperCase()]}),(0,a.jsxs)("div",{className:"text-xs text-slate-500",children:["Правило: ",u.payload.match.rule.op,' → "',u.payload.match.rule.value,'"']})]}),(0,a.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"ManyChat"}),(0,a.jsxs)("div",{className:"text-slate-600",children:["handle: ",u.payload.normalized.handle||"—"]}),(0,a.jsxs)("div",{className:"text-slate-600",children:["full name: ",u.payload.normalized.fullName||"—"]}),(0,a.jsxs)("div",{className:"text-slate-500",children:["text: ",u.payload.normalized.text||"—"]})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Спроби пошуку"}),a.jsx("div",{className:"space-y-2",children:u.payload.search.attempts.map(e=>a.jsx(d,{attempt:e},`${e.kind}:${e.value}`))})]}),u.payload.search.selected&&(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Результат пошуку"}),(0,a.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[(0,a.jsxs)("div",{className:"font-medium text-slate-800",children:["Картка #",u.payload.search.selected.match?.cardId]}),a.jsx("div",{className:"text-slate-600",children:u.payload.search.selected.match?.title||"Без назви"}),(0,a.jsxs)("div",{className:"text-xs text-slate-500",children:["Збіг: ",u.payload.search.selected.match?.matchedField," →"," ",u.payload.search.selected.match?.matchedValue]})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Переміщення"}),(0,a.jsxs)("div",{className:"rounded-xl border px-4 py-3 text-sm",children:[u.payload.move.attempted?(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"font-medium text-slate-800",children:"Виконано через API"}),(0,a.jsxs)("div",{className:"text-slate-500",children:["HTTP статус: ",u.payload.move.status??"—"]}),u.payload.move.requestMethod&&u.payload.move.requestUrl&&(0,a.jsxs)("div",{className:"text-xs text-slate-500",children:["Запит: ",u.payload.move.requestMethod," ",u.payload.move.requestUrl]}),u.payload.move.error&&(0,a.jsxs)("div",{className:"text-xs text-rose-600",children:["Код помилки: ",u.payload.move.error]})]}):(0,a.jsxs)("div",{className:"text-slate-500",children:["Пропущено: ",u.payload.move.skippedReason||"невідомо"]}),u.payload.move.sent&&(0,a.jsxs)("div",{className:"mt-2 space-y-1",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"Тіло запиту"}),a.jsx(o,{value:u.payload.move.sent})]}),u.payload.move.response&&(0,a.jsxs)("div",{className:"mt-2 space-y-1",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"Сира відповідь"}),a.jsx(o,{value:u.payload.move.response})]}),Array.isArray(u.payload.move.attempts)&&u.payload.move.attempts.length>0&&(0,a.jsxs)("div",{className:"mt-2 space-y-1",children:[a.jsx("div",{className:"text-xs uppercase text-slate-400",children:"Спроби перевірки"}),a.jsx(o,{value:u.payload.move.attempts})]})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Сира відповідь автоматизації"}),a.jsx(o,{value:u.payload})]})]})]})}},6105:(e,t,s)=>{"use strict";s.d(t,{ManychatMessageInbox:()=>I});var a=s(326),r=s(7577);let l=(e,t)=>{if(!e)return null;let s={},a=(()=>{if("number"==typeof t&&Number.isFinite(t))return String(t);if("string"==typeof t){let e=t.trim();return e.length?e:null}return null})();a&&(s.card_id=a);let r=e.pipelineId??null;r&&(s.pipeline_id=r,s.to_pipeline_id=r);let l=e.pipelineStatusId??e.statusId??null;return l&&(s.pipeline_status_id=l,s.status_id=l,s.to_status_id=l),Array.isArray(e.statusAliases)&&e.statusAliases.length&&(s.status_aliases=e.statusAliases),Object.keys(s).length?s:null},n=e=>{if("number"==typeof e&&Number.isFinite(e))return String(e);if("string"==typeof e){let t=e.trim();if(t.length)return t}return null},i=({details:e,target:t,cardId:s,defaultMethod:a="POST"})=>{let r=d(e)?e:null,l=w(r?.requestUrl)??w(r?.url)??null,i=w(r?.requestMethod)??w(r?.method)??a,o=w(r?.baseUrl)??w(r?.base)??null,c=t?.pipelineId??null,m=t?.pipelineStatusId??t?.statusId??null,u=n(s);if(l)return{requestUrl:l,requestMethod:i,baseUrl:o,exact:!0};let p=o?o.replace(/\/+$/,""):null,x=u?`/pipelines/cards/${u}`:"/pipelines/cards/{id}",h=p??"https://openapi.keycrm.app/api/v1",g=`${h}${x}`;return u?m&&c&&(g=`${h}/pipelines/cards/${u}`):g=`${h}/pipelines/cards/move`,{requestUrl:g,requestMethod:i,baseUrl:o,exact:!1}},d=e=>"object"==typeof e&&null!==e&&!Array.isArray(e),o=(e,t=240)=>{if(null==e)return"—";if("string"==typeof e){let s=e.trim();return s?s.length>t?`${s.slice(0,t)}…`:s:"—"}try{let s=JSON.stringify(e);if(!s)return"—";return s.length>t?`${s.slice(0,t)}…`:s}catch{let s=String(e);return s.length>t?`${s.slice(0,t)}…`:s}},c=e=>{switch(e){case"already_in_target":return"Картка вже у цільовій воронці та статусі";case"move_handler_missing":return"На сервері недоступна функція переміщення";case"campaign_target_status_missing":return"Кампанія не містить цільового статусу для переміщення";case"card_not_in_base":return"Картка знаходиться поза базовою парою кампанії";default:return e}},m=e=>!!(e&&e.ok),u=(e,t,s)=>{if(null==s)return null;let r=null;if("string"==typeof s)r=s.trim();else try{r=JSON.stringify(s,null,2)}catch(e){r=String(e instanceof Error?e.message:s)}return r?(0,a.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[a.jsx("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:t}),a.jsx("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:r})]},e):null},p=(e,t,s)=>{if(!s)return null;let r=s.trim();return r.length?(0,a.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[a.jsx("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:t}),a.jsx("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:r})]},e):null},x=e=>{if(!d(e))return[];let t=e.history;if(!Array.isArray(t))return[];let s=[];for(let e of t){if(!d(e))continue;let t=Array.isArray(e.verification)?e.verification:void 0;s.push({attempt:"string"==typeof e.attempt?e.attempt:void 0,status:"number"==typeof e.status?e.status:void 0,ok:"boolean"==typeof e.ok?e.ok:void 0,sent:d(e.sent)?e.sent:null,verification:t,body:e.body,error:"string"==typeof e.error?e.error:void 0})}return s},h=e=>e&&0!==e.length?e.slice(0,4).map((e,t)=>{let s=e.snapshot?.pipelineId??"—",a=e.snapshot?.statusId??"—",r=e.pipelineMatches?"✅":"⚠️",l=e.statusMatches?"✅":"⚠️";return`#${t+1}: воронка ${s} ${r} \xb7 статус ${a} ${l}`}):[],g=e=>{if(null==e)return null;if("string"==typeof e){let t=e.trim();return t.length?t:null}return"number"==typeof e&&Number.isFinite(e)?String(e):null},f=e=>{let t=new Set,s=[];for(let a of e){let e=g(a);!e||t.has(e)||(t.add(e),s.push(e))}return s},y=e=>{let t=f(e);return t.length?t.join(", "):"—"},b=e=>{if(!e)return"—";let t=e.pipelineName??e.pipelineId??"—",s=e.statusName??e.statusId??e.pipelineStatusId??"—",a=y([e.statusId,e.pipelineStatusId,...e.statusAliases??[]]);return"—"===a?`${t} → ${s}`:`${t} → ${s} (ID: ${a})`},j=e=>{if(!e?.snapshot)return"—";let t=e.snapshot.pipelineId??"—",s=e.snapshot.statusId??"—";return`${t} → ${s}`},N={invalid_json:{stage:"message",step:1,title:"Отримання повідомлення",module:"web/app/api/mc/manychat/route.ts → normalizeManyChat",hint:"ManyChat надіслав невалідний JSON або тіло вебхука порожнє."},identity_missing:{stage:"message",step:1,title:"Пошук ідентифікаторів",module:"web/lib/manychat-routing.ts → resolveIdentityCandidates",hint:"У повідомленні нема username/full name для пошуку картки."},campaign_not_found:{stage:"campaign",step:2,title:"Визначення кампанії",module:"web/lib/manychat-routing.ts → matchCampaignByRules",hint:"Перевірте правила V1/V2 та значення в KV."},campaign_base_missing:{stage:"campaign",step:2,title:"Перевірка базової пари",module:"web/lib/manychat-routing.ts → normaliseCampaignBase",hint:"У кампанії не вказано базову воронку чи статус."},campaign_target_missing:{stage:"campaign",step:2,title:"Перевірка цільової пари",module:"web/lib/manychat-routing.ts → normaliseCampaignTarget",hint:"У кампанії відсутні цільові воронка/статус."},campaign_target_status_missing:{stage:"campaign",step:2,title:"Статус цільової пари",module:"web/lib/manychat-routing.ts → resolveTargetStatus",hint:"Кеш воронок KeyCRM не повернув pipeline_status_id для обраного статусу."},keycrm_search_failed:{stage:"search",step:3,title:"Пошук картки у KeyCRM",module:"web/lib/keycrm-card-search.ts",hint:"KeyCRM повернув помилку під час пошуку картки."},card_not_found:{stage:"search",step:3,title:"Пошук картки у KeyCRM",module:"web/lib/manychat-routing.ts → pickCardMatch",hint:"Немає картки у базовій воронці, що відповідає критеріям."},card_match_missing:{stage:"search",step:3,title:"Валідація збігу картки",module:"web/lib/manychat-routing.ts → ensureCardMatch"},card_not_in_base:{stage:"search",step:3,title:"Перевірка базової пари",module:"web/lib/manychat-routing.ts → ensureCardInBase",hint:"Картку знайдено, але вона вже не у стартовому статусі кампанії."},keycrm_move_failed:{stage:"move",step:4,title:"Переміщення картки",module:"web/lib/keycrm-move.ts",hint:"KeyCRM повернув помилку або не підтвердив зміну статусу."},keycrm_not_configured:{stage:"move",step:4,title:"Переміщення картки",module:"web/app/api/mc/manychat/route.ts → performMove",hint:"Не налаштовані KEYCRM_API_URL чи KEYCRM_API_TOKEN."},automation_exception:{stage:"move",step:4,title:"Виконання автоматизації",module:"web/app/api/mc/manychat/route.ts"}},v={message:"message",campaign:"campaign",search:"card",move:"move"},k=e=>N[e]??{stage:"move",step:4,title:"Переміщення картки",module:"web/lib/manychat-routing.ts"},w=e=>{if("string"==typeof e){let t=e.trim();return t.length?t:null}return"number"==typeof e&&Number.isFinite(e)?String(e):null},_=e=>e&&"object"==typeof e?{pipelineId:w(e.pipelineId)??w(e.pipeline_id)??w(e.pipeline),statusId:w(e.statusId)??w(e.status_id)??w(e.status),pipelineStatusId:w(e.pipelineStatusId)??w(e.pipeline_status_id)??w(e?.pipeline_status),pipelineName:w(e.pipelineName)??w(e.pipeline_name)??w(e.pipelineTitle),statusName:w(e.statusName)??w(e.status_name)??w(e.statusTitle),statusAliases:Array.isArray(e?.statusAliases)?e.statusAliases.map(e=>w(e)).filter(e=>!!e):null}:{pipelineId:null,statusId:null,pipelineStatusId:null,pipelineName:null,statusName:null,statusAliases:null},S={success:{dot:"bg-emerald-500",border:"border-emerald-200",title:"text-emerald-700",text:"text-emerald-700"},warning:{dot:"bg-amber-500",border:"border-amber-200",title:"text-amber-700",text:"text-amber-700"},error:{dot:"bg-rose-500",border:"border-rose-200",title:"text-rose-700",text:"text-rose-700"},info:{dot:"bg-slate-400",border:"border-slate-200",title:"text-slate-700",text:"text-slate-600"}};function R({steps:e}){return e.length?a.jsx("ol",{className:"space-y-3",children:e.map((e,t)=>{let s=S[e.status];return(0,a.jsxs)("li",{className:"relative ml-0 list-none pl-10",children:[a.jsx("span",{className:`absolute left-0 top-2 flex h-7 w-7 items-center justify-center rounded-full text-xs font-semibold text-white shadow-sm ${s.dot}`,children:t+1}),(0,a.jsxs)("div",{className:`rounded-xl border bg-white px-4 py-3 shadow-sm ${s.border}`,children:[a.jsx("div",{className:`text-sm font-semibold ${s.title}`,children:e.title}),a.jsx("div",{className:`mt-1 space-y-1 text-sm ${s.text}`,children:e.details.map((t,s)=>a.jsx("div",{children:t},`${e.key}-${s}`))})]})]},e.key)})}):null}function I(){let[e,t]=(0,r.useState)({status:"loading",trace:null,diagnostics:null,automation:null,automationAnalysis:null});(0,r.useRef)(null);let[s,n]=(0,r.useState)(!1);async function f(){try{n(!0);let e=await fetch("/api/mc/manychat",{cache:"no-store"}),s=await e.json().catch(()=>null),a=s?.automationAnalysis??null;if(!s||!e.ok){t({status:"error",message:`Помилка завантаження (${e.status})`,trace:s?.trace??null,diagnostics:s?.diagnostics??null,automation:s?.automation??null,automationAnalysis:a});return}let r=Array.isArray(s.feed)?s.feed:Array.isArray(s.messages)?s.messages:null,l=r&&r.length>0?r:s.latest?[s.latest]:[],i=(!l||0===l.length)&&s.trace?[{id:s.trace.receivedAt??Date.now(),receivedAt:s.trace.receivedAt??Date.now(),source:"trace:webhook",title:"ManyChat Webhook",handle:s.trace.handle??null,fullName:s.trace.fullName??null,text:s.trace.messagePreview??"",raw:null}]:[],d=l&&l.length>0?l:i,o=d&&d.length>0?d[0]:s.latest?s.latest:i.length>0?i[0]:null,c=s.requestSnapshot?{rawText:s.requestSnapshot.rawText??null,receivedAt:"number"==typeof s.requestSnapshot.receivedAt?s.requestSnapshot.receivedAt:s.requestSnapshot.receivedAt?Number(s.requestSnapshot.receivedAt):null,source:s.requestSnapshot.source??null}:null;t({status:"ready",messages:d,lastMessage:o,updatedAt:new Date,source:s.source??null,trace:s.trace??null,diagnostics:s.diagnostics??null,rawSnapshot:s.rawSnapshot??null,requestSnapshot:c,automation:s.automation??null,automationAnalysis:a})}catch(e){t({status:"error",message:e instanceof Error?e.message:String(e),trace:null,diagnostics:null,automation:null,automationAnalysis:null})}finally{n(!1)}}let y=e.trace??null,N=e.diagnostics??null,S=N?.api??null,I=N?.kvConfig??null,C=N?.kv??null,A=N?.kvTrace??null,M=N?.kvRaw??null,P=N?.kvRequest??null,K=N?.kvFeed??null,$=N?.traceFallback??null,O="ready"===e.status?e.automation:e.automation??null,q=(e.status,e.automationAnalysis??null),T=O??q??null,E="ready"===e.status?e.lastMessage:null,U="ready"===e.status?e.rawSnapshot??null:null,V="ready"===e.status?e.requestSnapshot??null:null,D=V?.rawText??U?.rawText??U?.text??null,L=E?.text?.trim()?.length?E.text:D?.trim()?.length?D:null,J=[],H=O&&!1===O.ok?O:q&&!1===q.ok?q:null,F=H?k(H.error):null,B=H&&"object"==typeof H?H.details??null:null,G=y?"accepted"===y.status?"success":"warning":E?"success":"info";if(E||y||L){let e=[];E?.fullName||E?.handle?e.push((0,a.jsxs)("span",{children:["Контакт: ",E?.fullName||"—",E?.handle?(0,a.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",E.handle,")"]}):null]},"contact")):(y?.fullName||y?.handle)&&e.push((0,a.jsxs)("span",{children:["Контакт: ",y?.fullName||"—",y?.handle?(0,a.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",y.handle,")"]}):null]},"contact-trace")),e.push((0,a.jsxs)("span",{children:["Текст: ",L??"(порожній текст повідомлення)"]},"text")),e.push((0,a.jsxs)("span",{children:["Час: ",new Date(y?.receivedAt??("number"==typeof E?.receivedAt?E.receivedAt:"string"==typeof E?.receivedAt?Number.parseInt(E.receivedAt,10):Date.now())).toLocaleString()]},"time")),J.push({key:"message",title:"1. Отримане повідомлення з ManyChat",status:G,details:e})}else J.push({key:"message",title:"1. Очікуємо ManyChat повідомлення",status:"info",details:[a.jsx("span",{children:"Надішліть ключове слово в Instagram, щоб ManyChat надіслав вебхук у це середовище."},"pending")]});if(O||q){let e=O&&!1===O.ok?O:null,t=q&&!1===q.ok?q:null,s=O&&O.ok?{result:O,origin:"automation"}:q&&q.ok?{result:q,origin:"analysis"}:null;if(s){let t=s.result,r="automation"===s.origin,n=t.match.campaign,d=n.base,m=n.target,g=[(0,a.jsxs)("span",{children:["Кампанія: ",n.name??"(без назви)"]},"name"),(0,a.jsxs)("span",{children:["Маршрут: ",t.match.route.toUpperCase()," \xb7 Правило: ","equals"===t.match.rule.op?"точний збіг":"містить"]},"route"),(0,a.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",d.pipelineName??d.pipelineId??"—"," → статус ",d.statusName??d.statusId??"—"," \xb7 Ціль: ",m.pipelineName??m.pipelineId??"—"," → ",m.statusName??m.statusId??"—"]},"targets")];!r&&e&&g.push((0,a.jsxs)("span",{className:"text-xs text-amber-600/80",children:["Автоматизація завершилась з помилкою: ",e.error,". Показано аналітичний підбір кампанії."]},"analysis-note")),J.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:g});let f=t.search.selected??null,y=f?.match??null,N=f?.summary??null,v=y?"success":"warning",k=e=>{if("string"==typeof e){let t=e.trim();return t.length?t:null}return"number"==typeof e&&Number.isFinite(e)?String(e):null},w=[];if(y?(w.push((0,a.jsxs)("span",{children:["Картка #",y.cardId,y.title?` • ${y.title}`:""]},"card")),w.push((0,a.jsxs)("span",{className:"text-xs text-slate-600",children:["Збіг за: ",y.matchedField,y.matchedValue?` → ${y.matchedValue}`:""]},"field"))):w.push(a.jsx("span",{children:"Картку не знайдено. Перевірте кампанію або ключові слова."},"missing")),t.search.usedNeedle&&w.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Використаний ідентифікатор: ",t.search.usedNeedle]},"needle")),N){let e=N.pipelineName??N.pipelineId??"—",t=N.statusName??N.statusId??N.pipelineStatusId??"—";w.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Поточна позиція: ",e," → ",t]},"summary"));let s=[k(d.pipelineStatusId),k(d.statusId),...Array.isArray(d.statusAliases)?d.statusAliases.map(e=>k(e)):[]].filter(e=>!!e),r=!k(d.pipelineId)||k(d.pipelineId)===k(N.pipelineId),l=0===s.length||s.some(e=>e===k(N.pipelineStatusId)||e===k(N.statusId));if(!r||!l){v="error";let s=d.pipelineName??d.pipelineId??"—",r=d.statusName??d.statusId??d.pipelineStatusId??"—";w.push((0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Картка не знаходиться у базовій парі. Очікували ",s," → ",r,", а отримали ",e," → ",t,"."]},"base-mismatch"))}}!r&&e&&w.push((0,a.jsxs)("span",{className:"text-xs text-amber-600/80",children:["Автоматичне переміщення зупинилось з помилкою: ",e.error,"."]},"automation-error")),J.push({key:"card",title:"3. Пошук картки у KeyCRM",status:v,details:w});let _=O&&O.ok?O:q&&q.ok?q:null,S=_&&O&&O.ok&&_===O?"automation":_?"analysis":null,R=_?.move??null;if(R){if(_&&_.ok){let e=[],t=R.ok?"success":"warning";if(R.attempted){let s=_.match?.campaign?.target??null,r=_.match?.campaign?.base??null,n=_.search?.selected?.match?.cardId??_.search?.selected?.cardId??null;e.push((0,a.jsxs)("span",{children:["Переміщення: ",R.ok?"✅ успішно":"⚠️ не підтверджено"]},"attempt")),r&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова пара (очікували, що картка тут): ",b(r)]},"base")),s&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Цільова пара (переміщуємо сюди): ",b(s)]},"target"));let i=(Array.isArray(R.response?.history)?R.response.history:[]).find(e=>e?.url),d=i?.url,c=i?.method,m=R.requestUrl??d??null,g=R.requestMethod??c??null,f=R.sent??l(s,n),y=u("payload",R.sent?"JSON запиту до KeyCRM":"Очікуваний JSON запиту",f);y?e.push(y):e.push(a.jsx("span",{className:"text-xs text-amber-600/80",children:"Параметри запиту не зафіксовані — перевірте серверні логи."},"payload-missing")),R.baseUrl&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова адреса KeyCRM:"," ",a.jsx("code",{className:"break-all text-[0.7rem]",children:R.baseUrl})]},"base-url")),(m||g)&&e.push((0,a.jsxs)("div",{className:"text-xs text-slate-600/80",children:["URL запиту:"," ",m?a.jsx("code",{className:"break-all text-[0.7rem]",children:m}):"н/д",g?(0,a.jsxs)("span",{className:"ml-1 text-slate-500",children:["(метод ",g,")"]}):null]},"request-url"));let N=R.attempts??[];if(N.length){let t=N[N.length-1];e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/70",children:["Перевірка KeyCRM: воронка ",t.pipelineMatches?"✅":"⚠️"," \xb7 статус ",t.statusMatches?"✅":"⚠️"]},"verify")),e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/70",children:["Поточний стан картки за останньою перевіркою: ",j(t)]},"snapshot")),e.push((0,a.jsxs)("div",{className:"mt-1 space-y-1 rounded-lg border border-slate-200/70 bg-white/70 p-2 text-[0.7rem] text-slate-700",children:[a.jsx("div",{className:"font-semibold text-slate-800",children:"Перевірки API KeyCRM:"}),N.map((e,t)=>(0,a.jsxs)("div",{className:"leading-tight",children:["#",t+1,": ",j(e)," \xb7 воронка ",e.pipelineMatches?"✅":"⚠️"," \xb7 статус ",e.statusMatches?"✅":"⚠️"]},`attempt-${t}`))]},"attempt-list"))}else e.push(a.jsx("span",{className:"text-xs text-amber-600/80",children:"KeyCRM не повернув жодної перевірки стану — запит міг завершитись помилкою до застосування змін."},"no-attempts"));R.status&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/70",children:["Код відповіді KeyCRM: ",R.status]},"status")),!R.ok&&R.error&&e.push((0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Помилка: ",R.error]},"error"));let v=u("details","Деталі помилки",R.details);v&&e.push(v);let k=x(R.response);k.length&&e.push((0,a.jsxs)("div",{className:"mt-2 space-y-2 rounded-lg border border-emerald-100 bg-emerald-50/60 p-2 text-left text-[0.72rem] text-slate-700",children:[a.jsx("div",{className:"font-semibold text-emerald-800",children:"Деталі спроб:"}),k.map((e,t)=>{let s=h(e.verification),r=e.sent?o(e.sent):null,l=null!=e.body?o(e.body):null;return(0,a.jsxs)("div",{className:"rounded border border-emerald-200/80 bg-white/80 p-2",children:[(0,a.jsxs)("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-emerald-700",children:["Спроба #",t+1,": ",e.attempt??"(невідомий ендпоінт)"]}),(0,a.jsxs)("div",{className:"mt-1",children:["HTTP ",e.status??"—"," \xb7 ",e.ok?"✅ підтверджено":"⚠️ не підтверджено"]}),e.error?(0,a.jsxs)("div",{className:"mt-1 text-rose-600/80",children:["Помилка запиту: ",e.error]}):null,r?(0,a.jsxs)("div",{className:"mt-1 text-slate-600",children:["Надіслано: ",a.jsx("code",{className:"break-all text-[0.7rem]",children:r})]}):null,l?(0,a.jsxs)("div",{className:"mt-1 text-slate-600",children:["Відповідь: ",a.jsx("code",{className:"break-all text-[0.7rem]",children:l})]}):null,s.length?(0,a.jsxs)("div",{className:"mt-1 space-y-1 text-slate-600",children:[a.jsx("div",{className:"font-medium text-emerald-800",children:"Перевірки:"}),s.map((e,s)=>a.jsx("div",{className:"text-[0.7rem]",children:e},`verify-${t}-${s}`)),e.verification&&e.verification.length>s.length?(0,a.jsxs)("div",{className:"text-[0.7rem] text-slate-500",children:["…іще ",e.verification.length-s.length," перевірок"]}):null]}):null]},`${e.attempt??"attempt"}-${t}`)})]},"history")),"analysis"===S&&e.push(a.jsx("span",{className:"text-xs text-amber-600/80",children:"Показано результати аналізу — фактична автоматизація ще не запускалась."},"analysis-note")),J.push({key:"move",title:"4. Переміщення картки",status:t,details:e});let w=[],I=R.ok?"success":R.response?"warning":"info",C=u("response","Сира відповідь KeyCRM",R.response);C?w.push(C):R.attempted?w.push(a.jsx("span",{className:"text-xs text-amber-600/80",children:"KeyCRM не повернув тіло відповіді — перевірте логи API."},"no-response")):w.push(a.jsx("span",{className:"text-xs text-slate-600/80",children:"Запит до KeyCRM не виконувався, тому відповіді немає."},"response-skipped")),J.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:I,details:w});let A=[];if(R.baseUrl&&A.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова адреса: ",a.jsx("code",{className:"break-all text-[0.7rem]",children:R.baseUrl})]},"req-base")),(m||g)&&A.push((0,a.jsxs)("div",{className:"text-xs text-slate-600/80",children:["HTTP ",g??"—"," ",a.jsx("code",{className:"break-all text-[0.7rem]",children:m??"(URL не зафіксовано)"})]},"req-url")),R.requestHeaders&&Object.keys(R.requestHeaders).length){let e=u("request-headers-step6","HTTP заголовки",R.requestHeaders);e&&A.push(e)}let M=p("request-body-raw-step6","Тіло запиту (raw)",R.requestBodyRaw);if(M)A.push(M);else if(R.sent){let e=u("request-body-json-step6","JSON запиту",R.sent);e&&A.push(e)}let P=p("request-response-raw-step6","Відповідь KeyCRM (raw)",R.responseRaw);if(P)A.push(P);else if(R.response&&!R.ok){let e=u("request-response-json-step6","JSON відповіді KeyCRM",R.response);e&&A.push(e)}A.length||A.push(a.jsx("span",{className:"text-xs text-slate-600/80",children:"Параметри запиту не зафіксовані — перевірте серверні логи."},"request-empty")),J.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:R.attempted?R.ok?"success":R.status&&R.status>=400?"error":"warning":"info",details:A})}else"already_in_target"===R.skippedReason?(t="success",e.push(a.jsx("span",{children:"Картка вже була у цільовій воронці/статусі."},"already")),J.push({key:"move",title:"4. Переміщення картки",status:t,details:e}),J.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"info",details:[a.jsx("span",{className:"text-xs text-slate-600/80",children:"Відповідь KeyCRM не очікувалась, оскільки картка вже у цільовій парі."},"already-response")]}),J.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"info",details:[a.jsx("span",{className:"text-xs text-slate-600/80",children:"Запит не надсилався, бо картка вже знаходилась у цільовій парі."},"already-request")]})):(e.push(a.jsx("span",{children:"Переміщення пропущено."},"skipped")),R.skippedReason&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Причина: ",c(R.skippedReason)]},"skipped-reason")),J.push({key:"move",title:"4. Переміщення картки",status:t,details:e}),J.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"warning",details:[a.jsx("span",{className:"text-xs text-slate-600/80",children:"Відповідь KeyCRM відсутня, оскільки переміщення не запускалось."},"skipped-response")]}),J.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"warning",details:[a.jsx("span",{className:"text-xs text-slate-600/80",children:"Запит не надсилався через пропущене переміщення."},"skipped-request")]}))}else{let e=[],t="warning",s="object"==typeof O&&O&&"error"in O?O.error:void 0;"keycrm_move_failed"===s?(t="error",e.push(a.jsx("span",{children:"Переміщення картки у KeyCRM не підтверджено."},"fail"))):s?(t="error",e.push((0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Автоматизація завершилась з помилкою: ",s]},"automation-error"))):e.push(a.jsx("span",{children:"Переміщення не виконувалось через попередню помилку."},"skip"));let r="object"==typeof O&&O&&"details"in O?O.details:void 0,n=u("automation-details","Деталі помилки",r);n&&e.push(n);let d=q?.ok?q.match?.campaign?.target??null:O&&O.ok?O.match?.campaign?.target??null:null,o=q?.ok?q.search?.selected?.match?.cardId??q.search?.selected?.cardId??null:O&&O.ok?O.search?.selected?.match?.cardId??O.search?.selected?.cardId??null:null,c=l(d,o);if(c){let t=u("error-expected-payload","Очікуваний JSON запиту",c);t&&e.push(t)}let m=i({details:r,target:d,cardId:o});m&&e.push((0,a.jsxs)("div",{className:"text-xs text-slate-600/80",children:[m.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,a.jsxs)("code",{className:"break-all text-[0.7rem]",children:[m.requestMethod," ",m.requestUrl]}),m.exact?null:a.jsx("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"error-request")),J.push({key:"move",title:"4. Переміщення картки",status:t,details:e}),J.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"warning",details:[a.jsx("span",{className:"text-xs text-slate-600/80",children:"Відповідь KeyCRM відсутня через попередню помилку автоматизації."},"error-response")]});let p=[];if(m?(p.push((0,a.jsxs)("div",{className:"text-xs text-slate-600/80",children:[m.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,a.jsxs)("code",{className:"break-all text-[0.7rem]",children:[m.requestMethod," ",m.requestUrl]}),m.exact?null:a.jsx("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"error-request-info")),m.baseUrl&&p.push((0,a.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Базова адреса: ",a.jsx("code",{className:"break-all",children:m.baseUrl})]},"error-base"))):p.push(a.jsx("span",{className:"text-xs text-slate-600/80",children:"Дані про запит до KeyCRM відсутні через помилку автоматизації."},"error-request-missing")),c){let e=u("error-request-expected","Очікуваний JSON запиту",c);e&&p.push(e)}J.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"warning",details:p})}}else{let e=O?.ok?O.match?.campaign?.target??null:q?.ok?q.match?.campaign?.target??null:null,t=O?.ok?O.search?.selected?.match?.cardId??O.search?.selected?.cardId??null:q?.ok?q.search?.selected?.match?.cardId??q.search?.selected?.cardId??null:null,s=[a.jsx("span",{children:"Автоматизація ще не запускалась у цьому середовищі — відображено лише аналітичний пошук."},"pending")],r=l(e,t),n=i({details:O&&!1===O.ok?O.details:void 0,target:e,cardId:t});if(r){let e=u("expected-move-payload","Очікуваний JSON запиту",r);e&&s.push(e)}n&&s.push((0,a.jsxs)("div",{className:"text-xs text-slate-600/80",children:[n.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,a.jsxs)("code",{className:"break-all text-[0.7rem]",children:[n.requestMethod," ",n.requestUrl]}),n.exact?null:a.jsx("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"pending-request")),J.push({key:"move",title:"4. Переміщення картки",status:"info",details:s}),J.push({key:"keycrm-response",title:"5. Відповідь KeyCRM",status:"info",details:[a.jsx("span",{children:"Відповідь KeyCRM ще не отримано."},"response-missing")]});let d=[];n?(d.push((0,a.jsxs)("div",{className:"text-xs text-slate-600/80",children:[n.exact?"Запит до KeyCRM:":"Очікуваний запит до KeyCRM:"," ",(0,a.jsxs)("code",{className:"break-all text-[0.7rem]",children:[n.requestMethod," ",n.requestUrl]}),n.exact?null:a.jsx("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"pending-request")),n.baseUrl&&d.push((0,a.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Базова адреса: ",a.jsx("code",{className:"break-all",children:n.baseUrl})]},"pending-base"))):d.push(a.jsx("span",{className:"text-xs text-slate-600/80",children:"Запит до KeyCRM ще не сформовано — очікуємо запуск автоматизації."},"pending-request-missing")),J.push({key:"keycrm-request",title:"6. HTTP запит до KeyCRM",status:"info",details:d})}}else{let s=e??t;if(s){let e=s.details??{},r=e&&"object"==typeof e&&e.campaign&&"object"==typeof e.campaign?e.campaign:null,l=t&&t.details&&"object"==typeof t.details?t.details.campaign:void 0,n="string"==typeof s.error?s.error.trim():String(s.error),i=r??l??null;if(n.includes("keycrm_move_failed")){let t=w(i?.name)??w(i?.title)??w(i?.id)??"(без назви)",s=_(i?.base??null),r=_(i?.target??i?.t1??i?.t2??null),l=d(e)?e:null,n=w(l?.requestUrl)??w(l?.url)??w(l?.baseUrl),c=w(l?.requestMethod),m=l?.sent??null,p=l?.response??null,x=[(0,a.jsxs)("span",{children:["Кампанія: ",t]},"move-campaign"),(0,a.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",s.pipelineName??s.pipelineId??"—"," → статус",s.statusName?` ${s.statusName}`:s.statusId?` ${s.statusId}`:" —"]},"move-route"),(0,a.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["Ціль: ",r.pipelineName??r.pipelineId??"—"," →",r.statusName?` ${r.statusName}`:r.statusId?` ${r.statusId}`:" —"]},"move-target")],h=e&&"object"==typeof e&&e.selected?e.selected:null,g=_(e.summary??(h&&"summary"in h?h.summary:null)),f=h&&"match"in h&&h.match&&"object"==typeof h.match?h.match:null,y=f?.cardId,b="number"==typeof y?String(y):w(y),j=w(f?.title),N=w(f?.matchedField),v=w(f?.matchedValue),k=[a.jsx("span",{children:"Картку знайдено, але переміщення не підтверджено (keycrm_move_failed)."},"move-failed")];if(b&&k.push((0,a.jsxs)("span",{children:["Картка #",b,j?` • ${j}`:""]},"move-card")),N&&k.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Збіг за: ",N,v?` → ${v}`:""]},"move-match")),g){let e=g.pipelineName??g.pipelineId??"—",t=g.statusName??g.statusId??g.pipelineStatusId??"—";k.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Поточна позиція: ",e," → ",t]},"move-summary"))}let S=Array.isArray(l?.attempts)?l?.attempts??[]:[],R=S.length;R&&k.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Перевірок: ",R]},"move-attempts")),p&&k.push((0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Відповідь: ",o(p)]},"move-response")),J.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:x},{key:"card",title:"3. Пошук картки у KeyCRM",status:"warning",details:k},{key:"move",title:"4. Переміщення картки",status:"error",details:(()=>{let e=[a.jsx("span",{children:"Переміщення не вдалося: keycrm_move_failed."},"error")];"number"==typeof l?.status&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["HTTP статус KeyCRM: ",l.status]},"status")),l?.error&&e.push((0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Код помилки: ",String(l.error)]},"error-code")),l?.baseUrl&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Базова адреса KeyCRM:"," ",a.jsx("code",{className:"break-all text-[0.7rem]",children:String(l.baseUrl)})]},"base-url")),(n||c)&&e.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["URL запиту: ",n?a.jsx("code",{className:"break-all text-[0.7rem]",children:n}):"н/д",c?(0,a.jsxs)("span",{className:"ml-1",children:["(метод ",c,")"]}):null]},"request"));let t=u("move-error-payload","JSON запиту до KeyCRM",m);t&&e.push(t);let s=u("move-error-response","Сира відповідь KeyCRM",p);s&&e.push(s),S.length&&e.push((0,a.jsxs)("div",{className:"mt-1 space-y-1 rounded-lg border border-slate-200/70 bg-white/70 p-2 text-[0.7rem] text-slate-700",children:[a.jsx("div",{className:"font-semibold text-slate-800",children:"Перевірки API KeyCRM:"}),S.map((e,t)=>(0,a.jsxs)("div",{className:"leading-tight",children:["#",t+1,": ",o(e)]},`move-error-attempt-${t}`))]},"attempts"));let r=u("move-error-details","Деталі помилки",l);return r&&e.push(r),e})()})}else if("card_not_in_base"===n){let t=w(i?.name)??w(i?.title)??w(i?.id)??"(без назви)",s=_(i?.base??e.base??null),r=_(i?.target??i?.t1??i?.t2??e.target??null),l=_(e.summary??(e.selected&&"object"==typeof e.selected?e.selected.summary:null)??null),n=e.mismatch??{},d=[(0,a.jsxs)("span",{children:["Кампанія: ",t]},"campaign"),(0,a.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",s.pipelineName??s.pipelineId??"—"," →",s.statusName?` ${s.statusName}`:s.statusId?` ${s.statusId}`:s.pipelineStatusId?` ${s.pipelineStatusId}`:" —"]},"base"),(0,a.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["Ціль: ",r.pipelineName??r.pipelineId??"—"," →",r.statusName?` ${r.statusName}`:r.statusId?` ${r.statusId}`:r.pipelineStatusId?` ${r.pipelineStatusId}`:" —"]},"target")],o=l.pipelineName??l.pipelineId??"—",c=l.statusName??l.statusId??l.pipelineStatusId??"—",m=[(0,a.jsxs)("span",{children:["Картку знайдено, але вона зараз у ",o," → ",c,"."]},"mismatch"),(0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Очікувана базова пара: ",s.pipelineName??s.pipelineId??"—"," →",s.statusName?` ${s.statusName}`:s.statusId?` ${s.statusId}`:s.pipelineStatusId?` ${s.pipelineStatusId}`:" —"]},"expected")];!1===n.pipelineMatches&&m.push(a.jsx("span",{className:"text-xs text-rose-600/80",children:"Поточна воронка не збігається з базовою."},"pipeline-mismatch")),!1===n.statusMatches&&m.push(a.jsx("span",{className:"text-xs text-rose-600/80",children:"Поточний статус не збігається з базовим."},"status-mismatch")),J.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:d},{key:"card",title:"3. Пошук картки у KeyCRM",status:"error",details:m},{key:"move",title:"4. Переміщення картки",status:"info",details:[a.jsx("span",{children:"Переміщення пропущено, оскільки картка не у базовій воронці/статусі."},"skipped")]})}else if(i){let t=w(i.name)??w(i.title)??w(i.id)??"(без назви)",r=_(i.base??null),l=_(i.target??i.t1??i.t2??null),n=[(0,a.jsxs)("span",{children:["Кампанія: ",t]},"name")],d=r.pipelineName??r.pipelineId??w(i.base_pipeline_name)??w(i.base_pipeline_id)??"—",o=r.statusName??r.statusId??w(i.base_status_name)??w(i.base_status_id)??"—";n.push((0,a.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["База: ",d," → статус ",o]},"base"));let c=l.pipelineName??l.pipelineId??w(i.target_pipeline_name)??w(i.target_pipeline_id)??w(i.v1_to_pipeline_name)??w(i.v1_to_pipeline_id)??w(i.v2_to_pipeline_name)??w(i.v2_to_pipeline_id)??"—",m=l.statusName??l.statusId??w(i.target_status_name)??w(i.target_status_id)??w(i.v1_to_status_name)??w(i.v1_to_status_id)??w(i.v2_to_status_name)??w(i.v2_to_status_id)??"—";n.push((0,a.jsxs)("span",{className:"text-xs text-emerald-700/80",children:["Ціль: ",c," → ",m]},"target"));let u=[],p="warning";switch(s.error){case"card_not_found":u.push(a.jsx("span",{children:"Картку не знайдено за обраними ідентифікаторами."},"card-missing"));break;case"keycrm_search_failed":p="error",u.push(a.jsx("span",{children:"Пошук у KeyCRM завершився помилкою."},"search-failed")),e.error&&u.push((0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Деталі: ",JSON.stringify(e.error)]},"search-error"));break;default:u.push((0,a.jsxs)("span",{children:["Пошук картки зупинився з помилкою: ",s.error,"."]},"generic-error"))}Array.isArray(e.attempts)&&e.attempts.length&&u.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Спроб запиту: ",e.attempts.length]},"attempts")),J.push({key:"campaign",title:"2. Знайдена кампанія",status:"success",details:n},{key:"card",title:"3. Пошук картки у KeyCRM",status:p,details:u},{key:"move",title:"4. Переміщення картки",status:"warning",details:[a.jsx("span",{children:"Переміщення не виконувалось через попередню помилку."},"skipped-move")]})}else J.push({key:"campaign",title:"2. Визначення кампанії",status:"error",details:[(0,a.jsxs)("span",{children:["Помилка: ",s.error]},"error"),e?(0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Деталі: ",JSON.stringify(e)]},"details"):null].filter(Boolean)},{key:"card",title:"3. Пошук картки у KeyCRM",status:"warning",details:[a.jsx("span",{children:"campaign_not_found"===s.error||"campaign_base_missing"===s.error||"campaign_target_missing"===s.error?"Пошук не виконувався через помилку під час визначення кампанії.":`Пошук не виконувався через помилку автоматизації (${s.error}).`},"skipped")]},{key:"move",title:"4. Переміщення картки",status:"warning",details:[a.jsx("span",{children:"Переміщення пропущено."},"skipped")]})}}}else J.push({key:"campaign",title:"2. Визначення кампанії",status:"info",details:[a.jsx("span",{children:"Очікуємо запуск автоматизації після отримання вебхука."},"pending")]},{key:"card",title:"3. Пошук картки у KeyCRM",status:"info",details:[a.jsx("span",{children:"Пошук картки почнеться, щойно буде підібрано кампанію."},"pending")]},{key:"move",title:"4. Переміщення картки",status:"info",details:[a.jsx("span",{children:"Переміщення відбудеться автоматично після успішного пошуку картки."},"pending")]});if(m(O)){let e=O.move,t=[],s=O.search?.selected??null,r=s&&"object"==typeof s?g(s.match?.cardId??s.cardId??null):null,n=O.match?.campaign?.target??null,d=l(n,r),o=i({details:{requestUrl:e.requestUrl??void 0,requestMethod:e.requestMethod??void 0,baseUrl:e.baseUrl??void 0},target:n,cardId:r,defaultMethod:e.requestMethod??"POST"}),m=e.requestUrl??o.requestUrl,p=e.requestMethod??o.requestMethod,x=e.baseUrl??o.baseUrl,h=!!e.requestUrl;if(t.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Запит: ",p," ",a.jsx("code",{className:"break-all text-[0.7rem]",children:m}),h?null:a.jsx("span",{className:"ml-1 text-slate-400",children:"(оцінка)"})]},"trace-request")),x&&t.push((0,a.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Базова адреса: ",a.jsx("code",{className:"break-all",children:x})]},"trace-base")),e.requestHeaders&&Object.keys(e.requestHeaders).length){let s=u("trace-request-headers","HTTP заголовки",e.requestHeaders);s&&t.push(s)}let f="string"==typeof e.requestBodyRaw?e.requestBodyRaw.trim():"";if(f)t.push((0,a.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[a.jsx("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Тіло запиту (raw)"}),a.jsx("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:f})]},"trace-request-body"));else if(e.sent){let s=u("trace-request-json","JSON запиту",e.sent);s&&t.push(s)}else if(d){let e=u("trace-request-fallback","Очікуваний JSON запиту",d);e&&t.push(e)}let y="string"==typeof e.responseRaw?e.responseRaw.trim():"";if(y)t.push((0,a.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[a.jsx("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Відповідь KeyCRM (raw)"}),a.jsx("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:y})]},"trace-response-raw"));else if(e.response){let s=u("trace-response-json","JSON відповіді KeyCRM",e.response);s&&t.push(s)}Array.isArray(e.trace)&&e.trace.length&&t.push((0,a.jsxs)("div",{className:"mt-2 space-y-2 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[a.jsx("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Внутрішній трейc виконання"}),a.jsx("div",{className:"space-y-2",children:e.trace.map((e,t)=>(0,a.jsxs)("div",{className:"rounded border border-slate-200/70 bg-white/90 p-2 text-[0.7rem] leading-tight text-slate-700",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-1",children:[(0,a.jsxs)("span",{className:"font-semibold",children:["#",t+1," \xb7 ",e.step]}),a.jsx("span",{className:"text-[0.65rem] text-slate-400",children:new Date(e.timestamp).toLocaleString()})]}),e.info?a.jsx("div",{className:"mt-1 text-[0.7rem] text-slate-600",children:e.info}):null,null!=e.data?a.jsx("pre",{className:"mt-1 max-h-48 overflow-auto whitespace-pre-wrap break-words text-[0.65rem] leading-tight text-slate-700",children:(()=>{try{return JSON.stringify(e.data,null,2)}catch{return String(e.data)}})()}):null]},`trace-entry-${t}`))})]},"trace-entries")),"string"==typeof e.stack&&e.stack.trim()&&t.push((0,a.jsxs)("div",{className:"mt-2 space-y-1 rounded-lg border border-slate-200/80 bg-white/80 p-2 text-left",children:[a.jsx("div",{className:"text-[0.7rem] font-semibold uppercase tracking-wide text-slate-600",children:"Stack-trace (web/lib/keycrm-move.ts)"}),a.jsx("pre",{className:"max-h-72 overflow-auto whitespace-pre-wrap break-words text-[0.7rem] leading-tight text-slate-700",children:e.stack})]},"trace-stack")),e.attempted||t.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Переміщення не запускалося: ",e.skippedReason?c(e.skippedReason):"причина не вказана","."]},"trace-skipped")),t.length||t.push(a.jsx("span",{className:"text-xs text-slate-500",children:"Дані про запит до KeyCRM відсутні."},"trace-empty"));let b={key:"move-trace",title:"3.1 Трейс",status:e.attempted?e.ok?"success":"error":e.skippedReason?"warning":"info",details:t},j=J.findIndex(e=>"move-trace"===e.key);-1!==j&&J.splice(j,1);let N=J.findIndex(e=>"card"===e.key);-1!==N?J.splice(N+1,0,b):J.push(b)}let z=O&&O.ok?O.move.attempted?O.move.ok?"success":"failed":"already_in_target"===O.move.skippedReason?"already":"skipped":null;if(F){let e=v[F.stage],t=J.find(t=>t.key===e),s=[(0,a.jsxs)("span",{className:"text-xs text-rose-600/80",children:["Автоматизація зупинилась на кроці ",F.step,": ",F.title,"."]},"stage"),(0,a.jsxs)("span",{className:"text-[0.7rem] text-slate-500",children:["Код: ",a.jsx("code",{className:"break-all",children:F.module})]},"module")];if(F.hint&&s.push((0,a.jsxs)("span",{className:"text-xs text-slate-600/80",children:["Підказка: ",F.hint]},"hint")),B){let e=u(`automation-${F.stage}-details`,"Деталі помилки",B);e&&s.push(e)}t?(t.status="error",t.details=[...t.details,...s]):J.push({key:e,title:`${F.step}. ${F.title}`,status:"error",details:s})}return(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between",children:[(0,a.jsxs)("div",{children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Журнал ManyChat-повідомлень"}),a.jsx("p",{className:"mt-1 text-sm text-slate-500",children:"Повідомлення з вебхука ManyChat автоматично з'являються у списку нижче."})]}),a.jsx("button",{type:"button",onClick:f,disabled:s,className:"inline-flex items-center justify-center rounded-lg border border-emerald-200 px-3 py-2 text-sm font-medium text-emerald-700 shadow-sm transition hover:border-emerald-300 hover:text-emerald-600 disabled:cursor-not-allowed disabled:border-slate-200 disabled:text-slate-400",children:s?"Оновлення…":"Оновити"})]}),(0,a.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,a.jsxs)("div",{className:"rounded-2xl border border-dashed border-emerald-300/80 bg-emerald-50 p-4 shadow-sm",children:[a.jsx("h3",{className:"text-sm font-semibold text-emerald-800",children:"Візуальна послідовність автоматизації"}),a.jsx("p",{className:"mt-1 text-xs text-emerald-700/80",children:"Кроки: отримуємо повідомлення з ManyChat, визначаємо кампанію, шукаємо картку в KeyCRM і переміщуємо її у ціль."}),a.jsx("div",{className:"mt-3",children:a.jsx(R,{steps:J})})]}),I?(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-slate-200 bg-white/60 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-700",children:"Конфігурація Vercel KV"}),(0,a.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["URL: ",I.hasBaseUrl?"✅ задано":"⚠️ відсутній"," \xb7 Токен читання: ",I.hasReadToken?"✅":"⚠️"," \xb7 Токен запису: ",I.hasWriteToken?"✅":"⚠️"," \xb7 Кандидатів бази: ",I.candidates]})]}):null,(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-slate-200 bg-slate-50 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-slate-600",children:"Діагностика вебхука"}),y?(0,a.jsxs)("div",{className:"mt-2 space-y-1 text-sm text-slate-600",children:[(0,a.jsxs)("p",{children:["Статус: ","accepted"===y.status?"✅ Прийнято":"⚠️ Відхилено",y.statusCode?` \xb7 Код ${y.statusCode}`:""]}),(0,a.jsxs)("p",{children:["Час: ",new Date(y.receivedAt).toLocaleString()]}),y.reason&&(0,a.jsxs)("p",{children:["Деталі: ",y.reason]}),y.fullName||y.handle?(0,a.jsxs)("p",{children:["Контакт: ",y.fullName??"—",y.handle&&(0,a.jsxs)("span",{className:"ml-1",children:["(@",y.handle,")"]})]}):null,y.messagePreview&&(0,a.jsxs)("p",{children:["Текст: ",y.messagePreview]})]}):a.jsx("p",{className:"mt-2 text-sm text-slate-500",children:"Вебхук ще не надходив у це середовище."})]}),(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-amber-200 bg-amber-50/60 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-amber-700",children:"Статус підключення ManyChat API"}),S?(0,a.jsxs)("p",{className:"mt-2 text-sm text-amber-700",children:[S.ok?`✅ Дані отримано (${S.note??"API активне"})`:`⚠️ ${S.message??"ManyChat API вимкнено"}`,S.note?a.jsx("span",{className:"block text-xs text-amber-600/80",children:S.note}):null]}):a.jsx("p",{className:"mt-2 text-sm text-amber-700/80",children:"Очікуємо перше звернення до ManyChat API…"})]}),(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-emerald-200 bg-emerald-50/80 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-emerald-700",children:"Автоматизація ManyChat → KeyCRM"}),O?O.ok?(0,a.jsxs)("div",{className:"mt-2 space-y-1 text-sm text-emerald-700",children:[a.jsx("p",{children:"success"===z?`✅ Маршрут ${O.match.route.toUpperCase()} → ${O.match.campaign.name??"без назви"} виконано`:"already"===z?`✅ Картка вже була у цілі для маршруту ${O.match.route.toUpperCase()} → ${O.match.campaign.name??"без назви"}`:"skipped"===z?`⚠️ Маршрут ${O.match.route.toUpperCase()} → ${O.match.campaign.name??"без назви"} виконано без переміщення`:`⚠️ Маршрут ${O.match.route.toUpperCase()} → ${O.match.campaign.name??"без назви"} не завершив переміщення`}),(0,a.jsxs)("p",{children:["Ціль: ",O.match.campaign.target.pipelineName||O.match.campaign.target.pipelineId||"—",O.match.campaign.target.statusName||O.match.campaign.target.statusId?` \xb7 Статус: ${O.match.campaign.target.statusName||O.match.campaign.target.statusId}`:""]}),(0,a.jsxs)("p",{children:["Переміщення: ",O.move.attempted?O.move.ok?"✅ виконано":"⚠️ не вдалося":"already_in_target"===O.move.skippedReason?"✅ картка вже у цілі":"⚠️ пропущено",O.move.error?` \xb7 Помилка: ${O.move.error}`:""]})]}):(0,a.jsxs)("div",{className:"mt-2 text-sm text-red-600",children:["⚠️ Помилка автоматизації: ",O.error]}):a.jsx("p",{className:"mt-2 text-sm text-emerald-700/80",children:"Автоматизація ще не запускалася для цього середовища."})]}),T?(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-emerald-200 bg-white/70 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-emerald-700",children:"Сира відповідь автоматизації"}),a.jsx("pre",{className:"mt-3 max-h-72 overflow-auto rounded-lg bg-emerald-900/5 p-3 text-xs text-slate-800",children:(()=>{try{return JSON.stringify(T,null,2)}catch(e){return`<< неможливо серіалізувати: ${e instanceof Error?e.message:String(e)} >>`}})()})]}):null,(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-sky-200 bg-sky-50/70 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-sky-700",children:"Сховище повідомлень (KV)"}),C?(0,a.jsxs)("p",{className:"mt-2 text-sm text-sky-700",children:[C.ok?"memory"===C.source?"✅ Останній вебхук уже в пам'яті процесу":"✅ Повідомлення знайдено у Vercel KV":`⚠️ ${C.message??"Не вдалося отримати повідомлення з KV"}`,(0,a.jsxs)("span",{className:"block text-xs text-sky-600/80",children:["Ключ: ",C.key,C.source?` • джерело: ${C.source}`:""]})]}):a.jsx("p",{className:"mt-2 text-sm text-sky-700/80",children:"Очікуємо перший запис у KV…"})]}),K?(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-emerald-200/70 bg-emerald-50/70 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-emerald-700",children:"Журнал повідомлень (KV)"}),(0,a.jsxs)("p",{className:"mt-2 text-sm text-emerald-700",children:[K.ok?`✅ Завантажено ${K.count??0} запис(ів)`:`⚠️ ${K.message??"Журнал недоступний"}`,(0,a.jsxs)("span",{className:"block text-xs text-emerald-600/80",children:["Ключ: ",K.key,K.source?` • джерело: ${K.source}`:""]})]})]}):null,A?(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-purple-200 bg-purple-50/70 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-purple-700",children:"Сховище трасування (KV)"}),(0,a.jsxs)("p",{className:"mt-2 text-sm text-purple-700",children:[A.ok?"✅ Трасування вебхука знайдено":"error"===A.source?`⚠️ ${A.message??"Помилка читання KV"}`:"⚠️ Трасування не знайдено у KV",(0,a.jsxs)("span",{className:"block text-xs text-purple-600/80",children:["Ключ: ",A.key,A.source?` • джерело: ${A.source}`:""]})]})]}):null,M?(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-amber-200 bg-amber-50/70 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-amber-700",children:"Сирий payload (KV)"}),(0,a.jsxs)("p",{className:"mt-2 text-sm text-amber-700",children:[M.ok?"✅ Сирий JSON збережено у KV":"error"===M.source?`⚠️ ${M.message??"Помилка читання KV"}`:"⚠️ Сирий payload відсутній у KV",(0,a.jsxs)("span",{className:"block text-xs text-amber-600/80",children:["Ключ: ",M.key,M.source?` • джерело: ${M.source}`:""]})]})]}):null,P?(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-blue-200 bg-blue-50/70 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-blue-700",children:"Останній сирий запит (KV)"}),(0,a.jsxs)("p",{className:"mt-2 text-sm text-blue-700",children:[P.ok?"✅ Запит збережено у KV":"error"===P.source?`⚠️ ${P.message??"Помилка читання KV"}`:"⚠️ Запит відсутній у KV",(0,a.jsxs)("span",{className:"block text-xs text-blue-600/80",children:["Ключ: ",P.key,P.source?` • джерело: ${P.source}`:""]})]})]}):null,$?(0,a.jsxs)("div",{className:"rounded-xl border border-dashed border-indigo-200 bg-indigo-50/70 p-4",children:[a.jsx("h3",{className:"text-sm font-semibold text-indigo-700",children:"Fallback із трасування"}),a.jsx("p",{className:"mt-2 text-sm text-indigo-700/90",children:$.reason})]}):null]}),(0,a.jsxs)("div",{className:"mt-6 space-y-4",children:[E?(0,a.jsxs)("div",{className:"rounded-xl border border-emerald-200 bg-emerald-50/80 p-4 text-sm text-emerald-900",children:[a.jsx("h3",{className:"text-base font-semibold text-emerald-800",children:"Останній вебхук ManyChat"}),(0,a.jsxs)("p",{className:"mt-1 text-xs text-emerald-700/80",children:[new Date("string"==typeof E.receivedAt?Number.parseInt(E.receivedAt,10):E.receivedAt??Date.now()).toLocaleString()," • ",E.source]}),(0,a.jsxs)("div",{className:"mt-2 text-slate-700",children:[(0,a.jsxs)("div",{className:"font-medium",children:[E.fullName||"—",E.handle&&(0,a.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",E.handle,")"]})]}),a.jsx("div",{className:"mt-1 whitespace-pre-wrap text-slate-600",children:E.text?.trim()?.length?E.text:D?.trim()?.length?D:"(порожній текст повідомлення)"}),(0,a.jsxs)("div",{className:"mt-3",children:[a.jsx("h4",{className:"text-sm font-semibold text-emerald-800",children:"Сирий JSON вебхука"}),a.jsx("pre",{className:"mt-2 max-h-64 overflow-auto rounded-lg bg-emerald-900/5 p-3 text-xs text-emerald-900",children:(()=>{let e=E.rawText?.trim()?.length?E.rawText.trim():V?.rawText?.trim()?.length?V.rawText.trim():D?.trim()?.length?D.trim():null;if(e)try{return JSON.stringify(JSON.parse(e),null,2)}catch{return e}let t=null!=E.raw?E.raw:U?.raw!=null?U.raw:null;try{return JSON.stringify(t,null,2)}catch(e){return`<< неможливо серіалізувати: ${e instanceof Error?e.message:String(e)} >>`}})()}),V?(0,a.jsxs)("p",{className:"mt-2 text-xs text-emerald-700/70",children:["Збережено: ",V.receivedAt?new Date(V.receivedAt).toLocaleString():"—",V.source?` • джерело запиту: ${V.source}`:""]}):null,U?.source?(0,a.jsxs)("p",{className:"mt-2 text-xs text-emerald-700/70",children:["Джерело: ",U.source]}):null]})]})]}):null,(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-slate-700",children:"Останні повідомлення"}),"loading"===e.status&&a.jsx("p",{className:"mt-3 text-sm text-slate-500",children:"Завантаження…"}),"error"===e.status&&a.jsx("p",{className:"mt-3 text-sm text-red-500",children:e.message}),"ready"===e.status&&0===e.messages.length&&a.jsx("p",{className:"mt-3 text-sm text-slate-500",children:"Повідомлень ще немає. Натисніть \xabОновити\xbb, щойно ManyChat надішле вебхук, або перевірте діагностику вище."}),"ready"===e.status&&e.messages.length>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("p",{className:"mt-2 text-xs text-slate-400",children:["Оновлено: ",e.updatedAt.toLocaleTimeString()," (автооновлення кожні 5 секунд)",e.source&&(0,a.jsxs)("span",{className:"ml-1",children:["• джерело: ",e.source]})]}),a.jsx("div",{className:"mt-3 space-y-3",children:e.messages.map((e,t)=>(0,a.jsxs)("div",{className:"rounded-xl border border-slate-200 p-4 text-sm",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2 text-xs text-slate-400",children:[(0,a.jsxs)("span",{children:["ID:"," ",(()=>{if("number"==typeof e.id&&Number.isFinite(e.id))return e.id;if("string"==typeof e.id){let t=Number(e.id.trim());if(Number.isFinite(t))return t;if(e.id.trim())return e.id.trim()}return"—"})()]}),a.jsx("span",{children:(()=>{let t="string"==typeof e.receivedAt?Number(e.receivedAt.trim()):e.receivedAt;return"number"==typeof t&&Number.isFinite(t)?new Date(t).toLocaleString():"Невідомо"})()})]}),(e.source||e.title)&&(0,a.jsxs)("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-400",children:[e.source&&(0,a.jsxs)("span",{children:["Джерело: ",e.source]}),e.title&&(0,a.jsxs)("span",{children:["Заголовок: ",e.title]})]}),(0,a.jsxs)("div",{className:"mt-2 text-slate-600",children:[(0,a.jsxs)("div",{className:"font-medium text-slate-700",children:[e.fullName||"—",e.handle&&(0,a.jsxs)("span",{className:"ml-1 text-slate-500",children:["(@",e.handle,")"]})]}),a.jsx("div",{className:"mt-1 whitespace-pre-wrap text-slate-500",children:e.text?.trim()?.length?e.text:D?.trim()?.length&&0===t?D:"(порожній текст повідомлення)"})]})]},`${e.id??t}-${t}`))})]})]})]})]})}},9337:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>O,dynamic:()=>I,revalidate:()=>C});var a=s(9510),r=s(7560),l=s(1615),n=s(4332),i=s(8570);let d=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/keycrm-card-search-widget.tsx`),{__esModule:o,$$typeof:c}=d;d.default;let m=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/keycrm-card-search-widget.tsx#KeycrmCardSearchWidget`),u=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/manychat-message-inbox.tsx`),{__esModule:p,$$typeof:x}=u;u.default;let h=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/manychat-message-inbox.tsx#ManychatMessageInbox`),g=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/manychat-campaign-router.tsx`),{__esModule:f,$$typeof:y}=g;g.default;let b=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/manychat-campaign-router.tsx#ManychatCampaignRouter`),j=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/keycrm-env-card.tsx`),{__esModule:N,$$typeof:v}=j;j.default;let k=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/keycrm-env-card.tsx#KeycrmEnvCard`),w=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/campaigns-maintenance-card.tsx`),{__esModule:_,$$typeof:S}=w;w.default;let R=(0,i.createProxy)(String.raw`/Users/mykolay/P-3-0/web/components/admin/campaigns-maintenance-card.tsx#CampaignsMaintenanceCard`),I="force-dynamic",C=0,A=e=>`cmp:item:${e}`;async function M(){let e={url:!!process.env.KV_REST_API_URL,token:!!process.env.KV_REST_API_TOKEN,readOnly:!!process.env.KV_REST_API_READ_ONLY_TOKEN},t={env:e,ids:[],items:[],error:null};if(!e.url||!e.token)return t.error="KV середовище не налаштоване",t;try{let e=await r.kv.get("cmp:ids");Array.isArray(e)&&t.ids.push(...e.filter(Boolean))}catch(e){return t.error=`kv.get: ${K(e)}`,t}try{let e=await n.kvRead.lrange("cmp:ids:list",0,-1);Array.isArray(e)&&t.ids.push(...e.filter(Boolean))}catch(e){return t.error=`kv.lrange: ${K(e)}`,t}if(t.ids=Array.from(new Set(t.ids)),!t.ids.length)return t;try{let e=await r.kv.mget(...t.ids.map(A));t.items=Array.isArray(e)?e.filter(e=>null!=e):[]}catch(e){t.error=`kv.mget: ${K(e)}`}return t}async function P(){let e={ok:!1,items:[],meta:null,error:null},t=async t=>{try{let e=await n.kvRead.listCampaigns();return{ok:!0,items:e,meta:{source:"direct",reason:t},error:null}}catch(s){return{...e,error:`${t}; direct fallback failed: ${K(s)}`,meta:{source:"direct",reason:t,fallbackError:K(s)}}}};try{let s=(0,l.headers)(),a=s.get("x-forwarded-proto")??"https",r=s.get("x-forwarded-host")??s.get("host")??"",n=process.env.VERCEL_URL??"",i=r||n;if(!i)return t("host_unavailable");let d=`${a}://${i}/api/campaigns`,o=s.get("x-vercel-protection-bypass")??process.env.X_VERCEL_PROTECTION_BYPASS??process.env.VERCEL_PROTECTION_BYPASS??null,c=s.get("authorization"),m=(0,l.cookies)().getAll().map(e=>`${e.name}=${e.value}`).join("; "),u=await fetch(d,{cache:"no-store",next:{revalidate:0},headers:{...o?{"x-vercel-protection-bypass":o}:{},...c?{authorization:c}:{},...m?{cookie:m}:{}}});if(!u.ok)return e.error=`HTTP ${u.status}`,t(e.error);let p=await u.json().catch(()=>null);if(Array.isArray(p))return e.ok=!0,e.items=p,e.meta={source:"array"},e;if(p&&"object"==typeof p){let t=Array.isArray(p.items)?p.items:[];return e.ok=!!(p.ok??!0),e.items=t,e.meta={..."meta"in p&&"object"==typeof p.meta?p.meta:{}},e}return e.error="Невідомий формат відповіді",t(e.error)}catch(e){return t(K(e))}}function K(e){return e instanceof Error?e.message:String(e)}function $(e){try{return JSON.stringify(e,null,2)}catch(e){return`<< serialization error: ${K(e)} >>`}}async function O(){let[e,t]=await Promise.all([M(),P()]),s=function(){let e=globalThis.__campaignMemoryStore;if(!e)return{ids:[],items:[]};let t=Array.from(new Set(e.ids)).filter(Boolean),s=t.map(t=>e.items?.[t]).filter(e=>null!=e);return{ids:t,items:s}}(),r=function(){let e=globalThis.__campaignKvState;return{disabled:!!e?.disabled,error:e?.error?.message??null}}();return(0,a.jsxs)("main",{className:"mx-auto flex max-w-5xl flex-col gap-8 px-6 py-8",children:[(0,a.jsxs)("header",{className:"space-y-2",children:[a.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Адмін • Тестова сторінка"}),a.jsx("p",{className:"text-sm text-slate-500",children:"Допоміжна діагностика KV / fallback. Дані оновлюються при кожному запиті."})]}),a.jsx(k,{}),a.jsx(R,{}),(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Пошук карток KeyCRM"}),a.jsx("p",{className:"mt-2 text-sm text-slate-500",children:"Шукає card_id за повним ім'ям або social_id контакту/клієнта. За потреби звузьте запит фільтрами pipeline_id та status_id, щоб уникнути rate limit."}),a.jsx(m,{})]}),a.jsx(h,{}),a.jsx(b,{}),(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Статус KV"}),(0,a.jsxs)("div",{className:"mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"KV_REST_API_URL:"})," ",e.env.url?"налаштовано":"немає"]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"KV_REST_API_TOKEN:"})," ",e.env.token?"налаштовано":"немає"]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"Read-only token:"})," ",e.env.readOnly?"так":"ні"]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"KV disabled (runtime):"})," ",r.disabled?"так":"ні"]}),r.error&&(0,a.jsxs)("div",{className:"sm:col-span-2 text-red-600",children:["Runtime error: ",a.jsx("code",{children:r.error})]}),e.error&&(0,a.jsxs)("div",{className:"sm:col-span-2 text-red-600",children:["KV error: ",a.jsx("code",{children:e.error})]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"IDs (KV):"})," ",e.ids.length]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"Items (KV):"})," ",e.items.length]})]}),(0,a.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"font-medium text-slate-700",children:"KV ids"}),a.jsx("pre",{className:"mt-2 max-h-64 overflow-auto rounded-lg bg-slate-900 p-3 text-xs text-slate-100",children:$(e.ids)})]}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"font-medium text-slate-700",children:"KV items"}),a.jsx("pre",{className:"mt-2 max-h-64 overflow-auto rounded-lg bg-slate-900 p-3 text-xs text-slate-100",children:$(e.items)})]})]})]}),(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Fallback / API"}),(0,a.jsxs)("div",{className:"mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"API status:"})," ",t.ok?"ok":"error"]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"Items (API):"})," ",t.items.length]}),t.meta&&(0,a.jsxs)("div",{className:"sm:col-span-2",children:[a.jsx("span",{className:"font-medium text-slate-700",children:"Meta:"}),a.jsx("pre",{className:"mt-2 max-h-48 overflow-auto rounded bg-slate-100 p-3 text-xs text-slate-700",children:$(t.meta)})]}),t.error&&(0,a.jsxs)("div",{className:"sm:col-span-2 text-red-600",children:["API error: ",a.jsx("code",{children:t.error})]})]}),(0,a.jsxs)("div",{className:"mt-4",children:[a.jsx("h3",{className:"font-medium text-slate-700",children:"API items"}),a.jsx("pre",{className:"mt-2 max-h-64 overflow-auto rounded-lg bg-slate-900 p-3 text-xs text-slate-100",children:$(t.items)})]})]}),(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm",children:[a.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"In-memory fallback"}),a.jsx("p",{className:"mt-2 text-sm text-slate-500",children:"Використовується, якщо KV недоступне під час обробки /api/campaigns. Дані живуть лише у процесі."}),(0,a.jsxs)("div",{className:"mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"IDs (memory):"})," ",s.ids.length]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-medium text-slate-700",children:"Items (memory):"})," ",s.items.length]})]}),(0,a.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-2",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"font-medium text-slate-700",children:"Memory ids"}),a.jsx("pre",{className:"mt-2 max-h-64 overflow-auto rounded-lg bg-slate-900 p-3 text-xs text-slate-100",children:$(s.ids)})]}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"font-medium text-slate-700",children:"Memory items"}),a.jsx("pre",{className:"mt-2 max-h-64 overflow-auto rounded-lg bg-slate-900 p-3 text-xs text-slate-100",children:$(s.items)})]})]})]})]})}},2675:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c,metadata:()=>o});var a=s(9510),r=s(18),l=s.n(r);s(7272);var n=s(9720);function i(e=globalThis){let t=(e,t)=>{if("get"in e||"set"in e){let s=e.get?e.get.bind(t):void 0,a=e.set?e.set.bind(t):void 0;return{configurable:e.configurable,enumerable:e.enumerable??!1,get:s,set:a}}if("function"==typeof e.value){let s=e.value.bind(t);return{configurable:e.configurable,enumerable:e.enumerable??!1,writable:e.writable??!1,value:s}}return e},s=(e,t,s,a)=>{let r=t?.enumerable??!1;if(t&&("get"in t||"set"in t)){let l=t.get?t.get.bind(a):void 0,n=t.set?t.set.bind(a):void 0;return{configurable:!0,enumerable:r,get:()=>s.has(e)?void 0:l?l():void 0,set:t=>{s.delete(e),n&&n(t)}}}let l=t?t.value:void 0;return{configurable:!0,enumerable:r,get:()=>s.has(e)?void 0:l,set:t=>{s.delete(e),l=t}}};if(!e||e.__p30SymbolGuarded)return;let a=(e=>{let t=e.Symbol;return"function"==typeof t?t:void 0})(e);if(!a){e.__p30SymbolGuarded=!0;return}let r=new Set(["dispose","asyncDispose"]);a.dispose&&r.add(a.dispose),a.asyncDispose&&r.add(a.asyncDispose);let l=new Set,n=function(e){return a(e)};try{Reflect.defineProperty(n,"name",{configurable:!0,enumerable:!1,writable:!1,value:"Symbol"})}catch{}try{Reflect.defineProperty(n,"length",{configurable:!0,enumerable:!1,writable:!1,value:0})}catch{}try{Reflect.defineProperty(n,"prototype",{configurable:!1,enumerable:!1,writable:!1,value:a.prototype})}catch{}for(let e of Reflect.ownKeys(a)){let i=Reflect.getOwnPropertyDescriptor(a,e);if(i){if(r.has(e)){try{Reflect.defineProperty(n,e,s(e,i,l,a))}catch{}continue}try{Reflect.defineProperty(n,e,t(i,a))}catch{}}}Object.defineProperty(n,"__p30ProxyGuard",{configurable:!1,enumerable:!1,writable:!1,value:!0});try{Object.defineProperty(n,Symbol.toStringTag,{configurable:!0,enumerable:!1,writable:!1,value:"Symbol"})}catch{}let i=e=>!!r.has(e)&&(l.add(e),!0),d=new Proxy(n,{apply:(e,t,s)=>Reflect.apply(a,t,s),deleteProperty(e,t){if(i(t)){try{Reflect.deleteProperty(e,t)}catch{}return!0}try{return Reflect.deleteProperty(a,t)}catch{return!1}},get(e,t,s){if("__p30ProxyGuard"===t)return!0;if(r.has(t)){let a=Reflect.getOwnPropertyDescriptor(e,t);return a?"get"in a&&a.get?a.get.call(s):a.value:void 0}let l=Reflect.get(e,t,s);if("function"==typeof l)try{return l.bind(a)}catch{}return l},has:(e,t)=>r.has(t)?!l.has(t)&&Reflect.has(e,t):Reflect.has(e,t)||Reflect.has(a,t),ownKeys(e){let t=[];for(let s of Reflect.ownKeys(e))!(r.has(s)&&l.has(s))&&("string"!=typeof s&&"symbol"!=typeof s||t.includes(s)||t.push(s));return t},getOwnPropertyDescriptor(e,t){if(r.has(t)){if(l.has(t))return;let s=Reflect.getOwnPropertyDescriptor(e,t);return s&&(s.configurable=!0),s}return Reflect.getOwnPropertyDescriptor(e,t)},set:(e,t,s,a)=>(r.has(t)&&l.delete(t),Reflect.set(e,t,s,a)),defineProperty(e,t,n){if(r.has(t)){l.delete(t);let r=s(t,n,l,a);return Reflect.defineProperty(e,t,r)}return Reflect.defineProperty(e,t,n)}});try{Object.defineProperty(e,"Symbol",{configurable:!0,enumerable:!1,writable:!0,value:d})}catch{e.Symbol=d}let o=function(){};try{Object.defineProperty(e,"lockdown",{configurable:!0,enumerable:!1,writable:!0,value:o})}catch{e.lockdown=o}let c=e.ses;if(c)try{Object.defineProperty(c,"lockdown",{configurable:!0,enumerable:!1,writable:!0,value:o})}catch{c.lockdown=o}"function"!=typeof e.harden&&(e.harden=e=>e),e.__p30SymbolGuarded=!0}let d=`;(${i.toString()})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : undefined);`;i();let o={title:"P-3-0",description:"Admin console"};function c({children:e}){return(0,a.jsxs)("html",{lang:"uk",className:l().className,children:[a.jsx("head",{children:a.jsx(n.default,{id:"p30-lockdown-guard",strategy:"beforeInteractive",dangerouslySetInnerHTML:{__html:d}})}),a.jsx("body",{children:e})]})}},1615:(e,t,s)=>{"use strict";var a=s(8757);s.o(a,"cookies")&&s.d(t,{cookies:function(){return a.cookies}}),s.o(a,"headers")&&s.d(t,{headers:function(){return a.headers}})},3085:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"DraftMode",{enumerable:!0,get:function(){return l}});let a=s(5869),r=s(6278);class l{get isEnabled(){return this._provider.isEnabled}enable(){let e=a.staticGenerationAsyncStorage.getStore();return e&&(0,r.trackDynamicDataAccessed)(e,"draftMode().enable()"),this._provider.enable()}disable(){let e=a.staticGenerationAsyncStorage.getStore();return e&&(0,r.trackDynamicDataAccessed)(e,"draftMode().disable()"),this._provider.disable()}constructor(e){this._provider=e}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},8757:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}(t,{cookies:function(){return u},draftMode:function(){return p},headers:function(){return m}});let a=s(8996),r=s(3047),l=s(2044),n=s(2934),i=s(3085),d=s(6278),o=s(5869),c=s(4580);function m(){let e="headers",t=o.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return r.HeadersAdapter.seal(new Headers({}));(0,d.trackDynamicDataAccessed)(t,e)}return(0,c.getExpectedRequestStore)(e).headers}function u(){let e="cookies",t=o.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return a.RequestCookiesAdapter.seal(new l.RequestCookies(new Headers({})));(0,d.trackDynamicDataAccessed)(t,e)}let s=(0,c.getExpectedRequestStore)(e),r=n.actionAsyncStorage.getStore();return(null==r?void 0:r.isAction)||(null==r?void 0:r.isAppRoute)?s.mutableCookies:s.cookies}function p(){let e=(0,c.getExpectedRequestStore)("draftMode");return new i.DraftMode(e.draftMode)}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},9925:e=>{"use strict";var t=Object.defineProperty,s=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,r=Object.prototype.hasOwnProperty,l={};function n(e){var t;let s=["path"in e&&e.path&&`Path=${e.path}`,"expires"in e&&(e.expires||0===e.expires)&&`Expires=${("number"==typeof e.expires?new Date(e.expires):e.expires).toUTCString()}`,"maxAge"in e&&"number"==typeof e.maxAge&&`Max-Age=${e.maxAge}`,"domain"in e&&e.domain&&`Domain=${e.domain}`,"secure"in e&&e.secure&&"Secure","httpOnly"in e&&e.httpOnly&&"HttpOnly","sameSite"in e&&e.sameSite&&`SameSite=${e.sameSite}`,"partitioned"in e&&e.partitioned&&"Partitioned","priority"in e&&e.priority&&`Priority=${e.priority}`].filter(Boolean),a=`${e.name}=${encodeURIComponent(null!=(t=e.value)?t:"")}`;return 0===s.length?a:`${a}; ${s.join("; ")}`}function i(e){let t=new Map;for(let s of e.split(/; */)){if(!s)continue;let e=s.indexOf("=");if(-1===e){t.set(s,"true");continue}let[a,r]=[s.slice(0,e),s.slice(e+1)];try{t.set(a,decodeURIComponent(null!=r?r:"true"))}catch{}}return t}function d(e){var t,s;if(!e)return;let[[a,r],...l]=i(e),{domain:n,expires:d,httponly:m,maxage:u,path:p,samesite:x,secure:h,partitioned:g,priority:f}=Object.fromEntries(l.map(([e,t])=>[e.toLowerCase(),t]));return function(e){let t={};for(let s in e)e[s]&&(t[s]=e[s]);return t}({name:a,value:decodeURIComponent(r),domain:n,...d&&{expires:new Date(d)},...m&&{httpOnly:!0},..."string"==typeof u&&{maxAge:Number(u)},path:p,...x&&{sameSite:o.includes(t=(t=x).toLowerCase())?t:void 0},...h&&{secure:!0},...f&&{priority:c.includes(s=(s=f).toLowerCase())?s:void 0},...g&&{partitioned:!0}})}((e,s)=>{for(var a in s)t(e,a,{get:s[a],enumerable:!0})})(l,{RequestCookies:()=>m,ResponseCookies:()=>u,parseCookie:()=>i,parseSetCookie:()=>d,stringifyCookie:()=>n}),e.exports=((e,l,n,i)=>{if(l&&"object"==typeof l||"function"==typeof l)for(let n of a(l))r.call(e,n)||void 0===n||t(e,n,{get:()=>l[n],enumerable:!(i=s(l,n))||i.enumerable});return e})(t({},"__esModule",{value:!0}),l);var o=["strict","lax","none"],c=["low","medium","high"],m=class{constructor(e){this._parsed=new Map,this._headers=e;let t=e.get("cookie");if(t)for(let[e,s]of i(t))this._parsed.set(e,{name:e,value:s})}[Symbol.iterator](){return this._parsed[Symbol.iterator]()}get size(){return this._parsed.size}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let s=Array.from(this._parsed);if(!e.length)return s.map(([e,t])=>t);let a="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return s.filter(([e])=>e===a).map(([e,t])=>t)}has(e){return this._parsed.has(e)}set(...e){let[t,s]=1===e.length?[e[0].name,e[0].value]:e,a=this._parsed;return a.set(t,{name:t,value:s}),this._headers.set("cookie",Array.from(a).map(([e,t])=>n(t)).join("; ")),this}delete(e){let t=this._parsed,s=Array.isArray(e)?e.map(e=>t.delete(e)):t.delete(e);return this._headers.set("cookie",Array.from(t).map(([e,t])=>n(t)).join("; ")),s}clear(){return this.delete(Array.from(this._parsed.keys())),this}[Symbol.for("edge-runtime.inspect.custom")](){return`RequestCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(e=>`${e.name}=${encodeURIComponent(e.value)}`).join("; ")}},u=class{constructor(e){var t,s,a;this._parsed=new Map,this._headers=e;let r=null!=(a=null!=(s=null==(t=e.getSetCookie)?void 0:t.call(e))?s:e.get("set-cookie"))?a:[];for(let e of Array.isArray(r)?r:function(e){if(!e)return[];var t,s,a,r,l,n=[],i=0;function d(){for(;i<e.length&&/\s/.test(e.charAt(i));)i+=1;return i<e.length}for(;i<e.length;){for(t=i,l=!1;d();)if(","===(s=e.charAt(i))){for(a=i,i+=1,d(),r=i;i<e.length&&"="!==(s=e.charAt(i))&&";"!==s&&","!==s;)i+=1;i<e.length&&"="===e.charAt(i)?(l=!0,i=r,n.push(e.substring(t,a)),t=i):i=a+1}else i+=1;(!l||i>=e.length)&&n.push(e.substring(t,e.length))}return n}(r)){let t=d(e);t&&this._parsed.set(t.name,t)}}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let s=Array.from(this._parsed.values());if(!e.length)return s;let a="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return s.filter(e=>e.name===a)}has(e){return this._parsed.has(e)}set(...e){let[t,s,a]=1===e.length?[e[0].name,e[0].value,e[0]]:e,r=this._parsed;return r.set(t,function(e={name:"",value:""}){return"number"==typeof e.expires&&(e.expires=new Date(e.expires)),e.maxAge&&(e.expires=new Date(Date.now()+1e3*e.maxAge)),(null===e.path||void 0===e.path)&&(e.path="/"),e}({name:t,value:s,...a})),function(e,t){for(let[,s]of(t.delete("set-cookie"),e)){let e=n(s);t.append("set-cookie",e)}}(r,this._headers),this}delete(...e){let[t,s,a]="string"==typeof e[0]?[e[0]]:[e[0].name,e[0].path,e[0].domain];return this.set({name:t,path:s,domain:a,value:"",expires:new Date(0)})}[Symbol.for("edge-runtime.inspect.custom")](){return`ResponseCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(n).join("; ")}}},3047:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}(t,{HeadersAdapter:function(){return l},ReadonlyHeadersError:function(){return r}});let a=s(8238);class r extends Error{constructor(){super("Headers cannot be modified. Read more: https://nextjs.org/docs/app/api-reference/functions/headers")}static callable(){throw new r}}class l extends Headers{constructor(e){super(),this.headers=new Proxy(e,{get(t,s,r){if("symbol"==typeof s)return a.ReflectAdapter.get(t,s,r);let l=s.toLowerCase(),n=Object.keys(e).find(e=>e.toLowerCase()===l);if(void 0!==n)return a.ReflectAdapter.get(t,n,r)},set(t,s,r,l){if("symbol"==typeof s)return a.ReflectAdapter.set(t,s,r,l);let n=s.toLowerCase(),i=Object.keys(e).find(e=>e.toLowerCase()===n);return a.ReflectAdapter.set(t,i??s,r,l)},has(t,s){if("symbol"==typeof s)return a.ReflectAdapter.has(t,s);let r=s.toLowerCase(),l=Object.keys(e).find(e=>e.toLowerCase()===r);return void 0!==l&&a.ReflectAdapter.has(t,l)},deleteProperty(t,s){if("symbol"==typeof s)return a.ReflectAdapter.deleteProperty(t,s);let r=s.toLowerCase(),l=Object.keys(e).find(e=>e.toLowerCase()===r);return void 0===l||a.ReflectAdapter.deleteProperty(t,l)}})}static seal(e){return new Proxy(e,{get(e,t,s){switch(t){case"append":case"delete":case"set":return r.callable;default:return a.ReflectAdapter.get(e,t,s)}}})}merge(e){return Array.isArray(e)?e.join(", "):e}static from(e){return e instanceof Headers?e:new l(e)}append(e,t){let s=this.headers[e];"string"==typeof s?this.headers[e]=[s,t]:Array.isArray(s)?s.push(t):this.headers[e]=t}delete(e){delete this.headers[e]}get(e){let t=this.headers[e];return void 0!==t?this.merge(t):null}has(e){return void 0!==this.headers[e]}set(e,t){this.headers[e]=t}forEach(e,t){for(let[s,a]of this.entries())e.call(t,a,s,this)}*entries(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase(),s=this.get(t);yield[t,s]}}*keys(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase();yield t}}*values(){for(let e of Object.keys(this.headers)){let t=this.get(e);yield t}}[Symbol.iterator](){return this.entries()}}},8996:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}(t,{MutableRequestCookiesAdapter:function(){return m},ReadonlyRequestCookiesError:function(){return n},RequestCookiesAdapter:function(){return i},appendMutableCookies:function(){return c},getModifiedCookieValues:function(){return o}});let a=s(2044),r=s(8238),l=s(5869);class n extends Error{constructor(){super("Cookies can only be modified in a Server Action or Route Handler. Read more: https://nextjs.org/docs/app/api-reference/functions/cookies#cookiessetname-value-options")}static callable(){throw new n}}class i{static seal(e){return new Proxy(e,{get(e,t,s){switch(t){case"clear":case"delete":case"set":return n.callable;default:return r.ReflectAdapter.get(e,t,s)}}})}}let d=Symbol.for("next.mutated.cookies");function o(e){let t=e[d];return t&&Array.isArray(t)&&0!==t.length?t:[]}function c(e,t){let s=o(t);if(0===s.length)return!1;let r=new a.ResponseCookies(e),l=r.getAll();for(let e of s)r.set(e);for(let e of l)r.set(e);return!0}class m{static wrap(e,t){let s=new a.ResponseCookies(new Headers);for(let t of e.getAll())s.set(t);let n=[],i=new Set,o=()=>{let e=l.staticGenerationAsyncStorage.getStore();if(e&&(e.pathWasRevalidated=!0),n=s.getAll().filter(e=>i.has(e.name)),t){let e=[];for(let t of n){let s=new a.ResponseCookies(new Headers);s.set(t),e.push(s.toString())}t(e)}};return new Proxy(s,{get(e,t,s){switch(t){case d:return n;case"delete":return function(...t){i.add("string"==typeof t[0]?t[0]:t[0].name);try{e.delete(...t)}finally{o()}};case"set":return function(...t){i.add("string"==typeof t[0]?t[0]:t[0].name);try{return e.set(...t)}finally{o()}};default:return r.ReflectAdapter.get(e,t,s)}}})}}},2044:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}(t,{RequestCookies:function(){return a.RequestCookies},ResponseCookies:function(){return a.ResponseCookies}});let a=s(9925)},7272:()=>{},7560:(e,t,s)=>{"use strict";s.d(t,{kv:()=>i});var a=s(242),r=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var l=class extends a.Redis{async *scanIterator(e){let t,s=0;do for(let a of([s,t]=await this.scan(s,e),t))yield a;while(0!==s)}async *hscanIterator(e,t){let s,a=0;do for(let r of([a,s]=await this.hscan(e,a,t),s))yield r;while(0!==a)}async *sscanIterator(e,t){let s,a=0;do for(let r of([a,s]=await this.sscan(e,a,t),s))yield r;while(0!==a)}async *zscanIterator(e,t){let s,a=0;do for(let r of([a,s]=await this.zscan(e,a,t),s))yield r;while(0!==a)}};function n(e){return new l({cache:"default",...e})}new Proxy({},{get(e,t,s){if("then"===t||"parse"===t)return Reflect.get(e,t,s);if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}});var i=new Proxy({},{get(e,t){if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[8948,242,4818,4332],()=>s(9505));module.exports=a})();