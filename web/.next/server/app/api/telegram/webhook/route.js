"use strict";(()=>{var e={};e.id=9009,e.ids=[9009,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},9360:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>N,patchFetch:()=>A,requestAsyncStorage:()=>v,routeModule:()=>y,serverHooks:()=>T,staticGenerationAsyncStorage:()=>k});var r={};a.r(r),a.d(r,{POST:()=>h,dynamic:()=>_,runtime:()=>w});var n=a(9303),i=a(8716),o=a(670),s=a(7070),l=a(6113),m=a(6724),d=a(9637),c=a(1833),u=a(3783),p=a(4528),f=a(6357);let _="force-dynamic",w="nodejs";async function h(e){try{(0,m.Jr)();let t=await e.json();return t.message?await g(t.message):t.callback_query&&await b(t.callback_query),s.NextResponse.json({ok:!0})}catch(e){return console.error("[telegram/webhook] Error processing update:",e),s.NextResponse.json({ok:!1},{status:200})}}async function g(e){if(!e)return;let t=e.chat.id,a=e.from;if(e.text?.startsWith("/start")){let e=await (0,f.WP)(t,a?.username,a?.first_name,a?.last_name);e?.master?await (0,d.bG)(t,`–ü—Ä–∏–≤—ñ—Ç, ${e.master.name}!

–Ø –±—É–¥—É –Ω–∞–≥–∞–¥—É–≤–∞—Ç–∏ –ø—Ä–æ —Ñ–æ—Ç–æ-–∑–≤—ñ—Ç–∏ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —ó—Ö –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
–ö–æ–ª–∏ –æ—Ç—Ä–∏–º–∞—î—à –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è, –Ω–∞—Ç–∏—Å–Ω–∏ \xab\\uD83D\\uDCF8 –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–æ—Ç–æ\xbb —Ç–∞ –ø—Ä–∏–∫—Ä—ñ–ø–∏ —Ñ–æ—Ç–æ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å.`):await (0,d.bG)(t,"–ü—Ä–∏–≤—ñ—Ç! –ù–∞—Ä–∞–∑—ñ —è –Ω–µ –∑–Ω–∞–π—à–æ–≤ —Ç–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å —É —Å–ø–∏—Å–∫—É –º–∞–π—Å—Ç—Ä—ñ–≤. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–æ–≤—ñ–¥–æ–º –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É.");return}if(e.photo?.length){await I(e);return}if(e.text){if("\uD83D\uDCF8 –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ"===e.text||e.text.includes("\uD83D\uDCF8 –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ")){let e=await (0,c.$d)(t);if(e){await (0,d.bG)(t,`üì∏ <b>–ù–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ ${e.appointment.clientName}</b>

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É –∫–∞–º–µ—Ä–∏ üì∑ –≤–Ω–∏–∑—É –µ–∫—Ä–∞–Ω—É –∞–±–æ –≤–∫–ª–∞–¥–µ–Ω–Ω—è (üìé) ‚Üí –§–æ—Ç–æ –∞–±–æ –í—ñ–¥–µ–æ.

–ü—ñ—Å–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ñ–æ—Ç–æ –∑'—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤ –≥—Ä—É–ø—É.`);return}await (0,d.bG)(t,"–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –Ω–∞ —Ñ–æ—Ç–æ. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è.");return}if(e.text.includes("‚è∞ –ù–∞–≥–∞–¥–∞—Ç–∏ —á–µ—Ä–µ–∑ 5 —Ö–≤")){let a=e.text.match(/\(([^)]+)\)$/)?.[1];if(a){let e=(0,p.OT)(a);if(e){await (0,d.bG)(t,`–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ ${e.clientName} –ø–æ–≤—Ç–æ—Ä–∏–º–æ —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω.`);return}}}if(e.text.includes("‚ùå –ö–ª—ñ—î–Ω—Ç –ø—ñ—à–æ–≤")){let a=e.text.match(/\(([^)]+)\)$/)?.[1];if(a){let e=(0,p.OT)(a);if(e){await (0,c.zT)(`‚ö†Ô∏è ${e.masterName} –∑–∞–∑–Ω–∞—á–∏–≤, —â–æ –∫–ª—ñ—î–Ω—Ç ${e.clientName} –ø—ñ—à–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ.`),await (0,d.bG)(t,"–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä —Å–ø–æ–≤—ñ—â–µ–Ω–∏–π. –î—è–∫—É—é –∑–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é!",{reply_markup:{remove_keyboard:!0}});return}}}await (0,d.bG)(t,"–ù–∞–¥—ñ—à–ª–∏ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É \xab\uD83D\uDCF8 –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ\xbb –∞–±–æ –¥–æ—á–µ–∫–∞–π—Å—è –Ω–æ–≤–æ–≥–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è.")}}async function b(e){let[t,a]=(e.data||"").split(":"),r=e.message?.chat.id;if(!r){await (0,d.MY)(e.id,{text:"–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ –¥—ñ—é",show_alert:!0});return}let n=await (0,c.$d)(r);if(!n){await (0,d.MY)(e.id,{text:"–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –≤–∂–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–µ",show_alert:!0});return}switch(t){case"send_photos":{if(!n.photoFileIds||0===n.photoFileIds.length){await (0,d.MY)(e.id,{text:"–ü–æ–º–∏–ª–∫–∞: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ",show_alert:!0});return}let t={id:(0,l.randomUUID)(),appointmentId:n.appointment.id,masterId:n.masterId,masterName:n.appointment.masterName,clientName:n.appointment.clientName,serviceName:n.appointment.serviceName,createdAt:new Date().toISOString(),telegramFileId:n.photoFileIds[0],telegramFileIds:n.photoFileIds,telegramMessageId:e.message?.message_id||0,caption:void 0};await (0,c.Ow)(r,t),await (0,d.MY)(e.id,{text:"‚úÖ –§–æ—Ç–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥—Ä—É–ø—É!"}),await (0,d.bG)(r,`‚úÖ –î—è–∫—É—é! ${n.photoFileIds.length} —Ñ–æ—Ç–æ –ø–æ –∫–ª—ñ—î–Ω—Ç—É <b>${n.appointment.clientName}</b> –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.`,{reply_markup:{remove_keyboard:!0}});let a=[`üì∑ <b>${n.appointment.masterName}</b>`,`<b>–ö–ª—ñ—î–Ω—Ç:</b> ${n.appointment.clientName}`,`<b>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞:</b> ${n.appointment.serviceName}`,`<b>–ß–∞—Å:</b> ${new Date().toLocaleString("uk-UA")}`,n.photoFileIds.length>1?`<b>–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–æ—Ç–æ:</b> ${n.photoFileIds.length}`:""].filter(Boolean).join("\n");await (0,d.A8)(n.photoFileIds,a);break}case"cancel_photo":await (0,d.MY)(e.id,{text:"–°–∫–∞—Å–æ–≤–∞–Ω–æ"}),await (0,d.bG)(r,"–§–æ—Ç–æ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ. –ú–æ–∂–µ—Ç–µ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —ó—Ö –ø—ñ–∑–Ω—ñ—à–µ.",{reply_markup:{remove_keyboard:!0}}),await (0,u.sZ)(r);break;case"add_more_photos":await (0,d.MY)(e.id,{text:"–ù–∞–¥—ñ—à–ª—ñ—Ç—å —â–µ —Ñ–æ—Ç–æ"}),await (0,d.bG)(r,`üì∏ –ù–∞–¥—ñ—à–ª—ñ—Ç—å —â–µ —Ñ–æ—Ç–æ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ <b>${n.appointment.clientName}</b>. –ü—ñ—Å–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∑'—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—Å—ñ—Ö —Ñ–æ—Ç–æ.`);break;default:await (0,d.MY)(e.id,{text:"–ù–µ–≤—ñ–¥–æ–º–∞ –¥—ñ—è"})}}async function I(e){let t=e.chat.id,a=await (0,c.$d)(t);if(!a){await (0,d.bG)(t,"–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—è –Ω–æ–≤–æ–≥–æ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å \xab\uD83D\uDCF8 –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ\xbb.",{reply_markup:{remove_keyboard:!0}});return}let r=e.photo?.[e.photo.length-1];if(!r){await (0,d.bG)(t,"–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–æ—Ç–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");return}if(!await (0,u.Ri)(t,r.file_id)){await (0,d.bG)(t,"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ —Ñ–æ—Ç–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");return}let n=await (0,c.$d)(t);if(!n){await (0,d.bG)(t,"–ü–æ–º–∏–ª–∫–∞: –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.");return}let i=n.photoFileIds?.length||0,o=[`‚úÖ –§–æ—Ç–æ –æ—Ç—Ä–∏–º–∞–Ω–æ!`,"",`<b>–ö–ª—ñ—î–Ω—Ç:</b> ${a.appointment.clientName}`,`<b>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞:</b> ${a.appointment.serviceName}`,`<b>–§–æ—Ç–æ:</b> ${i} —Ñ–æ—Ç–æ`,"",1===i?`–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å \xab‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –≥—Ä—É–ø—É\xbb, —â–æ–± –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–æ—Ç–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.`:`–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å \xab‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –≥—Ä—É–ø—É\xbb, —â–æ–± –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—Å—ñ ${i} —Ñ–æ—Ç–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.`].join("\n");await (0,d.bG)(t,o,{reply_markup:{inline_keyboard:[[{text:`‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ –≥—Ä—É–ø—É (${i})`,callback_data:`send_photos:${a.appointment.id}`}],[{text:"‚ûï –î–æ–¥–∞—Ç–∏ —â–µ —Ñ–æ—Ç–æ",callback_data:`add_more_photos:${a.appointment.id}`},{text:"‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏",callback_data:`cancel_photo:${a.appointment.id}`}]]}})}let y=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/telegram/webhook/route",pathname:"/api/telegram/webhook",filename:"route",bundlePath:"app/api/telegram/webhook/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/telegram/webhook/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:k,serverHooks:T}=y,N="/api/telegram/webhook/route";function A(){return(0,o.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:k})}},6357:(e,t,a)=>{a.d(t,{WP:()=>o,b$:()=>s,hY:()=>l});var r=a(7560),n=a(4528);let i="photo-reports:telegram:chats";async function o(e,t,a,o){let s=(0,n.Wh)(t)||function(e,t){if(!e)return;let a=[e,t].filter(Boolean).join(" ").toLowerCase();return(0,n.N$)().find(r=>r.name.toLowerCase().includes(e.toLowerCase())||!!t&&r.name.toLowerCase().includes(t.toLowerCase())||r.name.toLowerCase()===a)}(a,o);if(!s)return console.warn("[photo-report] Unknown master tried to register",e,t),null;let l={masterId:s.id,chatId:e,username:t,firstName:a,lastName:o,registeredAt:new Date().toISOString()};return await r.kv.hset(i,{[e]:l}),{master:s,entry:l}}async function s(){let e=await r.kv.hgetall(i);return e?Object.values(e):[]}async function l(e){let t=(await s()).find(t=>t.masterId===e);return t?.chatId}},1833:(e,t,a)=>{a.d(t,{$d:()=>m,Ow:()=>l,oy:()=>o,zT:()=>d});var r=a(9637),n=a(6724),i=a(3783);async function o(e,t){let a=`üì∏ <b>–§–æ—Ç–æ-–∑–≤—ñ—Ç –¥–ª—è ${t.masterName}</b>

<b>–ö–ª—ñ—î–Ω—Ç:</b> ${t.clientName}
<b>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞:</b> ${t.serviceName}
<b>–ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –æ:</b> ${new Date(t.endAt).toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"})}

–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –ø—Ä—è–º–æ –≤ —Ü–µ–π —á–∞—Ç –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—ñ–∑–∏—Ç—É.`;return await s(e,t),(0,r.bG)(e,a,{reply_markup:{keyboard:[[{text:"\uD83D\uDCF8 –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ"}],[{text:`‚è∞ –ù–∞–≥–∞–¥–∞—Ç–∏ —á–µ—Ä–µ–∑ 5 —Ö–≤ (${t.id})`},{text:`‚ùå –ö–ª—ñ—î–Ω—Ç –ø—ñ—à–æ–≤ (${t.id})`}]],resize_keyboard:!0,one_time_keyboard:!1}})}async function s(e,t){await (0,i.E$)({chatId:e,masterId:t.masterId,appointment:t,createdAt:new Date().toISOString(),photoFileIds:[]})}async function l(e,t){await (0,i.tq)(t),await (0,i.$e)(t.appointmentId),await (0,i.sZ)(e)}async function m(e){return(0,i.Yu)(e)}function d(e){return n.go.ADMIN_CHAT_IDS.length?Promise.all(n.go.ADMIN_CHAT_IDS.map(t=>(0,r.bG)(t,e))):(console.warn("[telegram] No admin chat ids configured:",e),Promise.resolve())}},4528:(e,t,a)=>{a.d(t,{Kf:()=>u,OT:()=>d,mC:()=>m,Wh:()=>l,N$:()=>s,y8:()=>c});let r=[{id:"master-test",name:"–¢–µ—Å—Ç–æ–≤–∏–π –º–∞–π—Å—Ç–µ—Ä (Mykolay)",telegramUsername:"Mykolay007",role:"master"},{id:"master-olena",name:"–û–ª–µ–Ω–∞",telegramUsername:"o_sarbeeva",role:"master",altegioStaffId:2658785},{id:"master-tester",name:"Mykolay (—Ç–µ—Å—Ç-—Ä–µ–∂–∏–º)",telegramUsername:"Mykolay007",role:"master"},{id:"master-oleksandra",name:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞",telegramUsername:"Alexandra_Z7",role:"master",altegioStaffId:2851361},{id:"master-maryana",name:"–ú–∞—Ä'—è–Ω–∞",telegramUsername:"maryana24021989",role:"master",altegioStaffId:2860168},{id:"master-halyna",name:"–ì–∞–ª–∏–Ω–∞",telegramUsername:"Halyna_Maxymiv",role:"master",altegioStaffId:2658783},{id:"admin-viktoria",name:"–í—ñ–∫—Ç–æ—Ä—ñ—è (–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)",telegramUsername:"kolachnykv",role:"admin",altegioStaffId:2643393}],n=new Date;function i(e,t){let a=new Date(e);return a.setMinutes(a.getMinutes()+t),a.toISOString()}let o=[{id:"apt-1001",clientName:"–Ü—Ä–∏–Ω–∞",serviceName:"–ù–∞—Ä–æ—â–µ–Ω–Ω—è –≤–æ–ª–æ—Å—Å—è (–ø–æ–≤–Ω–µ)",masterId:"master-olena",masterName:"–û–ª–µ–Ω–∞",startAt:i(n,-60),endAt:i(n,-5)},{id:"apt-1002",clientName:"–ú–∞—Ä—ñ—è",serviceName:"–ö–æ—Ä–µ–∫—Ü—ñ—è –Ω–∞—Ä–æ—â–µ–Ω–Ω—è",masterId:"master-oleksandra",masterName:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞",startAt:i(n,-30),endAt:i(n,10)},{id:"apt-1003",clientName:"–û–∫—Å–∞–Ω–∞",serviceName:"–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ —É–∫–ª–∞–¥–∫–∞",masterId:"master-maryana",masterName:"–ú–∞—Ä'—è–Ω–∞",startAt:i(n,-20),endAt:i(n,20)},{id:"apt-1004",clientName:"–¢–µ—Å—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç",serviceName:"–ù–∞—Ä–æ—â–µ–Ω–Ω—è –≤–æ–ª–æ—Å—Å—è (—Ç–µ—Å—Ç)",masterId:"master-test",masterName:"–¢–µ—Å—Ç–æ–≤–∏–π –º–∞–π—Å—Ç–µ—Ä (Mykolay)",startAt:i(n,-10),endAt:i(n,15)}];function s(){return r}function l(e){if(e)return r.find(t=>t.telegramUsername?.toLowerCase()===e.toLowerCase())}function m(e){return r.find(t=>t.altegioStaffId===e)}function d(e){return o.find(t=>t.id===e)}function c(e=15){let t=Date.now(),a=t+6e4*e;return o.filter(e=>{let r=new Date(e.endAt).getTime();return r>=t&&r<=a})}function u(e,t){if(!t)return null;let a=e.start_datetime||e.datetime||e.date,r=e.end_datetime||e.datetime||e.date;if(!a||!r)return console.warn(`[photo-reports] Appointment ${e.id} missing datetime fields`,e),null;let n=e.client?.name||e.client?.display_name||e.client_name||"–ö–ª—ñ—î–Ω—Ç",i=e.service?.title||e.service?.name||e.service_name||"–ü–æ—Å–ª—É–≥–∞";return{id:`altegio-${e.id}`,clientName:n,serviceName:i,masterId:t.id,masterName:t.name,startAt:new Date(a).toISOString(),endAt:new Date(r).toISOString()}}},3783:(e,t,a)=>{a.d(t,{$e:()=>f,E$:()=>s,HA:()=>p,Ri:()=>c,Yu:()=>l,qg:()=>u,sZ:()=>m,tq:()=>d,wH:()=>_});var r=a(7560);let n="photo-reports",i=e=>`photo-reports-pending:${e}`,o=e=>`${n}:${e}`;async function s(e){await r.kv.set(i(e.chatId),e,{ex:1800})}async function l(e){return r.kv.get(i(e))}async function m(e){await r.kv.del(i(e))}async function d(e){!e.telegramFileId&&e.telegramFileIds?.length>0&&(e.telegramFileId=e.telegramFileIds[0]),await r.kv.set(o(e.appointmentId),e)}async function c(e,t){let a=await l(e);return!!a&&(a.photoFileIds||(a.photoFileIds=[]),a.photoFileIds.includes(t)||(a.photoFileIds.push(t),await s(a)),!0)}async function u(e){return r.kv.get(o(e))}async function p(e=20){let t=`${n}:index`,a=await r.kv.lrange(t,0,-1)||[],i=[];for(let t of a.slice(0,e)){let e=await u(t);e&&i.push(e)}return i}async function f(e){let t=`${n}:index`;await r.kv.lpush(t,e),await r.kv.ltrim(t,0,99)}async function _(){let e=`${n}:index`,t=await r.kv.lrange(e,0,-1),a=0;for(let e of t)try{await r.kv.del(o(e)),a++}catch(t){console.warn(`[photo-reports/store] Failed to delete report ${e}:`,t)}return await r.kv.del(e),a}},9637:(e,t,a)=>{a.d(t,{A8:()=>l,MY:()=>s,bG:()=>i});var r=a(6724);async function n(e,t){(0,r.Jr)();let a=await fetch((0,r.kC)(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await a.json();if(!n.ok)throw Error(`Telegram API error (${e}): ${n.description||"Unknown error"}`);return n.result}function i(e,t,a={}){return n("sendMessage",{chat_id:e,text:t,parse_mode:"HTML",...a})}function o(e,t,a={}){return n("sendPhoto",{chat_id:e,photo:t,...a})}function s(e,t={}){return n("answerCallbackQuery",{callback_query_id:e,...t})}async function l(e,t){if(!r.go.REPORT_GROUP_ID){console.warn("[telegram] TELEGRAM_PHOTO_GROUP_ID not configured. Skipping forward.");return}if(0!==e.length){for(let t=0;t<e.length-1;t++)await o(r.go.REPORT_GROUP_ID,e[t]);await o(r.go.REPORT_GROUP_ID,e[e.length-1],{caption:t})}}},6724:(e,t,a)=>{a.d(t,{Jr:()=>n,go:()=>r,kC:()=>i});let r={BOT_TOKEN:process.env.TELEGRAM_BOT_TOKEN?.trim()||"",REPORT_GROUP_ID:process.env.TELEGRAM_PHOTO_GROUP_ID?Number(process.env.TELEGRAM_PHOTO_GROUP_ID):null,ADMIN_CHAT_IDS:process.env.TELEGRAM_ADMIN_CHAT_IDS?process.env.TELEGRAM_ADMIN_CHAT_IDS.split(",").map(e=>e.trim()).filter(Boolean).map(e=>Number(e)).filter(e=>!Number.isNaN(e)):[]};function n(){if(!r.BOT_TOKEN)throw Error("Missing TELEGRAM_BOT_TOKEN env variable")}function i(e){n();let t=e.startsWith("/")?e.slice(1):e;return`https://api.telegram.org/bot${r.BOT_TOKEN}/${t}`}},7560:(e,t,a)=>{a.d(t,{kv:()=>s});var r=a(242),n=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var i=class extends r.Redis{async *scanIterator(e){let t,a=0;do for(let r of([a,t]=await this.scan(a,e),t))yield r;while(0!==a)}async *hscanIterator(e,t){let a,r=0;do for(let n of([r,a]=await this.hscan(e,r,t),a))yield n;while(0!==r)}async *sscanIterator(e,t){let a,r=0;do for(let n of([r,a]=await this.sscan(e,r,t),a))yield n;while(0!==r)}async *zscanIterator(e,t){let a,r=0;do for(let n of([r,a]=await this.zscan(e,r,t),a))yield n;while(0!==r)}};function o(e){return new i({cache:"default",...e})}new Proxy({},{get(e,t,a){if("then"===t||"parse"===t)return Reflect.get(e,t,a);if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),n=o({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}});var s=new Proxy({},{get(e,t){if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");n=o({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,242],()=>a(9360));module.exports=r})();