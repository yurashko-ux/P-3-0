"use strict";(()=>{var e={};e.id=1821,e.ids=[1821,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},9518:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var a={};r.r(a),r.d(a,{GET:()=>f,dynamic:()=>c,runtime:()=>u});var n=r(9303),s=r(8716),i=r(670),o=r(7070),m=r(6724),l=r(6357),d=r(4528);let c="force-dynamic",u="nodejs";async function f(e){try{(0,m.Jr)();let t=e.nextUrl.searchParams.get("username");if(!t){let e=await (0,l.b$)();return o.NextResponse.json({ok:!0,registeredChats:e.map(e=>({chatId:e.chatId,username:e.username,masterId:e.masterId,firstName:e.firstName,lastName:e.lastName,registeredAt:e.registeredAt}))})}let r=(0,d.Wh)(t);if(!r)return o.NextResponse.json({ok:!1,error:`Master with username "${t}" not found in registry`},{status:404});let a=(await (0,l.b$)()).find(e=>e.username?.toLowerCase()===t.toLowerCase()||e.masterId===r.id);if(!a)return o.NextResponse.json({ok:!1,error:`Chat not registered for username "${t}". Please send /start to the bot first.`,master:{id:r.id,name:r.name,telegramUsername:r.telegramUsername}},{status:404});return o.NextResponse.json({ok:!0,chatId:a.chatId,master:{id:r.id,name:r.name,telegramUsername:r.telegramUsername},registeredAt:a.registeredAt})}catch(e){return console.error("[telegram/get-chat-id] Error:",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/telegram/get-chat-id/route",pathname:"/api/telegram/get-chat-id",filename:"route",bundlePath:"app/api/telegram/get-chat-id/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/telegram/get-chat-id/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:h}=p,v="/api/telegram/get-chat-id/route";function I(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},6357:(e,t,r)=>{r.d(t,{WP:()=>i,b$:()=>o,hY:()=>m});var a=r(7560),n=r(4528);let s="photo-reports:telegram:chats";async function i(e,t,r,i){let o=(0,n.Wh)(t)||function(e,t){if(!e)return;let r=[e,t].filter(Boolean).join(" ").toLowerCase();return(0,n.N$)().find(a=>a.name.toLowerCase().includes(e.toLowerCase())||!!t&&a.name.toLowerCase().includes(t.toLowerCase())||a.name.toLowerCase()===r)}(r,i);if(!o)return console.warn("[photo-report] Unknown master tried to register",e,t),null;let m={masterId:o.id,chatId:e,username:t,firstName:r,lastName:i,registeredAt:new Date().toISOString()};return await a.kv.hset(s,{[e]:m}),{master:o,entry:m}}async function o(){let e=await a.kv.hgetall(s);return e?Object.values(e):[]}async function m(e){let t=(await o()).find(t=>t.masterId===e);return t?.chatId}},4528:(e,t,r)=>{r.d(t,{Kf:()=>u,OT:()=>d,mC:()=>l,Wh:()=>m,N$:()=>o,y8:()=>c});let a=[{id:"master-test",name:"Тестовий майстер (Mykolay)",telegramUsername:"Mykolay007",role:"master"},{id:"master-olena",name:"Олена",telegramUsername:"o_sarbeeva",role:"master",altegioStaffId:2658785},{id:"master-tester",name:"Mykolay (тест-режим)",telegramUsername:"Mykolay007",role:"master"},{id:"master-oleksandra",name:"Олександра",telegramUsername:"Alexandra_Z7",role:"master",altegioStaffId:2851361},{id:"master-maryana",name:"Мар'яна",telegramUsername:"maryana24021989",role:"master",altegioStaffId:2860168},{id:"master-halyna",name:"Галина",telegramUsername:"Halyna_Maxymiv",role:"master",altegioStaffId:2658783},{id:"admin-viktoria",name:"Вікторія (адміністратор)",telegramUsername:"kolachnykv",role:"admin",altegioStaffId:2643393}],n=new Date;function s(e,t){let r=new Date(e);return r.setMinutes(r.getMinutes()+t),r.toISOString()}let i=[{id:"apt-1001",clientName:"Ірина",serviceName:"Нарощення волосся (повне)",masterId:"master-olena",masterName:"Олена",startAt:s(n,-60),endAt:s(n,-5)},{id:"apt-1002",clientName:"Марія",serviceName:"Корекція нарощення",masterId:"master-oleksandra",masterName:"Олександра",startAt:s(n,-30),endAt:s(n,10)},{id:"apt-1003",clientName:"Оксана",serviceName:"Полірування та укладка",masterId:"master-maryana",masterName:"Мар'яна",startAt:s(n,-20),endAt:s(n,20)},{id:"apt-1004",clientName:"Тестовий клієнт",serviceName:"Нарощення волосся (тест)",masterId:"master-test",masterName:"Тестовий майстер (Mykolay)",startAt:s(n,-10),endAt:s(n,15)}];function o(){return a}function m(e){if(e)return a.find(t=>t.telegramUsername?.toLowerCase()===e.toLowerCase())}function l(e){return a.find(t=>t.altegioStaffId===e)}function d(e){return i.find(t=>t.id===e)}function c(e=15){let t=Date.now(),r=t+6e4*e;return i.filter(e=>{let a=new Date(e.endAt).getTime();return a>=t&&a<=r})}function u(e,t){if(!t)return null;let r=e.start_datetime||e.datetime||e.date,a=e.end_datetime||e.datetime||e.date;if(!r||!a)return console.warn(`[photo-reports] Appointment ${e.id} missing datetime fields`,e),null;let n=e.client?.name||e.client?.display_name||e.client_name||"Клієнт",s=e.service?.title||e.service?.name||e.service_name||"Послуга";return{id:`altegio-${e.id}`,clientName:n,serviceName:s,masterId:t.id,masterName:t.name,startAt:new Date(r).toISOString(),endAt:new Date(a).toISOString()}}},6724:(e,t,r)=>{r.d(t,{Jr:()=>n,go:()=>a,kC:()=>s});let a={BOT_TOKEN:process.env.TELEGRAM_BOT_TOKEN?.trim()||"",REPORT_GROUP_ID:process.env.TELEGRAM_PHOTO_GROUP_ID?Number(process.env.TELEGRAM_PHOTO_GROUP_ID):null,ADMIN_CHAT_IDS:process.env.TELEGRAM_ADMIN_CHAT_IDS?process.env.TELEGRAM_ADMIN_CHAT_IDS.split(",").map(e=>e.trim()).filter(Boolean).map(e=>Number(e)).filter(e=>!Number.isNaN(e)):[]};function n(){if(!a.BOT_TOKEN)throw Error("Missing TELEGRAM_BOT_TOKEN env variable")}function s(e){n();let t=e.startsWith("/")?e.slice(1):e;return`https://api.telegram.org/bot${a.BOT_TOKEN}/${t}`}},7560:(e,t,r)=>{r.d(t,{kv:()=>o});var a=r(242),n=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var s=class extends a.Redis{async *scanIterator(e){let t,r=0;do for(let a of([r,t]=await this.scan(r,e),t))yield a;while(0!==r)}async *hscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.hscan(e,a,t),r))yield n;while(0!==a)}async *sscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.sscan(e,a,t),r))yield n;while(0!==a)}async *zscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.zscan(e,a,t),r))yield n;while(0!==a)}};function i(e){return new s({cache:"default",...e})}new Proxy({},{get(e,t,r){if("then"===t||"parse"===t)return Reflect.get(e,t,r);if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),n=i({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}});var o=new Proxy({},{get(e,t){if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");n=i({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,242],()=>r(9518));module.exports=a})();