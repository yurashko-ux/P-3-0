"use strict";(()=>{var e={};e.id=4962,e.ids=[4962,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},5783:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>I,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v});var r={};a.r(r),a.d(r,{GET:()=>f,dynamic:()=>u,runtime:()=>p});var n=a(9303),i=a(8716),s=a(670),o=a(7070),l=a(6724),d=a(4528),m=a(6357),c=a(3783);let u="force-dynamic",p="nodejs";async function f(e){try{(0,l.Jr)();let e=(0,d.N$)(),t=await (0,m.b$)(),a=await (0,c.HA)(20),r=await Promise.all(t.map(async e=>({chatId:e.chatId,pending:await (0,c.Yu)(Number(e.chatId))})));return o.NextResponse.json({ok:!0,masters:e,registeredChats:t,recentReports:a,pendingByChat:r.filter(e=>e.pending)})}catch(e){return console.error("[telegram/debug] error",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/telegram/debug/route",pathname:"/api/telegram/debug",filename:"route",bundlePath:"app/api/telegram/debug/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/telegram/debug/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:v,serverHooks:h}=g,w="/api/telegram/debug/route";function I(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}},6357:(e,t,a)=>{a.d(t,{WP:()=>s,b$:()=>o,hY:()=>l});var r=a(7560),n=a(4528);let i="photo-reports:telegram:chats";async function s(e,t,a,s){let o=(0,n.Wh)(t)||function(e,t){if(!e)return;let a=[e,t].filter(Boolean).join(" ").toLowerCase();return(0,n.N$)().find(r=>r.name.toLowerCase().includes(e.toLowerCase())||!!t&&r.name.toLowerCase().includes(t.toLowerCase())||r.name.toLowerCase()===a)}(a,s);if(!o)return console.warn("[photo-report] Unknown master tried to register",e,t),null;let l={masterId:o.id,chatId:e,username:t,firstName:a,lastName:s,registeredAt:new Date().toISOString()};return await r.kv.hset(i,{[e]:l}),{master:o,entry:l}}async function o(){let e=await r.kv.hgetall(i);return e?Object.values(e):[]}async function l(e){let t=(await o()).find(t=>t.masterId===e);return t?.chatId}},4528:(e,t,a)=>{a.d(t,{Kf:()=>u,OT:()=>m,mC:()=>d,Wh:()=>l,N$:()=>o,y8:()=>c});let r=[{id:"master-test",name:"Тестовий майстер (Mykolay)",telegramUsername:"Mykolay007",role:"master"},{id:"master-olena",name:"Олена",telegramUsername:"o_sarbeeva",role:"master",altegioStaffId:2658785},{id:"master-tester",name:"Mykolay (тест-режим)",telegramUsername:"Mykolay007",role:"master"},{id:"master-oleksandra",name:"Олександра",telegramUsername:"Alexandra_Z7",role:"master",altegioStaffId:2851361},{id:"master-maryana",name:"Мар'яна",telegramUsername:"maryana24021989",role:"master",altegioStaffId:2860168},{id:"master-halyna",name:"Галина",telegramUsername:"Halyna_Maxymiv",role:"master",altegioStaffId:2658783},{id:"admin-viktoria",name:"Вікторія (адміністратор)",telegramUsername:"kolachnykv",role:"admin",altegioStaffId:2643393}],n=new Date;function i(e,t){let a=new Date(e);return a.setMinutes(a.getMinutes()+t),a.toISOString()}let s=[{id:"apt-1001",clientName:"Ірина",serviceName:"Нарощення волосся (повне)",masterId:"master-olena",masterName:"Олена",startAt:i(n,-60),endAt:i(n,-5)},{id:"apt-1002",clientName:"Марія",serviceName:"Корекція нарощення",masterId:"master-oleksandra",masterName:"Олександра",startAt:i(n,-30),endAt:i(n,10)},{id:"apt-1003",clientName:"Оксана",serviceName:"Полірування та укладка",masterId:"master-maryana",masterName:"Мар'яна",startAt:i(n,-20),endAt:i(n,20)},{id:"apt-1004",clientName:"Тестовий клієнт",serviceName:"Нарощення волосся (тест)",masterId:"master-test",masterName:"Тестовий майстер (Mykolay)",startAt:i(n,-10),endAt:i(n,15)}];function o(){return r}function l(e){if(e)return r.find(t=>t.telegramUsername?.toLowerCase()===e.toLowerCase())}function d(e){return r.find(t=>t.altegioStaffId===e)}function m(e){return s.find(t=>t.id===e)}function c(e=15){let t=Date.now(),a=t+6e4*e;return s.filter(e=>{let r=new Date(e.endAt).getTime();return r>=t&&r<=a})}function u(e,t){if(!t)return null;let a=e.start_datetime||e.datetime||e.date,r=e.end_datetime||e.datetime||e.date;if(!a||!r)return console.warn(`[photo-reports] Appointment ${e.id} missing datetime fields`,e),null;let n=e.client?.name||e.client?.display_name||e.client_name||"Клієнт",i=e.service?.title||e.service?.name||e.service_name||"Послуга";return{id:`altegio-${e.id}`,clientName:n,serviceName:i,masterId:t.id,masterName:t.name,startAt:new Date(a).toISOString(),endAt:new Date(r).toISOString()}}},3783:(e,t,a)=>{a.d(t,{$e:()=>f,E$:()=>o,HA:()=>p,Ri:()=>c,Yu:()=>l,qg:()=>u,sZ:()=>d,tq:()=>m,wH:()=>g});var r=a(7560);let n="photo-reports",i=e=>`photo-reports-pending:${e}`,s=e=>`${n}:${e}`;async function o(e){await r.kv.set(i(e.chatId),e,{ex:1800})}async function l(e){return r.kv.get(i(e))}async function d(e){await r.kv.del(i(e))}async function m(e){!e.telegramFileId&&e.telegramFileIds?.length>0&&(e.telegramFileId=e.telegramFileIds[0]),await r.kv.set(s(e.appointmentId),e)}async function c(e,t){let a=await l(e);return!!a&&(a.photoFileIds||(a.photoFileIds=[]),a.photoFileIds.includes(t)||(a.photoFileIds.push(t),await o(a)),!0)}async function u(e){return r.kv.get(s(e))}async function p(e=20){let t=`${n}:index`,a=await r.kv.lrange(t,0,-1)||[],i=[];for(let t of a.slice(0,e)){let e=await u(t);e&&i.push(e)}return i}async function f(e){let t=`${n}:index`;await r.kv.lpush(t,e),await r.kv.ltrim(t,0,99)}async function g(){let e=`${n}:index`,t=await r.kv.lrange(e,0,-1),a=0;for(let e of t)try{await r.kv.del(s(e)),a++}catch(t){console.warn(`[photo-reports/store] Failed to delete report ${e}:`,t)}return await r.kv.del(e),a}},6724:(e,t,a)=>{a.d(t,{Jr:()=>n,go:()=>r,kC:()=>i});let r={BOT_TOKEN:process.env.TELEGRAM_BOT_TOKEN?.trim()||"",REPORT_GROUP_ID:process.env.TELEGRAM_PHOTO_GROUP_ID?Number(process.env.TELEGRAM_PHOTO_GROUP_ID):null,ADMIN_CHAT_IDS:process.env.TELEGRAM_ADMIN_CHAT_IDS?process.env.TELEGRAM_ADMIN_CHAT_IDS.split(",").map(e=>e.trim()).filter(Boolean).map(e=>Number(e)).filter(e=>!Number.isNaN(e)):[]};function n(){if(!r.BOT_TOKEN)throw Error("Missing TELEGRAM_BOT_TOKEN env variable")}function i(e){n();let t=e.startsWith("/")?e.slice(1):e;return`https://api.telegram.org/bot${r.BOT_TOKEN}/${t}`}},7560:(e,t,a)=>{a.d(t,{kv:()=>o});var r=a(242),n=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var i=class extends r.Redis{async *scanIterator(e){let t,a=0;do for(let r of([a,t]=await this.scan(a,e),t))yield r;while(0!==a)}async *hscanIterator(e,t){let a,r=0;do for(let n of([r,a]=await this.hscan(e,r,t),a))yield n;while(0!==r)}async *sscanIterator(e,t){let a,r=0;do for(let n of([r,a]=await this.sscan(e,r,t),a))yield n;while(0!==r)}async *zscanIterator(e,t){let a,r=0;do for(let n of([r,a]=await this.zscan(e,r,t),a))yield n;while(0!==r)}};function s(e){return new i({cache:"default",...e})}new Proxy({},{get(e,t,a){if("then"===t||"parse"===t)return Reflect.get(e,t,a);if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}});var o=new Proxy({},{get(e,t){if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,242],()=>a(5783));module.exports=r})();