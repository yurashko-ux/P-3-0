"use strict";(()=>{var e={};e.id=6896,e.ids=[6896,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},7643:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{POST:()=>p,dynamic:()=>u,runtime:()=>f});var n=r(9303),i=r(8716),s=r(670),o=r(7070),l=r(6724),m=r(1833),d=r(6357),c=r(4528);let u="force-dynamic",f="nodejs";async function p(e){try{(0,l.Jr)();let t=await e.json().catch(()=>({})),r=null;if(t.chatId)r=t.chatId;else if(t.telegramUsername){let e=(0,c.Wh)(t.telegramUsername);if(e){let a=(await (0,d.b$)()).find(r=>r.username?.toLowerCase()===t.telegramUsername?.toLowerCase()||r.masterId===e.id);a&&(r=a.chatId)}}if(!r)return o.NextResponse.json({ok:!1,error:"chatId not found. Please send /start to the Telegram bot first, then try again.",hint:t.telegramUsername?`Username "${t.telegramUsername}" not registered. Send /start to the bot.`:"Provide chatId or telegramUsername in the request body."},{status:400});let a=new Date,n=t.minutesUntilEnd||15,i=new Date(a);i.setMinutes(i.getMinutes()+n);let s={id:`test-${Date.now()}`,clientName:t.clientName||"–¢–µ—Å—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç",serviceName:t.serviceName||"–¢–µ—Å—Ç–æ–≤–∞ –ø–æ—Å–ª—É–≥–∞",masterId:"master-test",masterName:"–¢–µ—Å—Ç–æ–≤–∏–π –º–∞–π—Å—Ç–µ—Ä",startAt:a.toISOString(),endAt:i.toISOString()};return await (0,m.oy)(r,s),o.NextResponse.json({ok:!0,message:"Test reminder sent successfully",chatId:r,appointment:s})}catch(e){return console.error("[telegram/test-reminder] Error:",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/telegram/test-reminder/route",pathname:"/api/telegram/test-reminder",filename:"route",bundlePath:"app/api/telegram/test-reminder/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/telegram/test-reminder/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:w}=g,I="/api/telegram/test-reminder/route";function v(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},6357:(e,t,r)=>{r.d(t,{WP:()=>s,b$:()=>o,hY:()=>l});var a=r(7560),n=r(4528);let i="photo-reports:telegram:chats";async function s(e,t,r,s){let o=(0,n.Wh)(t)||function(e,t){if(!e)return;let r=[e,t].filter(Boolean).join(" ").toLowerCase();return(0,n.N$)().find(a=>a.name.toLowerCase().includes(e.toLowerCase())||!!t&&a.name.toLowerCase().includes(t.toLowerCase())||a.name.toLowerCase()===r)}(r,s);if(!o)return console.warn("[photo-report] Unknown master tried to register",e,t),null;let l={masterId:o.id,chatId:e,username:t,firstName:r,lastName:s,registeredAt:new Date().toISOString()};return await a.kv.hset(i,{[e]:l}),{master:o,entry:l}}async function o(){let e=await a.kv.hgetall(i);return e?Object.values(e):[]}async function l(e){let t=(await o()).find(t=>t.masterId===e);return t?.chatId}},1833:(e,t,r)=>{r.d(t,{$d:()=>m,Ow:()=>l,oy:()=>s,zT:()=>d});var a=r(9637),n=r(6724),i=r(3783);async function s(e,t){let r=`üì∏ <b>–§–æ—Ç–æ-–∑–≤—ñ—Ç –¥–ª—è ${t.masterName}</b>

<b>–ö–ª—ñ—î–Ω—Ç:</b> ${t.clientName}
<b>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞:</b> ${t.serviceName}
<b>–ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –æ:</b> ${new Date(t.endAt).toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"})}

–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –ø—Ä—è–º–æ –≤ —Ü–µ–π —á–∞—Ç –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—ñ–∑–∏—Ç—É.`;return await o(e,t),(0,a.bG)(e,r,{reply_markup:{keyboard:[[{text:"\uD83D\uDCF8 –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ"}],[{text:`‚è∞ –ù–∞–≥–∞–¥–∞—Ç–∏ —á–µ—Ä–µ–∑ 5 —Ö–≤ (${t.id})`},{text:`‚ùå –ö–ª—ñ—î–Ω—Ç –ø—ñ—à–æ–≤ (${t.id})`}]],resize_keyboard:!0,one_time_keyboard:!1}})}async function o(e,t){await (0,i.E$)({chatId:e,masterId:t.masterId,appointment:t,createdAt:new Date().toISOString(),photoFileIds:[]})}async function l(e,t){await (0,i.tq)(t),await (0,i.$e)(t.appointmentId),await (0,i.sZ)(e)}async function m(e){return(0,i.Yu)(e)}function d(e){return n.go.ADMIN_CHAT_IDS.length?Promise.all(n.go.ADMIN_CHAT_IDS.map(t=>(0,a.bG)(t,e))):(console.warn("[telegram] No admin chat ids configured:",e),Promise.resolve())}},4528:(e,t,r)=>{r.d(t,{Kf:()=>u,OT:()=>d,mC:()=>m,Wh:()=>l,N$:()=>o,y8:()=>c});let a=[{id:"master-test",name:"–¢–µ—Å—Ç–æ–≤–∏–π –º–∞–π—Å—Ç–µ—Ä (Mykolay)",telegramUsername:"Mykolay007",role:"master"},{id:"master-olena",name:"–û–ª–µ–Ω–∞",telegramUsername:"o_sarbeeva",role:"master",altegioStaffId:2658785},{id:"master-tester",name:"Mykolay (—Ç–µ—Å—Ç-—Ä–µ–∂–∏–º)",telegramUsername:"Mykolay007",role:"master"},{id:"master-oleksandra",name:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞",telegramUsername:"Alexandra_Z7",role:"master",altegioStaffId:2851361},{id:"master-maryana",name:"–ú–∞—Ä'—è–Ω–∞",telegramUsername:"maryana24021989",role:"master",altegioStaffId:2860168},{id:"master-halyna",name:"–ì–∞–ª–∏–Ω–∞",telegramUsername:"Halyna_Maxymiv",role:"master",altegioStaffId:2658783},{id:"admin-viktoria",name:"–í—ñ–∫—Ç–æ—Ä—ñ—è (–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)",telegramUsername:"kolachnykv",role:"admin",altegioStaffId:2643393}],n=new Date;function i(e,t){let r=new Date(e);return r.setMinutes(r.getMinutes()+t),r.toISOString()}let s=[{id:"apt-1001",clientName:"–Ü—Ä–∏–Ω–∞",serviceName:"–ù–∞—Ä–æ—â–µ–Ω–Ω—è –≤–æ–ª–æ—Å—Å—è (–ø–æ–≤–Ω–µ)",masterId:"master-olena",masterName:"–û–ª–µ–Ω–∞",startAt:i(n,-60),endAt:i(n,-5)},{id:"apt-1002",clientName:"–ú–∞—Ä—ñ—è",serviceName:"–ö–æ—Ä–µ–∫—Ü—ñ—è –Ω–∞—Ä–æ—â–µ–Ω–Ω—è",masterId:"master-oleksandra",masterName:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞",startAt:i(n,-30),endAt:i(n,10)},{id:"apt-1003",clientName:"–û–∫—Å–∞–Ω–∞",serviceName:"–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ —É–∫–ª–∞–¥–∫–∞",masterId:"master-maryana",masterName:"–ú–∞—Ä'—è–Ω–∞",startAt:i(n,-20),endAt:i(n,20)},{id:"apt-1004",clientName:"–¢–µ—Å—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç",serviceName:"–ù–∞—Ä–æ—â–µ–Ω–Ω—è –≤–æ–ª–æ—Å—Å—è (—Ç–µ—Å—Ç)",masterId:"master-test",masterName:"–¢–µ—Å—Ç–æ–≤–∏–π –º–∞–π—Å—Ç–µ—Ä (Mykolay)",startAt:i(n,-10),endAt:i(n,15)}];function o(){return a}function l(e){if(e)return a.find(t=>t.telegramUsername?.toLowerCase()===e.toLowerCase())}function m(e){return a.find(t=>t.altegioStaffId===e)}function d(e){return s.find(t=>t.id===e)}function c(e=15){let t=Date.now(),r=t+6e4*e;return s.filter(e=>{let a=new Date(e.endAt).getTime();return a>=t&&a<=r})}function u(e,t){if(!t)return null;let r=e.start_datetime||e.datetime||e.date,a=e.end_datetime||e.datetime||e.date;if(!r||!a)return console.warn(`[photo-reports] Appointment ${e.id} missing datetime fields`,e),null;let n=e.client?.name||e.client?.display_name||e.client_name||"–ö–ª—ñ—î–Ω—Ç",i=e.service?.title||e.service?.name||e.service_name||"–ü–æ—Å–ª—É–≥–∞";return{id:`altegio-${e.id}`,clientName:n,serviceName:i,masterId:t.id,masterName:t.name,startAt:new Date(r).toISOString(),endAt:new Date(a).toISOString()}}},3783:(e,t,r)=>{r.d(t,{$e:()=>p,E$:()=>o,HA:()=>f,Ri:()=>c,Yu:()=>l,qg:()=>u,sZ:()=>m,tq:()=>d,wH:()=>g});var a=r(7560);let n="photo-reports",i=e=>`photo-reports-pending:${e}`,s=e=>`${n}:${e}`;async function o(e){await a.kv.set(i(e.chatId),e,{ex:1800})}async function l(e){return a.kv.get(i(e))}async function m(e){await a.kv.del(i(e))}async function d(e){!e.telegramFileId&&e.telegramFileIds?.length>0&&(e.telegramFileId=e.telegramFileIds[0]),await a.kv.set(s(e.appointmentId),e)}async function c(e,t){let r=await l(e);return!!r&&(r.photoFileIds||(r.photoFileIds=[]),r.photoFileIds.includes(t)||(r.photoFileIds.push(t),await o(r)),!0)}async function u(e){return a.kv.get(s(e))}async function f(e=20){let t=`${n}:index`,r=await a.kv.lrange(t,0,-1)||[],i=[];for(let t of r.slice(0,e)){let e=await u(t);e&&i.push(e)}return i}async function p(e){let t=`${n}:index`;await a.kv.lpush(t,e),await a.kv.ltrim(t,0,99)}async function g(){let e=`${n}:index`,t=await a.kv.lrange(e,0,-1),r=0;for(let e of t)try{await a.kv.del(s(e)),r++}catch(t){console.warn(`[photo-reports/store] Failed to delete report ${e}:`,t)}return await a.kv.del(e),r}},9637:(e,t,r)=>{r.d(t,{A8:()=>l,MY:()=>o,bG:()=>i});var a=r(6724);async function n(e,t){(0,a.Jr)();let r=await fetch((0,a.kC)(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await r.json();if(!n.ok)throw Error(`Telegram API error (${e}): ${n.description||"Unknown error"}`);return n.result}function i(e,t,r={}){return n("sendMessage",{chat_id:e,text:t,parse_mode:"HTML",...r})}function s(e,t,r={}){return n("sendPhoto",{chat_id:e,photo:t,...r})}function o(e,t={}){return n("answerCallbackQuery",{callback_query_id:e,...t})}async function l(e,t){if(!a.go.REPORT_GROUP_ID){console.warn("[telegram] TELEGRAM_PHOTO_GROUP_ID not configured. Skipping forward.");return}if(0!==e.length){for(let t=0;t<e.length-1;t++)await s(a.go.REPORT_GROUP_ID,e[t]);await s(a.go.REPORT_GROUP_ID,e[e.length-1],{caption:t})}}},6724:(e,t,r)=>{r.d(t,{Jr:()=>n,go:()=>a,kC:()=>i});let a={BOT_TOKEN:process.env.TELEGRAM_BOT_TOKEN?.trim()||"",REPORT_GROUP_ID:process.env.TELEGRAM_PHOTO_GROUP_ID?Number(process.env.TELEGRAM_PHOTO_GROUP_ID):null,ADMIN_CHAT_IDS:process.env.TELEGRAM_ADMIN_CHAT_IDS?process.env.TELEGRAM_ADMIN_CHAT_IDS.split(",").map(e=>e.trim()).filter(Boolean).map(e=>Number(e)).filter(e=>!Number.isNaN(e)):[]};function n(){if(!a.BOT_TOKEN)throw Error("Missing TELEGRAM_BOT_TOKEN env variable")}function i(e){n();let t=e.startsWith("/")?e.slice(1):e;return`https://api.telegram.org/bot${a.BOT_TOKEN}/${t}`}},7560:(e,t,r)=>{r.d(t,{kv:()=>o});var a=r(242),n=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var i=class extends a.Redis{async *scanIterator(e){let t,r=0;do for(let a of([r,t]=await this.scan(r,e),t))yield a;while(0!==r)}async *hscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.hscan(e,a,t),r))yield n;while(0!==a)}async *sscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.sscan(e,a,t),r))yield n;while(0!==a)}async *zscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.zscan(e,a,t),r))yield n;while(0!==a)}};function s(e){return new i({cache:"default",...e})}new Proxy({},{get(e,t,r){if("then"===t||"parse"===t)return Reflect.get(e,t,r);if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}});var o=new Proxy({},{get(e,t){if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,242],()=>r(7643));module.exports=a})();