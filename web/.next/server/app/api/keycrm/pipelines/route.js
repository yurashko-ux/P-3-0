"use strict";(()=>{var e={};e.id=2316,e.ids=[2316],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7103:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>y,patchFetch:()=>_,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>m,staticGenerationAsyncStorage:()=>A});var s={};i.r(s),i.d(s,{GET:()=>c,POST:()=>d,dynamic:()=>p,runtime:()=>u});var r=i(9303),n=i(8716),a=i(670),l=i(7070),o=i(6755);let u="nodejs",p="force-dynamic";async function c(e){let{searchParams:t}=new URL(e.url),i=t.get("pipeline_id")??t.get("id");if(i){let e=Number(i);if(!Number.isFinite(e)||e<=0)return l.NextResponse.json({ok:!1,error:"invalid_pipeline_id",details:`Некоректний pipeline_id: ${i}`,pipeline:null,fetchedAt:null},{status:400});let t=await (0,o.P)(e);if(!1===t.ok){let e="keycrm_env_missing"===t.error?500:"keycrm_pipeline_not_found"===t.error?404:502;return l.NextResponse.json(t,{status:e})}return l.NextResponse.json(t)}let s=await (0,o.w)();if(!1===s.ok){let e="keycrm_env_missing"===s.error?500:502;return l.NextResponse.json(s,{status:e})}return l.NextResponse.json(s)}async function d(){let e=await (0,o.w)({forceRefresh:!0,persist:!0});if(!1===e.ok){let t="keycrm_env_missing"===e.error?500:"keycrm_fetch_failed"===e.error?502:500;return l.NextResponse.json(e,{status:t})}return l.NextResponse.json({...e,refreshed:!0})}let f=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/keycrm/pipelines/route",pathname:"/api/keycrm/pipelines",filename:"route",bundlePath:"app/api/keycrm/pipelines/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/pipelines/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:A,serverHooks:m}=f,y="/api/keycrm/pipelines/route";function _(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:A})}},6755:(e,t,i)=>{i.d(t,{P:()=>y,w:()=>m});var s=i(1964),r=i(4332);let n=null,a=!1,l=new Map;async function o(){if(!a){a=!0;try{let e=await r.kvRead.keycrmPipelinesSnapshot();if(!e||!Array.isArray(e.pipelines)||0===e.pipelines.length)return;let t=e.fetchedAt??new Date(e.storedAt).toISOString(),i=Date.now()+3e5;for(let s of(n={data:e.pipelines,fetchedAt:t,expiresAt:i},e.pipelines))s?.id&&Array.isArray(s?.statuses)&&s.statuses.length&&c(s,{fetchedAt:t,expiresAt:i,source:"cache"})}catch(e){}}}async function u(e,t){try{await r.kvWrite.keycrmPipelinesSnapshot({pipelines:e,fetchedAt:t,storedAt:Date.now()})}catch(e){}}async function p(e){let t=null;for(let i of[{url:`/pipelines/${e}?with[]=statuses`,kind:"pipeline"},{url:`/pipelines/${e}/statuses`,kind:"statuses"},{url:`/pipeline-statuses?pipeline_id=${e}&per_page=100`,kind:"statuses"},{url:`/statuses?pipeline_id=${e}&per_page=100`,kind:"statuses"}])try{let t=await fetch((0,s.Qv)(i.url),{headers:(0,s.xD)(),cache:"no-store"});if(404===t.status)continue;if(!t.ok){let e=await t.text().catch(()=>""),i=e?`${t.status} ${t.statusText}: ${e}`:`${t.status} ${t.statusText}`;throw Error(`KeyCRM statuses request failed: ${i}`)}let r=await t.json().catch(()=>null);if("pipeline"===i.kind){let e=h(r?.data??r??{});if(e?.statuses.length)return e.statuses;continue}let n=h({id:e,statuses:r??[]});if(n?.statuses.length)return n.statuses}catch(e){t=e}if(t)throw t;return[]}function c(e,t){if(l.set(e.id,{pipeline:e,fetchedAt:t.fetchedAt,expiresAt:t.expiresAt,source:t.source}),!n){n={data:[e],fetchedAt:t.fetchedAt,expiresAt:t.expiresAt};return}let i=n.data.findIndex(t=>t.id===e.id);n={data:(-1===i?[...n.data,e]:n.data.map((t,s)=>s===i?e:t)).sort((e,t)=>{let i=e.position??Number.MAX_SAFE_INTEGER,s=t.position??Number.MAX_SAFE_INTEGER;return i===s?e.id-t.id:i-s}),fetchedAt:t.fetchedAt,expiresAt:t.expiresAt}}function d(e){let t=Number(e);return Number.isFinite(t)?t:null}function f(e){return e?Array.isArray(e)?e:"object"==typeof e?Array.isArray(e.data)?e.data:Array.isArray(e.items)?e.items:Array.isArray(e.list)?e.list:Object.values(e):[]:[]}function h(e){let t=d(e?.id);if(null===t)return null;let i=[...f(e?.statuses),...f(e?.pipeline_statuses),...f(e?.statuses?.data),...f(e?.statuses?.items),...f(e?.statuses?.list),...f(e?.pivot?.statuses)],s=new Set,r=i.map(t=>{let i=d(t?.pivot?.pipeline_status_id)??d(t?.pivot?.status_id)??d(t?.pipeline_status_id),r=d(t?.id),n=d(t?.status_id??t?.status?.id),a=[i,n,r].filter(e=>null!=e);if(!a.length)return null;let l=i??r??n??a[0],o=i??r??n??l,u=d(t?.pipeline_id??t?.pivot?.pipeline_id??e?.id)??null,p=`${l}:${u??""}`;if(s.has(p))return null;s.add(p);let c=Array.from(new Set(a.filter(e=>e!==l)));return{id:l,title:String(t?.title??t?.name??`Статус #${l}`),pipelineId:u,color:t?.color?String(t.color):null,isFinal:"boolean"==typeof t?.is_final?t.is_final:null,position:d(t?.position),statusId:n??(null==i&&null!=r?r:null),pipelineStatusId:o,aliases:c}}).filter(e=>null!==e).sort((e,t)=>(e.position??Number.MAX_SAFE_INTEGER)-(t.position??Number.MAX_SAFE_INTEGER)).filter(e=>null===e.pipelineId||e.pipelineId===t);return{id:t,title:String(e?.title??e?.name??`Воронка #${t}`),color:e?.color?String(e.color):null,isDefault:"boolean"==typeof e?.is_default?e.is_default:null,position:d(e?.position),statuses:r}}function A(e){return e instanceof Error?e.message:String(e)}async function m(e={}){let t=Date.now();if(await o(),!e.forceRefresh&&n&&n.expiresAt>t)return{ok:!0,pipelines:n.data,fetchedAt:n.fetchedAt,source:"cache"};try{(0,s.w6)()}catch(e){if(n)return{ok:!1,error:"keycrm_env_missing",details:A(e),pipelines:n.data,fetchedAt:n.fetchedAt,source:"stale"};return{ok:!1,error:"keycrm_env_missing",details:A(e),pipelines:[],fetchedAt:null,source:"none"}}try{let i=new URLSearchParams;i.append("with[]","statuses"),i.set("per_page","100");let r=await fetch((0,s.Qv)(`/pipelines?${i.toString()}`),{headers:(0,s.xD)(),cache:"no-store"});if(!r.ok){let e=await r.text().catch(()=>""),t=e?`${r.status} ${r.statusText}: ${e}`:`${r.status} ${r.statusText}`;throw Error(`KeyCRM pipelines request failed: ${t}`)}let a=await r.json().catch(()=>null),l=(Array.isArray(a)?a:Array.isArray(a?.data)?a.data:[]).map(h).filter(e=>null!==e).sort((e,t)=>{let i=e.position??Number.MAX_SAFE_INTEGER,s=t.position??Number.MAX_SAFE_INTEGER;return i===s?e.id-t.id:i-s}),o=new Map;for(let e of l)try{let t=await p(e.id);if(!t.length||!t.some(e=>null!==e.pipelineStatusId)&&e.statuses.length&&e.statuses.some(e=>null!==e.pipelineStatusId))continue;o.set(e.id,t)}catch(t){console.warn("Failed to load KeyCRM pipeline statuses",{pipelineId:e.id,error:A(t)})}o.size&&(l=l.map(e=>{let t=o.get(e.id);return t&&t.length?{...e,statuses:t}:e}));let d=new Date().toISOString(),f=t+3e5;for(let e of(n={data:l,fetchedAt:d,expiresAt:f},l))e.statuses.length&&c(e,{fetchedAt:d,expiresAt:f,source:"remote"});return!1!==e.persist&&await u(l,d),{ok:!0,pipelines:l,fetchedAt:d,source:"remote"}}catch(e){if(n)return{ok:!1,error:"keycrm_fetch_failed",details:A(e),pipelines:n.data,fetchedAt:n.fetchedAt,source:"stale"};return{ok:!1,error:"keycrm_fetch_failed",details:A(e),pipelines:[],fetchedAt:null,source:"none"}}}async function y(e,t={}){let i=Date.now();await o();let r=l.get(e);if(!t.forceRefresh&&r&&r.expiresAt>i)return{ok:!0,pipeline:r.pipeline,fetchedAt:r.fetchedAt,source:r.source};if(!t.forceRefresh&&n){let t=n.data.find(t=>t.id===e);if(t&&t.statuses.length){let i={pipeline:t,fetchedAt:n.fetchedAt,expiresAt:n.expiresAt,source:"cache"};return l.set(e,i),{ok:!0,pipeline:i.pipeline,fetchedAt:i.fetchedAt,source:i.source}}}try{(0,s.w6)()}catch(e){if(r)return{ok:!1,error:"keycrm_env_missing",details:A(e),pipeline:r.pipeline,fetchedAt:r.fetchedAt};return{ok:!1,error:"keycrm_env_missing",details:A(e),pipeline:null,fetchedAt:null}}let a=null,u=null;if(r)u=r.pipeline,a=r.fetchedAt;else if(n){let t=n.data.find(t=>t.id===e)??null;t&&(u=t,a=n.fetchedAt)}let d=null,f=[];try{let t=new URLSearchParams;t.append("with[]","statuses");let i=await fetch((0,s.Qv)(`/pipelines/${e}?${t.toString()}`),{headers:(0,s.xD)(),cache:"no-store"});if(404===i.status);else if(i.ok){let e=await i.json().catch(()=>null),t=h(e?.data??e??{});t&&(d=t,f=t.statuses)}else{let e=await i.text().catch(()=>""),t=e?`${i.status} ${i.statusText}: ${e}`:`${i.status} ${i.statusText}`;throw Error(`KeyCRM pipeline request failed: ${t}`)}}catch(t){console.warn("Failed to load KeyCRM pipeline detail",{pipelineId:e,error:A(t)})}if(!d&&u&&(d={...u}),d&&d.statuses.length&&0===f.length&&(f=d.statuses),0===f.length)try{f=await p(e)}catch(t){console.warn("Failed to load KeyCRM pipeline statuses via fallbacks",{pipelineId:e,error:A(t)})}if(!d&&f.length&&(d=u??{id:e,title:`Воронка #${e}`,color:null,isDefault:null,position:null,statuses:[]}),d){let e={...d,statuses:f},t=new Date().toISOString();return c(e,{fetchedAt:t,expiresAt:i+3e5,source:"remote"}),{ok:!0,pipeline:e,fetchedAt:t,source:"remote"}}return{ok:!1,error:"keycrm_pipeline_not_found",pipeline:u,fetchedAt:a}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[8948,5972,4332],()=>i(7103));module.exports=s})();