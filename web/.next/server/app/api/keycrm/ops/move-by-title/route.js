"use strict";(()=>{var e={};e.id=4727,e.ids=[4727],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6243:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>P,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>h,dynamic:()=>u});var s=r(9303),i=r(8716),o=r(670),n=r(7070);let u="force-dynamic",p=process.env.KEYCRM_API_URL?.replace(/\/+$/,"")||"https://openapi.keycrm.app/v1",c=process.env.KEYCRM_BEARER||process.env.KEYCRM_API_TOKEN;async function d(e,t){let r=new URL(`${p}${e}`);if(t?.query)for(let[e,a]of Object.entries(t.query))null!=a&&""!==a&&r.searchParams.set(e,String(a));let a=await fetch(r.toString(),{...t,headers:{Authorization:`Bearer ${function(){if(!c)throw Error("KEYCRM token missing (KEYCRM_BEARER або KEYCRM_API_TOKEN)");return c}()}`,"Content-Type":"application/json",...t?.headers||{}},cache:"no-store"}),s=await a.text();if(!a.ok)throw Error(`KeyCRM ${a.status} ${a.statusText} at ${r} :: ${s.slice(0,400)}`);try{return JSON.parse(s)}catch{return s}}async function l(e){return d("/pipelines/cards",{query:e})}async function m(e){return d(`/pipelines/cards/${e}`)}async function _(e,t){return d(`/pipelines/cards/${e}`,{method:"PUT",body:JSON.stringify(t)})}async function h(e){try{let t=new URL(e.url),r=(t.searchParams.get("full_name")||"").trim();if(!r)return n.NextResponse.json({ok:!1,error:"full_name is required"},{status:400});let a=t.searchParams.get("search_pipeline_id")?Number(t.searchParams.get("search_pipeline_id")):void 0,s=t.searchParams.get("search_status_id")?Number(t.searchParams.get("search_status_id")):void 0,i=t.searchParams.get("to_pipeline_id")?Number(t.searchParams.get("to_pipeline_id")):void 0,o=t.searchParams.get("to_status_id")?Number(t.searchParams.get("to_status_id")):void 0;if(!i||!o)return n.NextResponse.json({ok:!1,error:"to_pipeline_id and to_status_id are required"},{status:400});let u=Number(t.searchParams.get("per_page")||50),p=Number(t.searchParams.get("max_pages")||60),c=function(e){let t=e.trim().toLowerCase();return[`чат з ${t}`,`chat with ${t}`,t]}(r),d=1,h=0,y=1,f=0,g=null;for(;d<=p;){let e=await l({page:d,per_page:u,pipeline_id:a,status_id:s}).catch(()=>null);if(!e)break;for(let t of(y=Number(e.last_page??y),Array.isArray(e.data)?e.data:[])){f++;let e=String(t?.title??"").toLowerCase();if(c.some(t=>e.includes(t))){g=Number(t.id),t.id,t.pipeline_id,t.status_id,t.title;break}}if(h++,g||++d>y)break}if(!g)return n.NextResponse.json({ok:!1,error:"card not found by title",used:{full_name:r,variants:c,search_pipeline_id:a,search_status_id:s,per_page:u,max_pages:p},stats:{scanned:f,pages_used:h,last_page:y}},{status:404});let v=await m(g).catch(()=>null),P=await _(g,{pipeline_id:i,status_id:o}).catch(e=>({error:String(e?.message||e)}));return n.NextResponse.json({ok:!("error"in(P||{})),card_id:g,move:{to_pipeline_id:i,to_status_id:o},before:v,after:P,used:{full_name:r,variants:c,search_pipeline_id:a,search_status_id:s,per_page:u,max_pages:p}})}catch(e){return n.NextResponse.json({ok:!1,error:String(e?.message||e)},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/ops/move-by-title/route",pathname:"/api/keycrm/ops/move-by-title",filename:"route",bundlePath:"app/api/keycrm/ops/move-by-title/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/ops/move-by-title/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:v}=y,P="/api/keycrm/ops/move-by-title/route";function b(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>r(6243));module.exports=a})();