"use strict";(()=>{var e={};e.id=4284,e.ids=[4284],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8789:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>N,patchFetch:()=>M,requestAsyncStorage:()=>b,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>x});var r={};a.r(r),a.d(r,{GET:()=>g,dynamic:()=>u});var s=a(9303),i=a(8716),n=a(670),o=a(7070);let u="force-dynamic",p=e=>new Promise(t=>setTimeout(t,e)),l=e=>String(e??"").trim().toLowerCase(),c=e=>e?e.trim().replace(/^@+/,"").toLowerCase():"";async function m(e){let t=new URL(e.url).searchParams.get("pass")||"",a=e.headers.get("authorization")||"",r=a.startsWith("Bearer ")?a.slice(7):"",s=process.env.ADMIN_PASS||"";return!s||r===s||t===s}async function d(e,{throttleMs:t,max429Retries:a,initialBackoffMs:r}){let s=`${process.env.KEYCRM_API_URL||process.env.KEYCRM_BASE_URL||"https://openapi.keycrm.app/v1"}${e}`,i=0,n=r;for(;;){t>0&&await p(t);let e=await fetch(s,{headers:{Authorization:`Bearer ${process.env.KEYCRM_API_TOKEN||process.env.KEYCRM_BEARER||process.env.KEYCRM_TOKEN||""}`,"Content-Type":"application/json"},cache:"no-store"});if(e.ok){let t=await e.text();try{return JSON.parse(t)}catch{throw Error(`KeyCRM returned non-JSON at ${s} :: ${t.slice(0,400)}`)}}if(429===e.status&&i<a){i++;let t=Math.max(n,1e3*(Number(e.headers.get("retry-after")||"")||0));await p(t),n=Math.min(2*n,15e3);continue}let r=await e.text().catch(()=>"");throw Error(`KeyCRM ${e.status} ${e.statusText} at ${s} :: ${r.slice(0,400)}`)}}async function h(e,t,a,r,s,i,n){let o=new URLSearchParams({page:String(e),per_page:String(t),pipeline_id:String(a),status_id:String(r)}),u=await d(`/pipelines/cards?${o.toString()}`,{throttleMs:s,max429Retries:i,initialBackoffMs:n});if(Array.isArray(u))return{ids:u.map(e=>e?.id).filter(Boolean),hasNext:u.length===t};let p=(Array.isArray(u?.data)?u.data:[]).map(e=>e?.id).filter(Boolean),l=Number(u?.current_page??e),c=Number(u?.last_page??l);return{ids:p,hasNext:!!u?.next_page_url||l<c}}async function _(e,t,a,r){return await d(`/pipelines/cards/${e}`,{throttleMs:t,max429Retries:a,initialBackoffMs:r})}async function g(e){try{if(!await m(e))return o.NextResponse.json({ok:!1,error:"Unauthorized"},{status:401});let t=new URL(e.url),a=t.searchParams.get("social_id")||t.searchParams.get("username")||t.searchParams.get("handle")||"",r=c(a),s=Number(t.searchParams.get("pipeline_id")||"1"),i=Number(t.searchParams.get("status_id")||"38"),n=Math.min(Math.max(Number(t.searchParams.get("per_page")||"50"),1),100),u=Math.min(Math.max(Number(t.searchParams.get("max_pages")||"20"),1),200),p=Math.min(Math.max(Number(t.searchParams.get("max_card_fetches")||"1000"),1),5e3),d=Math.min(Math.max(Number(t.searchParams.get("delay_ms")||"250"),0),2e3),g=Math.min(Math.max(Number(t.searchParams.get("retry_429")||"6"),0),10),f=Math.min(Math.max(Number(t.searchParams.get("backoff_ms")||"600"),100),5e3);if(!r)return o.NextResponse.json({ok:!1,error:"social_id is required"},{status:400});if(!Number.isFinite(s)||!Number.isFinite(i))return o.NextResponse.json({ok:!1,error:"pipeline_id and status_id must be numbers"},{status:400});let b=1,x=0,y=0,N=null,M=[];for(;b<=u&&y<p&&!N;){let{ids:e,hasNext:t}=await h(b,n,s,i,d,g,f);for(let t of(x+=e.length,e)){if(y>=p)break;let e=await _(t,d,g,f);y++;let a=e?.contact?.social_id??e?.contact?.client?.social_id??null;a&&M.length<12&&!M.includes(String(a))&&M.push(String(a));let s=l(a);if(s===r||s==="@"+r){let t=e?.status?.pipeline_id??e?.pipeline_id??null,r=e?.status_id??e?.status?.id??null;N={id:Number(e?.id),title:e?.title??"",full_name:e?.contact?.full_name??e?.contact?.client?.full_name??null,social_id:a,pipeline_id:t?Number(t):null,status_id:r?Number(r):null,page:b};break}}if(!t||y>=p||N)break;b++}return o.NextResponse.json({ok:!0,found_card_id:N?.id??null,found:N,stats:{pipeline_id:s,status_id:i,pages_scanned:b,per_page:n,list_items_seen:x,card_details_scanned:y,max_card_fetches:p},rate_limits:{delay_ms:d,retry_429:g,backoff_ms:f},sample_seen_social_ids:M,used:{social_id:"@"+r}})}catch(e){return o.NextResponse.json({ok:!1,error:e?.message||String(e)},{status:400})}}let f=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/probe-pair-deep/route",pathname:"/api/keycrm/probe-pair-deep",filename:"route",bundlePath:"app/api/keycrm/probe-pair-deep/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/probe-pair-deep/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:b,staticGenerationAsyncStorage:x,serverHooks:y}=f,N="/api/keycrm/probe-pair-deep/route";function M(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(8789));module.exports=r})();