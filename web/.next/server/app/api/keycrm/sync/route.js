"use strict";(()=>{var e={};e.id=345,e.ids=[345,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},919:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>K,requestAsyncStorage:()=>d,routeModule:()=>f,serverHooks:()=>I,staticGenerationAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{GET:()=>R,POST:()=>A,dynamic:()=>u,runtime:()=>p});var i=r(9303),s=r(8716),a=r(670),o=r(7070),c=r(6471),_=r(7560);let p="nodejs",u="force-dynamic",E=e=>`kcrm:st:${e}`;async function l(e,t){await _.kv.set(e,{map:t,updatedAt:Date.now()})}async function R(e){let t=e.nextUrl.searchParams.get("secret")||e.headers.get("x-admin-pass")||"";if(!process.env.ADMIN_PASS||t!==process.env.ADMIN_PASS)return o.NextResponse.json({error:"unauthorized"},{status:401});let r=await (0,c.pr)(),n=Object.fromEntries(r.map(e=>[String(e.id),String(e.name)]));await l("kcrm:pipelines",n);let i=0;for(let e of r){let t=await (0,c.e6)(String(e.id)),r=Object.fromEntries(t.map(e=>[String(e.id),String(e.name)]));await l(E(String(e.id)),r),i+=t.length}return o.NextResponse.json({ok:!0,pipelines:r.length,statuses:i})}async function A(e){return R(e)}let f=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/keycrm/sync/route",pathname:"/api/keycrm/sync",filename:"route",bundlePath:"app/api/keycrm/sync/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/sync/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:I}=f,v="/api/keycrm/sync/route";function K(){return(0,a.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:m})}},1964:(e,t,r)=>{r.d(t,{Ls:()=>l,Nd:()=>R,Qv:()=>p,Rv:()=>u,SJ:()=>d,_P:()=>m,hC:()=>E,w6:()=>o,xD:()=>_});let n="https://openapi.keycrm.app/v1",i="M2EwMjAwMGE1ZWY4ODhkMzlkYzRiNTU2MDY4ZjZmZDc3ZGJkZjQ3MA",s={KEYCRM_API_URL:n,KEYCRM_API_BASE:n,KEYCRM_BASE_URL:n,KEYCRM_API_TOKEN:i,KEYCRM_TOKEN:i,KEYCRM_BEARER:i,KEYCRM_API_BEARER:i},a={KEYCRM_API_URL:process.env.KEYCRM_API_URL?.trim()||n,KEYCRM_API_TOKEN:process.env.KEYCRM_API_TOKEN?.trim()||process.env.KEYCRM_BEARER?.trim()||i,KEYCRM_BEARER:process.env.KEYCRM_BEARER?.trim()||process.env.KEYCRM_API_TOKEN?.trim()||i,ALTEGIO_API_URL:process.env.ALTEGIO_API_URL?.trim()||"",ALTEGIO_APPLICATION_ID:process.env.ALTEGIO_APPLICATION_ID?.trim()||"",ALTEGIO_PARTNER_ID:process.env.ALTEGIO_PARTNER_ID?.trim()||"",ALTEGIO_PARTNER_TOKEN:process.env.ALTEGIO_PARTNER_TOKEN?.trim()||"",ALTEGIO_USER_TOKEN:process.env.ALTEGIO_USER_TOKEN?.trim()||"",ALTEGIO_COMPANY_ID:process.env.ALTEGIO_COMPANY_ID?.trim()||""};function o(){if(!a.KEYCRM_API_URL)throw Error("Missing env KEYCRM_API_URL");if(!a.KEYCRM_API_TOKEN)throw Error("Missing env KEYCRM_API_TOKEN")}function c(e){return e.toLowerCase().startsWith("bearer ")?e:`Bearer ${e}`}function _(){return{Accept:"application/json","Content-Type":"application/json",Authorization:c(a.KEYCRM_BEARER)}}function p(e){let t=a.KEYCRM_API_URL.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}function u(){return a.KEYCRM_API_URL}function E(){return c(a.KEYCRM_BEARER)}function l(){return a.KEYCRM_API_TOKEN}let R={API_URL:n,API_TOKEN:i},A=new Map;for(let[e,t]of Object.entries(process.env))A.set(e.toLowerCase(),t);function f(e){if("string"!=typeof e)return;let t=e.trim();return t.length>0?t:void 0}function d(...e){for(let t of e){let e=f(process.env[t]);if(void 0!==e)return e}for(let t of e){let e=f(A.get(t.toLowerCase()));if(void 0!==e)return e}for(let t of e){let e=s[t.toUpperCase()];if(e)return e}}function m(...e){return void 0!==d(...e)}},6471:(e,t,r)=>{r.d(t,{Vq:()=>E,d4:()=>l,e6:()=>_,pr:()=>c});var n=r(1964);let i=(0,n.Rv)().replace(/\/+$/,""),s=function(){let e=(0,n.hC)();if(e)return e;let t=(0,n.Ls)();return t.toLowerCase().startsWith("bearer ")?t:`Bearer ${t}`}();function a(e){return Array.isArray(e)?e:e?.data&&Array.isArray(e.data)?e.data:e?.items&&Array.isArray(e.items)?e.items:[]}async function o(e){try{let t=await fetch(e,{headers:function(){let e={Accept:"application/json"};return s&&(e.Authorization=s),e}(),cache:"no-store"});if(!t.ok)return console.warn("[KeyCRM] non-OK",t.status,e),null;return await t.json()}catch(t){return console.warn("[KeyCRM] fetch error",e,t),null}}async function c(){return a(await o(`${i}/pipelines?per_page=200`)).map(e=>({id:String(e.id),name:String(e.name??e.title??e.label??e.slug??e.id)}))}async function _(e){let t=encodeURIComponent(e);return a(await o(`${i}/pipelines/${t}/statuses?per_page=200`)).map(e=>({id:String(e.id),name:String(e.name??e.title??e.label??e.slug??e.id)}))}let p=new Map,u=new Map;async function E(e){if(!e)return"";if(p.has(e))return p.get(e);for(let e of(await c()))p.set(e.id,e.name);return p.get(e)??e}async function l(e,t){if(!e||!t)return"";let r=u.get(e)??new Map;if(u.set(e,r),r.has(t))return r.get(t);for(let t of(await _(e)))r.set(t.id,t.name);return r.get(t)??t}s&&s.toLowerCase().startsWith("bearer ")},7560:(e,t,r)=>{r.d(t,{kv:()=>o});var n=r(242),i=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var s=class extends n.Redis{async *scanIterator(e){let t,r=0;do for(let n of([r,t]=await this.scan(r,e),t))yield n;while(0!==r)}async *hscanIterator(e,t){let r,n=0;do for(let i of([n,r]=await this.hscan(e,n,t),r))yield i;while(0!==n)}async *sscanIterator(e,t){let r,n=0;do for(let i of([n,r]=await this.sscan(e,n,t),r))yield i;while(0!==n)}async *zscanIterator(e,t){let r,n=0;do for(let i of([n,r]=await this.zscan(e,n,t),r))yield i;while(0!==n)}};function a(e){return new s({cache:"default",...e})}new Proxy({},{get(e,t,r){if("then"===t||"parse"===t)return Reflect.get(e,t,r);if(!i){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),i=a({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(i,t)}});var o=new Proxy({},{get(e,t){if(!i){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");i=a({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(i,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,242],()=>r(919));module.exports=n})();