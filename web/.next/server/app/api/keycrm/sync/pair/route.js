"use strict";(()=>{var e={};e.id=2760,e.ids=[2760],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3395:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>k,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>v,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>y,dynamic:()=>p,runtime:()=>c});var n=a(9303),i=a(8716),o=a(670),s=a(7070),u=a(4332);let c="nodejs",p="force-dynamic";function m(e){return("string"==typeof e?e:"").trim()}function l(e,t){if(!t||!t.value)return!1;let a=t.value.toLowerCase(),r=(e||"").toLowerCase();return"equals"===t.op?r===a:r.includes(a)}async function d(e,t){let a=u.campaignKeys.ITEM_KEY(e),r=await u.kvRead.getRaw(a);if(r)try{let n=JSON.parse(r);n[t]=("number"==typeof n[t]?n[t]:0)+1,await u.kvWrite.setRaw(a,JSON.stringify(n));try{await u.kvWrite.lpush(u.campaignKeys.INDEX_KEY,e)}catch{}}catch{}}async function y(e){try{let t=await e.json().catch(()=>({})),a=function(e){let t=m(e?.title),a=m(e?.handle),r=m(e?.text);if(t||a||r)return{title:t,handle:a,text:r};let n=m(e?.data?.message?.text)||m(e?.message?.text);return{title:"",handle:m(e?.data?.user?.username)||m(e?.user?.username),text:n}}(t),r=[];try{r=await u.kvRead.listCampaigns()}catch{r=[]}let n=r.filter(e=>e?.active!==!1),i={route:"none"};for(let e of n){let t=function(e,t){let a=l(e,t?.v1),r=l(e,t?.v2);return a&&!r?"v1":r&&!a?"v2":a&&r?"v1":"none"}(a.text,e.rules);if("none"!==t){i={route:t,campaign:e};break}}return i.campaign&&"none"!==i.route&&await d(i.campaign.id,"v1"===i.route?"v1_count":"v2_count"),s.NextResponse.json({ok:!0,matched:"none"!==i.route,route:i.route,campaign:i.campaign?{id:i.campaign.id,name:i.campaign.name}:void 0,input:a})}catch(e){return s.NextResponse.json({ok:!1,error:e?.message||"pair failed"},{status:500})}}let v=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/sync/pair/route",pathname:"/api/keycrm/sync/pair",filename:"route",bundlePath:"app/api/keycrm/sync/pair/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/sync/pair/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:h}=v,k="/api/keycrm/sync/pair/route";function x(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,4332],()=>a(3395));module.exports=r})();