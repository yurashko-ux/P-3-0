"use strict";(()=>{var e={};e.id=9753,e.ids=[9753],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5580:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>p});var s=r(9303),i=r(8716),n=r(670),o=r(7070);let p="force-dynamic";async function u(e){let t=new URL(e.url).searchParams.get("pass")||"",r=e.headers.get("authorization")||"",a=r.startsWith("Bearer ")?r.slice(7):"",s=process.env.ADMIN_PASS||"";if(s&&a!==s&&t!==s)throw Error("Unauthorized")}function l(e){return e.toLowerCase().normalize("NFKC").replace(/\s+/g," ").trim()}async function c(e){let t;let r=new URL(`${process.env.KEYCRM_API_URL||process.env.KEYCRM_BASE_URL||"https://openapi.keycrm.app/v1"}/pipelines/cards`);r.searchParams.set("page",String(e.page)),r.searchParams.set("per_page",String(e.per_page)),e.pipeline_id&&r.searchParams.set("pipeline_id",String(e.pipeline_id)),e.status_id&&r.searchParams.set("status_id",String(e.status_id));let a=await fetch(r.toString(),{headers:{Authorization:`Bearer ${process.env.KEYCRM_API_TOKEN||process.env.KEYCRM_BEARER||process.env.KEYCRM_TOKEN||""}`,"Content-Type":"application/json"},cache:"no-store"}),s=await a.text();if(!a.ok)throw Error(`KeyCRM ${a.status} ${a.statusText} at ${r} :: ${s.slice(0,400)}`);try{t=JSON.parse(s)}catch{t={}}return t}async function d(e){try{await u(e);let t=new URL(e.url),r=(t.searchParams.get("full_name")||"").trim();if(!r)return o.NextResponse.json({ok:!1,error:"full_name is required"},{status:400});let a=t.searchParams.get("pipeline_id"),s=t.searchParams.get("status_id"),i=Number(t.searchParams.get("per_page")||50),n=Math.min(Number(t.searchParams.get("max_pages")||60),200),p=a?Number(a):void 0,d=s?Number(s):void 0,m=function(e){let t=l(e);return[`чат з ${t}`,`чат з ${t}`,`chat with ${t}`,t]}(r),h=new Set(m),_=1,g=null,y=1,f=0;for(;_<=n;){let e=await c({page:_,per_page:i,pipeline_id:p,status_id:d});for(let t of(y=e.last_page||y,e.data||[])){let e=l(String(t.title||""));if(f++,[...h].some(t=>e===t||e.includes(t))){g={id:Number(t.id),pipeline_id:Number(t.pipeline_id??t?.status?.pipeline_id??0)||null,status_id:Number(t.status_id??t?.status?.id??0)||null,title:String(t.title||"")};break}}if(g||++_>(e.last_page||1))break;await new Promise(e=>setTimeout(e,120))}return o.NextResponse.json({ok:!0,found_card_id:g?.id??null,found:g,used:{full_name:r,variants:[...h],pipeline_id:p??null,status_id:d??null,per_page:i,max_pages:n},stats:{scanned:f,pages_used:_,last_page:y}})}catch(e){return o.NextResponse.json({ok:!1,error:e?.message||String(e)},{status:400})}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/search/by-title/route",pathname:"/api/keycrm/search/by-title",filename:"route",bundlePath:"app/api/keycrm/search/by-title/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/search/by-title/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:_,serverHooks:g}=m,y="/api/keycrm/search/by-title/route";function f(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>r(5580));module.exports=a})();