"use strict";(()=>{var e={};e.id=7786,e.ids=[7786],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4277:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>M,patchFetch:()=>N,requestAsyncStorage:()=>b,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>x});var r={};a.r(r),a.d(r,{GET:()=>g,dynamic:()=>l});var s=a(9303),i=a(8716),n=a(670),o=a(7070);let l="force-dynamic",u=e=>new Promise(t=>setTimeout(t,e)),c=e=>String(e??"").trim().toLowerCase(),p=e=>e?e.trim().replace(/^@+/,"").toLowerCase():"";async function m(e){let t=new URL(e.url).searchParams.get("pass")||"",a=e.headers.get("authorization")||"",r=a.startsWith("Bearer ")?a.slice(7):"",s=process.env.ADMIN_PASS||"";return!s||r===s||t===s}async function d(e,t){let a=`${process.env.KEYCRM_API_URL||process.env.KEYCRM_BASE_URL||"https://openapi.keycrm.app/v1"}${e}`,r=0,s=t.initialBackoffMs;for(;;){t.throttleMs>0&&await u(t.throttleMs);let e=await fetch(a,{headers:{Authorization:`Bearer ${process.env.KEYCRM_API_TOKEN||process.env.KEYCRM_BEARER||process.env.KEYCRM_TOKEN||""}`,"Content-Type":"application/json"},cache:"no-store"});if(e.ok){let t=await e.text();try{return JSON.parse(t)}catch{throw Error(`KeyCRM returned non-JSON at ${a} :: ${t.slice(0,400)}`)}}if(429===e.status&&r<t.max429Retries){r++;let t=Math.max(s,1e3*(Number(e.headers.get("retry-after")||"")||0));await u(t),s=Math.min(2*s,15e3);continue}let i=await e.text().catch(()=>"");throw Error(`KeyCRM ${e.status} ${e.statusText} at ${a} :: ${i.slice(0,400)}`)}}async function h(e,t,a,r,s){let i=new URLSearchParams({page:String(e),per_page:String(t)}),n=await d(`/pipelines/cards?${i.toString()}`,{throttleMs:a,max429Retries:r,initialBackoffMs:s});if(Array.isArray(n))return{ids:n.map(e=>e?.id).filter(Boolean),hasNext:n.length===t};let o=(Array.isArray(n?.data)?n.data:[]).map(e=>e?.id).filter(Boolean),l=Number(n?.current_page??e),u=Number(n?.last_page??l);return{ids:o,hasNext:!!n?.next_page_url||l<u}}async function _(e,t,a,r){return await d(`/pipelines/cards/${e}`,{throttleMs:t,max429Retries:a,initialBackoffMs:r})}async function g(e){try{if(!await m(e))return o.NextResponse.json({ok:!1,error:"Unauthorized"},{status:401});let t=new URL(e.url),a=t.searchParams.get("social_id")||t.searchParams.get("username")||t.searchParams.get("handle")||"",r=p(a),s=Math.min(Math.max(Number(t.searchParams.get("per_page")||"50"),1),100)||50,i=Math.min(Math.max(Number(t.searchParams.get("max_pages")||"20"),1),200)||20,n=Math.min(Math.max(Number(t.searchParams.get("max_card_fetches")||"800"),1),3e3)||800,l=Math.min(Math.max(Number(t.searchParams.get("delay_ms")||"300"),0),2e3)||300,u=Math.min(Math.max(Number(t.searchParams.get("retry_429")||"6"),0),10)||6,d=Math.min(Math.max(Number(t.searchParams.get("backoff_ms")||"700"),100),5e3)||700;if(!r)return o.NextResponse.json({ok:!1,error:"social_id is required"},{status:400});let g=1,f=0,b=0,x=null,y=[],M=[];for(;g<=i&&b<n&&!x;){let{ids:e,hasNext:t}=await h(g,s,l,u,d);for(let t of(f+=e.length,e)){if(b>=n)break;let e=await _(t,l,u,d);b++;let a=e?.status?.pipeline_id??e?.pipeline_id??null,s=e?.status_id??e?.status?.id??null;y.length<12&&y.push({pipeline_id:a?Number(a):null,status_id:s?Number(s):null});let i=e?.contact?.social_id??e?.contact?.client?.social_id??null,o=c(i);if(i&&M.length<12&&!M.includes(String(i))&&M.push(String(i)),o===r||o==="@"+r){x={id:Number(e?.id),title:e?.title??"",full_name:e?.contact?.full_name??e?.contact?.client?.full_name??null,social_id:i,pipeline_id:a?Number(a):null,status_id:s?Number(s):null,page:g};break}}if(!t||b>=n||x)break;g++}return o.NextResponse.json({ok:!0,found_card_id:x?.id??null,found:x,stats:{pages_scanned:g,per_page:s,list_items_seen:f,card_details_scanned:b,max_card_fetches:n,max_pages:i},rate_limits:{throttle_ms:l,retry_429:u,backoff_ms:d},sample_seen_pairs:y,sample_seen_social_ids:M,used:{social_id:"@"+r}})}catch(e){return o.NextResponse.json({ok:!1,error:e?.message||String(e)},{status:400})}}let f=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/probe-global-deep/route",pathname:"/api/keycrm/probe-global-deep",filename:"route",bundlePath:"app/api/keycrm/probe-global-deep/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/probe-global-deep/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:b,staticGenerationAsyncStorage:x,serverHooks:y}=f,M="/api/keycrm/probe-global-deep/route";function N(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(4277));module.exports=r})();