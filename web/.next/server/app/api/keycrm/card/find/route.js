"use strict";(()=>{var e={};e.id=439,e.ids=[439],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3931:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>A,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{GET:()=>d,dynamic:()=>c,runtime:()=>u});var i=r(9303),l=r(8716),a=r(670),s=r(7070),o=r(296);let u="nodejs",c="force-dynamic";function p(e){if(!e)return null;let t=Number(e);return Number.isFinite(t)?t:null}async function d(e){let t;let r=new URL(e.url),n=r.searchParams.get("needle")||r.searchParams.get("q")||r.searchParams.get("query")||r.searchParams.get("value")||"",i=p(r.searchParams.get("pipeline_id")),l=p(r.searchParams.get("status_id")),a=p(r.searchParams.get("per_page")),u=p(r.searchParams.get("max_pages"));try{t=await (0,o.l)({needle:n,pipelineId:i??void 0,statusId:l??void 0,perPage:a??void 0,maxPages:u??void 0})}catch(t){let e=t instanceof Error?t.message:t;return s.NextResponse.json({ok:!1,error:"keycrm_search_unhandled",details:e},{status:500})}if(!1===t.ok){let e="needle_required"===t.error?400:"keycrm_env_missing"===t.error?500:"keycrm_rate_limited"===t.error?429:502;return s.NextResponse.json(t,{status:e})}return s.NextResponse.json(t)}let f=new i.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/keycrm/card/find/route",pathname:"/api/keycrm/card/find",filename:"route",bundlePath:"app/api/keycrm/card/find/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/card/find/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:h}=f,E="/api/keycrm/card/find/route";function A(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},1964:(e,t,r)=>{r.d(t,{Ls:()=>f,Nd:()=>_,Qv:()=>c,Rv:()=>p,SJ:()=>E,_P:()=>A,hC:()=>d,w6:()=>s,xD:()=>u});let n="https://openapi.keycrm.app/v1",i="M2EwMjAwMGE1ZWY4ODhkMzlkYzRiNTU2MDY4ZjZmZDc3ZGJkZjQ3MA",l={KEYCRM_API_URL:n,KEYCRM_API_BASE:n,KEYCRM_BASE_URL:n,KEYCRM_API_TOKEN:i,KEYCRM_TOKEN:i,KEYCRM_BEARER:i,KEYCRM_API_BEARER:i},a={KEYCRM_API_URL:process.env.KEYCRM_API_URL?.trim()||n,KEYCRM_API_TOKEN:process.env.KEYCRM_API_TOKEN?.trim()||process.env.KEYCRM_BEARER?.trim()||i,KEYCRM_BEARER:process.env.KEYCRM_BEARER?.trim()||process.env.KEYCRM_API_TOKEN?.trim()||i,ALTEGIO_API_URL:process.env.ALTEGIO_API_URL?.trim()||"",ALTEGIO_APPLICATION_ID:process.env.ALTEGIO_APPLICATION_ID?.trim()||"",ALTEGIO_PARTNER_ID:process.env.ALTEGIO_PARTNER_ID?.trim()||"",ALTEGIO_PARTNER_TOKEN:process.env.ALTEGIO_PARTNER_TOKEN?.trim()||"",ALTEGIO_USER_TOKEN:process.env.ALTEGIO_USER_TOKEN?.trim()||"",ALTEGIO_COMPANY_ID:process.env.ALTEGIO_COMPANY_ID?.trim()||""};function s(){if(!a.KEYCRM_API_URL)throw Error("Missing env KEYCRM_API_URL");if(!a.KEYCRM_API_TOKEN)throw Error("Missing env KEYCRM_API_TOKEN")}function o(e){return e.toLowerCase().startsWith("bearer ")?e:`Bearer ${e}`}function u(){return{Accept:"application/json","Content-Type":"application/json",Authorization:o(a.KEYCRM_BEARER)}}function c(e){let t=a.KEYCRM_API_URL.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}function p(){return a.KEYCRM_API_URL}function d(){return o(a.KEYCRM_BEARER)}function f(){return a.KEYCRM_API_TOKEN}let _={API_URL:n,API_TOKEN:i},m=new Map;for(let[e,t]of Object.entries(process.env))m.set(e.toLowerCase(),t);function h(e){if("string"!=typeof e)return;let t=e.trim();return t.length>0?t:void 0}function E(...e){for(let t of e){let e=h(process.env[t]);if(void 0!==e)return e}for(let t of e){let e=h(m.get(t.toLowerCase()));if(void 0!==e)return e}for(let t of e){let e=l[t.toUpperCase()];if(e)return e}}function A(...e){return void 0!==E(...e)}},296:(e,t,r)=>{r.d(t,{l:()=>f});var n=r(1964);let i=(e,t,r)=>Math.max(t,Math.min(r,e)),l=e=>(e??"").trim().toLowerCase(),a=e=>{let t=l(e);if(!t||!(t=t.replace(/^@+/,"")))return"";let r=(t=(t=t.replace(/^https?:\/\//,"")).replace(/^www\./,"")).indexOf("#");-1!==r&&(t=t.slice(0,r));let n=t.indexOf("?");if(-1!==n&&(t=t.slice(0,n)),!(t=t.replace(/\/+$/,"")))return"";let i=t.split("/").filter(Boolean);return i.length>=2?i[i.length-1]:i[0]??t},s=e=>{if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){let t=e.trim();if(!t)return null;let r=Number(t);return Number.isFinite(r)?r:null}return null};class o extends Error{constructor(e,t,r,n){let i=`KeyCRM ${e} ${t}`.trim();super(r?`${i}: ${r}`:i),this.name="KeycrmHttpError",this.status=e,this.responseBody=r,this.retryAfter=n}}function u(e){let t=[],r=e?.contact??null,n=[];for(let[i,l]of(e?.client&&n.push(e.client),r?.client&&n.push(r.client),r&&(null!=r.full_name&&t.push({path:"contact.full_name",value:String(r.full_name)}),null!=r.social_id&&t.push({path:"contact.social_id",value:String(r.social_id)})),n.entries()))if(l){if(null!=l.full_name){let e=n.length>1?`#${i}`:"";t.push({path:`client${e}.full_name`,value:String(l.full_name)})}if(null!=l.social_id){let e=n.length>1?`#${i}`:"";t.push({path:`client${e}.social_id`,value:String(l.social_id)})}if(Array.isArray(l.profiles)){let e=n.length>1?`#${i}`:"";for(let r of l.profiles)if(r?.value!=null){let n=r?.id!=null?r.id:"?";t.push({path:`client${e}.profiles[${n}].value`,value:String(r.value)})}}}return t}function c(e,t){let r=l(e),n=a(e);if(!r&&!n)return null;for(let e of t){if(!e.path.includes("social_id"))continue;let t=e.value??"",r=a(t);if(n&&r&&r===n)return{field:e.path,value:t}}if(n)return null;for(let e of t){let t=e.value??"",n=l(t);if(r&&n&&n===r)return{field:e.path,value:t}}return null}async function p(e,t,r,i){let l=()=>{let r=new URLSearchParams;for(let n of(r.set("page[number]",String(e)),r.set("page[size]",String(t)),null!=i&&r.set("filter[status_id]",String(i)),["contact","contact.client","status"]))r.append("include[]",n),r.append("with[]",n);return r},a=[];null!=r&&a.push({path:`/pipelines/${encodeURIComponent(String(r))}/cards`}),a.push({path:"/pipelines/cards",configure:e=>{null!=r&&e.set("filter[pipeline_id]",String(r))}});let s=null;for(let i of a){let a=l();i.configure&&i.configure(a);let u=await fetch((0,n.Qv)(`${i.path}?${a.toString()}`),{headers:(0,n.xD)(),cache:"no-store"});if(!u.ok){let e=await u.text().catch(()=>""),t=new o(u.status,u.statusText,e,u.headers.get("retry-after"));if(null!=r&&"/pipelines/cards"!==i.path&&404===u.status){s=t;continue}throw t}let c=await u.json(),p=Array.isArray(c)?c:Array.isArray(c?.data)?c.data:[],d=(()=>{if(c?.links?.next||c?.next_page_url)return!0;let r=Number(c?.meta?.current_page??c?.current_page??e),n=Number(c?.meta?.last_page??c?.last_page??r);return Number.isFinite(r)&&Number.isFinite(n)?r<n:p.length===t})();return{data:p,hasNext:d}}throw s??new o(404,"Not Found","",null)}async function d(e){let t=await fetch((0,n.Qv)(`/pipelines/cards/${e}`),{headers:(0,n.xD)(),cache:"no-store"});if(!t.ok){let e=await t.text().catch(()=>"");throw new o(t.status,t.statusText,e,t.headers.get("retry-after"))}return await t.json()}async function f(e){let t=(e.needle??"").trim(),r=0===t.length;try{(0,n.w6)()}catch(e){return{ok:!1,error:"keycrm_env_missing",details:e instanceof Error?e.message:e}}let l=i(e.perPage??50,1,100),a=i(e.maxPages??20,1,100),f=s(e.pipelineId),_=s(e.statusId),m=0,h=0,E=[];try{for(let e=1;e<=a;e++){let{data:n,hasNext:i}=await p(e,l,f,_);for(let i of(m=e,n)){let e=s(i?.pipeline_id??i?.pipeline?.id),n=s(i?.status_id??i?.status?.id),o=null==f||e===f||null==e,p=null==_||n===_||null==n;if(!o||!p)continue;let A={cardId:Number(i?.id??NaN),title:i?.title??null,pipelineId:e,pipelineTitle:i?.pipeline?.title??i?.pipeline_title??null??null,statusId:n,statusTitle:i?.status?.title??i?.status_title??null??null,contactName:i?.contact?.full_name??null,contactSocialId:i?.contact?.social_id??null,clientName:i?.client?.full_name??i?.contact?.client?.full_name??(Array.isArray(i?.clients)&&i.clients[0]?.full_name)??null,clientSocialId:i?.client?.social_id??i?.contact?.client?.social_id??(Array.isArray(i?.clients)&&i.clients[0]?.social_id)??null};Number.isFinite(A.cardId)&&E.push(A);let R=u(i);if(h++,r)continue;let g=c(t,R);if(g)return g.field.includes("social_id"),{ok:!0,needle:t,pagesScanned:m,cardsChecked:h,match:{cardId:Number(i.id),title:i?.title??null,matchedField:g.field,matchedValue:g.value},items:E,filters:{pipelineId:f,statusId:_,perPage:l,maxPages:a}};let y=R.some(e=>e.path.startsWith("client")),v=i?.id!=null&&(0===R.length||!y&&!Array.isArray(i?.client?.profiles));if(!r&&v&&i?.id!=null){let e=await d(i.id),r=u(e),n=c(t,r);if(n)return{ok:!0,needle:t,pagesScanned:m,cardsChecked:h,match:{cardId:Number(e?.id??i?.id),title:e?.title??i?.title??null,matchedField:n.field,matchedValue:n.value},items:E,filters:{pipelineId:f,statusId:_,perPage:l,maxPages:a}}}}if(!i)break}}catch(e){if(e instanceof o){if(429===e.status){let t=e.responseBody;try{t=e.responseBody?JSON.parse(e.responseBody):e.responseBody}catch{t=e.responseBody}return{ok:!1,error:"keycrm_rate_limited",details:{status:e.status,message:e.message,retryAfter:e.retryAfter,response:t}}}return{ok:!1,error:"keycrm_request_failed",details:{status:e.status,message:e.message,response:(()=>{try{return e.responseBody?JSON.parse(e.responseBody):e.responseBody}catch{return e.responseBody}})()}}}return{ok:!1,error:"keycrm_request_failed",details:e instanceof Error?e.message:e}}return{ok:!0,needle:t,pagesScanned:m,cardsChecked:h,match:null,items:E,filters:{pipelineId:f,statusId:_,perPage:l,maxPages:a}}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972],()=>r(3931));module.exports=n})();