"use strict";(()=>{var e={};e.id=2218,e.ids=[2218],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7744:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>N,patchFetch:()=>P,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>x,staticGenerationAsyncStorage:()=>b});var r={};a.r(r),a.d(r,{GET:()=>g,dynamic:()=>c});var s=a(9303),i=a(8716),n=a(670),o=a(7070);let c="force-dynamic",u=e=>new Promise(t=>setTimeout(t,e)),l=e=>String(e??"").trim().toLowerCase(),p=e=>e?e.trim().replace(/^@+/,"").toLowerCase():"";async function m(e){let t=new URL(e.url).searchParams.get("pass")||"",a=e.headers.get("authorization")||"",r=a.startsWith("Bearer ")?a.slice(7):"",s=process.env.ADMIN_PASS||"";return!s||r===s||t===s}async function d(e,{throttleMs:t,max429Retries:a,initialBackoffMs:r}){let s=`${process.env.KEYCRM_API_URL||process.env.KEYCRM_BASE_URL||"https://openapi.keycrm.app/v1"}${e}`,i=0,n=r;for(;;){t>0&&await u(t);let e=await fetch(s,{headers:{Authorization:`Bearer ${process.env.KEYCRM_API_TOKEN||process.env.KEYCRM_BEARER||process.env.KEYCRM_TOKEN||""}`,"Content-Type":"application/json"},cache:"no-store"});if(e.ok){let t=await e.text();try{return JSON.parse(t)}catch{throw Error(`KeyCRM returned non-JSON at ${s} :: ${t.slice(0,400)}`)}}if(429===e.status&&i<a){i++;let t=Math.max(n,1e3*(Number(e.headers.get("retry-after")||"")||0));await u(t),n=Math.min(2*n,15e3);continue}let r=await e.text().catch(()=>"");throw Error(`KeyCRM ${e.status} ${e.statusText} at ${s} :: ${r.slice(0,400)}`)}}async function h(e,t,a,r,s,i,n){let o=new URLSearchParams({page:String(e),per_page:String(t),pipeline_id:String(a),status_id:String(r)}),c=await d(`/pipelines/cards?${o.toString()}`,{throttleMs:s,max429Retries:i,initialBackoffMs:n});if(Array.isArray(c))return{ids:c.map(e=>e?.id).filter(Boolean),hasNext:c.length===t};let u=(Array.isArray(c?.data)?c.data:[]).map(e=>e?.id).filter(Boolean),l=Number(c?.current_page??e),p=Number(c?.last_page??l);return{ids:u,hasNext:!!c?.next_page_url||l<p}}async function _(e,t,a,r){return await d(`/pipelines/cards/${e}`,{throttleMs:t,max429Retries:a,initialBackoffMs:r})}async function g(e){try{if(!await m(e))return o.NextResponse.json({ok:!1,error:"Unauthorized"},{status:401});let t=new URL(e.url),a=t.searchParams.get("social_id")||t.searchParams.get("username")||t.searchParams.get("handle")||"",r=p(a),s=Number(t.searchParams.get("pipeline_id")||""),i=Number(t.searchParams.get("status_id")||""),n=Math.min(Math.max(Number(t.searchParams.get("per_page")||"50"),1),100),c=Math.min(Math.max(Number(t.searchParams.get("max_pages")||"20"),1),200),u=Math.min(Math.max(Number(t.searchParams.get("delay_ms")||"250"),0),2e3),d=Math.min(Math.max(Number(t.searchParams.get("retry_429")||"6"),0),10),g=Math.min(Math.max(Number(t.searchParams.get("backoff_ms")||"600"),100),5e3);if(!r)return o.NextResponse.json({ok:!1,error:"social_id is required"},{status:400});if(!Number.isFinite(s)||!Number.isFinite(i))return o.NextResponse.json({ok:!1,error:"pipeline_id and status_id must be numbers"},{status:400});let y=1,f=0,b=0,x=null;for(;y<=c&&!x;){let{ids:e,hasNext:t}=await h(y,n,s,i,u,d,g);for(let t of(f+=e.length,e)){let e=await _(t,u,d,g);b++;let a=e?.contact?.social_id??e?.contact?.client?.social_id??null,s=l(a);if(s===r||s==="@"+r){let t=e?.status?.pipeline_id??e?.pipeline_id??null,r=e?.status_id??e?.status?.id??null;x={id:Number(e?.id),title:e?.title??"",full_name:e?.contact?.full_name??e?.contact?.client?.full_name??null,social_id:a,pipeline_id:t?Number(t):null,status_id:r?Number(r):null,page:y};break}}if(!t||x)break;y++}return o.NextResponse.json({ok:!0,card_id:x?.id??null,found:x,stats:{pipeline_id:s,status_id:i,pages_scanned:y,per_page:n,list_items_seen:f,card_details_scanned:b},used:{social_id:"@"+r}})}catch(e){return o.NextResponse.json({ok:!1,error:e?.message||String(e)},{status:400})}}let y=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/card/by-social/route",pathname:"/api/keycrm/card/by-social",filename:"route",bundlePath:"app/api/keycrm/card/by-social/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/card/by-social/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:b,serverHooks:x}=y,N="/api/keycrm/card/by-social/route";function P(){return(0,n.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:b})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(7744));module.exports=r})();