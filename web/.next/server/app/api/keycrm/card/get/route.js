"use strict";(()=>{var e={};e.id=3589,e.ids=[3589],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8340:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>R,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{GET:()=>p,dynamic:()=>c});var n=a(9303),i=a(8716),s=a(670),o=a(7070);let c="force-dynamic",l=e=>new Promise(t=>setTimeout(t,e));async function u(e){let t=new URL(e.url).searchParams.get("pass")||"",a=e.headers.get("authorization")||"",r=a.startsWith("Bearer ")?a.slice(7):"",n=process.env.ADMIN_PASS||"";return!n||r===n||t===n}async function d(e,t={}){let{delayMs:a=150,retry429:r=5,backoffMs:n=500}=t,i=`${process.env.KEYCRM_API_URL||process.env.KEYCRM_BASE_URL||"https://openapi.keycrm.app/v1"}${e}`,s=0,o=n;for(;;){a>0&&await l(a);let e=await fetch(i,{headers:{Authorization:`Bearer ${process.env.KEYCRM_API_TOKEN||process.env.KEYCRM_BEARER||process.env.KEYCRM_TOKEN||""}`,"Content-Type":"application/json"},cache:"no-store"});if(e.ok){let t=await e.text();try{return JSON.parse(t)}catch{throw Error(`Non-JSON from KeyCRM :: ${t.slice(0,400)}`)}}if(429===e.status&&s<r){let t=Number(e.headers.get("retry-after")||"")||0;await l(Math.max(o,1e3*t)),o=Math.min(2*o,15e3),s++;continue}let t=await e.text().catch(()=>"");throw Error(`KeyCRM ${e.status} ${e.statusText} :: ${t.slice(0,400)}`)}}async function p(e){try{if(!await u(e))return o.NextResponse.json({ok:!1,error:"Unauthorized"},{status:401});let t=new URL(e.url).searchParams.get("id");if(!t)return o.NextResponse.json({ok:!1,error:"id is required"},{status:400});let a=await d(`/pipelines/cards/${encodeURIComponent(t)}`),r=a?.status?.pipeline_id??a?.pipeline_id??null,n=a?.status_id??a?.status?.id??null,i=a?.contact??null,s=i?"card.contact":null,c=a?.contact_id??a?.contact?.id??null,l=a?.contact&&(a?.contact?.social_id||a?.contact?.client?.social_id)||!1;if((!i||!l)&&c)try{let e=await d(`/contacts/${encodeURIComponent(String(c))}`);e&&"object"==typeof e&&(i={id:e?.id??c,full_name:e?.full_name??null,social_name:e?.social_name??null,social_id:e?.social_id??null,client:e?.client??null},s="contacts/{id}")}catch{}let p=i?.full_name??i?.client?.full_name??null,m=i?.social_id??i?.client?.social_id??null,_=i?.social_name??null,h={};for(let e of["updated_at","updatedAt","updated","created_at","createdAt","created","moved_at","movedAt"])a&&e in a&&(h[e]=a[e]);return o.NextResponse.json({ok:!0,id:Number(a?.id??t),pipeline_id:r?Number(r):null,status_id:n?Number(n):null,title:a?.title??null,contact_full_name:p,contact_social_name:_,contact_social_id:m,contact_source:s,raw_has_contact_in_card:!!a?.contact,raw_sample_keys:Object.keys(a||{}).slice(0,16),timestamp_fields:h,raw_card_sample:a?{...Object.fromEntries(Object.entries(a).slice(0,30).map(([e,t])=>[e,"object"==typeof t&&null!==t?"[object]":t]))}:null})}catch(e){return o.NextResponse.json({ok:!1,error:e?.message||String(e)},{status:400})}}let m=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/card/get/route",pathname:"/api/keycrm/card/get",filename:"route",bundlePath:"app/api/keycrm/card/get/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/card/get/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:f}=m,y="/api/keycrm/card/get/route";function R(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(8340));module.exports=r})();