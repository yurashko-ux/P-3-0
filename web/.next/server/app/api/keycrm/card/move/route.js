"use strict";(()=>{var e={};e.id=2872,e.ids=[2872],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4075:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>A,requestAsyncStorage:()=>E,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>R});var s={};r.r(s),r.d(s,{POST:()=>_,dynamic:()=>u,revalidate:()=>d});var a=r(9303),i=r(8716),o=r(670),n=r(7070),p=r(7756);let u="force-dynamic",d=0,l=(e,t,r)=>n.NextResponse.json({ok:!1,error:t,...r??{}},{status:e}),c=e=>n.NextResponse.json({ok:!0,...e??{}});async function _(e){let t=await e.json().catch(()=>({}))??{},r=(0,p.kg)(t.card_id),s=(0,p.kg)(t.to_pipeline_id),a=(0,p.kg)(t.to_status_id),i=(0,p.kg)(t.pipeline_status_id),o=(Array.isArray(t.status_aliases)?t.status_aliases:[]).map(e=>(0,p.kg)(e)).filter(e=>!!e),n=i??a,u=new Set;for(let e of(i&&i!==n&&u.add(i),a&&a!==n&&u.add(a),o))e&&e!==n&&u.add(e);let d=Array.from(u);if(!r)return l(400,"card_id required");if(!s&&!n)return l(400,"to_pipeline_id or to_status_id required");try{let e=await (0,p.$j)({cardId:r,pipelineId:s,statusId:n,pipelineStatusId:i,statusAliases:d});if(!e.ok)return l(502,"keycrm move unverified",e);return c({moved:!0,via:"pipelines/cards/{id} PUT",status:e.status,response:e.response,attempts:e.attempts,sent:e.sent,requestUrl:e.requestUrl,requestMethod:e.requestMethod})}catch(e){if(e?.code==="keycrm_not_configured")return l(500,"keycrm not configured",{need:{KEYCRM_API_TOKEN:!!process.env.KEYCRM_API_TOKEN,KEYCRM_BASE_URL:!!process.env.KEYCRM_BASE_URL}});if(e?.code==="target_missing")return l(400,"to_pipeline_id or to_status_id required");return l(502,"keycrm move failed",{error:e?.message??String(e)})}}let m=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/keycrm/card/move/route",pathname:"/api/keycrm/card/move",filename:"route",bundlePath:"app/api/keycrm/card/move/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/keycrm/card/move/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:E,staticGenerationAsyncStorage:R,serverHooks:f}=m,h="/api/keycrm/card/move/route";function A(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:R})}},1964:(e,t,r)=>{r.d(t,{Ls:()=>_,Nd:()=>m,Qv:()=>d,Rv:()=>l,SJ:()=>f,_P:()=>h,hC:()=>c,w6:()=>n,xD:()=>u});let s="https://openapi.keycrm.app/v1",a="M2EwMjAwMGE1ZWY4ODhkMzlkYzRiNTU2MDY4ZjZmZDc3ZGJkZjQ3MA",i={KEYCRM_API_URL:s,KEYCRM_API_BASE:s,KEYCRM_BASE_URL:s,KEYCRM_API_TOKEN:a,KEYCRM_TOKEN:a,KEYCRM_BEARER:a,KEYCRM_API_BEARER:a},o={KEYCRM_API_URL:process.env.KEYCRM_API_URL?.trim()||s,KEYCRM_API_TOKEN:process.env.KEYCRM_API_TOKEN?.trim()||process.env.KEYCRM_BEARER?.trim()||a,KEYCRM_BEARER:process.env.KEYCRM_BEARER?.trim()||process.env.KEYCRM_API_TOKEN?.trim()||a,ALTEGIO_API_URL:process.env.ALTEGIO_API_URL?.trim()||"",ALTEGIO_APPLICATION_ID:process.env.ALTEGIO_APPLICATION_ID?.trim()||"",ALTEGIO_PARTNER_ID:process.env.ALTEGIO_PARTNER_ID?.trim()||"",ALTEGIO_PARTNER_TOKEN:process.env.ALTEGIO_PARTNER_TOKEN?.trim()||"",ALTEGIO_USER_TOKEN:process.env.ALTEGIO_USER_TOKEN?.trim()||"",ALTEGIO_COMPANY_ID:process.env.ALTEGIO_COMPANY_ID?.trim()||""};function n(){if(!o.KEYCRM_API_URL)throw Error("Missing env KEYCRM_API_URL");if(!o.KEYCRM_API_TOKEN)throw Error("Missing env KEYCRM_API_TOKEN")}function p(e){return e.toLowerCase().startsWith("bearer ")?e:`Bearer ${e}`}function u(){return{Accept:"application/json","Content-Type":"application/json",Authorization:p(o.KEYCRM_BEARER)}}function d(e){let t=o.KEYCRM_API_URL.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}function l(){return o.KEYCRM_API_URL}function c(){return p(o.KEYCRM_BEARER)}function _(){return o.KEYCRM_API_TOKEN}let m={API_URL:s,API_TOKEN:a},E=new Map;for(let[e,t]of Object.entries(process.env))E.set(e.toLowerCase(),t);function R(e){if("string"!=typeof e)return;let t=e.trim();return t.length>0?t:void 0}function f(...e){for(let t of e){let e=R(process.env[t]);if(void 0!==e)return e}for(let t of e){let e=R(E.get(t.toLowerCase()));if(void 0!==e)return e}for(let t of e){let e=i[t.toUpperCase()];if(e)return e}}function h(...e){return void 0!==f(...e)}},7756:(e,t,r)=>{r.d(t,{$j:()=>_,kg:()=>n,st:()=>o});var s=r(1964);let a=(e,t)=>`${e.replace(/\/+$/,"")}/${t.replace(/^\/+/,"")}`,i=e=>{let t=new Set,r=[];for(let s of e)t.has(s)||(t.add(s),r.push(s));return r},o=e=>{if(!e)return[];let t=e.trim().replace(/\s+/g,""),r=[],s=e=>{e&&r.push(e.replace(/\/+$/,""))},a=(e,t)=>{let r=t.replace(/\/+$/,"");r?(r.startsWith("/")||(r=`/${r}`),/\/api$/i.test(r)?r=`${r}/v1`:/\/v\d+$/i.test(r)||(r=`${r}/v1`)):r="/v1",s(`${e}${r}`),/\/api\/v\d+$/i.test(r)?s(`${e}${r.replace(/\/api(\/v\d+)$/i,"$1")}`):/\/v\d+$/i.test(r)&&s(`${e}/api${r}`)};try{let e=new URL(t);a(e.origin,e.pathname)}catch{try{let e=new URL(`https://${t}`);a(e.origin,e.pathname)}catch{s(`${t.replace(/\/+$/,"")}/v1`),s(`${t.replace(/\/+$/,"")}/api/v1`)}}return i(r)},n=e=>{if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return String(e);if("string"==typeof e){let t=e.trim();return t.length?t:null}return null},p=e=>{let t=Number(e);return Number.isFinite(t)?t:e},u=e=>{let t=Array.isArray(e?.data)?e?.data[0]:e?.data??(Array.isArray(e)?e[0]:e),r=t&&"object"==typeof t&&"attributes"in t?t.attributes:t,s=t&&"object"==typeof t&&"relationships"in t?t.relationships:void 0;return{pipelineId:n(r?.pipeline_id)??n(r?.pipelineId)??n(r?.pipeline?.id)??n(t?.pipeline_id)??n(t?.pipelineId)??n(t?.pipeline?.id)??n(s?.pipeline?.data?.id)??n(s?.pipelines?.data?.id),statusId:n(r?.status_id)??n(r?.pipeline_status_id)??n(r?.statusId)??n(r?.status?.id)??n(t?.status_id)??n(t?.pipeline_status_id)??n(t?.statusId)??n(t?.status?.id)??n(s?.status?.data?.id)??n(s?.pipeline_status?.data?.id)??n(s?.pipeline_statuses?.data?.id),raw:e}},d=async(e,t,r)=>{let s=[`/pipelines/cards/${encodeURIComponent(r)}`,`/crm/deals/${encodeURIComponent(r)}`],i=["with[]=status&with[]=pipeline&include[]=status&include[]=pipeline",""];for(let r of s)for(let s of i){let i=s?`${r}${r.includes("?")?"&":"?"}${s}`:r;try{let r=await fetch(a(e,i),{headers:{Authorization:t,Accept:"application/json"},cache:"no-store"});if(!r.ok)continue;let s=await r.text();if(!s)return{pipelineId:null,statusId:null,raw:null};try{let e=JSON.parse(s);return u(e)}catch{return{pipelineId:null,statusId:null,raw:s}}}catch{continue}}return null},l=e=>new Promise(t=>setTimeout(t,e)),c=(e,t,r,s)=>{e.push({step:t,info:r??null,data:s,timestamp:Date.now()})};async function _({cardId:e,pipelineId:t,statusId:r,pipelineStatusId:i=null,statusAliases:u=[]}){let _=[],m=Error("moveKeycrmCard trace").stack??null;c(_,"moveKeycrmCard:start",null,{cardId:e,pipelineId:t,statusId:r,pipelineStatusId:i,statusAliases:u});let E=(0,s.SJ)("KEYCRM_API_URL","KEYCRM_API_BASE","KEYCRM_BASE_URL")??(0,s.Rv)(),R=(0,s.SJ)("KEYCRM_API_TOKEN","KEYCRM_TOKEN")??(0,s.Ls)(),f=(0,s.SJ)("KEYCRM_BEARER","KEYCRM_API_BEARER")??(0,s.Ls)(),h="";h=f?f.toLowerCase().startsWith("bearer ")?f:`Bearer ${f}`:R?`Bearer ${R}`:(0,s.hC)();let A=o(E);if(c(_,"moveKeycrmCard:credentials",null,{hasBase:!!E,baseCandidates:A,hasToken:!!(R||f),authorizationLength:h.length,authorizationPrefix:h.substring(0,20)+"..."}),!h||0===A.length)throw Object.assign(Error("KeyCRM credentials are missing"),{code:"keycrm_not_configured",details:{base:!!E,token:!!(R||f),baseCandidate:E,tokenCandidate:R?"***":null,bearerCandidate:f?"***":null}});h.includes(s.Nd.API_TOKEN)&&(console.warn("[keycrm-move] ⚠️ Використовується дефолтний токен KeyCRM! Перевірте змінні середовища KEYCRM_API_TOKEN або KEYCRM_BEARER в Vercel"),c(_,"moveKeycrmCard:warning","default_token_used",{message:"Використовується дефолтний токен, який може бути недійсним"}));let y=n(e);if(!y)throw Object.assign(Error("card_id required"),{code:"card_id_missing"});let v=n(t),I=n(r),C=n(i),K=Array.isArray(u)?Array.from(new Set([C,...u.map(e=>n(e))].filter(e=>!!e))):[];if(!v&&!I)throw Object.assign(Error("to_pipeline_id or to_status_id required"),{code:"target_missing"});let M=v?p(v):void 0,w=C?p(C):void 0,P=I?p(I):void 0,g=K.find(e=>e!==I),T=null!=g?p(g):void 0,b=P??T;p(y);let O=[],k=async(e,t)=>{let r=a(t,e.path),s={Authorization:h,Accept:"application/json","Content-Type":e.contentType},i=JSON.stringify(e.body);c(_,"performAttempt:start",e.attempt,{base:t,url:r,method:e.method,headers:s,body:e.body});let o=await fetch(r,{method:e.method,headers:s,body:i,cache:"no-store"}),n=await o.text(),p=null;if(n)try{p=JSON.parse(n)}catch{p=n}let u=[];if(c(_,"performAttempt:response",e.attempt,{status:o.status,ok:o.ok,raw:n}),o.ok)for(let r=0;r<20;r+=1){0===r?await l(300):await l(500);let s=await d(t,h,y),a=!v||s?.pipelineId===v,i=[C,I,...K],o=0===i.length||i.some(e=>s?.statusId===e);if(u.push({snapshot:s,pipelineMatches:a,statusMatches:o}),c(_,"performAttempt:verification",e.attempt,{attempt:r+1,pipelineMatches:a,statusMatches:o,snapshot:s}),a&&o)break}let m=o.ok&&u.some(e=>e.pipelineMatches&&e.statusMatches),E=e.body;return O.push({attempt:e.attempt,status:o.status,ok:m,body:p,sent:E,verification:u,url:r,method:e.method,requestHeaders:s,requestBodyRaw:i,responseRaw:n||null}),{ok:m,status:o.status,body:p,sent:E,verification:u,url:r,method:e.method,requestHeaders:s,requestBodyRaw:i,responseRaw:n||null}},Y=[],$={};void 0!==M&&($.pipeline_id=M,$.to_pipeline_id=M),void 0!==w&&($.pipeline_status_id=w),void 0!==b&&($.status_id=b,$.to_status_id=b),Y.push({attempt:"pipelines/cards/{id} PUT",method:"PUT",path:`/pipelines/cards/${encodeURIComponent(y)}`,contentType:"application/json",body:$});let N=null;for(let e of A){let t=e.replace(/\/+$/,"");for(let e of Y)try{let r=await k(e,t);if(N={...r,attemptName:e.attempt,base:t},O.push({attempt:e.attempt,status:r.status,ok:r.ok,body:r.body,sent:e.body,verification:r.verification,url:r.url,method:e.method,requestHeaders:r.requestHeaders,requestBodyRaw:r.requestBodyRaw,responseRaw:r.responseRaw}),r.ok)return c(_,"moveKeycrmCard:success",e.attempt,{status:r.status,base:t}),{ok:!0,status:r.status,response:{attempt:e.attempt,body:r.body,history:O},sent:e.body,attempts:r.verification,requestUrl:r.url,requestMethod:e.method,baseUrl:t,requestHeaders:r.requestHeaders,requestBodyRaw:r.requestBodyRaw,responseRaw:r.responseRaw,trace:_,stack:m};if(401===r.status){c(_,"moveKeycrmCard:unauthorized",e.attempt,{status:r.status,base:t});continue}}catch(r){c(_,"performAttempt:error",e.attempt,{base:t,error:r instanceof Error?r.message:String(r)}),O.push({attempt:e.attempt,status:0,ok:!1,body:null,sent:e.body,verification:[],url:a(t,e.path),method:e.method,error:r instanceof Error?r.message:String(r)})}}let L=N?.base??A[0]?.replace(/\/+$/,"")??"",U=N?.sent??Y[0]?.body??$,q=N?.status??0,B=N?.body??null,S=O.at(-1)?.attempt??N?.attemptName??Y[0]?.attempt??"unknown",j=N?.verification??[],x=N?.url??a(L,Y[0]?.path??""),G=N?.method??Y[0]?.method??"POST",D=N?.requestHeaders??null,z=N?.requestBodyRaw??null,J=N?.responseRaw??null;return c(_,"moveKeycrmCard:failure",S,{status:q,base:L,url:x}),{ok:!1,status:q,response:{attempt:S,body:B,history:O},sent:U,attempts:j,requestUrl:x,requestMethod:G,baseUrl:L,requestHeaders:D,requestBodyRaw:z,responseRaw:J,trace:_,stack:m}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972],()=>r(4075));module.exports=s})();