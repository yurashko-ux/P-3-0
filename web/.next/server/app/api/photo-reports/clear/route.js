"use strict";(()=>{var e={};e.id=8630,e.ids=[8630,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},5885:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>R,requestAsyncStorage:()=>v,routeModule:()=>h,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{GET:()=>d,POST:()=>u,dynamic:()=>l,runtime:()=>p});var n=r(9303),a=r(8716),s=r(670),i=r(7070),c=r(3783);let l="force-dynamic",p="nodejs";async function u(e){try{if(!function(e){let t=e.nextUrl.searchParams.get("secret"),r=process.env.CRON_SECRET||"";return r&&t&&r===t}(e))return i.NextResponse.json({ok:!1,error:"Unauthorized"},{status:403});let t=await (0,c.wH)();return i.NextResponse.json({ok:!0,deletedCount:t,message:`Очищено ${t} фото-звітів`})}catch(e){return console.error("[photo-reports/clear] Error:",e),i.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}async function d(e){return u(e)}let h=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/photo-reports/clear/route",pathname:"/api/photo-reports/clear",filename:"route",bundlePath:"app/api/photo-reports/clear/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/photo-reports/clear/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:v,staticGenerationAsyncStorage:f,serverHooks:_}=h,w="/api/photo-reports/clear/route";function R(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:f})}},3783:(e,t,r)=>{r.d(t,{$e:()=>v,E$:()=>i,HA:()=>h,Ri:()=>u,Yu:()=>c,qg:()=>d,sZ:()=>l,tq:()=>p,wH:()=>f});var o=r(7560);let n="photo-reports",a=e=>`photo-reports-pending:${e}`,s=e=>`${n}:${e}`;async function i(e){await o.kv.set(a(e.chatId),e,{ex:1800})}async function c(e){return o.kv.get(a(e))}async function l(e){await o.kv.del(a(e))}async function p(e){!e.telegramFileId&&e.telegramFileIds?.length>0&&(e.telegramFileId=e.telegramFileIds[0]),await o.kv.set(s(e.appointmentId),e)}async function u(e,t){let r=await c(e);return!!r&&(r.photoFileIds||(r.photoFileIds=[]),r.photoFileIds.includes(t)||(r.photoFileIds.push(t),await i(r)),!0)}async function d(e){return o.kv.get(s(e))}async function h(e=20){let t=`${n}:index`,r=await o.kv.lrange(t,0,-1)||[],a=[];for(let t of r.slice(0,e)){let e=await d(t);e&&a.push(e)}return a}async function v(e){let t=`${n}:index`;await o.kv.lpush(t,e),await o.kv.ltrim(t,0,99)}async function f(){let e=`${n}:index`,t=await o.kv.lrange(e,0,-1),r=0;for(let e of t)try{await o.kv.del(s(e)),r++}catch(t){console.warn(`[photo-reports/store] Failed to delete report ${e}:`,t)}return await o.kv.del(e),r}},7560:(e,t,r)=>{r.d(t,{kv:()=>i});var o=r(242),n=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var a=class extends o.Redis{async *scanIterator(e){let t,r=0;do for(let o of([r,t]=await this.scan(r,e),t))yield o;while(0!==r)}async *hscanIterator(e,t){let r,o=0;do for(let n of([o,r]=await this.hscan(e,o,t),r))yield n;while(0!==o)}async *sscanIterator(e,t){let r,o=0;do for(let n of([o,r]=await this.sscan(e,o,t),r))yield n;while(0!==o)}async *zscanIterator(e,t){let r,o=0;do for(let n of([o,r]=await this.zscan(e,o,t),r))yield n;while(0!==o)}};function s(e){return new a({cache:"default",...e})}new Proxy({},{get(e,t,r){if("then"===t||"parse"===t)return Reflect.get(e,t,r);if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}});var i=new Proxy({},{get(e,t){if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,242],()=>r(5885));module.exports=o})();