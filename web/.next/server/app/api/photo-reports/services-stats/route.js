"use strict";(()=>{var e={};e.id=6106,e.ids=[6106],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4039:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>A,requestAsyncStorage:()=>y,routeModule:()=>v,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>g,dynamic:()=>p,runtime:()=>f});var s=r(9303),i=r(8716),o=r(670),n=r(7070),l=r(4044),c=r(7582),d=r(4528),m=r(4332);let p="force-dynamic",f="nodejs";async function u(e,t){try{for(let r of(console.log(`[photo-reports/services-stats] Fetching services from category ${t} for company ${e}`),[{name:"GET /company/{id}/services (then filter by category_id)",url:`/company/${e}/services`,filterByCategory:!0},{name:"GET /services?company_id={id}",url:`/services?company_id=${e}`,filterByCategory:!0},{name:"GET /company/{id}/service_category/{category_id}/services",url:`/company/${e}/service_category/${t}/services`,filterByCategory:!1},{name:"GET /service_category/{category_id}/services",url:`/service_category/${t}/services?company_id=${e}`,filterByCategory:!1},{name:"GET /company/{id}/services?category_id={id}",url:`/company/${e}/services?category_id=${t}`,filterByCategory:!1},{name:"GET /services?company_id={id}&category_id={id}",url:`/services?company_id=${e}&category_id=${t}`,filterByCategory:!1}]))try{console.log(`[photo-reports/services-stats] Trying ${r.name}...`);let e=await (0,c.B)(r.url),a=[];if(Array.isArray(e)?a=e:e&&"object"==typeof e&&(Array.isArray(e.data)?a=e.data:Array.isArray(e.services)?a=e.services:Array.isArray(e.items)&&(a=e.items)),a.length>0){if(r.filterByCategory){let e=a.length;a=a.filter(e=>(e.category_id||e.service_category_id||e.category?.id||e.service_category?.id)===t),console.log(`[photo-reports/services-stats] Filtered ${a.length} services from ${e} total by category_id ${t}`)}let e=a.map(e=>e.id||e.service_id).filter(e=>"number"==typeof e&&!isNaN(e));if(e.length>0)return console.log(`[photo-reports/services-stats] âœ… Got ${e.length} service IDs from category ${t} using ${r.name}`),e}}catch(e){console.warn(`[photo-reports/services-stats] Failed with ${r.name}:`,e instanceof Error?e.message:String(e));continue}return console.warn(`[photo-reports/services-stats] Could not fetch services from category ${t}, falling back to name-based filtering`),[]}catch(e){return console.error("[photo-reports/services-stats] Error fetching services from category:",e),[]}}async function g(e){try{(0,l.cC)();let t=function(e){let t=e.nextUrl.searchParams.get("company_id");if(t){let e=parseInt(t,10);if(!isNaN(e))return e}let r=process.env.ALTEGIO_COMPANY_ID;if(r){let e=parseInt(r,10);if(!isNaN(e))return e}let a=l.B0.PARTNER_ID;if(a){let e=parseInt(a,10);if(!isNaN(e))return e}return null}(e);if(!t)return n.NextResponse.json({ok:!1,error:"company_id required. Set ALTEGIO_PARTNER_ID in env or pass ?company_id=..."},{status:400});let r=parseInt(e.nextUrl.searchParams.get("daysBack")||"30",10);e.nextUrl.searchParams.get("includeFuture");let a=e.nextUrl.searchParams.get("category_id"),s=a?parseInt(a,10):parseInt(process.env.ALTEGIO_SERVICE_CATEGORY_ID||"11928106",10),i=new Date,o=new Date(i);o.setDate(o.getDate()-r);let c=new Date(i);c.setDate(c.getDate()+365);let p=o.toISOString().split("T")[0],f=c.toISOString().split("T")[0];console.log(`[photo-reports/services-stats] ðŸ“… Period calculation: nowDate=${i.toISOString()}, dateFrom=${p}, dateTo=${f}, daysBack=${r}`),console.log(`[photo-reports/services-stats] Fetching appointments from ${p} to ${f} for company ${t}, category ${s}`);let g=await u(t,s);console.log(`[photo-reports/services-stats] Will filter by ${g.length} service IDs:`,g.slice(0,5),g.length>5?`... (${g.length} total)`:"");let v=[];if(console.log(`[photo-reports/services-stats] â­ï¸ Skipping Altegio visits/appointments API (all endpoints return 404), using webhook records only`),0===v.length){console.log(`[photo-reports/services-stats] ðŸ” Checking if fallback to webhook data is needed...`),console.log(`[photo-reports/services-stats] âš ï¸ No appointments from API (all endpoints returned 404 or empty), trying webhook data fallback...`);try{let e=(await m.kvRead.lrange("altegio:webhook:log",0,9999)).map(e=>{try{let t=JSON.parse(e);if(t&&"object"==typeof t&&"value"in t&&"string"==typeof t.value)return JSON.parse(t.value);return t}catch{return null}}).filter(Boolean);e.sort((e,t)=>{let r=new Date(e.receivedAt||0).getTime(),a=new Date(t.receivedAt||0).getTime();return r-a});let t={};for(let r of e){let e=r?.body||r;if(!e||"record"!==e.resource||!e.data)continue;let a=e.data,s=a.visit_id||e.resource_id,i=a.datetime;if(!s||!i)continue;if("delete"===e.status){delete t[s];continue}let o=Array.isArray(a.services)?a.services:a.service?[a.service]:[],n=o[0]||null;t[s]={visitId:s,recordId:e.resource_id,datetime:i,serviceId:n?.id||a.service_id,serviceName:n?.title||n?.name||a.service?.title||a.service?.name,staffId:a.staff?.id||a.staff_id,clientId:a.client?.id||a.client_id,companyId:a.company_id||e.company_id,receivedAt:r.receivedAt||new Date().toISOString(),data:{service:n||a.service,services:o,staff:a.staff,client:a.client}}}let r=Object.values(t);console.log(`[photo-reports/services-stats] Built ${r.length} active records from webhook log (after applying create/update/delete, no date filter applied)`),v=r.map(e=>({id:e.visitId,datetime:e.datetime,end_datetime:e.datetime,service_id:e.serviceId,service:e.data?.service||(e.serviceId?{id:e.serviceId,title:e.serviceName}:null),staff_id:e.staffId,staff:e.data?.staff||(e.staffId?{id:e.staffId}:null),client_id:e.clientId,client:e.data?.client||(e.clientId?{id:e.clientId}:null)}))}catch(e){console.warn("[photo-reports/services-stats] Failed to get webhook records:",e instanceof Error?e.message:String(e))}}let y=new Date,h=new Date(y);h.setHours(0,0,0,0);let _=v.filter(e=>{let t=e.end_datetime||e.datetime||e.date;if(!t)return!1;let r=new Date(t);return r>=h&&r<y}),I=v.filter(e=>{let t=e.end_datetime||e.datetime||e.date;return!!t&&new Date(t)>=y});console.log(`[photo-reports/services-stats] Completed appointments=${_.length}, planned=${I.length}`);let A=e=>{if(e.service)return function(e,t){if(!e)return!1;if(t.length>0){let r=e.id||e.service_id;if(r&&t.includes(r))return!0}let r=(e.title||e.name||e.service_name||"").toLowerCase().trim();return r.includes("Ð½Ð°Ñ€Ð¾Ñ‰ÑƒÐ²Ð°Ð½Ð½Ñ")||r.includes("Ð½Ð°Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ")||r.includes("hair extension")||r.includes("hair extensions")}(e.service,g);let t=e.service_id;return!!t&&g.length>0&&g.includes(t)},$=_.filter(A),w=I.filter(A),N=$.length+w.length;if(N>0&&0===$.length&&0===w.length){let e=_[0]||I[0];e&&console.log("[photo-reports/services-stats] Sample appointment structure:",{id:e.id,service_id:e.service_id,hasService:!!e.service,serviceKeys:e.service?Object.keys(e.service):[],allKeys:Object.keys(e)})}console.log(`[photo-reports/services-stats] Hair extensions: total=${N}, completed=${$.length}, planned=${w.length}`);let k={};for(let e of $){let t=e.staff_id;if(!t)continue;let r=(0,d.mC)(t);if(!r){console.warn(`[photo-reports/services-stats] Master not found for staff_id ${t}`);continue}k[r.id]||(k[r.id]={masterId:r.id,masterName:r.name,count:0,plannedCount:0}),k[r.id].count++}for(let e of w){let t=e.staff_id;if(!t)continue;let r=(0,d.mC)(t);if(!r){console.warn(`[photo-reports/services-stats] Master not found for staff_id ${t}`);continue}k[r.id]||(k[r.id]={masterId:r.id,masterName:r.name,count:0,plannedCount:0}),k[r.id].plannedCount++}let S=Object.values(k);return n.NextResponse.json({ok:!0,period:{dateFrom:p,dateTo:f,daysBack:r},totalAppointments:v.length,completedAppointments:_.length,hairExtensionAppointments:$.length,statsByMaster:S})}catch(e){return console.error("[photo-reports/services-stats] Error:",e),n.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let v=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/photo-reports/services-stats/route",pathname:"/api/photo-reports/services-stats",filename:"route",bundlePath:"app/api/photo-reports/services-stats/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/photo-reports/services-stats/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:_}=v,I="/api/photo-reports/services-stats/route";function A(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},4528:(e,t,r)=>{r.d(t,{Kf:()=>p,OT:()=>d,mC:()=>c,Wh:()=>l,N$:()=>n,y8:()=>m});let a=[{id:"master-test",name:"Ð¢ÐµÑÑ‚Ð¾Ð²Ð¸Ð¹ Ð¼Ð°Ð¹ÑÑ‚ÐµÑ€ (Mykolay)",telegramUsername:"Mykolay007",role:"master"},{id:"master-olena",name:"ÐžÐ»ÐµÐ½Ð°",telegramUsername:"o_sarbeeva",role:"master",altegioStaffId:2658785},{id:"master-tester",name:"Mykolay (Ñ‚ÐµÑÑ‚-Ñ€ÐµÐ¶Ð¸Ð¼)",telegramUsername:"Mykolay007",role:"master"},{id:"master-oleksandra",name:"ÐžÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€Ð°",telegramUsername:"Alexandra_Z7",role:"master",altegioStaffId:2851361},{id:"master-maryana",name:"ÐœÐ°Ñ€'ÑÐ½Ð°",telegramUsername:"maryana24021989",role:"master",altegioStaffId:2860168},{id:"master-halyna",name:"Ð“Ð°Ð»Ð¸Ð½Ð°",telegramUsername:"Halyna_Maxymiv",role:"master",altegioStaffId:2658783},{id:"admin-viktoria",name:"Ð’Ñ–ÐºÑ‚Ð¾Ñ€Ñ–Ñ (Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€)",telegramUsername:"kolachnykv",role:"admin",altegioStaffId:2643393}],s=new Date;function i(e,t){let r=new Date(e);return r.setMinutes(r.getMinutes()+t),r.toISOString()}let o=[{id:"apt-1001",clientName:"Ð†Ñ€Ð¸Ð½Ð°",serviceName:"ÐÐ°Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ Ð²Ð¾Ð»Ð¾ÑÑÑ (Ð¿Ð¾Ð²Ð½Ðµ)",masterId:"master-olena",masterName:"ÐžÐ»ÐµÐ½Ð°",startAt:i(s,-60),endAt:i(s,-5)},{id:"apt-1002",clientName:"ÐœÐ°Ñ€Ñ–Ñ",serviceName:"ÐšÐ¾Ñ€ÐµÐºÑ†Ñ–Ñ Ð½Ð°Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ",masterId:"master-oleksandra",masterName:"ÐžÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€Ð°",startAt:i(s,-30),endAt:i(s,10)},{id:"apt-1003",clientName:"ÐžÐºÑÐ°Ð½Ð°",serviceName:"ÐŸÐ¾Ð»Ñ–Ñ€ÑƒÐ²Ð°Ð½Ð½Ñ Ñ‚Ð° ÑƒÐºÐ»Ð°Ð´ÐºÐ°",masterId:"master-maryana",masterName:"ÐœÐ°Ñ€'ÑÐ½Ð°",startAt:i(s,-20),endAt:i(s,20)},{id:"apt-1004",clientName:"Ð¢ÐµÑÑ‚Ð¾Ð²Ð¸Ð¹ ÐºÐ»Ñ–Ñ”Ð½Ñ‚",serviceName:"ÐÐ°Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ Ð²Ð¾Ð»Ð¾ÑÑÑ (Ñ‚ÐµÑÑ‚)",masterId:"master-test",masterName:"Ð¢ÐµÑÑ‚Ð¾Ð²Ð¸Ð¹ Ð¼Ð°Ð¹ÑÑ‚ÐµÑ€ (Mykolay)",startAt:i(s,-10),endAt:i(s,15)}];function n(){return a}function l(e){if(e)return a.find(t=>t.telegramUsername?.toLowerCase()===e.toLowerCase())}function c(e){return a.find(t=>t.altegioStaffId===e)}function d(e){return o.find(t=>t.id===e)}function m(e=15){let t=Date.now(),r=t+6e4*e;return o.filter(e=>{let a=new Date(e.endAt).getTime();return a>=t&&a<=r})}function p(e,t){if(!t)return null;let r=e.start_datetime||e.datetime||e.date,a=e.end_datetime||e.datetime||e.date;if(!r||!a)return console.warn(`[photo-reports] Appointment ${e.id} missing datetime fields`,e),null;let s=e.client?.name||e.client?.display_name||e.client_name||"ÐšÐ»Ñ–Ñ”Ð½Ñ‚",i=e.service?.title||e.service?.name||e.service_name||"ÐŸÐ¾ÑÐ»ÑƒÐ³Ð°";return{id:`altegio-${e.id}`,clientName:s,serviceName:i,masterId:t.id,masterName:t.name,startAt:new Date(r).toISOString(),endAt:new Date(a).toISOString()}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,4332,7582],()=>r(4039));module.exports=a})();