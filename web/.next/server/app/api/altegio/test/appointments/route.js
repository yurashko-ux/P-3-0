"use strict";(()=>{var e={};e.id=97,e.ids=[97,9512],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9267:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>u,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f});var n={};a.r(n),a.d(n,{GET:()=>c,dynamic:()=>p,runtime:()=>m});var s=a(9303),i=a(8716),r=a(670),o=a(7070),d=a(9512),l=a(4044);let p="force-dynamic",m="nodejs";async function c(e){try{(0,l.cC)();let t=process.env.ALTEGIO_COMPANY_ID;if(!t)return o.NextResponse.json({ok:!1,error:"ALTEGIO_COMPANY_ID not set in environment variables"},{status:400});let a=parseInt(t,10);if(isNaN(a))return o.NextResponse.json({ok:!1,error:`Invalid ALTEGIO_COMPANY_ID: ${t}`},{status:400});let n=e.nextUrl.searchParams.get("days"),s=n?parseInt(n,10):30,i=await (0,d.getUpcomingAppointments)(a,s,!0),r=i.map(e=>{let t=e.client,a=null,n=null;if(t){let e=["instagram-user-name","instagram_user_name","instagramUsername","instagram_username","instagram"];for(let s of e){let e=Object.keys(t).find(e=>e.toLowerCase().replace(/[-_]/g,"")===s.toLowerCase().replace(/[-_]/g,""));if(e&&t[e]){a=String(t[e]),n=e;break}}if(!a&&t.custom_fields)for(let s of e){let e=Object.keys(t.custom_fields).find(e=>e.toLowerCase().replace(/[-_]/g,"")===s.toLowerCase().replace(/[-_]/g,""));if(e&&t.custom_fields[e]){a=String(t.custom_fields[e]),n=`custom_fields.${e}`;break}}}return{id:e.id,datetime:e.datetime||e.start_datetime||e.date,client_id:e.client_id,client_name:t?.name||"Unknown",client_phone:t?.phone||null,instagram_username:a,instagram_field_name:n,service_id:e.service_id,staff_id:e.staff_id,status:e.status,has_client_data:!!t}}),p=r.filter(e=>e.instagram_username).length;return o.NextResponse.json({ok:!0,message:`Found ${i.length} upcoming appointments`,appointmentsCount:i.length,appointmentsWithInstagram:p,days:s,appointments:r,sampleAppointment:i.length>0?{fullStructure:i[0],keys:Object.keys(i[0])}:null})}catch(t){console.error("[altegio/test/appointments] Error:",t);let e=t instanceof Error?t.message:String(t);return o.NextResponse.json({ok:!1,error:e},{status:500})}}let u=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/altegio/test/appointments/route",pathname:"/api/altegio/test/appointments",filename:"route",bundlePath:"app/api/altegio/test/appointments/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/test/appointments/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:_}=u,h="/api/altegio/test/appointments/route";function y(){return(0,r.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:f})}},9512:(e,t,a)=>{a.d(t,{B:()=>s,getUpcomingAppointments:()=>i});var n=a(7582);async function s(e,t={}){try{let a={};t.dateFrom&&(a.date_from=t.dateFrom),t.dateTo&&(a.date_to=t.dateTo),t.status&&(a.status=t.status),t.clientId&&(a.client_id=t.clientId),t.staffId&&(a.staff_id=t.staffId),t.serviceId&&(a.service_id=t.serviceId),t.serviceIds&&t.serviceIds.length>0&&(a.service_ids=t.serviceIds,a.service_id=t.serviceIds);let s=[];t.includeClient&&s.push("client"),t.includeService&&s.push("service"),t.includeStaff&&s.push("staff");let i=[{name:"POST /company/{id}/appointments/search (recommended)",method:"POST",path:`/company/${e}/appointments/search`,body:{page:1,page_size:500,...a,...s.length?{include:s}:{}}},{name:"GET /company/{id}/appointments",method:"GET",path:`/company/${e}/appointments`,useQuery:!0},{name:"GET /location/{id}/timetable_event_schedules/days/events (Schedule Events API)",method:"GET",path:`/location/${e}/timetable_event_schedules/days/events`,useQuery:!0},{name:"GET /schedule/events (Schedule API, fallback)",method:"GET",path:"/schedule/events",useQuery:!0},{name:"POST /appointments/search",method:"POST",path:"/appointments/search",body:{location_id:e,page:1,page_size:500,...a,...s.length?{include:s}:{}}},{name:"GET /appointments?location_id=...",method:"GET",path:"/appointments",useQuery:!0}],r=null;for(let o of i){let i=o.path;try{let r=new URLSearchParams;o.useQuery&&(a.date_from&&r.set("date_from",a.date_from),a.date_to&&r.set("date_to",a.date_to),a.status&&r.set("status",a.status),a.client_id&&r.set("client_id",String(a.client_id)),a.staff_id&&r.set("staff_id",String(a.staff_id)),s.length&&s.forEach(e=>{r.append("include[]",e)}),"/appointments"===o.path?r.set("location_id",String(e)):"/schedule/events"===o.path?r.set("location_id",String(e)):o.path.includes("/timetable_event_schedules/days/events")&&(r.set("location_id",String(e)),a.date_from&&r.set("date_from",a.date_from),a.date_to&&r.set("date_to",a.date_to)));let d=o.useQuery&&r.toString()?`${o.path}?${r.toString()}`:o.path;i=d,console.log(`[altegio/appointments] Trying ${o.name} → ${i}`);let l=await (0,n.B)(d,{method:o.method,..."POST"===o.method?{body:JSON.stringify(o.body??{})}:{}}),p=[];if(Array.isArray(l))p=l;else if(l&&"object"==typeof l&&(Array.isArray(l.data)?p=l.data:Array.isArray(l.appointments)?p=l.appointments:Array.isArray(l.items)?p=l.items:Array.isArray(l.results)&&(p=l.results),!p.length&&!0===l.success&&Array.isArray(l.data?.events)&&(p=l.data.events),!p.length&&Array.isArray(l.data)&&l.data.length>0)){let e=l.data[0];e&&(e.datetime||e.start_datetime||e.service_id)&&(p=l.data)}if(console.log(`[altegio/appointments] Response from ${o.name}: count=${p.length}`),0===p.length)continue;if(!t.dateFrom){let e=new Date;p=p.filter(t=>{let a=t.datetime||t.start_datetime||t.date;return!!a&&new Date(a)>=e})}return p.sort((e,t)=>{let a=e.datetime||e.start_datetime||e.date||"",n=t.datetime||t.start_datetime||t.date||"";return new Date(a).getTime()-new Date(n).getTime()}),console.log(`[altegio/appointments] ✅ Got ${p.length} appointments for company ${e} using ${o.name}`),p}catch(a){let t=a instanceof Error?a:Error("string"==typeof a?a:JSON.stringify(a));t.message=`[${o.name}] ${i} :: ${t.message}`,r=t,console.warn(`[altegio/appointments] ❌ ${o.name} failed for company ${e}:`,t.message);continue}}if(r)throw r;return console.warn(`[altegio/appointments] No appointments found for company ${e}`),[]}catch(t){throw console.error(`[altegio/appointments] Failed to get appointments for company ${e}:`,t),t}}async function i(e,t=30,a=!0){let n=new Date,i=new Date(n);return i.setDate(i.getDate()+t),s(e,{dateFrom:n.toISOString().split("T")[0],dateTo:i.toISOString().split("T")[0],includeClient:a})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[8948,5972,7582],()=>a(9267));module.exports=n})();