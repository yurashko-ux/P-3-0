"use strict";(()=>{var e={};e.id=663,e.ids=[663],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2268:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var i={};n.r(i),n.d(i,{GET:()=>d,dynamic:()=>m,runtime:()=>c});var a=n(9303),s=n(8716),l=n(670),o=n(7070),r=n(4044),u=n(8630),p=n(9512);let m="force-dynamic",c="nodejs";async function d(e){try{(0,r.cC)();let e=process.env.ALTEGIO_COMPANY_ID;if(!e)return o.NextResponse.json({ok:!1,error:"ALTEGIO_COMPANY_ID not set in environment variables"},{status:400});let t=parseInt(e,10);if(isNaN(t))return o.NextResponse.json({ok:!1,error:`Invalid ALTEGIO_COMPANY_ID: ${e}`},{status:400});let n=new Date,i=new Date(n);i.setDate(i.getDate()-3);let a=new Date(n);a.setDate(a.getDate()+4);let s=i.toISOString().split("T")[0],l=a.toISOString().split("T")[0];console.log(`[altegio/test/appointments/full-week] Fetching appointments and visits from ${s} to ${l}`);let m=[],c=[];try{m=await (0,p.B)(t,{dateFrom:s,dateTo:l,includeClient:!0}),console.log(`[altegio/test/appointments/full-week] Got ${m.length} appointments`)}catch(e){console.warn("[altegio/test/appointments/full-week] Failed to get appointments:",e)}try{c=await (0,u.s1)(t,{dateFrom:s,dateTo:l,includeClient:!0,includeService:!0,includeStaff:!0,includePayment:!0}),console.log(`[altegio/test/appointments/full-week] Got ${c.length} visits`)}catch(e){console.warn("[altegio/test/appointments/full-week] Failed to get visits:",e)}let d=new Map;c.forEach(e=>{e.appointment_id&&d.set(e.appointment_id,e),d.set(e.id,e)});let f=[];if(m.forEach(e=>{let t=d.get(e.id);t?(f.push({...e,visit_id:t.id,payment:t.payment||t.transactions||e.payment,transactions:t.transactions,is_visit:!0}),d.delete(e.id)):f.push({...e,is_visit:!1})}),c.forEach(e=>{f.find(t=>t.id===e.id||t.visit_id===e.id)||f.push({...e,is_visit:!0})}),console.log(`[altegio/test/appointments/full-week] Total records: ${f.length} (appointments + visits)`),0===f.length)return o.NextResponse.json({ok:!1,error:"No appointments or visits found",note:"Tried both /appointments and /visits endpoints"},{status:404});let g=f[0],y=Object.keys(g),h=f.map(e=>{let t=e.client?.name||e.client_name||null,n=e.datetime||e.start_datetime||e.date||null,i=e.status||null,a=e.payment||e.payments||null,s=a?.status||e.payment_status||null,l=a?.amount||e.payment_amount||e.amount||null,o=e.service||null,r=o?.name||e.service_name||null,u=o?.type||e.service_type||null,p=o?.id||e.service_id||null,m=e.staff||null,c=m?.name||e.staff_name||null,d=m?.id||e.staff_id||null,f=e.comment||e.note||e.notes||null,g=e.duration||o?.duration||null,y=null;if(e.client?.email&&e.client.email.includes("@")){let t=e.client.email.split("@");t[0]&&t[0].trim()&&(y=t[0].trim())}return{id:e.id,clientName:t,datetime:n,status:i,payment:{status:s,amount:l,full:a},service:{id:p,name:r,type:u,duration:g,full:o},staff:{id:d,name:c,full:m},client:{id:e.client?.id||e.client_id||null,name:t,instagramUsername:y,full:e.client||null},comment:f,rawStructure:e,allKeys:Object.keys(e)}}),v=n.getTime(),w=h.filter(e=>!!e.datetime&&new Date(e.datetime).getTime()<v),k=h.filter(e=>!!e.datetime&&new Date(e.datetime).getTime()>=v),_=h.reduce((e,t)=>{let n=t.status||"unknown";return e[n]=(e[n]||0)+1,e},{}),O={withPayment:h.filter(e=>e.payment?.amount||e.payment?.status).length,withoutPayment:h.filter(e=>!e.payment?.amount&&!e.payment?.status).length,totalAmount:h.filter(e=>e.payment?.amount).reduce((e,t)=>e+(parseFloat(String(t.payment?.amount||0))||0),0)};return o.NextResponse.json({ok:!0,message:`Found ${f.length} appointments for the week`,dateRange:{from:s,to:l,days:7},summary:{total:f.length,past:w.length,future:k.length,statusStats:_,paymentStats:O,appointmentsCount:m.length,visitsCount:c.length},appointments:h,pastAppointments:w,futureAppointments:k,firstAppointmentAnalysis:{allKeys:y,sampleStructure:g,hasClient:!!g.client,hasService:!!g.service,hasStaff:!!g.staff,hasPayment:!!g.payment||!!g.payment_status,clientKeys:g.client?Object.keys(g.client):[],serviceKeys:g.service?Object.keys(g.service):[],staffKeys:g.staff?Object.keys(g.staff):[]}})}catch(t){console.error("[altegio/test/appointments/full-week] Error:",t);let e=t instanceof Error?t.message:String(t);return o.NextResponse.json({ok:!1,error:e},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/altegio/test/appointments/full-week/route",pathname:"/api/altegio/test/appointments/full-week",filename:"route",bundlePath:"app/api/altegio/test/appointments/full-week/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/test/appointments/full-week/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:h}=f,v="/api/altegio/test/appointments/full-week/route";function w(){return(0,l.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),i=t.X(0,[8948,5972,7582,7493],()=>n(2268));module.exports=i})();