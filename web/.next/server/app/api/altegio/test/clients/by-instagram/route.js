"use strict";(()=>{var e={};e.id=1213,e.ids=[1213],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7200:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>$,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>v,staticGenerationAsyncStorage:()=>b});var i={};a.r(i),a.d(i,{GET:()=>u,dynamic:()=>h,runtime:()=>p});var n=a(9303),s=a(8716),l=a(670),r=a(7070),o=a(1756),c=a(7582);async function m(e,t=1,a=100){try{let i=`/company/${e}/clients/search`,n=JSON.stringify({page:t,page_size:a,fields:["id","name","phone","email","custom_fields","card_number","note"],order_by:"last_visit_date",order_by_direction:"desc"}),s=await (0,c.B)(i,{method:"POST",body:n}),l=[],r=!1;if(Array.isArray(s))r=(l=s).length>=a;else if(s&&"object"==typeof s&&("data"in s&&Array.isArray(s.data)?r=(l=s.data).length>=a:"clients"in s&&Array.isArray(s.clients)?r=(l=s.clients).length>=a:"items"in s&&Array.isArray(s.items)&&(r=(l=s.items).length>=a),"meta"in s&&s.meta)){let e=s.meta;if(void 0!==e.total_count&&void 0!==e.page&&void 0!==e.page_size){let t=Math.ceil(e.total_count/e.page_size);r=e.page<t}}return console.log(`[altegio/clients-search] Page ${t}: got ${l.length} clients, hasMore: ${r}`),{clients:l,hasMore:r}}catch(e){throw console.error(`[altegio/clients-search] Failed to get clients page ${t}:`,e),e}}async function g(e,t=1e3,a=100){let i=[],n=1,s=!0;for(;i.length<t&&s;)try{let{clients:l,hasMore:r}=await m(e,n,a);if(0===l.length){s=!1;break}let o=new Set(i.map(e=>e.id)),c=l.filter(e=>!o.has(e.id));i.push(...c),console.log(`[altegio/clients-search] Total clients so far: ${i.length}`),s=r&&i.length<t,n++,s&&await new Promise(e=>setTimeout(e,200))}catch(e){console.error(`[altegio/clients-search] Error on page ${n}:`,e),s=!1;break}return i.slice(0,t)}var d=a(4044);let h="force-dynamic",p="nodejs";async function u(e){try{(0,d.cC)();let t=process.env.ALTEGIO_COMPANY_ID;if(!t)return r.NextResponse.json({ok:!1,error:"ALTEGIO_COMPANY_ID not set in environment variables"},{status:400});let i=parseInt(t,10),n=e.nextUrl.searchParams.get("instagram");if(!n)return r.NextResponse.json({ok:!1,error:"Instagram parameter is required. Use ?instagram=..."},{status:400});let s=n.replace(/^@/,"").trim().toLowerCase();console.log(`[altegio/test/clients/by-instagram] Searching for client with Instagram: ${s}`),console.log("[altegio/test/clients/by-instagram] Fetching up to 1000 clients with pagination...");let l=[];try{l=await g(i,1e3,100),console.log(`[altegio/test/clients/by-instagram] Received ${l.length} clients via paginated search`)}catch(e){console.warn("[altegio/test/clients/by-instagram] Paginated search failed, trying direct fetch:",e);try{l=await (0,o.Z)(i,1e3),console.log(`[altegio/test/clients/by-instagram] Received ${l.length} clients via direct fetch`)}catch(e){throw console.error("[altegio/test/clients/by-instagram] Both methods failed:",e),e}}console.log(`[altegio/test/clients/by-instagram] Total clients for search: ${l.length}`);let c=l.filter(e=>e.email&&e.email.includes("@"));if(console.log(`[altegio/test/clients/by-instagram] Clients with email: ${c.length}`),c.length>0){let e=c.slice(0,5).map(e=>{let t=e.email.split("@");return{email:e.email,instagramPart:t[0]?.trim().toLowerCase()||null}});console.log("[altegio/test/clients/by-instagram] Sample email Instagram parts:",e)}let m=e=>{if(!e.email||!e.email.includes("@"))return!1;let t=e.email.split("@");if(t[0]&&t[0].trim()){let a=t[0].trim().toLowerCase()===s;return a&&console.log(`[altegio/test/clients/by-instagram] ✅ Match found! Client ${e.id}, email: ${e.email}`),a}return!1},h=l.find(m);if(!h){console.log("[altegio/test/clients/by-instagram] Client not found in main list, trying via appointments...");try{let{getUpcomingAppointments:e}=await a.e(9512).then(a.bind(a,9512)),t=await e(i,90,!0),n=new Map;for(let e of t)e.client&&e.client.id&&!n.has(e.client.id)&&n.set(e.client.id,e.client);for(let e of(console.log(`[altegio/test/clients/by-instagram] Found ${n.size} unique clients via appointments`),n.values()))if(m(e)){h=e,console.log(`[altegio/test/clients/by-instagram] ✅ Found via appointments! Client ${e.id}, email: ${e.email}`);break}}catch(e){console.warn("[altegio/test/clients/by-instagram] Failed to search via appointments:",e)}}if(!h){let e=c.filter(e=>{let t=e.email.split("@"),a=t[0]?.trim().toLowerCase()||"";return a.includes(s)||s.includes(a)}).slice(0,5).map(e=>{let t=e.email.split("@");return{id:e.id,name:e.name,email:e.email,instagramPart:t[0]?.trim().toLowerCase()||null}}),t=c.slice(0,10).map(e=>{let t=e.email.split("@");return{id:e.id,name:e.name,email:e.email,instagramPart:t[0]?.trim().toLowerCase()||null}});return r.NextResponse.json({ok:!1,error:`Client with Instagram username "${n}" not found`,instagram:n,normalizedInstagram:s,diagnostics:{searchedClients:l.length,clientsWithEmail:c.length,clientsWithoutEmail:l.length-c.length},similarMatches:e.length>0?e:void 0,sampleEmails:t.length>0?t:void 0,note:e.length>0?`Found ${e.length} similar matches (see similarMatches array)`:`Searched ${l.length} clients (${c.length} with email). Check sampleEmails for format examples.`},{status:404})}let p=h.email.split("@"),u=p[0]?.trim()||null;return r.NextResponse.json({ok:!0,instagram:n,client:{id:h.id,name:h.name,phone:h.phone,email:h.email,instagramUsername:u},note:"Instagram username extracted from email field (part before @)"})}catch(t){console.error("[altegio/test/clients/by-instagram] Error:",t);let e=t instanceof Error?t.message:String(t);return r.NextResponse.json({ok:!1,error:e},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/altegio/test/clients/by-instagram/route",pathname:"/api/altegio/test/clients/by-instagram",filename:"route",bundlePath:"app/api/altegio/test/clients/by-instagram/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/test/clients/by-instagram/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:b,serverHooks:v}=y,w="/api/altegio/test/clients/by-instagram/route";function $(){return(0,l.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:b})}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[8948,5972,7582,1756],()=>a(7200));module.exports=i})();