"use strict";(()=>{var e={};e.id=665,e.ids=[665],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9739:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>_,staticGenerationAsyncStorage:()=>p});var s={};i.r(s),i.d(s,{GET:()=>d,dynamic:()=>m,runtime:()=>u});var n=i(9303),a=i(8716),l=i(670),r=i(7070),o=i(1756),c=i(4044);let m="force-dynamic",u="nodejs";async function d(e){try{(0,c.cC)();let e=process.env.ALTEGIO_COMPANY_ID;if(!e)return r.NextResponse.json({ok:!1,error:"ALTEGIO_COMPANY_ID not set in environment variables"},{status:400});let t=parseInt(e,10);if(isNaN(t))return r.NextResponse.json({ok:!1,error:`Invalid ALTEGIO_COMPANY_ID: ${e}`},{status:400});let s=!1;try{let{getCompany:e}=await i.e(9668).then(i.bind(i,9668)),n=await e(t);s=!!n,console.log(`[altegio/test/clients] Company ${t} exists: ${s}`,n?{id:n.id,title:n.title||n.public_title}:"")}catch(e){console.warn(`[altegio/test/clients] Failed to verify company ${t}:`,e)}if(!s)return r.NextResponse.json({ok:!1,error:`Company with ID ${t} not found. Please check ALTEGIO_COMPANY_ID environment variable.`,companyId:t},{status:400});let n=[],a="direct",l="";try{n=await (0,o.Z)(t,10),a="direct";let e=n.filter(e=>e.name||e.phone||e.email||Object.keys(e).length>1);if(e.length<n.length&&console.log(`[altegio/test/clients] ⚠️ Filtered ${n.length-e.length} clients without data (only ID or empty)`),n.length>0){console.log("[altegio/test/clients] ⚠️ Fetching full client details to get custom_fields (Card number, Note, Instagram)...");let e=[],i=0;for(let s of n.slice(0,10))try{let i=await (0,o.s)(t,s.id);i?(e.push(i),console.log(`[altegio/test/clients] ✅ Got full info for client ${s.id}:`,{name:i.name,hasCustomFields:!!i.custom_fields,customFieldsKeys:i.custom_fields?Object.keys(i.custom_fields):[],customFieldsData:i.custom_fields||null,allKeys:Object.keys(i)}),i.custom_fields||console.warn(`[altegio/test/clients] ⚠️ Client ${s.id} has no custom_fields! Full structure:`,JSON.stringify(i,null,2).substring(0,1e3))):e.push(s),await new Promise(e=>setTimeout(e,100))}catch(t){i++,console.warn(`[altegio/test/clients] Failed to get full info for client ${s.id}:`,t),e.push(s)}console.log(`[altegio/test/clients] Summary: ${e.length} clients with full details, ${i} skipped`),n=e}}catch(e){l=e instanceof Error?e.message:String(e),console.warn("[altegio/test/clients] Direct API failed, trying via appointments...",l);try{let{getUpcomingAppointments:e}=await i.e(9512).then(i.bind(i,9512)),s=await e(t,90,!0),l=new Map;for(let e of s)if(e.client&&e.client.id){let t=e.client.id;l.has(t)||l.set(t,e.client)}n=Array.from(l.values()).slice(0,10),a="via_appointments",console.log(`[altegio/test/clients] ✅ Got ${n.length} clients via appointments`)}catch(t){let e=t instanceof Error?t.message:String(t);return console.error("[altegio/test/clients] Appointments fallback also failed:",e),r.NextResponse.json({ok:!1,error:`Direct API error: ${l}. Appointments fallback also failed: ${e}`,directError:l,appointmentsError:e,recommendation:"Перевірте логи Vercel для деталей. Можливо, потрібно звернутися до підтримки Altegio щодо прав доступу для непублічних програм."},{status:500})}}if(0===n.length)return r.NextResponse.json({ok:!0,message:`No clients found (source: ${a})`,source:a,clientsCount:0,clients:[],firstClientStructure:null,instagramFieldFound:!1,instagramFieldName:null});let m=n[0],u=Object.keys(m),d=["instagram-user-name","instagram_user_name","instagramUsername","instagram_username","instagram","instagram_user","insta_username","instausername","insta","gram"],f=!1,g=null,p=null,_=["id","name","phone","email","created_at","updated_at","company_id"];for(let e of d){let t=u.find(t=>{if(_.includes(t.toLowerCase()))return!1;let i=t.toLowerCase().replace(/[-_]/g,""),s=e.toLowerCase().replace(/[-_]/g,"");return i===s||i.includes(s)||s.includes(i)});if(t&&m[t]){let e=String(m[t]).trim();if(e&&e!==m.name){f=!0,g=t,p=e;break}}}if(!f)for(let e of["instagram","insta","gram"]){let t=u.find(t=>!_.includes(t.toLowerCase())&&t.toLowerCase().includes(e.toLowerCase()));if(t&&m[t]){let e=String(m[t]).trim();if(e&&e!==m.name){f=!0,g=t,p=e;break}}}if(m.email&&m.email.includes("@")){let e=m.email.split("@");e[0]&&e[0].trim()&&(f=!0,g="email (Instagram username)",p=e[0].trim(),console.log(`[altegio/test/clients] ✅ Found Instagram in email field: ${p} from ${m.email}`))}if(!f&&m.custom_fields){if(console.log("[altegio/test/clients] Checking custom_fields for Instagram:",Object.keys(m.custom_fields)),m.custom_fields["instagram-user-name"])f=!0,g="custom_fields.instagram-user-name",p=String(m.custom_fields["instagram-user-name"]).trim(),console.log("[altegio/test/clients] ✅ Found Instagram in custom_fields.instagram-user-name:",p);else for(let e of d){let t=Object.keys(m.custom_fields).find(t=>{let i=t.toLowerCase().replace(/[-_]/g,""),s=e.toLowerCase().replace(/[-_]/g,"");return i===s||i.includes(s)||s.includes(i)});if(t&&m.custom_fields[t]){let e=String(m.custom_fields[t]).trim();if(e&&e!==m.name){f=!0,g=`custom_fields.${t}`,p=e,console.log("[altegio/test/clients] ✅ Found Instagram in custom_fields:",g,p);break}}}}let h=["id","name","phone","email","created_at","updated_at","company_id"],y=u.filter(e=>!h.includes(e)),b={id:m.id,name:m.name,phone:m.phone,email:m.email,allKeys:u,customFields:y,customFieldsData:y.reduce((e,t)=>(e[t]=m[t],e),{}),custom_fields:m.custom_fields||null,instagramField:f?{name:g,value:p}:null},w=n.map(e=>{let t=Object.keys(e),i=null,s=null,n=null;if(e.email&&e.email.includes("@")){let t=e.email.split("@");t[0]&&t[0].trim()&&(i=t[0].trim(),console.log(`[altegio/test/clients] ✅ Found Instagram in email for client ${e.id}: ${i} from ${e.email}`))}let a=["card_number","cardNumber","card-number","card","card_id","loyalty_card"];for(let t of a)if(e[t]){s=String(e[t]).trim();break}if(!s&&e.custom_fields){for(let t of a)if(e.custom_fields[t]){s=String(e.custom_fields[t]).trim();break}}let l=["note","notes","comment","comments","description","remarks"];for(let t of l)if(e[t]){n=String(e[t]).trim();break}if(!n&&e.custom_fields){for(let t of l)if(e.custom_fields[t]){n=String(e.custom_fields[t]).trim();break}}let r=["id","name","phone","email","created_at","updated_at","company_id"],o=["instagram-user-name","instagram_user_name","instagramUsername","instagram_username","instagram","instagram_user","insta_username","instausername","insta","gram"];for(let s of o){let n=t.find(e=>{if(r.includes(e.toLowerCase()))return!1;let t=e.toLowerCase().replace(/[-_]/g,""),i=s.toLowerCase().replace(/[-_]/g,"");return t===i||t.includes(i)||i.includes(t)});if(n&&e[n]){let t=String(e[n]).trim();if(t&&t!==e.name){i=t;break}}}if(!i)for(let s of["instagram","insta","gram"]){let n=t.find(e=>!r.includes(e.toLowerCase())&&e.toLowerCase().includes(s.toLowerCase()));if(n&&e[n]){let t=String(e[n]).trim();if(t&&t!==e.name){i=t;break}}}if(!i&&e.custom_fields)for(let t of o){let s=Object.keys(e.custom_fields).find(e=>e.toLowerCase().replace(/[-_]/g,"")===t.toLowerCase().replace(/[-_]/g,""));if(s&&e.custom_fields[s]){i=String(e.custom_fields[s]);break}}return{id:e.id,name:e.name||"Без імені",phone:e.phone||"—",email:e.email||"—",instagram:i||"—",cardNumber:s||"—",note:n||"—",allFields:Object.fromEntries(Object.entries(e).map(([e,t])=>[e,"string"==typeof t&&t.length>100?t.substring(0,100)+"...":t]))}});return r.NextResponse.json({ok:!0,message:`Found ${n.length} clients (source: ${a})`,source:a,clientsCount:n.length,clients:w,firstClientStructure:{...b,rawStructure:JSON.stringify(m,null,2)},instagramFieldFound:f,instagramFieldName:g,instagramFieldValue:p,allKeys:u,customFields:y,note:f?`✅ Instagram field found: ${g} = ${p}`:"⚠️ Instagram field not found. Showing full structure below for analysis."})}catch(t){console.error("[altegio/test/clients] Error:",t);let e=t instanceof Error?t.message:String(t);return r.NextResponse.json({ok:!1,error:e},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/altegio/test/clients/route",pathname:"/api/altegio/test/clients",filename:"route",bundlePath:"app/api/altegio/test/clients/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/test/clients/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:p,serverHooks:_}=f,h="/api/altegio/test/clients/route";function y(){return(0,l.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:p})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[8948,5972,7582,1756],()=>i(9739));module.exports=s})();