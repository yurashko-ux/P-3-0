"use strict";(()=>{var e={};e.id=3942,e.ids=[3942],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4681:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>v,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var i={};a.r(i),a.d(i,{GET:()=>u,POST:()=>m,dynamic:()=>c,runtime:()=>g});var o=a(9303),r=a(8716),s=a(670),n=a(7070),l=a(4332),d=a(2804);let c="force-dynamic",g="nodejs";async function m(e){try{let t=await e.json().catch(()=>({}));console.log("[altegio/webhook] Received webhook:",{timestamp:new Date().toISOString(),bodyKeys:Object.keys(t),eventType:t.event||t.type||"unknown"});try{let e={receivedAt:new Date().toISOString(),event:t.event||t.type||null,body:t},a=JSON.stringify(e);await l.kvWrite.lpush("altegio:webhook:log",a),await l.kvWrite.ltrim("altegio:webhook:log",0,49)}catch(e){console.warn("[altegio/webhook] Failed to persist webhook to KV:",e)}if("record"===t.resource){let e=t.resource_id,a=t.data?.visit_id||t.resource_id,i=t.status,o=t.data||{};if(console.log("[altegio/webhook] Processing record event:",{recordId:e,visitId:a,status:i,hasData:!!o,dataKeys:Object.keys(o),datetime:o.datetime,hasClient:!!o.client,clientKeys:o.client?Object.keys(o.client):[],hasServices:Array.isArray(o.services)&&o.services.length>0,servicesCount:Array.isArray(o.services)?o.services.length:0}),"delete"===i)try{let e=`altegio:reminder:byVisit:${a}`,t=await l.kvRead.getRaw(e);if(t){for(let e of JSON.parse(t)){let t=`altegio:reminder:job:${e}`,a=await l.kvRead.getRaw(t);if(a){let e=JSON.parse(a);e.status="canceled",e.updatedAt=Date.now(),e.canceledAt=Date.now(),await l.kvWrite.setRaw(t,JSON.stringify(e))}}await l.kvWrite.setRaw(e,JSON.stringify([]))}console.log(`[altegio/webhook] ✅ Canceled reminders for deleted visit ${a}`)}catch(e){console.error(`[altegio/webhook] ❌ Failed to cancel reminders for visit ${a}:`,e)}else if("update"===i||"create"===i){try{let t=Array.isArray(o.services)&&o.services.length>0?o.services[0]:o.service||null,r={visitId:a,recordId:e,status:i,datetime:o.datetime,serviceId:t?.id||o.service_id,serviceName:t?.title||t?.name||o.service?.title||o.service?.name,staffId:o.staff?.id||o.staff_id,clientId:o.client?.id||o.client_id,companyId:o.company_id,receivedAt:new Date().toISOString(),data:{service:t||o.service,services:o.services,staff:o.staff,client:o.client}},s=JSON.stringify(r);await l.kvWrite.lpush("altegio:records:log",s),await l.kvWrite.ltrim("altegio:records:log",0,9999),console.log(`[altegio/webhook] ✅ Saved record event for stats: visitId=${a}, recordId=${e}, serviceId=${r.serviceId}, serviceName=${r.serviceName}, datetime=${o.datetime}`)}catch(e){console.warn("[altegio/webhook] Failed to save record event for stats:",e)}try{let e=o.datetime;if(!e)return console.log(`[altegio/webhook] ⏭️ Skipping visit ${a} - no datetime`),n.NextResponse.json({ok:!0,received:!0,skipped:"no_datetime"});let i=new Date(e).getTime(),r=Date.now();if(i<=r)return console.log(`[altegio/webhook] ⏭️ Skipping past visit ${a} (datetime: ${e})`),n.NextResponse.json({ok:!0,received:!0,skipped:"past_visit"});let s=await (0,d.v$)(),c=o.client||{};console.log("[altegio/webhook] Client data:",{clientId:c.id,clientName:c.display_name||c.name,hasCustomFields:!!c.custom_fields,customFieldsKeys:c.custom_fields?Object.keys(c.custom_fields):[],customFields:c.custom_fields});let g=c.custom_fields?.["instagram-user-name"]||c.custom_fields?.instagram_username||c.custom_fields?.instagram||null;if(!g)return console.log(`[altegio/webhook] ⏭️ Skipping visit ${a} - no Instagram username`,{customFields:c.custom_fields,allClientKeys:Object.keys(c)}),n.NextResponse.json({ok:!0,received:!0,skipped:"no_instagram"});if("mykolayyurashko"!==g.toLowerCase())return console.log(`[altegio/webhook] ⏭️ Skipping visit ${a} - not test client (instagram: ${g})`),n.NextResponse.json({ok:!0,received:!0,skipped:"not_test_client"});let m=`altegio:reminder:byVisit:${a}`,u=await l.kvRead.getRaw(m);u&&JSON.parse(u);let v=[];for(let n of(console.log(`[altegio/webhook] Processing ${s.length} rules for visit ${a}`,{datetime:e,visitAt:new Date(i).toISOString(),now:new Date(r).toISOString(),daysUntilVisit:Math.round((i-r)/864e5)}),s)){let s;let m=(0,d.mw)(e,n.daysBefore);if(console.log(`[altegio/webhook] Rule ${n.id} (${n.daysBefore} days before):`,{dueAt:new Date(m).toISOString(),now:new Date(r).toISOString(),visitAt:new Date(i).toISOString(),isPast:m<=r,diffMs:m-r,diffHours:Math.round((m-r)/36e5)}),m<=r){console.log(`[altegio/webhook] ⏭️ Skipping rule ${n.id} for visit ${a} - dueAt in past`,{dueAt:new Date(m).toISOString(),now:new Date(r).toISOString(),visitAt:new Date(i).toISOString(),daysBefore:n.daysBefore,diffMs:m-r});continue}let u=(0,d.po)(a,n.id),p=`altegio:reminder:job:${u}`,f=await l.kvRead.getRaw(p);f?((s=JSON.parse(f)).datetime=e,s.dueAt=m,s.updatedAt=Date.now(),"canceled"===s.status&&(s.status="pending",delete s.canceledAt)):s={id:u,ruleId:n.id,visitId:a,companyId:o.company_id||t.company_id||0,clientId:c.id||0,instagram:g,datetime:e,dueAt:m,payload:{clientName:c.display_name||c.name||"Клієнт",phone:c.phone||null,email:c.email||null,serviceTitle:o.services?.[0]?.title||null,staffName:o.staff?.name||null},status:"pending",attempts:0,createdAt:Date.now(),updatedAt:Date.now()},await l.kvWrite.setRaw(p,JSON.stringify(s)),v.push(u);let y="altegio:reminder:index",w=await l.kvRead.getRaw(y),h=[];if(w)try{let e=JSON.parse(w);Array.isArray(e)?h=e:(console.warn("[altegio/webhook] Index is not an array, resetting:",typeof e,e),h=[],await l.kvWrite.setRaw(y,JSON.stringify(h)))}catch(e){console.warn("[altegio/webhook] Failed to parse index:",e),h=[],await l.kvWrite.setRaw(y,JSON.stringify(h))}h.includes(u)?console.log(`[altegio/webhook] Job ${u} already in index`):(h.push(u),await l.kvWrite.setRaw(y,JSON.stringify(h)),console.log(`[altegio/webhook] Added job ${u} to index, total: ${h.length}`))}await l.kvWrite.setRaw(m,JSON.stringify(v)),console.log(`[altegio/webhook] ✅ Created/updated ${v.length} reminders for visit ${a}`)}catch(e){console.error(`[altegio/webhook] ❌ Failed to process ${i} for visit ${a}:`,e)}}}return n.NextResponse.json({ok:!0,received:!0,timestamp:new Date().toISOString()})}catch(e){return console.error("[altegio/webhook] Error processing webhook:",e),n.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:200})}}async function u(e){try{let t=e.nextUrl.searchParams.get("limit"),a=t?Math.min(Math.max(parseInt(t,10)||10,1),100):10,i=(await l.kvRead.lrange("altegio:webhook:log",0,a-1)).map(e=>{try{return JSON.parse(e)}catch{return{raw:e}}}).filter(Boolean),o=i.filter(e=>e.body?.resource==="record").map(e=>({receivedAt:e.receivedAt,status:e.body?.status,visitId:e.body?.resource_id,datetime:e.body?.data?.datetime,serviceId:e.body?.data?.service?.id||e.body?.data?.service_id,serviceName:e.body?.data?.service?.title||e.body?.data?.service?.name||"Невідома послуга",staffId:e.body?.data?.staff?.id||e.body?.data?.staff_id,staffName:e.body?.data?.staff?.name||e.body?.data?.staff?.display_name||"Невідомий майстер",clientId:e.body?.data?.client?.id,clientName:e.body?.data?.client?.display_name||e.body?.data?.client?.name,fullBody:e.body})),r=[];try{r=(await l.kvRead.lrange("altegio:records:log",0,a-1)).map(e=>{try{let t=JSON.parse(e);if(t&&"object"==typeof t&&"value"in t&&"string"==typeof t.value)try{return JSON.parse(t.value)}catch{return null}return t}catch{return null}}).filter(e=>e&&e.visitId&&e.datetime)}catch(e){console.warn("[webhook GET] Failed to read records log:",e)}let s=o.length>0?o[0]:r.length>0?{visitId:r[0].visitId,datetime:r[0].datetime,serviceId:r[0].serviceId,serviceName:r[0].serviceName,staffId:r[0].staffId,receivedAt:r[0].receivedAt,status:"saved"}:null;return n.NextResponse.json({ok:!0,message:"Altegio webhook endpoint is active",timestamp:new Date().toISOString(),eventsCount:i.length,recordEventsCount:o.length,savedRecordsCount:r.length,lastRecordEvent:s,lastRecordEvents:o.slice(0,10),savedRecords:r.slice(0,10),allEvents:i.slice(0,5)})}catch(e){return n.NextResponse.json({ok:!1,message:"Failed to read webhook log",error:e instanceof Error?e.message:String(e)},{status:500})}}let v=new o.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/altegio/webhook/route",pathname:"/api/altegio/webhook",filename:"route",bundlePath:"app/api/altegio/webhook/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/webhook/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:y}=v,w="/api/altegio/webhook/route";function h(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},2804:(e,t,a)=>{a.d(t,{VE:()=>o,mw:()=>n,po:()=>s,v$:()=>r});let i=[{id:"before_7d",daysBefore:7,active:!0,channel:"instagram_dm",template:"Нагадуємо про ваш візит {date} о {time} у Home of Beauty. Чекаємо вас! ❤️"},{id:"before_3d",daysBefore:3,active:!0,channel:"instagram_dm",template:"Через {daysLeft} дні(в) у вас запис {date} о {time}. Підготуйтеся до візиту!"},{id:"before_1d",daysBefore:1,active:!0,channel:"instagram_dm",template:"Завтра у вас візит {date} о {time}. Чекаємо вас! ❤️"}];function o(e,t){let a=new Date(e.datetime),i=a.toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit",year:"numeric"}),o=a.toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"}),r=Math.round((a.getTime()-Date.now())/864e5);return t.template.replace("{clientName}",e.payload.clientName||"").replace("{instagram}",e.instagram?"@"+e.instagram:"").replace("{date}",i).replace("{time}",o).replace("{service}",e.payload.serviceTitle||"").replace("{master}",e.payload.staffName||"").replace("{daysLeft}",String(r))}async function r(){try{let e;let{kvRead:t}=await Promise.resolve().then(a.bind(a,4332)),o=await t.getRaw("altegio:reminder:rules");if(!o)return i.filter(e=>e.active);if("string"==typeof o)try{e=JSON.parse(o)}catch{e=o}else e=o;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}if(Array.isArray(e)&&e.length>0)return e.filter(e=>e.active)}catch(e){console.warn("[reminders] Failed to load rules from KV, using defaults:",e)}return i.filter(e=>e.active)}function s(e,t){return`${e}:${t}`}function n(e,t){return new Date(e).getTime()-864e5*t}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[8948,5972,4332],()=>a(4681));module.exports=i})();