"use strict";(()=>{var e={};e.id=9576,e.ids=[9576],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9432:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v});var r={};a.r(r),a.d(r,{GET:()=>u,dynamic:()=>n,runtime:()=>l});var o=a(9303),s=a(8716),d=a(670),i=a(7070),c=a(4332);let n="force-dynamic",l="nodejs";async function u(e){try{let t=e.nextUrl.searchParams.get("limit"),a=t?Math.min(Math.max(parseInt(t,10)||20,1),100):20,r=(await c.kvRead.lrange("altegio:webhook:log",0,a-1)).map(e=>{try{let t=JSON.parse(e);if(t&&"object"==typeof t&&"value"in t&&"string"==typeof t.value)try{return JSON.parse(t.value)}catch{}return t}catch{return{raw:e}}}).filter(Boolean),o=r.filter(e=>e.body?.resource==="record").map(e=>({receivedAt:e.receivedAt,status:e.body?.status,visitId:e.body?.resource_id,datetime:e.body?.data?.datetime,serviceId:e.body?.data?.service?.id||e.body?.data?.service_id,serviceName:e.body?.data?.service?.title||e.body?.data?.service?.name||"Невідома послуга",staffId:e.body?.data?.staff?.id||e.body?.data?.staff_id,staffName:e.body?.data?.staff?.name||e.body?.data?.staff?.display_name||"Невідомий майстер",clientId:e.body?.data?.client?.id,clientName:e.body?.data?.client?.display_name||e.body?.data?.client?.name||"Невідомий клієнт",fullBody:e.body})),s=(await c.kvRead.lrange("altegio:records:log",0,a-1)).map(e=>{try{return JSON.parse(e)}catch{return null}}).filter(e=>e&&e.visitId&&e.datetime),d=o.length>0?o[0]:s.length>0?{visitId:s[0].visitId,datetime:s[0].datetime,serviceId:s[0].serviceId,serviceName:s[0].serviceName,staffId:s[0].staffId,receivedAt:s[0].receivedAt,status:"saved"}:null;return i.NextResponse.json({ok:!0,summary:{totalWebhookEvents:r.length,recordEventsFromWebhook:o.length,savedRecords:s.length,lastRecordEvent:d},lastRecordEvents:o.slice(0,10),savedRecords:s.slice(0,10),allWebhookEvents:r.slice(0,5)})}catch(e){return console.error("[webhook/check-records] Error:",e),i.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/altegio/webhook/check-records/route",pathname:"/api/altegio/webhook/check-records",filename:"route",bundlePath:"app/api/altegio/webhook/check-records/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/webhook/check-records/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:v,serverHooks:h}=p,y="/api/altegio/webhook/check-records/route";function b(){return(0,d.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,4332],()=>a(9432));module.exports=r})();