"use strict";(()=>{var e={};e.id=8922,e.ids=[8922],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7350:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>_,patchFetch:()=>I,requestAsyncStorage:()=>h,routeModule:()=>y,serverHooks:()=>A,staticGenerationAsyncStorage:()=>b});var r={};s.r(r),s.d(r,{POST:()=>p,dynamic:()=>d,runtime:()=>u});var a=s(9303),n=s(8716),o=s(670),i=s(7070),c=s(4332),l=s(2804);let d="force-dynamic",u="nodejs";async function g(e,t,s,r){let a="mykolayyurashko";if(e!==a)return console.log(`[test-send] ‚è≠Ô∏è Skipping @${e} - not test account (only ${a} allowed)`),{success:!1,error:`Test mode: only @${a} allowed`};console.log(`[test-send] üì§ Sending Instagram DM to @${e}:`,{message:t,jobId:s.id,visitId:s.visitId,visitDate:s.datetime});let n=process.env.MANYCHAT_API_KEY||process.env.ManyChat_API_Key||process.env.MANYCHAT_API_TOKEN||process.env.MC_API_KEY||process.env.MANYCHAT_APIKEY;if(n)try{console.log("[test-send] Attempting to send via ManyChat API");let s=await m(e,t,n,r);if(s.success)return s;console.warn("[test-send] ManyChat API failed, trying Instagram Graph API:",s.error)}catch(e){console.warn("[test-send] ManyChat API error:",e)}let o=process.env.INSTAGRAM_ACCESS_TOKEN;if(o)try{console.log("[test-send] Attempting to send via Instagram Graph API");let s=await f(e,t,o);if(s.success)return s;console.warn("[test-send] Instagram Graph API failed:",s.error)}catch(e){console.warn("[test-send] Instagram Graph API error:",e)}return console.log(`[test-send] ‚ö†Ô∏è No API configured, simulating send (mock mode)`),{success:!0,messageId:`mock_${Date.now()}_${s.id}`}}async function m(e,t,s,r){try{let a=null,n=null,o=e.startsWith("@")?e.slice(1):e;console.log(`[test-send] Searching ManyChat subscriber for Instagram username: ${o} (original: ${e})`),console.log("[test-send] ===== METHOD 1: getSubscribers with ig_username filter =====");try{for(let e=1;e<=10;e++){let t=`https://api.manychat.com/fb/subscriber/getSubscribers?page=${e}&limit=100`;console.log(`[test-send] Fetching page ${e} from getSubscribers...`);let r=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${s}`}});if(r.ok){let t=await r.json(),s=t?.data||[];if(console.log(`[test-send] Page ${e}: received ${s.length} subscribers`),1===e&&s.length>0){let e=s[0];console.log("[test-send] Sample subscriber structure:",JSON.stringify({id:e.id,name:e.name,ig_username:e.ig_username,has_ig_username:!!e.ig_username,keys:Object.keys(e).slice(0,10)},null,2))}let i=s.find(e=>{let t=e.ig_username?.toLowerCase().trim(),s=o.toLowerCase().trim(),r=t===s;return t&&console.log(`[test-send] Checking subscriber ${e.id}: ig_username="${t}" vs search="${s}" -> ${r?"MATCH!":"no match"}`),r});if(i){a=i.id||i.subscriber_id,n=i,console.log(`[test-send] ‚úÖ Found subscriber via getSubscribers on page ${e}: ${a}`,JSON.stringify(i,null,2));break}if(s.length<100){console.log(`[test-send] Last page reached (${s.length} < 100)`);break}}else{let t=await r.text();console.warn(`[test-send] getSubscribers failed on page ${e}: ${r.status} ${t.substring(0,200)}`);break}}a||console.warn(`[test-send] ‚ùå Subscriber not found via getSubscribers after checking up to 10 pages`)}catch(e){console.error("[test-send] getSubscribers error:",e)}if(!a)for(let e of(console.log("[test-send] ===== METHOD 2: findByCustomField ====="),console.log(`[test-send] Trying findByCustomField for Instagram username: "${o}"`),["ig_username","instagram_username","instagram","username","Instagram Username","Instagram"])){if(a)break;console.log(`[test-send] Trying field_id: "${e}"`);let t={field_id:e,field_value:o};console.log("[test-send] Request body:",JSON.stringify(t,null,2));let r=await fetch("https://api.manychat.com/fb/subscriber/findByCustomField",{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(t)}),i=await r.text();if(console.log(`[test-send] Response status: ${r.status} ${r.statusText}`),console.log("[test-send] Response text (first 500 chars):",i.substring(0,500)),r.ok)try{if(n=JSON.parse(i),console.log("[test-send] Response JSON:",JSON.stringify(n,null,2)),a=n?.data?.subscriber_id||n?.subscriber_id||n?.subscriber?.id){console.log(`[test-send] ‚úÖ Found via findByCustomField with field_id: ${e}, subscriber_id: ${a}`);break}console.log(`[test-send] ‚ö†Ô∏è findByCustomField (${e}) returned OK but no subscriber_id`)}catch(e){console.error("[test-send] Failed to parse findByCustomField response as JSON:",e),console.log("[test-send] Raw response:",i)}else{console.warn(`[test-send] ‚ùå findByCustomField (${e}) failed: ${r.status} ${i}`);try{let e=JSON.parse(i);console.warn("[test-send] Error details:",JSON.stringify(e,null,2))}catch{}}}if(!a&&!r)return{success:!1,error:`Subscriber not found in ManyChat for ${o}. Make sure the user has interacted with your ManyChat bot. You can also provide subscriber_id manually for testing.`};a?console.log(`[test-send] Found subscriber_id: ${a} for ${o}`):r&&console.log(`[test-send] Using manual subscriber_id: ${r} for ${o}`);let i=r||a;if(!i)return{success:!1,error:`Subscriber not found in ManyChat for ${o}. Make sure the user has interacted with your ManyChat bot. You can also provide subscriber_id manually for testing.`};console.log(`[test-send] Using subscriber_id: ${i}${r?" (manual)":" (found via API)"}`);let c=await fetch("https://api.manychat.com/fb/sending/sendContent",{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({subscriber_id:i,data:{version:"v2",content:{messages:[{type:"text",text:t}]}}})});if(!c.ok){let e=await c.text();return{success:!1,error:`ManyChat send failed: ${c.status} ${e}`}}let l=await c.json();return{success:!0,messageId:l?.data?.message_id||`manychat_${Date.now()}`}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}async function f(e,t,s){try{let e=process.env.INSTAGRAM_PAGE_ID;if(!e)return{success:!1,error:"INSTAGRAM_PAGE_ID not configured"};let t=`https://graph.facebook.com/v18.0/${e}?fields=instagram_business_account&access_token=${s}`,r=await fetch(t);if(!r.ok){let e=await r.text();return{success:!1,error:`Failed to get Instagram Business Account: ${r.status} ${e}`}}let a=await r.json();if(!a?.instagram_business_account?.id)return{success:!1,error:"Instagram Business Account not found"};return{success:!1,error:"Instagram Graph API requires additional user lookup (not implemented yet)"}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}async function p(e){try{let{jobId:t,instagram:s,message:r,subscriberId:a}=await e.json();if(!t&&!s)return i.NextResponse.json({ok:!1,error:"jobId or instagram required"},{status:400});let n=null;if(t){let e=`altegio:reminder:job:${t}`,s=await c.kvRead.getRaw(e);if(s){let e;if("string"==typeof s)try{e=JSON.parse(s)}catch{e=s}else e=s;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return i.NextResponse.json({ok:!1,error:`Failed to parse job: ${e instanceof Error?e.message:String(e)}`},{status:400})}n=e}}if(!n){let e=(await (0,l.v$)())[0]||{id:"test",daysBefore:1,active:!0,channel:"instagram_dm",template:r||"–¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: {date} –æ {time}"},t=new Date;t.setDate(t.getDate()+1),t.setHours(15,0,0,0),n={id:"test_send",ruleId:e.id,visitId:999999,companyId:1169323,clientId:0,instagram:s||"mykolayyurashko",datetime:t.toISOString(),dueAt:Date.now(),payload:{clientName:"–¢–µ—Å—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç",phone:null,email:null,serviceTitle:null,staffName:null},status:"pending",attempts:0,createdAt:Date.now(),updatedAt:Date.now()}}let o=await (0,l.v$)(),d=o.find(e=>e.id===n.ruleId)||o[0];if(!d)return i.NextResponse.json({ok:!1,error:"Rule not found"},{status:400});let u=r||(0,l.VE)(n,d),m=await g(n.instagram||s||"",u,n,a),f=m.messageId?.startsWith("manychat_")?"ManyChat API":m.messageId?.startsWith("mock_")?"Mock (—Å–∏–º—É–ª—è—Ü—ñ—è - ManyChat API –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –∞–±–æ subscriber –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ)":"Instagram Graph API";return i.NextResponse.json({ok:m.success,message:m.success?`–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ ${f}!`:"–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏",result:m,job:{id:n.id,instagram:n.instagram,message:u},method:f,diagnostics:{manychatApiKeyConfigured:!!(process.env.MANYCHAT_API_KEY||process.env.ManyChat_API_Key||process.env.MANYCHAT_API_TOKEN||process.env.MC_API_KEY||process.env.MANYCHAT_APIKEY),instagramTokenConfigured:!!process.env.INSTAGRAM_ACCESS_TOKEN,manychatApiKeyName:process.env.MANYCHAT_API_KEY?"MANYCHAT_API_KEY":process.env.ManyChat_API_Key?"ManyChat_API_Key":process.env.MANYCHAT_API_TOKEN?"MANYCHAT_API_TOKEN":process.env.MC_API_KEY?"MC_API_KEY":process.env.MANYCHAT_APIKEY?"MANYCHAT_APIKEY":"not found"}})}catch(e){return console.error("[test-send] Error:",e),i.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/altegio/reminders/test-send/route",pathname:"/api/altegio/reminders/test-send",filename:"route",bundlePath:"app/api/altegio/reminders/test-send/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/reminders/test-send/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:b,serverHooks:A}=y,_="/api/altegio/reminders/test-send/route";function I(){return(0,o.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:b})}},2804:(e,t,s)=>{s.d(t,{VE:()=>a,mw:()=>i,po:()=>o,v$:()=>n});let r=[{id:"before_7d",daysBefore:7,active:!0,channel:"instagram_dm",template:"–ù–∞–≥–∞–¥—É—î–º–æ –ø—Ä–æ –≤–∞—à –≤—ñ–∑–∏—Ç {date} –æ {time} —É Home of Beauty. –ß–µ–∫–∞—î–º–æ –≤–∞—Å! ‚ù§Ô∏è"},{id:"before_3d",daysBefore:3,active:!0,channel:"instagram_dm",template:"–ß–µ—Ä–µ–∑ {daysLeft} –¥–Ω—ñ(–≤) —É –≤–∞—Å –∑–∞–ø–∏—Å {date} –æ {time}. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ—Å—è –¥–æ –≤—ñ–∑–∏—Ç—É!"},{id:"before_1d",daysBefore:1,active:!0,channel:"instagram_dm",template:"–ó–∞–≤—Ç—Ä–∞ —É –≤–∞—Å –≤—ñ–∑–∏—Ç {date} –æ {time}. –ß–µ–∫–∞—î–º–æ –≤–∞—Å! ‚ù§Ô∏è"}];function a(e,t){let s=new Date(e.datetime),r=s.toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit",year:"numeric"}),a=s.toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"}),n=Math.round((s.getTime()-Date.now())/864e5);return t.template.replace("{clientName}",e.payload.clientName||"").replace("{instagram}",e.instagram?"@"+e.instagram:"").replace("{date}",r).replace("{time}",a).replace("{service}",e.payload.serviceTitle||"").replace("{master}",e.payload.staffName||"").replace("{daysLeft}",String(n))}async function n(){try{let e;let{kvRead:t}=await Promise.resolve().then(s.bind(s,4332)),a=await t.getRaw("altegio:reminder:rules");if(!a)return r.filter(e=>e.active);if("string"==typeof a)try{e=JSON.parse(a)}catch{e=a}else e=a;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}if(Array.isArray(e)&&e.length>0)return e.filter(e=>e.active)}catch(e){console.warn("[reminders] Failed to load rules from KV, using defaults:",e)}return r.filter(e=>e.active)}function o(e,t){return`${e}:${t}`}function i(e,t){return new Date(e).getTime()-864e5*t}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972,4332],()=>s(7350));module.exports=r})();