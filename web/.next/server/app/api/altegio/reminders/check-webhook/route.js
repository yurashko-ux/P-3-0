"use strict";(()=>{var e={};e.id=6243,e.ids=[6243],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8583:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var r={};a.r(r),a.d(r,{GET:()=>f,POST:()=>m,dynamic:()=>c,runtime:()=>u});var i=a(9303),o=a(8716),n=a(670),s=a(7070),d=a(4332),l=a(2804);let c="force-dynamic",u="nodejs";async function f(e){try{let e=(await d.kvRead.lrange("altegio:webhook:log",0,19)).map(e=>{try{let t=JSON.parse(e);if(t&&"object"==typeof t&&"value"in t&&"string"==typeof t.value)try{return JSON.parse(t.value)}catch{}return t}catch{return{raw:e}}}).filter(Boolean),t=e.filter(e=>e.body?.resource==="record").map(e=>({receivedAt:e.receivedAt,status:e.body?.status,visitId:e.body?.resource_id,datetime:e.body?.data?.datetime,serviceId:e.body?.data?.service?.id||e.body?.data?.service_id,serviceName:e.body?.data?.service?.title||e.body?.data?.service?.name||"Невідома послуга",staffId:e.body?.data?.staff?.id||e.body?.data?.staff_id,staffName:e.body?.data?.staff?.name||e.body?.data?.staff?.display_name||"Невідомий майстер",clientId:e.body?.data?.client?.id,clientName:e.body?.data?.client?.display_name||e.body?.data?.client?.name,instagram:e.body?.data?.client?.custom_fields?.["instagram-user-name"],fullBody:e.body})),a=[];try{a=(await d.kvRead.lrange("altegio:records:log",0,19)).map(e=>{try{return JSON.parse(e)}catch{return null}}).filter(e=>e&&e.visitId&&e.datetime)}catch(e){console.warn("[check-webhook] Failed to read records log:",e)}let r=t.length>0?t[0]:a.length>0?{visitId:a[0].visitId,datetime:a[0].datetime,serviceId:a[0].serviceId,serviceName:a[0].serviceName,staffId:a[0].staffId,receivedAt:a[0].receivedAt,status:"saved"}:null;return s.NextResponse.json({ok:!0,totalEvents:e.length,recordEvents:t.length,savedRecords:a.length,lastRecordEvent:r,lastRecordEvents:t.slice(0,10),savedRecordsList:a.slice(0,10)})}catch(e){return console.error("[check-webhook] Error:",e),s.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}async function m(e){try{let{visitId:t,datetime:a,instagram:r,clientName:i,companyId:o,clientId:n}=await e.json();if(!t||!a||!r)return s.NextResponse.json({ok:!1,error:"Missing required fields: visitId, datetime, instagram"},{status:400});let c=new Date(a).getTime(),u=Date.now();if(c<=u)return s.NextResponse.json({ok:!1,error:"Visit datetime must be in the future"},{status:400});let f=await (0,l.v$)(),m=`altegio:reminder:byVisit:${t}`,p=[];for(let e of(console.log(`[check-webhook] Creating jobs for visit ${t}`,{datetime:a,visitAt:new Date(c).toISOString(),now:new Date(u).toISOString(),daysUntilVisit:Math.round((c-u)/864e5)}),f)){let s;let f=(0,l.mw)(a,e.daysBefore);if(console.log(`[check-webhook] Rule ${e.id} (${e.daysBefore} days before):`,{dueAt:new Date(f).toISOString(),now:new Date(u).toISOString(),visitAt:new Date(c).toISOString(),isPast:f<=u,diffMs:f-u,diffHours:Math.round((f-u)/36e5)}),f<=u){console.log(`[check-webhook] ⏭️ Skipping rule ${e.id} - dueAt in past`);continue}let m=(0,l.po)(t,e.id),y=`altegio:reminder:job:${m}`,g=await d.kvRead.getRaw(y);if(g){let d;if("string"==typeof g)try{d=JSON.parse(g)}catch{d=g}else d=g;if(d&&"object"==typeof d&&!Array.isArray(d)){let e=d.value??d.result??d.data;if(void 0!==e){if("string"==typeof e)try{d=JSON.parse(e)}catch{d=e}else d=e}}if("string"==typeof d)try{d=JSON.parse(d)}catch(e){console.warn(`[check-webhook] Failed to parse existing job ${m} as JSON:`,e),d=null}d&&"object"==typeof d&&"id"in d?((s=d).datetime=a,s.dueAt=f,s.updatedAt=Date.now(),"canceled"===s.status&&(s.status="pending",delete s.canceledAt)):s={id:m,ruleId:e.id,visitId:t,companyId:o||1169323,clientId:n||0,instagram:r,datetime:a,dueAt:f,payload:{clientName:i||"Тестовий клієнт",phone:null,email:null,serviceTitle:null,staffName:null},status:"pending",attempts:0,createdAt:Date.now(),updatedAt:Date.now()}}else s={id:m,ruleId:e.id,visitId:t,companyId:o||1169323,clientId:n||0,instagram:r,datetime:a,dueAt:f,payload:{clientName:i||"Тестовий клієнт",phone:null,email:null,serviceTitle:null,staffName:null},status:"pending",attempts:0,createdAt:Date.now(),updatedAt:Date.now()};await d.kvWrite.setRaw(y,JSON.stringify(s)),p.push(m);let h="altegio:reminder:index",v=await d.kvRead.getRaw(h),w=[];if(v)try{let e;if("string"==typeof v)try{e=JSON.parse(v)}catch{e=v}else e=v;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}Array.isArray(e)?w=e:(console.warn("[check-webhook] Index is not an array, resetting:",typeof e),w=[],await d.kvWrite.setRaw(h,JSON.stringify(w)))}catch(e){console.warn("[check-webhook] Failed to parse index:",e),w=[],await d.kvWrite.setRaw(h,JSON.stringify(w))}w.includes(m)?console.log(`[check-webhook] Job ${m} already in index`):(w.push(m),await d.kvWrite.setRaw(h,JSON.stringify(w)),console.log(`[check-webhook] Added job ${m} to index, total: ${w.length}`))}return await d.kvWrite.setRaw(m,JSON.stringify(p)),s.NextResponse.json({ok:!0,message:`Created/updated ${p.length} reminder jobs`,visitId:t,jobsCreated:p})}catch(e){return console.error("[check-webhook] Error:",e),s.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/altegio/reminders/check-webhook/route",pathname:"/api/altegio/reminders/check-webhook",filename:"route",bundlePath:"app/api/altegio/reminders/check-webhook/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/reminders/check-webhook/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:h}=p,v="/api/altegio/reminders/check-webhook/route";function w(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},2804:(e,t,a)=>{a.d(t,{VE:()=>i,mw:()=>s,po:()=>n,v$:()=>o});let r=[{id:"before_7d",daysBefore:7,active:!0,channel:"instagram_dm",template:"Нагадуємо про ваш візит {date} о {time} у Home of Beauty. Чекаємо вас! ❤️"},{id:"before_3d",daysBefore:3,active:!0,channel:"instagram_dm",template:"Через {daysLeft} дні(в) у вас запис {date} о {time}. Підготуйтеся до візиту!"},{id:"before_1d",daysBefore:1,active:!0,channel:"instagram_dm",template:"Завтра у вас візит {date} о {time}. Чекаємо вас! ❤️"}];function i(e,t){let a=new Date(e.datetime),r=a.toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit",year:"numeric"}),i=a.toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"}),o=Math.round((a.getTime()-Date.now())/864e5);return t.template.replace("{clientName}",e.payload.clientName||"").replace("{instagram}",e.instagram?"@"+e.instagram:"").replace("{date}",r).replace("{time}",i).replace("{service}",e.payload.serviceTitle||"").replace("{master}",e.payload.staffName||"").replace("{daysLeft}",String(o))}async function o(){try{let e;let{kvRead:t}=await Promise.resolve().then(a.bind(a,4332)),i=await t.getRaw("altegio:reminder:rules");if(!i)return r.filter(e=>e.active);if("string"==typeof i)try{e=JSON.parse(i)}catch{e=i}else e=i;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}if(Array.isArray(e)&&e.length>0)return e.filter(e=>e.active)}catch(e){console.warn("[reminders] Failed to load rules from KV, using defaults:",e)}return r.filter(e=>e.active)}function n(e,t){return`${e}:${t}`}function s(e,t){return new Date(e).getTime()-864e5*t}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,4332],()=>a(8583));module.exports=r})();