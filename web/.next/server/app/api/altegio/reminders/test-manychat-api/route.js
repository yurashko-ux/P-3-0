"use strict";(()=>{var e={};e.id=9870,e.ids=[9870],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2600:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>g,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>h});var a={};s.r(a),s.d(a,{GET:()=>d,dynamic:()=>u,runtime:()=>c});var r=s(9303),i=s(8716),o=s(670),n=s(7070);let u="force-dynamic",c="nodejs";async function d(e){try{let t=e.nextUrl.searchParams.get("instagram")||"mykolayyurashko",s=t.startsWith("@")?t.slice(1):t,a=process.env.MANYCHAT_API_KEY||process.env.ManyChat_API_Key||process.env.MANYCHAT_API_TOKEN||process.env.MC_API_KEY||process.env.MANYCHAT_APIKEY;if(!a)return n.NextResponse.json({ok:!1,error:"ManyChat API Key not configured"});let r=[];try{console.log(`[test-manychat-api] Testing findByName with: ${s}`);let e=await fetch("https://api.manychat.com/fb/subscriber/findByName",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({name:s})}),t=await e.text(),i=null;try{i=JSON.parse(t)}catch{i=t}r.push({method:"findByName",status:e.status,ok:e.ok,response:i,subscriberId:i?.data?.subscriber_id||i?.subscriber_id||i?.subscriber?.id})}catch(e){r.push({method:"findByName",error:e instanceof Error?e.message:String(e)})}try{console.log("[test-manychat-api] Trying to get custom fields list");let e=await fetch("https://api.manychat.com/fb/subscriber/getCustomFields",{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}}),t=await e.text(),s=null;try{s=JSON.parse(t)}catch{s=t}r.push({method:"getCustomFields",status:e.status,ok:e.ok,response:s})}catch(e){r.push({method:"getCustomFields",error:e instanceof Error?e.message:String(e)})}try{console.log("[test-manychat-api] Testing getSubscribers with ig_username filter");let e=!1;for(let t=1;t<=3;t++){let i=`https://api.manychat.com/fb/subscriber/getSubscribers?page=${t}&limit=100`,o=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${a}`}});if(o.ok){let a=await o.json(),i=a?.data||[];if(1===t&&i.length>0){let e=i[0];console.log("[test-manychat-api] Sample subscriber from getSubscribers:",{id:e.id,name:e.name,ig_username:e.ig_username,has_ig_username:!!e.ig_username,keys:Object.keys(e).slice(0,15)})}let n=i.find(e=>e.ig_username?.toLowerCase().trim()===s.toLowerCase().trim());if(n){e=!0,r.push({method:`getSubscribers (page ${t})`,status:o.status,ok:!0,response:{found:!0,subscriber:n,totalOnPage:i.length},subscriberId:n.id||n.subscriber_id});break}if(i.length<100){r.push({method:`getSubscribers (page ${t})`,status:o.status,ok:!0,response:{found:!1,totalOnPage:i.length,isLastPage:!0}});break}}else{let e=await o.text();r.push({method:`getSubscribers (page ${t})`,status:o.status,ok:!1,error:e.substring(0,200)});break}}e||r.push({method:"getSubscribers (summary)",status:200,ok:!0,response:{found:!1,message:"Checked up to 3 pages, subscriber not found"}})}catch(e){r.push({method:"getSubscribers",error:e instanceof Error?e.message:String(e)})}try{console.log("[test-manychat-api] Trying to find by Instagram handle");let e=await fetch("https://api.manychat.com/fb/subscriber/findByInstagram",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({instagram:s})}),t=await e.text(),i=null;try{i=JSON.parse(t)}catch{i=t}r.push({method:"findByInstagram",status:e.status,ok:e.ok,response:i,subscriberId:i?.data?.subscriber_id||i?.subscriber_id||i?.subscriber?.id})}catch(e){r.push({method:"findByInstagram",error:e instanceof Error?e.message:String(e)})}for(let e of["instagram_username","instagram","username","ig_username","Instagram Username","Instagram"])try{console.log(`[test-manychat-api] Testing findByCustomField with field_id: ${e}`);let t=await fetch("https://api.manychat.com/fb/subscriber/findByCustomField",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({field_id:e,field_value:s})}),i=await t.text(),o=null;try{o=JSON.parse(i)}catch{o=i}r.push({method:`findByCustomField (${e})`,status:t.status,ok:t.ok,response:o,subscriberId:o?.data?.subscriber_id||o?.subscriber_id||o?.subscriber?.id})}catch(t){r.push({method:`findByCustomField (${e})`,error:t instanceof Error?t.message:String(t)})}r.filter(e=>e.ok&&e.subscriberId).length;let i=r.find(e=>"getCustomFields"===e.method&&e.ok&&e.response);if(i&&i.response){let e=i.response.data?.fields||i.response.fields||[];console.log(`[test-manychat-api] Found ${e.length} custom fields`);let t=e.filter(e=>e.name?.toLowerCase().includes("instagram")||e.field_id?.toLowerCase().includes("instagram")||e.label?.toLowerCase().includes("instagram"));if(t.length>0)for(let e of(console.log("[test-manychat-api] Found Instagram-related fields:",t),t)){let t=e.field_id||e.id||e.name;try{console.log(`[test-manychat-api] Testing custom field: ${t}`);let e=await fetch("https://api.manychat.com/fb/subscriber/findByCustomField",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({field_id:t,field_value:s})}),i=await e.text(),o=null;try{o=JSON.parse(i)}catch{o=i}r.push({method:`findByCustomField (from getCustomFields: ${t})`,status:e.status,ok:e.ok,response:o,subscriberId:o?.data?.subscriber_id||o?.subscriber_id||o?.subscriber?.id})}catch(e){}}}let o=r.filter(e=>e.ok&&e.subscriberId),u=o.length>0;return n.NextResponse.json({ok:!0,instagram:s,found:u,successfulResults:o,allResults:r,summary:{totalTests:r.length,successful:o.length,failed:r.filter(e=>!e.ok||e.error).length},recommendations:u?[]:["1. Переконайся, що @"+s+" взаємодіяв з ManyChat ботом (написав повідомлення)","2. Перевір в ManyChat Dashboard → Contacts, чи є там цей контакт","3. Якщо контакт є, перевір, чи правильно збережений Instagram username в custom fields","4. Можливо, потрібно використати числовий field_id замість назви поля"]})}catch(e){return console.error("[test-manychat-api] Error:",e),n.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let l=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/altegio/reminders/test-manychat-api/route",pathname:"/api/altegio/reminders/test-manychat-api",filename:"route",bundlePath:"app/api/altegio/reminders/test-manychat-api/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/reminders/test-manychat-api/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:p}=l,g="/api/altegio/reminders/test-manychat-api/route";function b(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:h})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>s(2600));module.exports=a})();