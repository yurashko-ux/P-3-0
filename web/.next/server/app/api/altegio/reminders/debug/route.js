"use strict";(()=>{var e={};e.id=3026,e.ids=[3026],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},990:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{GET:()=>c,dynamic:()=>d,runtime:()=>u});var i=r(9303),n=r(8716),s=r(670),o=r(7070),l=r(4332);let d="force-dynamic",u="nodejs";async function c(e){try{let e=[];try{e=await l.kvRead.lrange("altegio:webhook:log",0,9)}catch(e){console.error("[altegio/reminders/debug] Failed to read webhook log:",e)}let t=e.map(e=>{try{let t=JSON.parse(e);if(t&&"object"==typeof t&&"value"in t&&"string"==typeof t.value)try{return JSON.parse(t.value)}catch{}return t}catch{return{raw:e}}}).filter(Boolean),r=await l.kvRead.getRaw("altegio:reminder:index"),a=[];if(r)try{let e;if("string"==typeof r)try{e=JSON.parse(r)}catch{e=r}else e=r;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}Array.isArray(e)&&(a=e)}catch(e){console.warn("[altegio/reminders/debug] Failed to parse index:",e)}let i=[],n=[];for(let e of a){let t=`altegio:reminder:job:${e}`,r=await l.kvRead.getRaw(t);if(r)try{i.push(JSON.parse(r))}catch(t){console.warn(`[altegio/reminders/debug] Failed to parse job ${e}:`,t)}else n.push(e)}let s=t.map(e=>{try{let t=e.body,r=e.receivedAt;if(!t&&e.value){if("string"==typeof e.value)try{let a=JSON.parse(e.value);t=a.body,r=a.receivedAt||r}catch{}else"object"==typeof e.value&&e.value.body&&(t=e.value.body,r=e.value.receivedAt||r)}return{receivedAt:r||new Date().toISOString(),resource:t?.resource,resource_id:t?.resource_id,status:t?.status,event:t?.event||e.event,type:t?.type||e.type,bodyKeys:t?Object.keys(t):[],datetime:t?.data?.datetime,clientId:t?.data?.client?.id,clientName:t?.data?.client?.display_name||t?.data?.client?.name,instagram:t?.data?.client?.custom_fields?.["instagram-user-name"],fullBody:t||e}}catch(t){return console.warn("[altegio/reminders/debug] Failed to analyze event:",t),{receivedAt:new Date().toISOString(),resource:null,resource_id:null,status:null,event:null,type:null,bodyKeys:[],datetime:null,clientId:null,clientName:null,instagram:null,fullBody:e}}}),d=s.filter(e=>"record"===e.resource),u=new Map;for(let e of i)u.has(e.visitId)||u.set(e.visitId,[]),u.get(e.visitId).push(e);let c=new Map;for(let e of s){let t=e.resource||"unknown";c.set(t,(c.get(t)||0)+1)}return o.NextResponse.json({ok:!0,diagnostics:{webhookEvents:{total:t.length,recordEvents:d.length,lastRecordEvents:d.slice(0,5),eventsByResource:Array.from(c.entries()).map(([e,t])=>({resource:e,count:t})),lastAllEvents:s.slice(0,10)},jobs:{total:i.length,indexTotal:a.length,missingJobs:n.length,missingJobIds:n.slice(0,10),pending:i.filter(e=>"pending"===e.status).length,sent:i.filter(e=>"sent"===e.status).length,failed:i.filter(e=>"failed"===e.status).length,canceled:i.filter(e=>"canceled"===e.status).length,byVisit:Array.from(u.entries()).map(([e,t])=>({visitId:e,count:t.length,jobs:t.map(e=>({id:e.id,ruleId:e.ruleId,status:e.status,instagram:e.instagram,datetime:e.datetime,dueAt:e.dueAt,dueAtFormatted:new Date(e.dueAt).toLocaleString("uk-UA")}))}))},allJobs:i.map(e=>({id:e.id,visitId:e.visitId,ruleId:e.ruleId,status:e.status,instagram:e.instagram,clientName:e.payload.clientName,datetime:e.datetime,dueAt:e.dueAt,dueAtFormatted:new Date(e.dueAt).toLocaleString("uk-UA"),createdAt:new Date(e.createdAt).toLocaleString("uk-UA")}))}})}catch(e){return console.error("[altegio/reminders/debug] Error:",e),o.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/altegio/reminders/debug/route",pathname:"/api/altegio/reminders/debug",filename:"route",bundlePath:"app/api/altegio/reminders/debug/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/reminders/debug/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:y}=g,v="/api/altegio/reminders/debug/route";function f(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:m})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,4332],()=>r(990));module.exports=a})();