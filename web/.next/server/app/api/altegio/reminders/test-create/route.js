"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6207:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>m,dynamic:()=>c,runtime:()=>u});var i=a(9303),n=a(8716),s=a(670),o=a(7070),d=a(4332),l=a(2804);let c="force-dynamic",u="nodejs";async function m(e){try{let{visitId:t,datetime:a,instagram:r,clientName:i}=await e.json();if(!t||!a||!r)return o.NextResponse.json({ok:!1,error:"Missing required fields: visitId, datetime, instagram"},{status:400});let n=new Date(a).getTime(),s=Date.now();if(n<=s)return o.NextResponse.json({ok:!1,error:"Visit datetime must be in the future"},{status:400});let c=await (0,l.v$)(),u=`altegio:reminder:byVisit:${t}`,m=[];for(let e of(console.log(`[test-create] Processing ${c.length} rules for visit ${t}`,{datetime:a,visitAt:new Date(n).toISOString(),now:new Date(s).toISOString(),daysUntilVisit:Math.round((n-s)/864e5)}),c)){let o=(0,l.mw)(a,e.daysBefore);if(console.log(`[test-create] Rule ${e.id} (${e.daysBefore} days before):`,{dueAt:new Date(o).toISOString(),now:new Date(s).toISOString(),visitAt:new Date(n).toISOString(),isPast:o<=s,diffMs:o-s,diffHours:Math.round((o-s)/36e5)}),o<=s){console.log(`[test-create] ⏭️ Skipping rule ${e.id} - dueAt in past`);continue}let c=(0,l.po)(t,e.id),u=`altegio:reminder:job:${c}`,p={id:c,ruleId:e.id,visitId:t,companyId:1169323,clientId:175956222,instagram:r,datetime:a,dueAt:o,payload:{clientName:i||"Тестовий клієнт",phone:null,email:null,serviceTitle:"Тестова послуга",staffName:null},status:"pending",attempts:0,createdAt:Date.now(),updatedAt:Date.now()};await d.kvWrite.setRaw(u,JSON.stringify(p)),m.push(c);let g="altegio:reminder:index",f=await d.kvRead.getRaw(g),y=[];if(f)try{let e=JSON.parse(f);Array.isArray(e)?y=e:(console.warn("[test-create] Index is not an array, resetting:",typeof e,e),y=[],await d.kvWrite.setRaw(g,JSON.stringify(y)))}catch(e){console.warn("[test-create] Failed to parse index:",e),y=[],await d.kvWrite.setRaw(g,JSON.stringify(y))}y.includes(c)?console.log(`[test-create] Job ${c} already in index`):(y.push(c),await d.kvWrite.setRaw(g,JSON.stringify(y)),console.log(`[test-create] Added job ${c} to index, total: ${y.length}`))}return await d.kvWrite.setRaw(u,JSON.stringify(m)),o.NextResponse.json({ok:!0,message:`Created ${m.length} reminder jobs`,visitId:t,jobsCreated:m})}catch(e){return console.error("[test-create] Error:",e),o.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/altegio/reminders/test-create/route",pathname:"/api/altegio/reminders/test-create",filename:"route",bundlePath:"app/api/altegio/reminders/test-create/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/reminders/test-create/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:y}=p,w="/api/altegio/reminders/test-create/route";function v(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},2804:(e,t,a)=>{a.d(t,{VE:()=>i,mw:()=>o,po:()=>s,v$:()=>n});let r=[{id:"before_7d",daysBefore:7,active:!0,channel:"instagram_dm",template:"Нагадуємо про ваш візит {date} о {time} у Home of Beauty. Чекаємо вас! ❤️"},{id:"before_3d",daysBefore:3,active:!0,channel:"instagram_dm",template:"Через {daysLeft} дні(в) у вас запис {date} о {time}. Підготуйтеся до візиту!"},{id:"before_1d",daysBefore:1,active:!0,channel:"instagram_dm",template:"Завтра у вас візит {date} о {time}. Чекаємо вас! ❤️"}];function i(e,t){let a=new Date(e.datetime),r=a.toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit",year:"numeric"}),i=a.toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"}),n=Math.round((a.getTime()-Date.now())/864e5);return t.template.replace("{clientName}",e.payload.clientName||"").replace("{instagram}",e.instagram?"@"+e.instagram:"").replace("{date}",r).replace("{time}",i).replace("{service}",e.payload.serviceTitle||"").replace("{master}",e.payload.staffName||"").replace("{daysLeft}",String(n))}async function n(){try{let e;let{kvRead:t}=await Promise.resolve().then(a.bind(a,4332)),i=await t.getRaw("altegio:reminder:rules");if(!i)return r.filter(e=>e.active);if("string"==typeof i)try{e=JSON.parse(i)}catch{e=i}else e=i;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}if(Array.isArray(e)&&e.length>0)return e.filter(e=>e.active)}catch(e){console.warn("[reminders] Failed to load rules from KV, using defaults:",e)}return r.filter(e=>e.active)}function s(e,t){return`${e}:${t}`}function o(e,t){return new Date(e).getTime()-864e5*t}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,4332],()=>a(6207));module.exports=r})();