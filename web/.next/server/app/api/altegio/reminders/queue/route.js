"use strict";(()=>{var e={};e.id=9897,e.ids=[9897],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3985:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{GET:()=>p,dynamic:()=>l,runtime:()=>d});var i=r(9303),n=r(8716),o=r(670),s=r(7070),u=r(4332);let l="force-dynamic",d="nodejs";async function p(e){try{let t=e.nextUrl.searchParams.get("status")||"pending",r=e.nextUrl.searchParams.get("limit"),a=r?Math.min(Math.max(parseInt(r,10)||50,1),200):50,i=await u.kvRead.getRaw("altegio:reminder:index"),n=[];if(i)try{let e;if("string"==typeof i)try{e=JSON.parse(i)}catch{e=i}else e=i;if(e&&"object"==typeof e&&!Array.isArray(e)){let t=e.value??e.result??e.data;if(void 0!==t){if("string"==typeof t)try{e=JSON.parse(t)}catch{e=t}else e=t}}Array.isArray(e)?n=e:(console.warn("[altegio/reminders/queue] Index is not an array, resetting:",typeof e,e),n=[])}catch(e){console.warn("[altegio/reminders/queue] Failed to parse index:",e),n=[]}let o=[],l=Date.now();for(let e of n){let r=`altegio:reminder:job:${e}`,a=await u.kvRead.getRaw(r);if(!a){console.warn(`[queue] Job ${e} not found in KV`);continue}try{let r;if("string"==typeof a)try{r=JSON.parse(a)}catch{r=a}else r=a;if(r&&"object"==typeof r&&!Array.isArray(r)){let e=r.value??r.result??r.data;if(void 0!==e){if("string"==typeof e)try{r=JSON.parse(e)}catch{r=e}else r=e}}if("string"==typeof r)try{r=JSON.parse(r)}catch(t){console.warn(`[queue] Failed to parse job ${e} as JSON:`,t);continue}let i=r;("all"===t||i.status===t)&&o.push(i)}catch(t){console.warn(`[altegio/reminders/queue] Failed to parse job ${e}:`,t)}}o.sort((e,t)=>e.dueAt-t.dueAt);let d="pending"===t?o.filter(e=>{let t="pending"===e.status,r=e.dueAt>l,a=t&&r;return a||console.log(`[queue] Filtering out job ${e.id}:`,{status:e.status,isPending:t,dueAt:new Date(e.dueAt).toISOString(),now:new Date(l).toISOString(),isFuture:r,diffMs:e.dueAt-l,diffHours:Math.round((e.dueAt-l)/36e5)}),a}):o.slice(0,a);console.log("[queue] Filter results:",{totalJobs:o.length,filteredQueue:d.length,statusParam:t,now:new Date(l).toISOString()});let p=d.map(e=>({id:e.id,ruleId:e.ruleId,visitId:e.visitId,clientName:e.payload?.clientName||"Невідомий клієнт",instagram:e.instagram,phone:e.payload?.phone||null,email:e.payload?.email||null,serviceTitle:e.payload?.serviceTitle||null,staffName:e.payload?.staffName||null,visitDateTime:e.datetime,dueAt:e.dueAt,dueAtFormatted:new Date(e.dueAt).toLocaleString("uk-UA",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),daysUntilVisit:Math.round((new Date(e.datetime).getTime()-l)/864e5),status:e.status,attempts:e.attempts}));return s.NextResponse.json({ok:!0,count:p.length,jobs:p,debug:{indexTotal:n.length,jobsBeforeFilter:o.length,jobsAfterFilter:d.length,now:new Date(l).toISOString()}})}catch(e){return console.error("[altegio/reminders/queue] Error:",e),s.NextResponse.json({ok:!1,error:e instanceof Error?e.message:String(e)},{status:500})}}let c=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/altegio/reminders/queue/route",pathname:"/api/altegio/reminders/queue",filename:"route",bundlePath:"app/api/altegio/reminders/queue/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/altegio/reminders/queue/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f}=c,y="/api/altegio/reminders/queue/route";function h(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,4332],()=>r(3985));module.exports=a})();