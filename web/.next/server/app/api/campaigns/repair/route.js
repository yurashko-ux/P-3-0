"use strict";(()=>{var e={};e.id=8640,e.ids=[8640,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},2655:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>T,requestAsyncStorage:()=>S,routeModule:()=>R,serverHooks:()=>P,staticGenerationAsyncStorage:()=>E});var a={};r.r(a),r.d(a,{GET:()=>_,POST:()=>A,dynamic:()=>d,runtime:()=>u});var n=r(9303),i=r(8716),s=r(670),o=r(7070),l=r(7560),c=r(4332),p=r(6471);let u="nodejs",d="force-dynamic",f="cmp:ids",m=e=>`cmp:item:${e}`;async function h(){let e=await l.kv.get(f);return Array.isArray(e)?e.filter(Boolean):[]}async function g(){try{let e=await c.kvRead.lrange("cmp:ids:list",0,-1);return Array.isArray(e)?e.filter(Boolean):[]}catch{return[]}}async function v(e){await l.kv.set(f,e)}async function w(e){if(!e||!e.pipeline||!e.status)return e;let t=e.pipelineName??(await (0,p.Vq)(e.pipeline)).toString(),r=e.statusName??(await (0,p.d4)(e.pipeline,e.status)).toString();return{...e,pipelineName:t,statusName:r}}async function y(e){let[t,r,a,n]=await Promise.all([w(e.base),w(e.t1),w(e.t2),w(e.texp)]);return{...e,base:t,t1:r,t2:a,texp:n}}async function _(e){var t;let r=e.nextUrl.searchParams.get("secret")||e.headers.get("x-admin-pass")||"";if(!process.env.ADMIN_PASS||r!==process.env.ADMIN_PASS)return o.NextResponse.json({error:"unauthorized"},{status:401});let a=await h(),n=await g(),i=function(e){let t=new Set,r=[];for(let a of e){let e=String(a);t.has(e)||(t.add(e),r.push(a))}return r}([...a,...n]),s=i.map(e=>m(e)),c=await l.kv.mget(...s),p=[],u=[];(c??[]).forEach((e,t)=>{let r=i[t];e&&"object"==typeof e?p.push(e):u.push(r)});let d=0;for(let e of p)if(e.base&&(!e.base.pipelineName||!e.base.statusName)||e.t1&&(!e.t1.pipelineName||!e.t1.statusName)||e.t2&&(!e.t2.pipelineName||!e.t2.statusName)||e.texp&&(!e.texp.pipelineName||!e.texp.statusName)){let t=await y(e);await l.kv.set(m(e.id),t),d++}let f=[...p].sort((e,t)=>(t.createdAt??0)-(e.createdAt??0)).map(e=>e.id);return await v(f),t={ok:!0,totals:{before:{arr:a.length,list:n.length,merged:i.length},existing:p.length,removedBrokenIds:u.length,enrichedItems:d,finalIds:f.length},sample:f.slice(0,10)},o.NextResponse.json(t,{status:200})}async function A(e){return _(e)}let R=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/campaigns/repair/route",pathname:"/api/campaigns/repair",filename:"route",bundlePath:"app/api/campaigns/repair/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/campaigns/repair/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:S,staticGenerationAsyncStorage:E,serverHooks:P}=R,x="/api/campaigns/repair/route";function T(){return(0,s.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:E})}},6471:(e,t,r)=>{r.d(t,{Vq:()=>d,d4:()=>f,e6:()=>c,pr:()=>l});var a=r(1964);let n=(0,a.Rv)().replace(/\/+$/,""),i=function(){let e=(0,a.hC)();if(e)return e;let t=(0,a.Ls)();return t.toLowerCase().startsWith("bearer ")?t:`Bearer ${t}`}();function s(e){return Array.isArray(e)?e:e?.data&&Array.isArray(e.data)?e.data:e?.items&&Array.isArray(e.items)?e.items:[]}async function o(e){try{let t=await fetch(e,{headers:function(){let e={Accept:"application/json"};return i&&(e.Authorization=i),e}(),cache:"no-store"});if(!t.ok)return console.warn("[KeyCRM] non-OK",t.status,e),null;return await t.json()}catch(t){return console.warn("[KeyCRM] fetch error",e,t),null}}async function l(){return s(await o(`${n}/pipelines?per_page=200`)).map(e=>({id:String(e.id),name:String(e.name??e.title??e.label??e.slug??e.id)}))}async function c(e){let t=encodeURIComponent(e);return s(await o(`${n}/pipelines/${t}/statuses?per_page=200`)).map(e=>({id:String(e.id),name:String(e.name??e.title??e.label??e.slug??e.id)}))}let p=new Map,u=new Map;async function d(e){if(!e)return"";if(p.has(e))return p.get(e);for(let e of(await l()))p.set(e.id,e.name);return p.get(e)??e}async function f(e,t){if(!e||!t)return"";let r=u.get(e)??new Map;if(u.set(e,r),r.has(t))return r.get(t);for(let t of(await c(e)))r.set(t.id,t.name);return r.get(t)??t}i&&i.toLowerCase().startsWith("bearer ")},7560:(e,t,r)=>{r.d(t,{kv:()=>o});var a=r(242),n=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var i=class extends a.Redis{async *scanIterator(e){let t,r=0;do for(let a of([r,t]=await this.scan(r,e),t))yield a;while(0!==r)}async *hscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.hscan(e,a,t),r))yield n;while(0!==a)}async *sscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.sscan(e,a,t),r))yield n;while(0!==a)}async *zscanIterator(e,t){let r,a=0;do for(let n of([a,r]=await this.zscan(e,a,t),r))yield n;while(0!==a)}};function s(e){return new i({cache:"default",...e})}new Proxy({},{get(e,t,r){if("then"===t||"parse"===t)return Reflect.get(e,t,r);if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}});var o=new Proxy({},{get(e,t){if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");n=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,242,4332],()=>r(2655));module.exports=a})();