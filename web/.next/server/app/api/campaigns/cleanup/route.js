"use strict";(()=>{var e={};e.id=6266,e.ids=[6266,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},7688:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>T,patchFetch:()=>w,requestAsyncStorage:()=>S,routeModule:()=>k,serverHooks:()=>R,staticGenerationAsyncStorage:()=>I});var n={};r.r(n),r.d(n,{GET:()=>K,POST:()=>h,dynamic:()=>d,runtime:()=>p});var a=r(9303),i=r(8716),s=r(670),o=r(7070),l=r(7560),c=r(4332),u=r(206);let p="nodejs",d="force-dynamic",_=["cmp:list:items","cmp:list:ids:RO","cmp:list:ids:WR","campaigns"],f=[c.campaignKeys.CMP_INDEX_KEY,c.campaignKeys.INDEX_KEY,c.campaignKeys.LEGACY_INDEX_KEY,..._];function m(){return o.NextResponse.json({ok:!1,error:"unauthorized"},{status:401})}function g(e,t){let r=(0,u.D0)(t);if("string"==typeof r){let t=r.trim();t&&"[object Object]"!==t&&e.add(t);return}if("number"==typeof r&&Number.isFinite(r)){e.add(String(r));return}r&&"object"==typeof r&&(void 0!==r.id?g(e,r.id):void 0!==r.value?g(e,r.value):void 0!==r.__index_id&&g(e,r.__index_id))}async function y(e){if(!e)return{ids:[],sources:{},kvDisabled:!0};let t=new Set,r={},n=(e,n)=>{let a=t.size;!function e(t,r,n=0){if(null==t||n>5)return;let a=(0,u.D0)(t);if(Array.isArray(a)){for(let t of a)e(t,r,n+1);return}if(g(r,a),a&&"object"==typeof a){for(let t of(Array.isArray(a.items)&&e(a.items,r,n+1),["base","t1","t2","texp"]))if(a[t]&&"object"==typeof a[t]){let e=a[t];void 0!==e.pipeline_id&&g(r,e.pipeline_id),void 0!==e.status_id&&g(r,e.status_id),void 0!==e.pipeline&&g(r,e.pipeline),void 0!==e.status&&g(r,e.status)}for(let t of Object.values(a))"string"==typeof t||"number"==typeof t?g(r,t):t&&"object"==typeof t&&e(t,r,n+1)}}(n,t);let i=t.size-a;i>0&&(r[e]=i)},a=async e=>{try{return await l.kv.get(e)??null}catch(t){return console.warn(`[campaigns:cleanup] kv.get(${e}) failed`,t),null}},i=async e=>{try{let t=await c.kvRead.lrange(e,0,-1);return Array.isArray(t)?t:[]}catch(t){return console.warn(`[campaigns:cleanup] kv.lrange(${e}) failed`,t),[]}},s=(0,u.D0)(await a(c.campaignKeys.CMP_INDEX_KEY));n(c.campaignKeys.CMP_INDEX_KEY,s);let o=await i(c.campaignKeys.CMP_INDEX_LIST_KEY);n(c.campaignKeys.CMP_INDEX_LIST_KEY,o);let p=(0,u.D0)(await a(c.campaignKeys.INDEX_KEY));n(c.campaignKeys.INDEX_KEY,p);let d=(0,u.D0)(await a(c.campaignKeys.LEGACY_INDEX_KEY));for(let e of(n(c.campaignKeys.LEGACY_INDEX_KEY,d),_)){let t=(0,u.D0)(await a(e));n(e,t)}return{ids:Array.from(t).filter(Boolean),sources:r}}async function v(e,t){if(!t)return 0;let r=Array.from(new Set(e.filter(Boolean))),n=0;for(let e=0;e<r.length;e+=50){let t=r.slice(e,e+50);t.length&&(await l.kv.del(...t),n+=t.length)}return n}function E(e,t=500){let r=e instanceof Error?e.message:"string"==typeof e?e:"unknown_error",n=e instanceof Error?e.stack:void 0;return o.NextResponse.json({ok:!1,error:"kv_cleanup_failed",message:r,...n?{stack:n}:{}},{status:t})}async function h(e){let t=process.env.ADMIN_PASS||"",r=(0,c.getKvConfigStatus)(),n=r.hasBaseUrl&&(r.hasReadToken||r.hasWriteToken),a=r.hasBaseUrl&&r.hasWriteToken,i={};try{i=await e.json()}catch{i={}}let s=("string"==typeof i?.token?i.token:null)||e.headers.get("x-admin-pass")||e.cookies.get("admin_token")?.value||"";if(t&&s!==t)return m();if(!i?.confirm)return o.NextResponse.json({ok:!1,error:"confirmation_required"},{status:400});try{let{ids:e,sources:t,kvDisabled:r}=await y(n),i=[];for(let t of e)i.push(c.campaignKeys.CMP_ITEM_KEY(t),c.campaignKeys.ITEM_KEY(t),c.campaignKeys.LEGACY_ITEM_KEY(t));let s=await v([...i,...f],a);return function(){let e=globalThis;e.__campaignMemoryStore&&(e.__campaignMemoryStore.ids=[],e.__campaignMemoryStore.items=Object.create(null)),e.__campaignKvState&&(e.__campaignKvState.disabled=!1,e.__campaignKvState.error=null)}(),o.NextResponse.json({ok:!0,deletedIds:e.length,deletedKeys:s,sampleIds:e.slice(0,10),sources:t,kvDisabled:!!(r||!a)})}catch(e){return E(e)}}async function K(e){let t=process.env.ADMIN_PASS||"",r=e.cookies.get("admin_token")?.value||"",n=e.headers.get("x-admin-pass")||"",a=(0,c.getKvConfigStatus)(),i=a.hasBaseUrl&&(a.hasReadToken||a.hasWriteToken);if(t&&r!==t&&n!==t)return m();try{let{ids:e,sources:t,kvDisabled:r}=await y(i);return o.NextResponse.json({ok:!0,totalIds:e.length,sampleIds:e.slice(0,10),sources:t,kvDisabled:!!(r||!i)})}catch(e){return E(e)}}let k=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/campaigns/cleanup/route",pathname:"/api/campaigns/cleanup",filename:"route",bundlePath:"app/api/campaigns/cleanup/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/campaigns/cleanup/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:S,staticGenerationAsyncStorage:I,serverHooks:R}=k,T="/api/campaigns/cleanup/route";function w(){return(0,s.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:I})}},206:(e,t,r)=>{function n(e){let t=e;for(let e=0;e<10&&null!=t;e++){if("object"==typeof t&&"value"in t&&1===Object.keys(t).length){t=t.value;continue}if("string"==typeof t){let e=t.trim();if(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]")||e.startsWith('"'))try{t=JSON.parse(e);continue}catch{}}break}return t}function a(e){let t=n(e);if(null==t)return"";if("string"==typeof t||"number"==typeof t)return String(t);if("object"==typeof t){if("id"in t)return String(t.id);if("value"in t)return String(t.value)}return String(t)}r.d(t,{D0:()=>n,kg:()=>a})},7560:(e,t,r)=>{r.d(t,{kv:()=>o});var n=r(242),a=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var i=class extends n.Redis{async *scanIterator(e){let t,r=0;do for(let n of([r,t]=await this.scan(r,e),t))yield n;while(0!==r)}async *hscanIterator(e,t){let r,n=0;do for(let a of([n,r]=await this.hscan(e,n,t),r))yield a;while(0!==n)}async *sscanIterator(e,t){let r,n=0;do for(let a of([n,r]=await this.sscan(e,n,t),r))yield a;while(0!==n)}async *zscanIterator(e,t){let r,n=0;do for(let a of([n,r]=await this.zscan(e,n,t),r))yield a;while(0!==n)}};function s(e){return new i({cache:"default",...e})}new Proxy({},{get(e,t,r){if("then"===t||"parse"===t)return Reflect.get(e,t,r);if(!a){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),a=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(a,t)}});var o=new Proxy({},{get(e,t){if(!a){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");a=s({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(a,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,242,4332],()=>r(7688));module.exports=n})();