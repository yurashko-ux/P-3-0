"use strict";(()=>{var e={};e.id=2025,e.ids=[2025,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},5825:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>F,patchFetch:()=>z,requestAsyncStorage:()=>U,routeModule:()=>M,serverHooks:()=>W,staticGenerationAsyncStorage:()=>D});var a={};i.r(a),i.d(a,{GET:()=>q,POST:()=>L,dynamic:()=>d,runtime:()=>c});var n=i(9303),s=i(8716),r=i(670),p=i(7070),l=i(7560),o=i(6471),u=i(4332);let c="nodejs",d="force-dynamic",m="cmp:ids",_="cmp:ids:list",f=e=>`cmp:item:${e}`,v=e=>Array.from(new Set(e.filter(Boolean))),y=globalThis,g=y.__campaignMemoryStore??(y.__campaignMemoryStore={ids:[],items:Object.create(null)}),h=y.__campaignKvState??(y.__campaignKvState={disabled:!1,error:null});function w(e){h.disabled||(h.disabled=!0,h.error=e instanceof Error?e:Error(String(e)),console.warn("[campaigns] KV disabled:",h.error?.message??h.error))}async function S(e){if(!h.disabled)try{return await e()}catch(e){w(e);return}}function b(){return[...g.ids]}function N(e){g.ids=v([e,...g.ids])}function A(e,t){g.items[e]=t,N(e)}function x(e){return e instanceof Error&&/WRONGTYPE/i.test(e.message)}async function R(){let e,t;if(!h.disabled)try{let t=await l.kv.get(m);Array.isArray(t)&&(e=t)}catch(e){x(e)||w(e)}if(!h.disabled)try{let e=await u.kvRead.lrange(_,0,-1);Array.isArray(e)&&(t=e)}catch(e){x(e)||w(e)}return void 0!==e||void 0!==t?v([...Array.isArray(e)?e:[],...Array.isArray(t)?t:[]]):b()}async function E(e){let t=v([e,...await R()]);N(e),await S(()=>l.kv.set(m,t)),await S(()=>u.kvWrite.lpush(_,e)),await S(()=>u.kvWrite.ltrim(_,0,199))}let I=e=>null==e?void 0:String(e).trim()||void 0,P=e=>{let t=Number(e);return Number.isFinite(t)?t:void 0},$=e=>{if("boolean"==typeof e)return e;if(null==e)return;let t=String(e).trim().toLowerCase();if(t){if(["true","1","yes","y"].includes(t))return!0;if(["false","0","no","n"].includes(t))return!1}};function k(e){if(!e||"object"!=typeof e)return null;let t=I(e.value??e.val??e.text??e.rule??e.name??e.pattern);if(!t)return null;let i=I(e.op??e.operator??e.compare),a=P(e.pipeline_id??e.pipelineId??e.pipeline??e.to_pipeline_id)??I(e.pipeline_id??e.pipelineId??e.pipeline??e.to_pipeline_id),n=P(e.pipeline_status_id??e.pipelineStatusId??e.pipeline_status??e.status_pipeline_id??e.pipelineStatus)??I(e.pipeline_status_id??e.pipelineStatusId??e.pipeline_status??e.status_pipeline_id??e.pipelineStatus),s=P(e.status_id??e.statusId??e.status)??I(e.status_id??e.statusId??e.status)??n,r=I(e.pipelineName??e.pipeline_name),p=I(e.statusName??e.status_name),l={op:"equals"===i?"equals":"contains",value:t};return null!=a&&(l.pipeline_id=a),null!=s&&(l.status_id=s),null!=n&&(l.pipeline_status_id=n),r&&(l.pipelineName=r),p&&(l.statusName=p),l}function T(e){if(!e)return;let t=I(e.pipeline_id??e.pipeline),i=I(e.status_id??e.status),a={pipeline:t,status:i,pipelineStatusId:I(e.pipeline_status_id??e.pipelineStatusId??e.pipeline_status),pipelineName:I(e.pipelineName??e.pipeline_name),statusName:I(e.statusName??e.status_name)};return a.pipeline||a.status||a.pipelineName||a.statusName?a:void 0}function K(e,t){let i=(...t)=>t.map(t=>e[t]).find(e=>null!=e),a=i(`${t}.pipeline`,`${t}_pipeline`,`${t}Pipeline`)??e[t]?.pipeline,n=i(`${t}.status`,`${t}_status`,`${t}Status`)??e[t]?.status,s=i(`${t}.pipelineStatusId`,`${t}_pipelineStatusId`,`${t}PipelineStatusId`,`${t}.pipeline_status_id`,`${t}_pipeline_status_id`,`${t}Pipeline_status_id`,`${t}.pipelineStatus`,`${t}_pipelineStatus`,`${t}PipelineStatus`)??e[t]?.pipelineStatusId??e[t]?.pipeline_status_id??e[t]?.pipelineStatus,r=i(`${t}.pipelineName`,`${t}_pipelineName`,`${t}PipelineName`)??e[t]?.pipelineName,p=i(`${t}.statusName`,`${t}_statusName`,`${t}StatusName`)??e[t]?.statusName,l={pipeline:I(a),status:I(n),pipelineStatusId:I(s),pipelineName:I(r),statusName:I(p)};return l.pipeline||l.status||l.pipelineName||l.statusName?l:void 0}function V(e){if(!e)return;let t=I(e.pipelineStatusId),i=I(e.status);return!t&&i?{...e,pipelineStatusId:i}:e}function j(e,t){if(!t)return{};let i=t=>`${"t1"===e?"v1_to":"t2"===e?"v2_to":e}${t}`,a="base"===e,n=I(t.pipeline),s=I(t.status),r=I(t.pipelineStatusId),p=I(t.pipelineName),l=I(t.statusName),o={};return n&&(a?o.base_pipeline_id=n:o[i("_pipeline_id")]=n),s&&(a?o.base_status_id=s:o[i("_status_id")]=s),r&&(a?o.base_pipeline_status_id=r:o[i("_pipeline_status_id")]=r),p&&(a?o.base_pipeline_name=p:o[i("_pipeline_name")]=p),l&&(a?o.base_status_name=l:o[i("_status_name")]=l),o}async function C(e){if(!e)return e;let t={...e};try{t.pipeline&&!t.pipelineName&&(t.pipelineName=String(await (0,o.Vq)(t.pipeline))||t.pipelineName)}catch{}try{t.pipeline&&t.status&&!t.statusName&&(t.statusName=String(await (0,o.d4)(t.pipeline,t.status))||t.statusName)}catch{}return t}function O(e,t){return{source:e,count:t,kvError:h.error?.message??null}}async function q(){let e=await R();if(!e.length)return p.NextResponse.json({ok:!0,items:[],meta:O(h.disabled?"memory":"kv",0)});let t=await S(()=>l.kv.mget(...e.map(e=>f(e)))),i=[];return void 0!==t?t.forEach(e=>{e&&"object"==typeof e&&(i.push(e),A(e.id,e))}):e.map(e=>g.items[e]??null).forEach(e=>{e&&i.push(e)}),i.sort((e,t)=>(t.createdAt??0)-(e.createdAt??0)),p.NextResponse.json({ok:!0,items:i,meta:O(void 0!==t?"kv":"memory",i.length)})}async function L(e){let t=e.headers.get("content-type")||"",a={};if(t.includes("application/json"))try{a=await e.json()}catch{}else{let t=await e.formData().catch(()=>null);t?.forEach((e,t)=>a[t]="string"==typeof e?e:String(e))}let n=Date.now(),s=String(n),r=K(a,"base"),o=K(a,"t1"),u=K(a,"t2"),c=K(a,"texp"),d=I(a.v1),m=I(a.v2),_=P(a.expDays)??P(a.exp?.days)??P(a.exp)??P(a.exp_value)??P(a.expireDays)??P(a.expire)??P(a.vexp),v=a.v1_condition&&"object"==typeof a.v1_condition?a.v1_condition:null,y=a.v2_condition&&"object"==typeof a.v2_condition?a.v2_condition:null,g=a?.rules&&"object"==typeof a.rules?a.rules:null,w=k(g?.v1??g?.V1??g?.variant1??v),N=k(g?.v2??g?.V2??g?.variant2??y),x={};w&&(x.v1=w),N&&(x.v2=N);let R=$(a.active)??$(a.isActive)??$(a.enabled),q=T(w),L=T(N),M=T(k(a.exp)),[U,D,W,F]=await Promise.all([C(r),C(o??q),C(u??L),C(c??M)]),z=w?.value??d,B=N?.value??m;try{let{checkCampaignVUniqueness:e}=await i.e(9091).then(i.bind(i,9091)),t=await e(z,B);if(t)return p.NextResponse.json({ok:!1,error:t.error,conflictingValue:t.conflictingValue,conflictingCampaign:t.conflictingCampaign},{status:400})}catch(e){console.error("[campaigns] Failed to check V uniqueness:",e)}let G={id:s,name:I(a.name)??"Без назви",base:V(U),t1:V(D??q??void 0),t2:V(W??L??void 0),texp:V(F??M??void 0),v1:z,v2:B,...Object.keys(x).length?{rules:x}:{},...null!=_?{expDays:_,exp:_}:{},counters:{v1:0,v2:0,exp:0},createdAt:n,...void 0!==R?{active:R}:{}};Object.assign(G,j("base",G.base),j("t1",G.t1),j("t2",G.t2),j("texp",G.texp));try{let{initializeCampaignStats:e}=await i.e(1916).then(i.bind(i,7985)),t=await e(G);Object.assign(G,t)}catch(e){G.baseCardsCount=0,G.baseCardsCountUpdatedAt=Date.now(),G.movedTotal=0,G.movedV1=0,G.movedV2=0,G.movedExp=0}return A(s,G),await S(()=>l.kv.set(f(s),G)),await E(s),p.NextResponse.json({ok:!0,id:s,meta:O(h.disabled?"memory":"kv",b().length)},{status:201})}let M=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/campaigns/route",pathname:"/api/campaigns",filename:"route",bundlePath:"app/api/campaigns/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/campaigns/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:U,staticGenerationAsyncStorage:D,serverHooks:W}=M,F="/api/campaigns/route";function z(){return(0,r.patchFetch)({serverHooks:W,staticGenerationAsyncStorage:D})}},6471:(e,t,i)=>{i.d(t,{Vq:()=>d,d4:()=>m,e6:()=>o,pr:()=>l});var a=i(1964);let n=(0,a.Rv)().replace(/\/+$/,""),s=function(){let e=(0,a.hC)();if(e)return e;let t=(0,a.Ls)();return t.toLowerCase().startsWith("bearer ")?t:`Bearer ${t}`}();function r(e){return Array.isArray(e)?e:e?.data&&Array.isArray(e.data)?e.data:e?.items&&Array.isArray(e.items)?e.items:[]}async function p(e){try{let t=await fetch(e,{headers:function(){let e={Accept:"application/json"};return s&&(e.Authorization=s),e}(),cache:"no-store"});if(!t.ok)return console.warn("[KeyCRM] non-OK",t.status,e),null;return await t.json()}catch(t){return console.warn("[KeyCRM] fetch error",e,t),null}}async function l(){return r(await p(`${n}/pipelines?per_page=200`)).map(e=>({id:String(e.id),name:String(e.name??e.title??e.label??e.slug??e.id)}))}async function o(e){let t=encodeURIComponent(e);return r(await p(`${n}/pipelines/${t}/statuses?per_page=200`)).map(e=>({id:String(e.id),name:String(e.name??e.title??e.label??e.slug??e.id)}))}let u=new Map,c=new Map;async function d(e){if(!e)return"";if(u.has(e))return u.get(e);for(let e of(await l()))u.set(e.id,e.name);return u.get(e)??e}async function m(e,t){if(!e||!t)return"";let i=c.get(e)??new Map;if(c.set(e,i),i.has(t))return i.get(t);for(let t of(await o(e)))i.set(t.id,t.name);return i.get(t)??t}s&&s.toLowerCase().startsWith("bearer ")},7560:(e,t,i)=>{i.d(t,{kv:()=>p});var a=i(242),n=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var s=class extends a.Redis{async *scanIterator(e){let t,i=0;do for(let a of([i,t]=await this.scan(i,e),t))yield a;while(0!==i)}async *hscanIterator(e,t){let i,a=0;do for(let n of([a,i]=await this.hscan(e,a,t),i))yield n;while(0!==a)}async *sscanIterator(e,t){let i,a=0;do for(let n of([a,i]=await this.sscan(e,a,t),i))yield n;while(0!==a)}async *zscanIterator(e,t){let i,a=0;do for(let n of([a,i]=await this.zscan(e,a,t),i))yield n;while(0!==a)}};function r(e){return new s({cache:"default",...e})}new Proxy({},{get(e,t,i){if("then"===t||"parse"===t)return Reflect.get(e,t,i);if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),n=r({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}});var p=new Proxy({},{get(e,t){if(!n){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");n=r({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(n,t)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[8948,5972,242,4332],()=>i(5825));module.exports=a})();