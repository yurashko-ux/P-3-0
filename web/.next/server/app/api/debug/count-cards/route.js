"use strict";(()=>{var e={};e.id=2655,e.ids=[2655,1916,7560,7985],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},1576:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>v,patchFetch:()=>y,requestAsyncStorage:()=>_,routeModule:()=>b,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var s={};a.r(s),a.d(s,{GET:()=>c,dynamic:()=>p});var r=a(9303),i=a(8716),n=a(670),o=a(7070),u=a(4332),d=a(7985),l=a(3903);let p="force-dynamic";async function c(e){let t=new URL(e.url).searchParams.get("campaign_id");if(!t)return o.NextResponse.json({error:"campaign_id required"},{status:400});try{let e=(await u.kvRead.listCampaigns()).map(e=>(0,l.b)(e)).find(e=>e&&(e.id===t||e.__index_id===t));if(!e)for(let a of[u.campaignKeys.ITEM_KEY(t),u.campaignKeys.CMP_ITEM_KEY(t),u.campaignKeys.LEGACY_ITEM_KEY(t)]){let t=await u.kvRead.getRaw(a),s=(0,l.b)(t);if(s){e=s;break}}if(!e)return o.NextResponse.json({error:"Campaign not found",campaignId:t},{status:404});let a=e.base?.pipelineId||e.base?.pipeline_id||e.base?.pipeline||e.base_pipeline_id||e.base_pipelineId,s=e.base?.statusId||e.base?.status_id||e.base?.status||e.base_status_id||e.baseStatusId,r=await (0,d.X)(a,s);return o.NextResponse.json({ok:!0,campaignId:t,campaignName:e.name,basePipelineId:a,baseStatusId:s,basePipelineIdType:typeof a,baseStatusIdType:typeof s,currentBaseCardsCount:e.baseCardsCount,countResult:r,campaignBase:e.base,campaignBaseKeys:e.base?Object.keys(e.base):null,fullCampaignKeys:Object.keys(e).slice(0,30),basePipelineValue:e.base?.pipeline,baseStatusValue:e.base?.status,basePipelineIdValue:e.base_pipeline_id,baseStatusIdValue:e.base_status_id,source:"listCampaigns"})}catch(e){return o.NextResponse.json({ok:!1,error:e.message,stack:void 0},{status:500})}}let b=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/debug/count-cards/route",pathname:"/api/debug/count-cards",filename:"route",bundlePath:"app/api/debug/count-cards/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/debug/count-cards/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:f,serverHooks:m}=b,v="/api/debug/count-cards/route";function y(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},7985:(e,t,a)=>{a.d(t,{X:()=>o,initializeCampaignStats:()=>d,updateCampaignBaseCardsCount:()=>u});var s=a(1964),r=a(4332),i=a(7560),n=a(3903);async function o(e,t){if(!e||!t)return 0;let a=Number(e),r=Number(t);if(!Number.isFinite(a)||!Number.isFinite(r))return 0;let i=0;try{for(let e=1;e<=20;e++){let t=new URLSearchParams;t.set("page[number]",String(e)),t.set("page[size]",String(50)),t.set("filter[pipeline_id]",String(a)),t.set("filter[status_id]",String(r)),t.set("pipeline_id",String(a)),t.set("status_id",String(r));let n=(0,s.Qv)(`/pipelines/cards?${t.toString()}`),o=await fetch(n,{headers:(0,s.xD)(),cache:"no-store"});if(!o.ok){if(404===o.status||e>1)break;let t=await o.text().catch(()=>"");throw Error(`KeyCRM API error: ${o.status} ${o.statusText} - ${t.slice(0,200)}`)}let u=await o.json(),d=Array.isArray(u)?u:Array.isArray(u?.data)?u.data:[];if(0===d.length)break;let l=d.filter(e=>{let t=e?.pipeline_id??e?.pipeline?.id??e?.pipeline_id??e?.attributes?.pipeline_id??e?.data?.pipeline_id,s=e?.status_id??e?.status?.id??e?.status_id??e?.attributes?.status_id??e?.data?.status_id,i="number"==typeof t?t:Number(t),n="number"==typeof s?s:Number(s),o=Number.isFinite(i)&&i===a,u=Number.isFinite(n)&&n===r;return o&&u});if(i+=l.length,!(u?.links?.next||u?.next_page_url||(u?.meta?.current_page??u?.current_page??e)<(u?.meta?.last_page??u?.last_page??e)))break}}catch(e){return 0}return i}async function u(e){try{let t=[r.campaignKeys.ITEM_KEY(e),r.campaignKeys.CMP_ITEM_KEY(e),r.campaignKeys.LEGACY_ITEM_KEY(e)],a=null,s=null;for(let e of t)try{if(a=await i.kv.get(e)){if(!(a=(0,n.b)(a)))continue;s=e;break}}catch{}if(!a){let e=null;for(let a of t)if(e=await r.kvRead.getRaw(a)){s=a;break}if(!e||!s)return null;let i=(0,n.b)(e);if(!i||!(a=i)||"object"!=typeof a||Array.isArray(a))return null}if(!a)return null;let u=a.base?.pipelineId||a.base?.pipeline_id||a.base?.pipeline||a.base_pipeline_id||a.base_pipelineId,d=a.base?.statusId||a.base?.status_id||a.base?.status||a.base_status_id||a.baseStatusId;if(!u||!d)return null;let l="number"==typeof a.counters?.v1?a.counters.v1:a.v1_count||0,p="number"==typeof a.counters?.v2?a.counters.v2:a.v2_count||0,c="number"==typeof a.counters?.exp?a.counters.exp:a.exp_count||0,b=l+p+c,_=await o(u,d);"number"!=typeof a.baseCardsCountInitial&&(a.baseCardsCountInitial=_),"number"!=typeof a.baseCardsTotalPassed&&(a.baseCardsTotalPassed=a.baseCardsCountInitial||0),"number"==typeof a.baseCardsCount?a.baseCardsCount:a.baseCardsCountInitial,a.baseCardsCount=_,a.baseCardsCountUpdatedAt=Date.now();let f=_+b,m="number"==typeof a.baseCardsTotalPassed?a.baseCardsTotalPassed:(a.baseCardsCountInitial||0)+b;if(a.baseCardsTotalPassed=Math.max(m,f),a.movedTotal=l+p+c,a.movedV1=l,a.movedV2=p,a.movedExp=c,s)try{await i.kv.set(s,a)}catch{await r.kvWrite.setRaw(s,JSON.stringify(a))}else for(let e of t)try{await i.kv.set(e,a);break}catch{try{await r.kvWrite.setRaw(e,JSON.stringify(a));break}catch{}}return _}catch(e){return null}}async function d(e){let t=e.base?.pipelineId||e.base?.pipeline_id||e.base?.pipeline||e.base_pipeline_id||e.base_pipelineId,a=e.base?.statusId||e.base?.status_id||e.base?.status||e.base_status_id||e.baseStatusId;if(!t||!a)return{...e,baseCardsCount:0,baseCardsCountInitial:0,baseCardsTotalPassed:0,baseCardsCountUpdatedAt:Date.now(),movedTotal:0,movedV1:0,movedV2:0,movedExp:0};let s=await o(t,a),r=e.counters?.v1||e.v1_count||0,i=e.counters?.v2||e.v2_count||0,n=e.counters?.exp||e.exp_count||0;return{...e,baseCardsCount:s,baseCardsCountInitial:s,baseCardsTotalPassed:s,baseCardsCountUpdatedAt:Date.now(),movedTotal:r+i+n,movedV1:r,movedV2:i,movedExp:n}}},7560:(e,t,a)=>{a.d(t,{kv:()=>o});var s=a(242),r=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var i=class extends s.Redis{async *scanIterator(e){let t,a=0;do for(let s of([a,t]=await this.scan(a,e),t))yield s;while(0!==a)}async *hscanIterator(e,t){let a,s=0;do for(let r of([s,a]=await this.hscan(e,s,t),a))yield r;while(0!==s)}async *sscanIterator(e,t){let a,s=0;do for(let r of([s,a]=await this.sscan(e,s,t),a))yield r;while(0!==s)}async *zscanIterator(e,t){let a,s=0;do for(let r of([s,a]=await this.zscan(e,s,t),a))yield r;while(0!==s)}};function n(e){return new i({cache:"default",...e})}new Proxy({},{get(e,t,a){if("then"===t||"parse"===t)return Reflect.get(e,t,a);if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}});var o=new Proxy({},{get(e,t){if(!r){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");r=n({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(r,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[8948,5972,242,4332],()=>a(1576));module.exports=s})();