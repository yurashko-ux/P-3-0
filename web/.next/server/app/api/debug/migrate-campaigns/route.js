"use strict";(()=>{var e={};e.id=4140,e.ids=[4140],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3284:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>m,dynamic:()=>p,runtime:()=>u});var n=a(9303),i=a(8716),o=a(670),s=a(7070),c=a(4332);let u="nodejs",p="force-dynamic";async function d(e){let t=process.env.KV_REST_API_URL||"",a=process.env.KV_REST_API_TOKEN||"";if(!t||!a)throw Error("KV env missing for DEL");let r=await fetch(`${t.replace(/\/$/,"")}/del/${encodeURIComponent(e)}`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},cache:"no-store"});if(!r.ok)throw Error(`DEL ${e} failed: ${r.status}`)}async function m(e){if(!function(e){let t=e.headers.get("x-admin-token")||"",a=e.cookies.get("admin_token")?.value||"",r=t||a;return!!r&&r===process.env.ADMIN_PASS}(e))return s.NextResponse.json({ok:!1,error:"unauthorized"},{status:401});try{let e=await c.kvRead.lrange(c.campaignKeys.INDEX_KEY,0,-1).catch(()=>[]),t=await c.kvRead.lrange("campaigns:index",0,-1).catch(()=>[]),a=[],r=new Set,n=e=>{for(let t of e){let e=function(e){if(!e||"{"!==e[0])return e;try{let t=JSON.parse(e);if(t&&"string"==typeof t.value)return t.value}catch{}return e}(t);!e||r.has(e)||(r.add(e),a.push(e))}};n(e),n(t);let i=0;for(let e of a){let t;let a=c.campaignKeys.ITEM_KEY(e),r=await c.kvRead.getRaw(a);if(!r)continue;try{t=JSON.parse(r)}catch{continue}let n=!1;t.created_at||(t.created_at=Number(e)||Date.now(),n=!0),t.name||(t.name="Untitled",n=!0),void 0===t.active&&(t.active=!0,n=!0),"number"!=typeof t.v1_count&&(t.v1_count=0,n=!0),"number"!=typeof t.v2_count&&(t.v2_count=0,n=!0),"number"!=typeof t.exp_count&&(t.exp_count=0,n=!0),n&&(await c.kvWrite.setRaw(a,JSON.stringify(t)),i++)}try{await d(c.campaignKeys.INDEX_KEY)}catch{}try{await d("campaigns:index")}catch{}for(let e=a.length-1;e>=0;e--)await c.kvWrite.lpush(c.campaignKeys.INDEX_KEY,a[e]);let o=await c.kvRead.lrange(c.campaignKeys.INDEX_KEY,0,-1).catch(()=>[]);return s.NextResponse.json({ok:!0,fixedCount:i,index:{before:{primary:e,legacy:t},after:{primary:o}},note:"Index normalized to plain string IDs; legacy index removed. Items backfilled."})}catch(e){return s.NextResponse.json({ok:!1,error:e?.message||"migration failed"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/debug/migrate-campaigns/route",pathname:"/api/debug/migrate-campaigns",filename:"route",bundlePath:"app/api/debug/migrate-campaigns/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/debug/migrate-campaigns/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:v}=l,h="/api/debug/migrate-campaigns/route";function y(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,4332],()=>a(3284));module.exports=r})();