"use strict";(()=>{var e={};e.id=646,e.ids=[646,9512,7560],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},4802:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>T,patchFetch:()=>A,requestAsyncStorage:()=>v,routeModule:()=>y,serverHooks:()=>I,staticGenerationAsyncStorage:()=>w});var r={};n.r(r),n.d(r,{GET:()=>h,POST:()=>_,dynamic:()=>g,runtime:()=>f});var a=n(9303),o=n(8716),i=n(670),s=n(7070),d=n(4044),l=n(9512),c=n(4528),m=n(6357),p=n(1833),u=n(3783);let f="nodejs",g="force-dynamic";async function h(e){return _(e)}async function _(e){if(console.log("[cron/photo-reminders] POST request received"),!function(e){if("1"===e.headers.get("x-vercel-cron"))return!0;let t=e.nextUrl.searchParams.get("secret"),n=process.env.CRON_SECRET||"";return!!n&&!!t&&n===t}(e))return console.log("[cron/photo-reminders] Request forbidden - not a valid cron request"),s.NextResponse.json({ok:!1,error:"forbidden"},{status:403});try{(0,d.cC)();let t=function(e){let t=e.nextUrl.searchParams.get("company_id");if(t){let e=parseInt(t,10);if(!isNaN(e))return e}let n=process.env.ALTEGIO_COMPANY_ID;if(n){let e=parseInt(n,10);if(!isNaN(e))return e}let r=d.B0.PARTNER_ID;if(r){let e=parseInt(r,10);if(!isNaN(e))return e}return null}(e);if(!t)return s.NextResponse.json({ok:!1,error:"company_id required. Set ALTEGIO_PARTNER_ID in env or pass ?company_id=..."},{status:400});let n=(await e.json().catch(()=>({}))).minutesAhead||parseInt(e.nextUrl.searchParams.get("minutesAhead")||"20",10);console.log(`[cron/photo-reminders] Processing reminders for company ${t}, minutesAhead=${n}`);let r=new Date,a=new Date(r);a.setMinutes(a.getMinutes()+n);let o=r.toISOString().split("T")[0],i=a.toISOString().split("T")[0];console.log(`[cron/photo-reminders] Fetching appointments from ${o} to ${i}`);let f=await (0,l.B)(t,{dateFrom:o,dateTo:i,includeClient:!0});console.log(`[cron/photo-reminders] Got ${f.length} appointments from Altegio`);let g={processed:0,sent:0,skipped:0,errors:[]},h=r.getTime(),_=a.getTime();for(let e of f)try{g.processed++;let t=e.end_datetime||e.datetime||e.date;if(!t){console.warn(`[cron/photo-reminders] Appointment ${e.id} missing end_datetime`),g.skipped++;continue}let n=new Date(t).getTime();if(n<h||n>_){g.skipped++;continue}let r=`altegio-${e.id}`;if(await (0,u.qg)(r)){console.log(`[cron/photo-reminders] Appointment ${e.id} already has photo report`),g.skipped++;continue}let a=e.staff_id;if(!a){console.warn(`[cron/photo-reminders] Appointment ${e.id} missing staff_id`),g.skipped++;continue}let o=(0,c.mC)(a);if(!o){console.warn(`[cron/photo-reminders] Master not found for staff_id ${a} (appointment ${e.id})`),g.skipped++;continue}let i=await (0,m.hY)(o.id);if(!i){console.warn(`[cron/photo-reminders] Chat not registered for master ${o.id} (staff_id ${a})`),g.skipped++;continue}let s=(0,c.Kf)(e,o);if(!s){console.warn(`[cron/photo-reminders] Failed to convert appointment ${e.id} to reminder`),g.skipped++;continue}console.log(`[cron/photo-reminders] Sending reminder for appointment ${e.id} to master ${o.name} (chatId: ${i})`),await (0,p.oy)(i,s),await (0,p.zT)(`\\uD83D\\uDCF8 <b>–ù–æ–≤–µ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ —Ñ–æ—Ç–æ-–∑–≤—ñ—Ç</b>

<b>–ú–∞–π—Å—Ç–µ—Ä:</b> ${o.name}
<b>–ö–ª—ñ—î–Ω—Ç:</b> ${s.clientName}
<b>–ü–æ—Å–ª—É–≥–∞:</b> ${s.serviceName}
<b>–ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –æ:</b> ${new Date(s.endAt).toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"})}`),g.sent++,console.log(`[cron/photo-reminders] ‚úÖ Successfully sent reminder for appointment ${e.id}`)}catch(n){let t=n instanceof Error?n.message:String(n);console.error(`[cron/photo-reminders] Error processing appointment ${e.id}:`,t),g.errors.push(`Appointment ${e.id}: ${t}`)}let y={ok:!0,timestamp:new Date().toISOString(),companyId:t,minutesAhead:n,summary:g};return console.log("[cron/photo-reminders] Processing completed:",JSON.stringify(y,null,2)),s.NextResponse.json(y)}catch(e){return console.error("[cron/photo-reminders] Fatal error:",e),s.NextResponse.json({ok:!1,error:String(e),timestamp:new Date().toISOString()},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cron/photo-reminders/route",pathname:"/api/cron/photo-reminders",filename:"route",bundlePath:"app/api/cron/photo-reminders/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/cron/photo-reminders/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:w,serverHooks:I}=y,T="/api/cron/photo-reminders/route";function A(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:w})}},9512:(e,t,n)=>{n.d(t,{B:()=>a,getUpcomingAppointments:()=>o});var r=n(7582);async function a(e,t={}){try{let n={};t.dateFrom&&(n.date_from=t.dateFrom),t.dateTo&&(n.date_to=t.dateTo),t.status&&(n.status=t.status),t.clientId&&(n.client_id=t.clientId),t.staffId&&(n.staff_id=t.staffId),t.serviceId&&(n.service_id=t.serviceId),t.serviceIds&&t.serviceIds.length>0&&(n.service_ids=t.serviceIds,n.service_id=t.serviceIds);let a=[];t.includeClient&&a.push("client"),t.includeService&&a.push("service"),t.includeStaff&&a.push("staff");let o=[{name:"POST /company/{id}/appointments/search (recommended)",method:"POST",path:`/company/${e}/appointments/search`,body:{page:1,page_size:500,...n,...a.length?{include:a}:{}}},{name:"GET /company/{id}/appointments",method:"GET",path:`/company/${e}/appointments`,useQuery:!0},{name:"GET /location/{id}/timetable_event_schedules/days/events (Schedule Events API)",method:"GET",path:`/location/${e}/timetable_event_schedules/days/events`,useQuery:!0},{name:"GET /schedule/events (Schedule API, fallback)",method:"GET",path:"/schedule/events",useQuery:!0},{name:"POST /appointments/search",method:"POST",path:"/appointments/search",body:{location_id:e,page:1,page_size:500,...n,...a.length?{include:a}:{}}},{name:"GET /appointments?location_id=...",method:"GET",path:"/appointments",useQuery:!0}],i=null;for(let s of o){let o=s.path;try{let i=new URLSearchParams;s.useQuery&&(n.date_from&&i.set("date_from",n.date_from),n.date_to&&i.set("date_to",n.date_to),n.status&&i.set("status",n.status),n.client_id&&i.set("client_id",String(n.client_id)),n.staff_id&&i.set("staff_id",String(n.staff_id)),a.length&&a.forEach(e=>{i.append("include[]",e)}),"/appointments"===s.path?i.set("location_id",String(e)):"/schedule/events"===s.path?i.set("location_id",String(e)):s.path.includes("/timetable_event_schedules/days/events")&&(i.set("location_id",String(e)),n.date_from&&i.set("date_from",n.date_from),n.date_to&&i.set("date_to",n.date_to)));let d=s.useQuery&&i.toString()?`${s.path}?${i.toString()}`:s.path;o=d,console.log(`[altegio/appointments] Trying ${s.name} ‚Üí ${o}`);let l=await (0,r.B)(d,{method:s.method,..."POST"===s.method?{body:JSON.stringify(s.body??{})}:{}}),c=[];if(Array.isArray(l))c=l;else if(l&&"object"==typeof l&&(Array.isArray(l.data)?c=l.data:Array.isArray(l.appointments)?c=l.appointments:Array.isArray(l.items)?c=l.items:Array.isArray(l.results)&&(c=l.results),!c.length&&!0===l.success&&Array.isArray(l.data?.events)&&(c=l.data.events),!c.length&&Array.isArray(l.data)&&l.data.length>0)){let e=l.data[0];e&&(e.datetime||e.start_datetime||e.service_id)&&(c=l.data)}if(console.log(`[altegio/appointments] Response from ${s.name}: count=${c.length}`),0===c.length)continue;if(!t.dateFrom){let e=new Date;c=c.filter(t=>{let n=t.datetime||t.start_datetime||t.date;return!!n&&new Date(n)>=e})}return c.sort((e,t)=>{let n=e.datetime||e.start_datetime||e.date||"",r=t.datetime||t.start_datetime||t.date||"";return new Date(n).getTime()-new Date(r).getTime()}),console.log(`[altegio/appointments] ‚úÖ Got ${c.length} appointments for company ${e} using ${s.name}`),c}catch(n){let t=n instanceof Error?n:Error("string"==typeof n?n:JSON.stringify(n));t.message=`[${s.name}] ${o} :: ${t.message}`,i=t,console.warn(`[altegio/appointments] ‚ùå ${s.name} failed for company ${e}:`,t.message);continue}}if(i)throw i;return console.warn(`[altegio/appointments] No appointments found for company ${e}`),[]}catch(t){throw console.error(`[altegio/appointments] Failed to get appointments for company ${e}:`,t),t}}async function o(e,t=30,n=!0){let r=new Date,o=new Date(r);return o.setDate(o.getDate()+t),a(e,{dateFrom:r.toISOString().split("T")[0],dateTo:o.toISOString().split("T")[0],includeClient:n})}},6357:(e,t,n)=>{n.d(t,{WP:()=>i,b$:()=>s,hY:()=>d});var r=n(7560),a=n(4528);let o="photo-reports:telegram:chats";async function i(e,t,n,i){let s=(0,a.Wh)(t)||function(e,t){if(!e)return;let n=[e,t].filter(Boolean).join(" ").toLowerCase();return(0,a.N$)().find(r=>r.name.toLowerCase().includes(e.toLowerCase())||!!t&&r.name.toLowerCase().includes(t.toLowerCase())||r.name.toLowerCase()===n)}(n,i);if(!s)return console.warn("[photo-report] Unknown master tried to register",e,t),null;let d={masterId:s.id,chatId:e,username:t,firstName:n,lastName:i,registeredAt:new Date().toISOString()};return await r.kv.hset(o,{[e]:d}),{master:s,entry:d}}async function s(){let e=await r.kv.hgetall(o);return e?Object.values(e):[]}async function d(e){let t=(await s()).find(t=>t.masterId===e);return t?.chatId}},1833:(e,t,n)=>{n.d(t,{$d:()=>l,Ow:()=>d,oy:()=>i,zT:()=>c});var r=n(9637),a=n(6724),o=n(3783);async function i(e,t){let n=`üì∏ <b>–§–æ—Ç–æ-–∑–≤—ñ—Ç –¥–ª—è ${t.masterName}</b>

<b>–ö–ª—ñ—î–Ω—Ç:</b> ${t.clientName}
<b>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞:</b> ${t.serviceName}
<b>–ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –æ:</b> ${new Date(t.endAt).toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"})}

–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –ø—Ä—è–º–æ –≤ —Ü–µ–π —á–∞—Ç –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—ñ–∑–∏—Ç—É.`;return await s(e,t),(0,r.bG)(e,n,{reply_markup:{keyboard:[[{text:"\uD83D\uDCF8 –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ"}],[{text:`‚è∞ –ù–∞–≥–∞–¥–∞—Ç–∏ —á–µ—Ä–µ–∑ 5 —Ö–≤ (${t.id})`},{text:`‚ùå –ö–ª—ñ—î–Ω—Ç –ø—ñ—à–æ–≤ (${t.id})`}]],resize_keyboard:!0,one_time_keyboard:!1}})}async function s(e,t){await (0,o.E$)({chatId:e,masterId:t.masterId,appointment:t,createdAt:new Date().toISOString(),photoFileIds:[]})}async function d(e,t){await (0,o.tq)(t),await (0,o.$e)(t.appointmentId),await (0,o.sZ)(e)}async function l(e){return(0,o.Yu)(e)}function c(e){return a.go.ADMIN_CHAT_IDS.length?Promise.all(a.go.ADMIN_CHAT_IDS.map(t=>(0,r.bG)(t,e))):(console.warn("[telegram] No admin chat ids configured:",e),Promise.resolve())}},4528:(e,t,n)=>{n.d(t,{Kf:()=>p,OT:()=>c,mC:()=>l,Wh:()=>d,N$:()=>s,y8:()=>m});let r=[{id:"master-test",name:"–¢–µ—Å—Ç–æ–≤–∏–π –º–∞–π—Å—Ç–µ—Ä (Mykolay)",telegramUsername:"Mykolay007",role:"master"},{id:"master-olena",name:"–û–ª–µ–Ω–∞",telegramUsername:"o_sarbeeva",role:"master",altegioStaffId:2658785},{id:"master-tester",name:"Mykolay (—Ç–µ—Å—Ç-—Ä–µ–∂–∏–º)",telegramUsername:"Mykolay007",role:"master"},{id:"master-oleksandra",name:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞",telegramUsername:"Alexandra_Z7",role:"master",altegioStaffId:2851361},{id:"master-maryana",name:"–ú–∞—Ä'—è–Ω–∞",telegramUsername:"maryana24021989",role:"master",altegioStaffId:2860168},{id:"master-halyna",name:"–ì–∞–ª–∏–Ω–∞",telegramUsername:"Halyna_Maxymiv",role:"master",altegioStaffId:2658783},{id:"admin-viktoria",name:"–í—ñ–∫—Ç–æ—Ä—ñ—è (–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä)",telegramUsername:"kolachnykv",role:"admin",altegioStaffId:2643393}],a=new Date;function o(e,t){let n=new Date(e);return n.setMinutes(n.getMinutes()+t),n.toISOString()}let i=[{id:"apt-1001",clientName:"–Ü—Ä–∏–Ω–∞",serviceName:"–ù–∞—Ä–æ—â–µ–Ω–Ω—è –≤–æ–ª–æ—Å—Å—è (–ø–æ–≤–Ω–µ)",masterId:"master-olena",masterName:"–û–ª–µ–Ω–∞",startAt:o(a,-60),endAt:o(a,-5)},{id:"apt-1002",clientName:"–ú–∞—Ä—ñ—è",serviceName:"–ö–æ—Ä–µ–∫—Ü—ñ—è –Ω–∞—Ä–æ—â–µ–Ω–Ω—è",masterId:"master-oleksandra",masterName:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞",startAt:o(a,-30),endAt:o(a,10)},{id:"apt-1003",clientName:"–û–∫—Å–∞–Ω–∞",serviceName:"–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ —É–∫–ª–∞–¥–∫–∞",masterId:"master-maryana",masterName:"–ú–∞—Ä'—è–Ω–∞",startAt:o(a,-20),endAt:o(a,20)},{id:"apt-1004",clientName:"–¢–µ—Å—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç",serviceName:"–ù–∞—Ä–æ—â–µ–Ω–Ω—è –≤–æ–ª–æ—Å—Å—è (—Ç–µ—Å—Ç)",masterId:"master-test",masterName:"–¢–µ—Å—Ç–æ–≤–∏–π –º–∞–π—Å—Ç–µ—Ä (Mykolay)",startAt:o(a,-10),endAt:o(a,15)}];function s(){return r}function d(e){if(e)return r.find(t=>t.telegramUsername?.toLowerCase()===e.toLowerCase())}function l(e){return r.find(t=>t.altegioStaffId===e)}function c(e){return i.find(t=>t.id===e)}function m(e=15){let t=Date.now(),n=t+6e4*e;return i.filter(e=>{let r=new Date(e.endAt).getTime();return r>=t&&r<=n})}function p(e,t){if(!t)return null;let n=e.start_datetime||e.datetime||e.date,r=e.end_datetime||e.datetime||e.date;if(!n||!r)return console.warn(`[photo-reports] Appointment ${e.id} missing datetime fields`,e),null;let a=e.client?.name||e.client?.display_name||e.client_name||"–ö–ª—ñ—î–Ω—Ç",o=e.service?.title||e.service?.name||e.service_name||"–ü–æ—Å–ª—É–≥–∞";return{id:`altegio-${e.id}`,clientName:a,serviceName:o,masterId:t.id,masterName:t.name,startAt:new Date(n).toISOString(),endAt:new Date(r).toISOString()}}},3783:(e,t,n)=>{n.d(t,{$e:()=>f,E$:()=>s,HA:()=>u,Ri:()=>m,Yu:()=>d,qg:()=>p,sZ:()=>l,tq:()=>c,wH:()=>g});var r=n(7560);let a="photo-reports",o=e=>`photo-reports-pending:${e}`,i=e=>`${a}:${e}`;async function s(e){await r.kv.set(o(e.chatId),e,{ex:1800})}async function d(e){return r.kv.get(o(e))}async function l(e){await r.kv.del(o(e))}async function c(e){!e.telegramFileId&&e.telegramFileIds?.length>0&&(e.telegramFileId=e.telegramFileIds[0]),await r.kv.set(i(e.appointmentId),e)}async function m(e,t){let n=await d(e);return!!n&&(n.photoFileIds||(n.photoFileIds=[]),n.photoFileIds.includes(t)||(n.photoFileIds.push(t),await s(n)),!0)}async function p(e){return r.kv.get(i(e))}async function u(e=20){let t=`${a}:index`,n=await r.kv.lrange(t,0,-1)||[],o=[];for(let t of n.slice(0,e)){let e=await p(t);e&&o.push(e)}return o}async function f(e){let t=`${a}:index`;await r.kv.lpush(t,e),await r.kv.ltrim(t,0,99)}async function g(){let e=`${a}:index`,t=await r.kv.lrange(e,0,-1),n=0;for(let e of t)try{await r.kv.del(i(e)),n++}catch(t){console.warn(`[photo-reports/store] Failed to delete report ${e}:`,t)}return await r.kv.del(e),n}},9637:(e,t,n)=>{n.d(t,{A8:()=>d,MY:()=>s,bG:()=>o});var r=n(6724);async function a(e,t){(0,r.Jr)();let n=await fetch((0,r.kC)(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await n.json();if(!a.ok)throw Error(`Telegram API error (${e}): ${a.description||"Unknown error"}`);return a.result}function o(e,t,n={}){return a("sendMessage",{chat_id:e,text:t,parse_mode:"HTML",...n})}function i(e,t,n={}){return a("sendPhoto",{chat_id:e,photo:t,...n})}function s(e,t={}){return a("answerCallbackQuery",{callback_query_id:e,...t})}async function d(e,t){if(!r.go.REPORT_GROUP_ID){console.warn("[telegram] TELEGRAM_PHOTO_GROUP_ID not configured. Skipping forward.");return}if(0!==e.length){for(let t=0;t<e.length-1;t++)await i(r.go.REPORT_GROUP_ID,e[t]);await i(r.go.REPORT_GROUP_ID,e[e.length-1],{caption:t})}}},6724:(e,t,n)=>{n.d(t,{Jr:()=>a,go:()=>r,kC:()=>o});let r={BOT_TOKEN:process.env.TELEGRAM_BOT_TOKEN?.trim()||"",REPORT_GROUP_ID:process.env.TELEGRAM_PHOTO_GROUP_ID?Number(process.env.TELEGRAM_PHOTO_GROUP_ID):null,ADMIN_CHAT_IDS:process.env.TELEGRAM_ADMIN_CHAT_IDS?process.env.TELEGRAM_ADMIN_CHAT_IDS.split(",").map(e=>e.trim()).filter(Boolean).map(e=>Number(e)).filter(e=>!Number.isNaN(e)):[]};function a(){if(!r.BOT_TOKEN)throw Error("Missing TELEGRAM_BOT_TOKEN env variable")}function o(e){a();let t=e.startsWith("/")?e.slice(1):e;return`https://api.telegram.org/bot${r.BOT_TOKEN}/${t}`}},7560:(e,t,n)=>{n.d(t,{kv:()=>s});var r=n(242),a=null;process.env.UPSTASH_DISABLE_TELEMETRY="1";var o=class extends r.Redis{async *scanIterator(e){let t,n=0;do for(let r of([n,t]=await this.scan(n,e),t))yield r;while(0!==n)}async *hscanIterator(e,t){let n,r=0;do for(let a of([r,n]=await this.hscan(e,r,t),n))yield a;while(0!==r)}async *sscanIterator(e,t){let n,r=0;do for(let a of([r,n]=await this.sscan(e,r,t),n))yield a;while(0!==r)}async *zscanIterator(e,t){let n,r=0;do for(let a of([r,n]=await this.zscan(e,r,t),n))yield a;while(0!==r)}};function i(e){return new o({cache:"default",...e})}new Proxy({},{get(e,t,n){if("then"===t||"parse"===t)return Reflect.get(e,t,n);if(!a){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");console.warn('\x1b[33m"The default export has been moved to a named export and it will be removed in version 1, change to import { kv }\x1b[0m"'),a=i({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(a,t)}});var s=new Proxy({},{get(e,t){if(!a){if(!process.env.KV_REST_API_URL||!process.env.KV_REST_API_TOKEN)throw Error("@vercel/kv: Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN");a=i({url:process.env.KV_REST_API_URL,token:process.env.KV_REST_API_TOKEN})}return Reflect.get(a,t)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[8948,5972,242,7582],()=>n(4802));module.exports=r})();