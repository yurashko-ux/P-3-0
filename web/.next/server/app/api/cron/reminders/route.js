"use strict";(()=>{var e={};e.id=9050,e.ids=[9050],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7879:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>S,patchFetch:()=>A,requestAsyncStorage:()=>w,routeModule:()=>b,serverHooks:()=>v,staticGenerationAsyncStorage:()=>$});var s={};t.r(s),t.d(s,{GET:()=>y,POST:()=>h,dynamic:()=>u,runtime:()=>d});var n=t(9303),a=t(8716),i=t(670),o=t(7070),c=t(4332),l=t(2804);let d="nodejs",u="force-dynamic";async function m(e,r,t){let s="mykolayyurashko";if(e!==s)return console.log(`[reminders] ‚è≠Ô∏è Skipping @${e} - not test account (only ${s} allowed)`),{success:!1,error:`Test mode: only @${s} allowed`};console.log(`[reminders] üì§ Sending Instagram DM to @${e}:`,{message:r,jobId:t.id,visitId:t.visitId,visitDate:t.datetime,clientName:t.payload.clientName});let n=process.env.MANYCHAT_API_KEY||process.env.ManyChat_API_Key||process.env.MANYCHAT_API_TOKEN||process.env.MC_API_KEY||process.env.MANYCHAT_APIKEY;if(n)try{console.log("[reminders] Attempting to send via ManyChat API");let t=await g(e,r,n);if(t.success)return t;console.warn("[reminders] ManyChat API failed, trying Instagram Graph API:",t.error)}catch(e){console.warn("[reminders] ManyChat API error:",e)}let a=process.env.INSTAGRAM_ACCESS_TOKEN;if(a)try{console.log("[reminders] Attempting to send via Instagram Graph API");let t=await f(e,r,a);if(t.success)return t;console.warn("[reminders] Instagram Graph API failed:",t.error)}catch(e){console.warn("[reminders] Instagram Graph API error:",e)}return console.log(`[reminders] ‚ö†Ô∏è No API configured, simulating send (mock mode)`),{success:!0,messageId:`mock_${Date.now()}_${t.id}`}}async function g(e,r,t){try{let s=null,n=null,a=e.startsWith("@")?e.slice(1):e;console.log(`[reminders] Searching ManyChat subscriber for Instagram username: ${a} (original: ${e})`),console.log("[reminders] ===== METHOD 1: getSubscribers with ig_username filter =====");try{for(let e=1;e<=10;e++){let r=`https://api.manychat.com/fb/subscriber/getSubscribers?page=${e}&limit=100`;console.log(`[reminders] Fetching page ${e} from getSubscribers...`);let i=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(i.ok){let r=await i.json(),t=r?.data||[];if(console.log(`[reminders] Page ${e}: received ${t.length} subscribers`),1===e&&t.length>0){let e=t[0];console.log("[reminders] Sample subscriber structure:",JSON.stringify({id:e.id,name:e.name,ig_username:e.ig_username,has_ig_username:!!e.ig_username,keys:Object.keys(e).slice(0,10)},null,2))}let o=t.find(e=>{let r=e.ig_username?.toLowerCase().trim(),t=a.toLowerCase().trim(),s=r===t;return r&&console.log(`[reminders] Checking subscriber ${e.id}: ig_username="${r}" vs search="${t}" -> ${s?"MATCH!":"no match"}`),s});if(o){s=o.id||o.subscriber_id,n=o,console.log(`[reminders] ‚úÖ Found subscriber via getSubscribers on page ${e}: ${s}`,JSON.stringify(o,null,2));break}if(t.length<100){console.log(`[reminders] Last page reached (${t.length} < 100)`);break}}else{let r=await i.text();console.warn(`[reminders] getSubscribers failed on page ${e}: ${i.status} ${r.substring(0,200)}`);break}}s||console.warn(`[reminders] ‚ùå Subscriber not found via getSubscribers after checking up to 10 pages`)}catch(e){console.error("[reminders] getSubscribers error:",e)}if(!s)for(let e of(console.log("[reminders] ===== METHOD 2: findByCustomField ====="),console.log(`[reminders] Trying findByCustomField for Instagram username: "${a}"`),["ig_username","instagram_username","instagram","username","Instagram Username","Instagram"])){if(s)break;let r=await fetch("https://api.manychat.com/fb/subscriber/findByCustomField",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({field_id:e,field_value:a})});if(r.ok){if(n=await r.json(),s=n?.data?.subscriber_id||n?.subscriber_id||n?.subscriber?.id){console.log(`[reminders] ‚úÖ Found via findByCustomField with field_id: ${e}`,JSON.stringify(n,null,2));break}console.log(`[reminders] findByCustomField (${e}) returned OK but no subscriber_id:`,JSON.stringify(n,null,2))}else{let t=await r.text();console.log(`[reminders] findByCustomField (${e}) failed: ${r.status} ${t}`)}}if(!s)return{success:!1,error:`Subscriber not found in ManyChat for ${a}. Make sure the user has interacted with your ManyChat bot.`};console.log(`[reminders] Found subscriber_id: ${s} for ${a}`);let i=await fetch("https://api.manychat.com/fb/sending/sendContent",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({subscriber_id:s,data:{version:"v2",content:{messages:[{type:"text",text:r}]}}})});if(!i.ok){let e=await i.text();return{success:!1,error:`ManyChat send failed: ${i.status} ${e}`}}let o=await i.json();return{success:!0,messageId:o?.data?.message_id||`manychat_${Date.now()}`}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}async function f(e,r,t){try{let s=process.env.INSTAGRAM_PAGE_ID;if(!s)return{success:!1,error:"INSTAGRAM_PAGE_ID not configured"};let n=`https://graph.facebook.com/v18.0/${s}?fields=instagram_business_account&access_token=${t}`,a=await fetch(n);if(!a.ok){let e=await a.text();return{success:!1,error:`Failed to get Instagram Business Account: ${a.status} ${e}`}}let i=await a.json(),o=i?.instagram_business_account?.id;if(!o)return{success:!1,error:"Instagram Business Account not found"};let c=`https://graph.instagram.com/v18.0/${o}/business_discovery?username=${encodeURIComponent(e)}&fields=id,username&access_token=${t}`,l=await fetch(c);if(!l.ok)return{success:!1,error:`Failed to find user @${e}: ${l.status}`};let d=await l.json(),u=d?.business_discovery?.id;if(!u)return{success:!1,error:`User @${e} not found`};let m=`https://graph.facebook.com/v18.0/${o}/messages`,g=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipient:{id:u},message:{text:r},access_token:t})});if(!g.ok){let e=await g.text();return{success:!1,error:`Instagram send failed: ${g.status} ${e}`}}let f=await g.json();return{success:!0,messageId:f?.message_id||`instagram_${Date.now()}`}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}async function p(e,r,t){let s="altegio:reminder:sent:log",n={timestamp:Date.now(),jobId:e.id,visitId:e.visitId,instagram:e.instagram,clientName:e.payload.clientName,message:r,result:t,visitDateTime:e.datetime,ruleId:e.ruleId},a=await c.kvRead.getRaw(s),i=[];if(a)try{let e;if("string"==typeof a)try{e=JSON.parse(a)}catch{e=a}else e=a;if(e&&"object"==typeof e&&!Array.isArray(e)){let r=e.value??e.result??e.data;if(void 0!==r){if("string"==typeof r)try{e=JSON.parse(r)}catch{e=r}else e=r}}Array.isArray(e)&&(i=e)}catch(e){console.warn("[reminders] Failed to parse sent log:",e),i=[]}i.unshift(n),i.length>1e3&&(i=i.slice(0,1e3)),await c.kvWrite.setRaw(s,JSON.stringify(i))}async function y(e){return h(e)}async function h(e){if(console.log("[reminders] POST request received"),!function(e){if("1"===e.headers.get("x-vercel-cron"))return!0;let r=e.nextUrl.searchParams.get("secret"),t=process.env.CRON_SECRET||"";return!!t&&!!r&&t===r}(e))return console.log("[reminders] Request forbidden - not a valid cron request"),o.NextResponse.json({ok:!1,error:"forbidden"},{status:403});console.log("[reminders] Request authorized, starting reminder processing");try{let e=Date.now(),r=await (0,l.v$)(),t=new Map(r.map(e=>[e.id,e])),s=await c.kvRead.getRaw("altegio:reminder:index"),n=[];if(s)try{let e;if("string"==typeof s)try{e=JSON.parse(s)}catch{e=s}else e=s;if(e&&"object"==typeof e&&!Array.isArray(e)){let r=e.value??e.result??e.data;if(void 0!==r){if("string"==typeof r)try{e=JSON.parse(r)}catch{e=r}else e=r}}Array.isArray(e)&&(n=e)}catch(e){console.warn("[reminders] Failed to parse index:",e),n=[]}console.log(`[reminders] Found ${n.length} jobs in index`);let a={processed:0,sent:0,failed:0,skipped:0,errors:[]};for(let r of n)try{let s;let n=`altegio:reminder:job:${r}`,i=await c.kvRead.getRaw(n);if(!i){console.warn(`[reminders] Job ${r} not found in KV`);continue}if("string"==typeof i)try{s=JSON.parse(i)}catch{s=i}else s=i;if(s&&"object"==typeof s&&!Array.isArray(s)){let e=s.value??s.result??s.data;if(void 0!==e){if("string"==typeof e)try{s=JSON.parse(e)}catch{s=e}else s=e}}if("string"==typeof s)try{s=JSON.parse(s)}catch(e){console.warn(`[reminders] Failed to parse job ${r}:`,e);continue}let o=s;if(a.processed++,"pending"!==o.status){console.log(`[reminders] ‚è≠Ô∏è Skipping job ${r}: status=${o.status}`),a.skipped++;continue}if(o.dueAt>e){console.log(`[reminders] ‚è≠Ô∏è Skipping job ${r}: dueAt in future (${new Date(o.dueAt).toISOString()})`),a.skipped++;continue}if(!o.instagram){console.log(`[reminders] ‚è≠Ô∏è Skipping job ${r}: no Instagram username`),a.skipped++;continue}let d=t.get(o.ruleId);if(!d){console.warn(`[reminders] ‚ö†Ô∏è Rule ${o.ruleId} not found for job ${r}`),o.status="failed",o.lastError=`Rule ${o.ruleId} not found`,o.updatedAt=e,await c.kvWrite.setRaw(n,JSON.stringify(o)),a.failed++;continue}let u=(0,l.VE)(o,d);console.log(`[reminders] üì§ Sending reminder for job ${r} to @${o.instagram}`);let g=await m(o.instagram,u,o);g.success?(o.status="sent",o.updatedAt=e,o.attempts++,delete o.lastError,await c.kvWrite.setRaw(n,JSON.stringify(o)),await p(o,u,g),a.sent++,console.log(`[reminders] ‚úÖ Successfully sent reminder for job ${r}`)):(o.status="failed",o.lastError=g.error||"Unknown error",o.attempts++,o.updatedAt=e,await c.kvWrite.setRaw(n,JSON.stringify(o)),a.failed++,a.errors.push(`Job ${r}: ${g.error||"Unknown error"}`),console.error(`[reminders] ‚ùå Failed to send reminder for job ${r}:`,g.error))}catch(e){console.error(`[reminders] Error processing job ${r}:`,e),a.errors.push(`Job ${r}: ${e instanceof Error?e.message:String(e)}`),a.failed++}let i={ok:!0,timestamp:new Date().toISOString(),summary:a};return console.log("[reminders] Reminder processing completed:",a),o.NextResponse.json(i)}catch(e){return console.error("[reminders] Fatal error:",e),o.NextResponse.json({ok:!1,error:String(e),timestamp:new Date().toISOString()},{status:500})}}let b=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/cron/reminders/route",pathname:"/api/cron/reminders",filename:"route",bundlePath:"app/api/cron/reminders/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/cron/reminders/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:$,serverHooks:v}=b,S="/api/cron/reminders/route";function A(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:$})}},2804:(e,r,t)=>{t.d(r,{VE:()=>n,mw:()=>o,po:()=>i,v$:()=>a});let s=[{id:"before_7d",daysBefore:7,active:!0,channel:"instagram_dm",template:"–ù–∞–≥–∞–¥—É—î–º–æ –ø—Ä–æ –≤–∞—à –≤—ñ–∑–∏—Ç {date} –æ {time} —É Home of Beauty. –ß–µ–∫–∞—î–º–æ –≤–∞—Å! ‚ù§Ô∏è"},{id:"before_3d",daysBefore:3,active:!0,channel:"instagram_dm",template:"–ß–µ—Ä–µ–∑ {daysLeft} –¥–Ω—ñ(–≤) —É –≤–∞—Å –∑–∞–ø–∏—Å {date} –æ {time}. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ—Å—è –¥–æ –≤—ñ–∑–∏—Ç—É!"},{id:"before_1d",daysBefore:1,active:!0,channel:"instagram_dm",template:"–ó–∞–≤—Ç—Ä–∞ —É –≤–∞—Å –≤—ñ–∑–∏—Ç {date} –æ {time}. –ß–µ–∫–∞—î–º–æ –≤–∞—Å! ‚ù§Ô∏è"}];function n(e,r){let t=new Date(e.datetime),s=t.toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit",year:"numeric"}),n=t.toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"}),a=Math.round((t.getTime()-Date.now())/864e5);return r.template.replace("{clientName}",e.payload.clientName||"").replace("{instagram}",e.instagram?"@"+e.instagram:"").replace("{date}",s).replace("{time}",n).replace("{service}",e.payload.serviceTitle||"").replace("{master}",e.payload.staffName||"").replace("{daysLeft}",String(a))}async function a(){try{let e;let{kvRead:r}=await Promise.resolve().then(t.bind(t,4332)),n=await r.getRaw("altegio:reminder:rules");if(!n)return s.filter(e=>e.active);if("string"==typeof n)try{e=JSON.parse(n)}catch{e=n}else e=n;if(e&&"object"==typeof e&&!Array.isArray(e)){let r=e.value??e.result??e.data;if(void 0!==r){if("string"==typeof r)try{e=JSON.parse(r)}catch{e=r}else e=r}}if(Array.isArray(e)&&e.length>0)return e.filter(e=>e.active)}catch(e){console.warn("[reminders] Failed to load rules from KV, using defaults:",e)}return s.filter(e=>e.active)}function i(e,r){return`${e}:${r}`}function o(e,r){return new Date(e).getTime()-864e5*r}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,5972,4332],()=>t(7879));module.exports=s})();