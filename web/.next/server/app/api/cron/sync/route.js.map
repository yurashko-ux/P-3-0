{"version":3,"file":"app/api/cron/sync/route.js","mappings":"oFAAAA,CAAAA,EAAAC,OAAA,CAAAC,QAAA,0CCAAF,CAAAA,EAAAC,OAAA,CAAAC,QAAA,iXCGO,IAAMC,EAAU,OAehB,eAAeC,EAAKC,CAAgB,EACzC,GAAI,CAACC,SAdSD,CAAgB,EAG9B,GADqBA,MAAAA,EAAIE,OAAO,CAACC,GAAG,CAAC,iBACnB,MAAO,GAGzB,IAAMC,EAAYJ,EAAIK,OAAO,CAACC,YAAY,CAACH,GAAG,CAAC,UACzCI,EAAYC,QAAQC,GAAG,CAACC,WAAW,EAAI,SACzCH,EAAAA,KAAaH,GAAaG,IAAcH,CAG9C,EAGcJ,GACV,OAAOW,EAAAA,EAAYA,CAACC,IAAI,CAAC,CAAEC,GAAI,GAAOC,MAAO,WAAY,EAAG,CAAEC,OAAQ,GAAI,GAG5E,IAAMC,EAAYR,QAAQC,GAAG,CAACQ,UAAU,EAAI,GACtCC,EACJV,QAAQC,GAAG,CAACU,UAAU,EACtBnB,EAAIE,OAAO,CAACC,GAAG,CAAC,qBAChBH,EAAIE,OAAO,CAACC,GAAG,CAAC,QAElB,GAAI,CAACe,EACH,OAAOP,EAAAA,EAAYA,CAACC,IAAI,CAAC,CAAEC,GAAI,GAAOC,MAAO,eAAgB,EAAG,CAAEC,OAAQ,GAAI,GAEhF,GAAI,CAACC,EACH,OAAOL,EAAAA,EAAYA,CAACC,IAAI,CAAC,CAAEC,GAAI,GAAOC,MAAO,oBAAqB,EAAG,CAAEC,OAAQ,GAAI,GAGrF,IAAMK,EAAS,CAAC,QAAQ,EAAEF,EAAU,CAAC,CAC/BG,EAAU,CAAC,EAAED,EAAO,wCAAwC,CAAC,CAEnE,GAAI,CACF,IAAME,EAAM,MAAMC,MAAMF,EAAS,CAC/BG,OAAQ,OACRtB,QAAS,CACP,cAAiB,CAAC,OAAO,EAAEc,EAAU,CAAC,CAG1C,GAEMS,EAAO,MAAMH,EAAIV,IAAI,GAAGc,KAAK,CAAC,IAAO,EAAC,IAC5C,OAAOf,EAAAA,EAAYA,CAACC,IAAI,CAAC,CACvBC,GAAIS,EAAIT,EAAE,CACVE,OAAQO,EAAIP,MAAM,CAClBY,KAAMF,CACR,EAAG,CAAEV,OAAQO,EAAIT,EAAE,CAAG,IAAMS,EAAIP,MAAM,EACxC,CAAE,MAAOa,EAAQ,CACf,OAAOjB,EAAAA,EAAYA,CAACC,IAAI,CAAC,CAAEC,GAAI,GAAOC,MAAOe,OAAOD,EAAG,EAAG,CAAEb,OAAQ,GAAI,EAC1E,CACF,CAEO,eAAee,EAAI9B,CAAgB,EAExC,OAAOD,EAAKC,EACd,CCvDA,IAAA+B,EAAA,IAAwBC,EAAAC,mBAAmB,EAC3CC,WAAA,CACAC,KAAcC,EAAAC,CAAS,CAAAC,SAAA,CACvBC,KAAA,uBACAC,SAAA,iBACAC,SAAA,QACAC,WAAA,yBACA,EACAC,iBAAA,sDACAC,iBAVA,GAWAC,SAAYC,CACZ,GAIA,CAAQC,oBAAAA,CAAA,CAAAC,6BAAAA,CAAA,CAAAC,YAAAA,CAAA,EAAiElB,EACzEmB,EAAA,uBACA,SAAAC,IACA,MAAW,GAAAC,EAAAC,EAAA,EAAW,CACtBJ,YAAAA,EACAD,6BAAAA,CACA,EACA,CC1BO,IAAAM,EAAqBC,EAC5BC,EAAeC,EAAAC,CAAsB,CAAAC,IAAA,CAAM5B","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/cron/sync/route.ts","webpack://_N_E/./app/api/cron/sync/route.ts?1559","webpack://_N_E/?d03e"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","// web/app/api/cron/sync/route.ts\nimport { NextRequest, NextResponse } from \"next/server\";\n\nexport const runtime = \"edge\";\n\nfunction okCron(req: NextRequest) {\n  // 1) Дозволяємо офіційний крон Vercel\n  const isVercelCron = req.headers.get(\"x-vercel-cron\") === \"1\";\n  if (isVercelCron) return true;\n\n  // 2) Або запит з локальним секретом (на випадок ручного виклику)\n  const urlSecret = req.nextUrl.searchParams.get(\"secret\");\n  const envSecret = process.env.CRON_SECRET || \"\";\n  if (envSecret && urlSecret && envSecret === urlSecret) return true;\n\n  return false;\n}\n\nexport async function POST(req: NextRequest) {\n  if (!okCron(req)) {\n    return NextResponse.json({ ok: false, error: \"forbidden\" }, { status: 403 });\n  }\n\n  const adminPass = process.env.ADMIN_PASS || \"\";\n  const vercelUrl =\n    process.env.VERCEL_URL ||\n    req.headers.get(\"x-forwarded-host\") ||\n    req.headers.get(\"host\");\n\n  if (!vercelUrl) {\n    return NextResponse.json({ ok: false, error: \"no vercel url\" }, { status: 500 });\n  }\n  if (!adminPass) {\n    return NextResponse.json({ ok: false, error: \"missing ADMIN_PASS\" }, { status: 500 });\n  }\n\n  const origin = `https://${vercelUrl}`;\n  const syncUrl = `${origin}/api/keycrm/sync?per_page=50&max_pages=3`;\n\n  try {\n    const res = await fetch(syncUrl, {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${adminPass}`\n      }\n      // body: не потрібне — ваш /api/keycrm/sync приймає query-параметри\n    });\n\n    const data = await res.json().catch(() => ({}));\n    return NextResponse.json({\n      ok: res.ok,\n      status: res.status,\n      sync: data\n    }, { status: res.ok ? 200 : res.status });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: String(e) }, { status: 500 });\n  }\n}\n\nexport async function GET(req: NextRequest) {\n  // Дозволяємо GET для швидкої перевірки статусу (лише для крону/секрету)\n  return POST(req);\n}\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"/Users/mykolay/P-3-0/web/app/api/cron/sync/route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/cron/sync/route\",\n        pathname: \"/api/cron/sync\",\n        filename: \"route\",\n        bundlePath: \"app/api/cron/sync/route\"\n    },\n    resolvedPagePath: \"/Users/mykolay/P-3-0/web/app/api/cron/sync/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/cron/sync/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fcron%2Fsync%2Froute&page=%2Fapi%2Fcron%2Fsync%2Froute&pagePath=private-next-app-dir%2Fapi%2Fcron%2Fsync%2Froute.ts&appDir=%2FUsers%2Fmykolay%2FP-3-0%2Fweb%2Fapp&appPaths=%2Fapi%2Fcron%2Fsync%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/cron/sync/route.ts?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map"],"names":["module","exports","require","runtime","POST","req","okCron","headers","get","urlSecret","nextUrl","searchParams","envSecret","process","env","CRON_SECRET","NextResponse","json","ok","error","status","adminPass","ADMIN_PASS","vercelUrl","VERCEL_URL","origin","syncUrl","res","fetch","method","data","catch","sync","e","String","GET","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fcron_2Fsync_2Froute_ts_page_2Fapi_2Fcron_2Fsync_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGY3JvbiUyRnN5bmMlMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRmNyb24lMkZzeW5jJTJGcm91dGUmcGFnZVBhdGg9cHJpdmF0ZS1uZXh0LWFwcC1kaXIlMkZhcGklMkZjcm9uJTJGc3luYyUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRm15a29sYXklMkZQLTMtMCUyRndlYiUyRmFwcCZhcHBQYXRocz0lMkZhcGklMkZjcm9uJTJGc3luYyUyRnJvdXRlJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEIQ_3D_3D_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap"],"sourceRoot":""}