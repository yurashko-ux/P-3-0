"use strict";(()=>{var e={};e.id=9962,e.ids=[9962],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},488:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>I,patchFetch:()=>M,requestAsyncStorage:()=>C,routeModule:()=>N,serverHooks:()=>K,staticGenerationAsyncStorage:()=>S});var r={};a.r(r),a.d(r,{GET:()=>R,POST:()=>A,dynamic:()=>f,runtime:()=>y});var n=a(9303),s=a(8716),o=a(670),l=a(7070),i=a(1964),u=a(4332),c=a(6195),m=a(1089),d=a(7756),p=a(3903),h=a(239);let y="nodejs",f="force-dynamic",g=null,v=null,w=0,k=null;function _(e){if("string"==typeof e){let t=e.trim();return t.length?t:null}return"number"==typeof e&&Number.isFinite(e)?String(e):null}function x(...e){for(let t of e){let e=_(t);if(e)return e}return null}function b(e,t=new WeakSet){if(null==e)return null;if("string"==typeof e){let a=e.trim();if(a.length)try{let e=JSON.parse(a);return b(e,t)??a}catch{return a}return null}if("number"==typeof e&&Number.isFinite(e))return String(e);if(Array.isArray(e)){for(let a of e){let e=b(a,t);if(e)return e}return null}if("object"!=typeof e||t.has(e))return null;t.add(e);let a=x(e.text,e.message,e.content,e.body,e.payload,e.preview,e.description);if(a)return a;for(let a of["text","message","content","body","payload","data","event","last_message","lastMessage","last_message_text","lastMessageText","last_message_preview","lastMessagePreview"]){if(!(a in e))continue;let r=b(e[a],t);if(r)return r}for(let a of Object.values(e)){let e=b(a,t);if(e)return e}return null}function E(e,t,a){if(!e)return null;let r="string"==typeof e.text?e.text.trim():"";if(r.length)return r===e.text?e:{...e,text:r};for(let r of[e.rawText,e.raw,a,t]){if(null==r)continue;if("string"==typeof r){let t=r.trim();if(t.length)try{let a=JSON.parse(t),r=b(a);if(r&&r.trim().length)return{...e,text:r.trim(),rawText:t}}catch{if(t.length)return{...e,text:t,rawText:t}}continue}let t=b(r);if(t&&t.trim().length)return{...e,text:t.trim()}}return e}async function T(e){let t=null;try{t=await e.text()}catch{t=null}if(!t)return{parsed:{},rawText:null};let a=t.trim(),r=e.headers.get("content-type")?.toLowerCase()??"";if(a)try{return{parsed:JSON.parse(a),rawText:t}}catch{}if(r.includes("application/x-www-form-urlencoded"))try{let e=new URLSearchParams(t),a={};for(let[t,r]of e.entries())a[t]=r;return{parsed:a,rawText:t}}catch{}return{parsed:{text:t,raw:t},rawText:t}}async function A(e){console.log("[manychat] POST request received");try{let t,r,n,s;console.log("[manychat] Step 1: Checking authentication");let o=(0,i.SJ)("MC_TOKEN"),y=(0,i.SJ)("MANYCHAT_API_KEY","MANYCHAT_API_TOKEN","MC_API_KEY"),f=e.headers.get("x-mc-token")||e.headers.get("authorization")?.replace(/^Bearer\s+/i,"")||"",b=new Set;if(o&&b.add(o),y&&b.add(y),b.size>0&&f&&!b.has(f))return v={receivedAt:Date.now(),status:"rejected",reason:"Невірний токен авторизації",statusCode:401},l.NextResponse.json({ok:!1,error:"invalid token"},{status:401});console.log("[manychat] Step 2: Reading request payload");try{let a=await T(e);t=a.parsed,r=a.rawText,console.log("[manychat] Step 2: Request payload read successfully")}catch(e){throw console.error("[manychat] Step 2: Failed to read request payload:",e),e}console.log("[manychat] Step 3: Normalizing payload");try{n=function(e,t){let a=e&&"object"==typeof e?e:{},r=x(a.handle,a.username,a.subscriber?.username,a.user?.username,a.sender?.username),n=x(a.full_name,a.fullName,a.fullname,a.name,[a.first_name,a.last_name].filter(Boolean).join(" ").trim()||null,a.subscriber?.name,a.user?.full_name,a.sender?.name),s=a.message,o=a.data,l=x(a.text,s?.text,o?.text,s,o)??"",i=x(a.title,s?.title,o?.title)??"IG Message";return{id:++w,receivedAt:Date.now(),source:"webhook:/api/mc/manychat",title:i,handle:r,fullName:n,text:l,raw:e,rawText:t??function(e){if("string"==typeof e){let t=e.trim();return t.length?t:null}try{return JSON.stringify(e)}catch{return null}}(e)}}(t,r),console.log("[manychat] Step 3: Payload normalized successfully")}catch(e){throw console.error("[manychat] Step 3: Failed to normalize payload:",e),e}g=n,v={receivedAt:n.receivedAt,status:"accepted",statusCode:200,handle:n.handle,fullName:n.fullName,messagePreview:n.text?n.text.slice(0,180):null};try{await (0,h.hk)(n,v)}catch(t){let e=t instanceof Error?t.message:"string"==typeof t?t:null;v={...v,reason:e?`Помилка збереження у KV: ${e}`:"Помилка збереження у KV"}}console.log("[manychat] Step 4: Starting automation routing");try{let e=t&&"object"==typeof t&&!Array.isArray(t)?t:{},a=e.message,r=e.data,o=e.subscriber,l=e.user,i=(0,c.m)({username:x(n.handle,e.username,e.handle,a?.username,a?.handle,o?.username,l?.username),text:x(n.text,e.text,a?.text,r?.text,a?.message?.text,e.message?.text),full_name:x(n.fullName,e.full_name,e.name,o?.name,l?.full_name),first_name:x(e.first_name,o?.first_name,l?.first_name),last_name:x(e.last_name,o?.last_name,l?.last_name)}),u=[{kind:"webhook_handle",value:n.handle??null},{kind:"webhook_fullName",value:n.fullName??null},{kind:"payload_username",value:x(e.username,e.handle)},{kind:"message_username",value:x(a?.username,a?.handle)},{kind:"subscriber_username",value:x(o?.username)},{kind:"user_username",value:x(l?.username)}];console.log("[manychat] Step 4: Calling routeManychatMessage"),s=await (0,m.M)({normalized:i,identityCandidates:u,performMove:async({cardId:e,pipelineId:t,statusId:a,pipelineStatusId:r,statusAliases:n})=>{let s=_(e);if(!s)return{ok:!1,status:0,skippedReason:"card_id_missing",response:{error:"card_id missing"}};let o=e=>_(e),l=Array.isArray(n)?n.map(e=>o(e)).filter(e=>!!e):[];try{let e=await (0,d.$j)({cardId:s,pipelineId:o(t),statusId:o(a),pipelineStatusId:o(r),statusAliases:l});return{ok:e.ok,status:e.status,response:e.response,sent:e.sent,attempts:e.attempts,requestUrl:e.requestUrl,requestMethod:e.requestMethod,baseUrl:e.baseUrl??null}}catch(a){let e="string"==typeof a?.code?a.code:void 0,t=a instanceof Error?a.message:String(a);return{ok:!1,status:0,response:{error:t,code:e},skippedReason:"keycrm_not_configured"===e?"keycrm_not_configured":void 0}}}}),console.log("[manychat] Step 4: Automation routing completed:",{ok:s?.ok})}catch(e){console.error("[manychat] Step 4: Automation routing failed:",e),s={ok:!1,error:"automation_exception",details:e instanceof Error?{message:e.message}:{message:String(e)}}}if(console.log("[manychat] NEW CODE: Checking if should update counters:",{automationOk:s?.ok,moveAttempted:s?.ok?s.move?.attempted:void 0,moveOk:s?.ok?s.move?.ok:void 0}),s?.ok&&s.move?.attempted&&s.move.ok){let e=s.match?.campaign?.id,t=s.match?.route;if(console.log("[manychat] NEW CODE: Inside counter update block:",{campaignId:e,route:t}),e&&("v1"===t||"v2"===t))try{let r="v1"===t?"v1_count":"v2_count",n=[u.campaignKeys.ITEM_KEY(e),u.campaignKeys.CMP_ITEM_KEY(e),u.campaignKeys.LEGACY_ITEM_KEY(e)],o=null;for(let t of n){let a=await u.kvRead.getRaw(t);if(a){let t=(0,p.b)(a);if(t&&(t.id===e||String(t.id)===e)){o=a;break}}}let l=u.campaignKeys.ITEM_KEY(e);if(console.log("[manychat] Updating counter:",{campaignId:e,route:t,field:r,itemKey:l,foundRaw:!!o}),o){let n;if(console.log("[manychat] Campaign found in KV, proceeding with counter update"),console.log("[manychat] Raw data type:",typeof o,"length:","string"==typeof o?o.length:"N/A"),"string"==typeof o)try{n=JSON.parse(o)}catch(e){console.error("[manychat] Failed to parse campaign JSON:",e),n=null}else n=o,console.log("[manychat] Raw data is not a string, using as-is:",typeof n);if(console.log("[manychat] After parsing, campaign type:",typeof n,"isObject:",n&&"object"==typeof n),n&&"object"==typeof n){console.log("[manychat] Campaign is an object, proceeding with counter update"),n.counters||(n.counters={v1:n.v1_count||0,v2:n.v2_count||0,exp:n.exp_count||0});let o="number"==typeof n[r]?n[r]:0;n[r]=o+1,console.log("[manychat] Counter incremented:",{field:r,oldValue:o,newValue:n[r]}),"v1"===t?n.counters.v1=n.v1_count:"v2"===t&&(n.counters.v2=n.v2_count);let i=n.counters.v1||n.v1_count||0,c=n.counters.v2||n.v2_count||0,m=n.counters.exp||n.exp_count||0;n.movedTotal=i+c+m,n.movedV1=i,n.movedV2=c,n.movedExp=m,console.log("[manychat] Counters calculated:",{v1Count:i,v2Count:c,expCount:m,movedTotal:n.movedTotal}),console.log("[manychat] Before saving: campaign object prepared",{campaignId:e,itemKey:l,v1_count:n.v1_count,movedV1:n.movedV1,movedTotal:n.movedTotal,campaignType:typeof n,isObject:n&&"object"==typeof n});try{let a=JSON.stringify(n);console.log("[manychat] Serialized campaign:",{campaignId:e,itemKey:l,serializedLength:a.length,serializedPreview:a.slice(0,200)}),console.log(`[manychat] Saving to ITEM_KEY: ${l}`,{campaignId:e,v1_count:n.v1_count,movedV1:n.movedV1,movedTotal:n.movedTotal}),await u.kvWrite.setRaw(l,a),console.log(`[manychat] Successfully saved to ITEM_KEY: ${l}`);let s=await u.kvRead.getRaw(l);if(s){let t=(0,p.b)(s);console.log(`[manychat] Verified ITEM_KEY after save: ${l}`,{campaignId:e,found:!!t,v1_count:t?.v1_count,movedV1:t?.movedV1,movedTotal:t?.movedTotal})}else console.error(`[manychat] Failed to verify ITEM_KEY after save: ${l}`);let i=u.campaignKeys.CMP_ITEM_KEY(e);try{await u.kvWrite.setRaw(i,a),console.log(`[manychat] Successfully saved to CMP_ITEM_KEY: ${i}`)}catch(e){console.warn("[manychat] Failed to save to CMP_ITEM_KEY:",e)}let c=u.campaignKeys.LEGACY_ITEM_KEY(e);try{await u.kvWrite.setRaw(c,a),console.log(`[manychat] Successfully saved to LEGACY_ITEM_KEY: ${c}`)}catch(e){console.warn("[manychat] Failed to save to LEGACY_ITEM_KEY:",e)}console.log("[manychat] Counter updated successfully:",{campaignId:e,route:t,field:r,oldValue:o,newValue:n[r],movedTotal:n.movedTotal,movedV1:n.movedV1,movedV2:n.movedV2,savedToKeys:[l,i,c]})}catch(t){console.error("[manychat] Error during save operation:",{campaignId:e,itemKey:l,error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0})}try{await u.kvWrite.lpush(u.campaignKeys.INDEX_KEY,e)}catch(e){}try{let{updateCampaignBaseCardsCount:t}=await a.e(7985).then(a.bind(a,7985));await t(e)}catch(e){console.warn("[manychat] Failed to update base cards count:",e)}if((n.expDays||n.expireDays||n.exp||n.vexp||n.expire||n.texp)&&s.search?.selected?.match?.cardId)try{let t=String(s.search.selected.match.cardId),r=s.match?.campaign?.base?.pipelineId?Number(s.match.campaign.base.pipelineId):null,n=s.match?.campaign?.base?.statusId?Number(s.match.campaign.base.statusId):null,{saveExpTracking:o}=await a.e(6071).then(a.bind(a,6071));await o(e,t,r,n)}catch(e){console.warn("[manychat] Failed to save EXP tracking:",e)}}else console.error("[manychat] Campaign is not an object:",{campaignId:e,itemKey:l,campaignType:typeof n})}else console.warn("[manychat] Campaign not found in KV:",{campaignId:e,possibleKeys:n}),console.log("[manychat] EXITING: No raw data found, cannot update counters")}catch(a){console.error("[manychat] Error updating counter:",{campaignId:e,route:t,error:a instanceof Error?a.message:String(a)})}}if(s)try{await (0,h.lW)(s)}catch(e){console.error("[manychat] Не вдалося зберегти автоматизацію у KV:",e)}return k=s,console.log("[manychat] Returning response:",{ok:!0,automationOk:s?.ok,moveAttempted:s?.ok?s.move?.attempted:void 0,moveOk:s?.ok?s.move?.ok:void 0}),l.NextResponse.json({ok:!0,message:n,automation:s})}catch(r){let e=r instanceof Error?r.message:String(r),t=r instanceof Error?r.stack:void 0,a=r instanceof Error?r.name:"UnknownError";return console.error("[manychat] Fatal error in POST handler:",{error:e,name:a,stack:t}),l.NextResponse.json({ok:!1,error:"internal_error",errorName:a,message:e,stack:t?t.split("\n").slice(0,10).join("\n"):void 0},{status:500})}}async function R(e){let t;let a={},r=(0,i._P)("MANYCHAT_API_KEY","MANYCHAT_API_TOKEN","MC_API_KEY"),n=(0,u.getKvConfigStatus)();a.kvConfig={hasBaseUrl:n.hasBaseUrl,hasReadToken:n.hasReadToken,hasWriteToken:n.hasWriteToken,candidates:n.baseCandidates.length};let s=g?"memory":null,o=g,p=v,y=k,f=y?"memory":null,w=null;if(o)a.kv={ok:!0,key:h.OE,source:"memory"};else{let{message:e,source:t,error:r}=await (0,h.R5)();e?(o=e,s="kv",a.kv={ok:!0,key:h.OE,source:"kv"}):r?a.kv={ok:!1,key:h.OE,source:"error",message:r}:a.kv={ok:!1,key:h.OE,source:"miss",message:"KV не містить збереженого повідомлення"}}if(!p){let{trace:e,error:t,source:r}=await (0,h.b3)();e?(p=e,a.kvTrace={ok:!0,key:h.RF,source:"kv"}):t?a.kvTrace={ok:!1,key:h.RF,source:"error",message:t}:a.kvTrace={ok:!1,key:h.RF,source:"miss",message:"KV не містить трасування вебхука"}}let T=await (0,h.Ow)();void 0!==T.raw&&null!==T.raw?a.kvRaw={ok:!0,key:h.JE,source:"kv"}:T.error?a.kvRaw={ok:!1,key:h.JE,source:"error",message:T.error}:a.kvRaw={ok:!1,key:h.JE,source:"miss",message:"KV не містить сирого payload останнього вебхука"};let A=await (0,h.X$)(),R=null;A.snapshot?(R=A.snapshot,a.kvRequest={ok:!0,key:h.Ez,source:"kv"}):A.error?a.kvRequest={ok:!1,key:h.Ez,source:"error",message:A.error}:a.kvRequest={ok:!1,key:h.Ez,source:"miss",message:"KV не містить останній сирий запит ManyChat"};let N=o?[o]:[],C=await (0,h.wm)(10),S=C.messages,K=C.source,I=C.error,M=!1;if(!S.length&&o&&await (0,h.AY)([o])){let e=await (0,h.wm)(10);e.messages.length&&(S=e.messages,K=e.source,I=e.error,M=!0)}if(S.length?(N=S,o=o??S[0],s=s??"kv",a.kvFeed={ok:!0,key:h.r6,source:"kv",count:S.length,message:M?"Журнал відновлено на основі останнього вебхука":"kv-client"===K?"Журнал отримано через @vercel/kv":"kv-rest"===K?"Журнал отримано через REST API Vercel KV":void 0}):I?a.kvFeed={ok:!1,key:h.r6,source:"error",message:I}:a.kvFeed={ok:!1,key:h.r6,source:"miss",message:"Журнал повідомлень у KV порожній"},!y){let{snapshot:e,source:a,error:r}=await (0,h.pm)();e?(y=e.result,f="kv",t=e.receivedAt,k=y):r?(f="error",w=r):f="miss"}if(a.api={ok:!1,message:r?"ManyChat API вимкнено: використовуються лише дані з вебхука.":"ManyChat API вимкнено і ключ не використовується.",note:"API-запити до ManyChat не виконуються за вимогою."},0===N.length&&p){let e=p.messagePreview??"",t=p.handle??null,r=p.fullName??null;if(e||t||r){let n={id:p.receivedAt,receivedAt:p.receivedAt,source:"trace:webhook",title:"ManyChat Webhook (trace)",handle:t,fullName:r,text:e,raw:null,rawText:null};N=[n],o=n,s=s??"trace",a.traceFallback={used:!0,reason:"Відображаємо останній вебхук із трасування, оскільки повідомлення не знайдено у KV або ManyChat API."}}}o&&0===N.length&&(N=[o]);let P=e=>{if(!e)return e;let t={...e},a=void 0!==t.raw&&null!==t.raw,r=a?t.raw:T.raw;if(a||void 0===T.raw||null===T.raw||(t.raw=T.raw),!("string"==typeof t.rawText?t.rawText.trim():"").length){if("string"==typeof r&&r.trim().length)t.rawText=r;else if(T.text&&T.text.trim().length)t.rawText=T.text;else if(null!=r)try{t.rawText=JSON.stringify(r)}catch{}}if(!("string"==typeof t.text?t.text.trim():"").length){let e=b(r);if(e&&e.trim().length)t.text=e.trim();else if("string"==typeof t.rawText&&t.rawText.trim().length)try{let e=JSON.parse(t.rawText),a=b(e);a&&a.trim().length&&(t.text=a.trim())}catch{let e=t.rawText.trim();e.length&&(t.text=e)}else p?.messagePreview&&p.messagePreview.trim().length&&(t.text=p.messagePreview.trim())}return t};o&&(o=P(o)),N.length&&(N=N.map(P)),!s&&N.length>0&&(s="kv");let $=null,O=null,q=(()=>{if(void 0!==T.raw&&null!==T.raw)return T.raw;if(o?.raw!==void 0&&o?.raw!==null)return o.raw;if(R?.rawText)try{return JSON.parse(R.rawText)}catch{return R.rawText}return null})(),j=(()=>{let e="string"==typeof T.text&&T.text.trim().length?T.text:null;if(e)return e;if("string"==typeof R?.rawText&&R.rawText.trim().length)return R.rawText;if("string"==typeof o?.rawText&&o.rawText.trim().length)return o.rawText;if(null!=q)try{return JSON.stringify(q)}catch{}return null})();if(o&&"string"==typeof j&&j.trim().length&&(!o.rawText||!o.rawText.trim().length)&&(o={...o,rawText:j}),N.length&&(N=N.map((e,t)=>{let a=e;0!==t||"string"!=typeof j||!j.trim().length||e.rawText&&e.rawText.trim().length||(a={...e,rawText:j});let r=j??R?.rawText??T.text??null;return E(a,q??T.raw,r)??a})),o){let e=j??R?.rawText??T.text??null;o=E(o,q??T.raw,e)}let Y=o??(N.length?N[0]:null),V=e=>{if(!e)return null;if("string"==typeof e)try{let t=JSON.parse(e);return V(t)}catch{return null}return"object"!=typeof e||Array.isArray(e)?null:e},U=V(q)??V(j)??V(R?.rawText??null),F=U?.message,J=U?.data,z=U?.subscriber,B=U?.user,L=(0,c.m)({username:x(Y?.handle,Y?.handle?`@${Y.handle}`:null,U?.username,U?.handle,F?.username,F?.handle,z?.username,B?.username),text:x(Y?.text,U?.text,F?.text,J?.text,"string"==typeof j?j:null,R?.rawText??null,p?.messagePreview??null),full_name:x(Y?.fullName,U?.full_name,U?.name,z?.name,B?.full_name,p?.fullName??null),first_name:x(U?.first_name,z?.first_name,B?.first_name),last_name:x(U?.last_name,z?.last_name,B?.last_name)}),W=[{kind:"message_handle",value:Y?.handle??null},{kind:"message_handle_raw",value:Y?.handle?`@${Y.handle}`:null},{kind:"message_fullName",value:Y?.fullName??null},{kind:"normalized_handle",value:L.handle??null},{kind:"normalized_handle_raw",value:L.handleRaw??null},{kind:"normalized_fullName",value:L.fullName??null},{kind:"payload_username",value:x(U?.username,U?.handle)},{kind:"payload_message_username",value:x(F?.username,F?.handle)},{kind:"payload_subscriber_username",value:x(z?.username)},{kind:"payload_user_username",value:x(B?.username)}];if(L.text.trim().length>0||null!==L.handle||null!==L.fullName)try{O=await (0,m.M)({normalized:L,identityCandidates:W})}catch(e){O={ok:!1,error:"analysis_failed",details:e instanceof Error?{message:e.message}:{message:String(e)}}}if(!y)try{let e=await (0,m.M)({normalized:L,identityCandidates:W,performMove:async({cardId:e,pipelineId:t,statusId:a,pipelineStatusId:r,statusAliases:n})=>{let s=_(e);if(!s)return{ok:!1,status:0,skippedReason:"card_id_missing",response:{error:"card_id missing"}};let o=e=>_(e),l=Array.isArray(n)?n.map(e=>o(e)).filter(e=>!!e):[];try{let e=await (0,d.$j)({cardId:s,pipelineId:o(t),statusId:o(a),pipelineStatusId:o(r),statusAliases:l});return{ok:e.ok,status:e.status,response:e.response,sent:e.sent,attempts:e.attempts,requestUrl:e.requestUrl,requestMethod:e.requestMethod,baseUrl:e.baseUrl??null}}catch(a){let e="string"==typeof a?.code?a.code:void 0,t=a instanceof Error?a.message:String(a);return{ok:!1,status:0,response:{error:t,code:e},skippedReason:"keycrm_not_configured"===e?"keycrm_not_configured":void 0}}}});y=e,f=f??"memory",t=Date.now(),k=y,$={used:!0,reason:"Автоматизацію виконано повторно під час GET, оскільки результат не знайдено у KV."};try{await (0,h.lW)(e)}catch(e){w=e instanceof Error?e.message:"string"==typeof e?e:w}}catch(e){f="error",w=e instanceof Error?e.message:"string"==typeof e?e:w}if(p||o){let e=o??N[0]??null;if(p){let t="number"==typeof p.receivedAt&&Number.isFinite(p.receivedAt)?p.receivedAt:"string"==typeof p.receivedAt?Number(p.receivedAt):NaN;p={...p,receivedAt:Number.isFinite(t)?t:e&&"number"==typeof e.receivedAt?e.receivedAt:Date.now(),status:"rejected"===p.status||"accepted"===p.status?p.status:"accepted",statusCode:"number"==typeof p.statusCode&&Number.isFinite(p.statusCode)?p.statusCode:"rejected"===p.status?401:200,handle:p.handle??e?.handle??null,fullName:p.fullName??e?.fullName??null,messagePreview:p.messagePreview??e?.text?.slice(0,180)??null}}else e&&(p={receivedAt:"number"==typeof e.receivedAt&&Number.isFinite(e.receivedAt)?e.receivedAt:Date.now(),status:"accepted",statusCode:200,handle:e.handle??null,fullName:e.fullName??null,messagePreview:e.text?e.text.slice(0,180):null})}return a.automationReplay=$,a.automation=y?y.ok?{ok:!0,source:f??"memory",receivedAt:t,message:w??void 0}:{ok:!1,error:y.error,source:f??"memory",receivedAt:t,message:w??void 0}:"error"===f?{ok:!1,error:w??"Не вдалося прочитати автоматизацію",source:"error",message:w??void 0}:"miss"===f?{ok:!1,source:"miss",message:"Автоматизацію ще не запускали в цьому середовищі."}:null,l.NextResponse.json({ok:!0,latest:o??null,feed:N,messages:N,source:s,trace:p,diagnostics:a,automation:y??null,automationAnalysis:O??null,rawSnapshot:{raw:q,text:j??null,rawText:j??null,source:T.source??A.source??(j?"message":null)},requestSnapshot:R?{rawText:R.rawText,receivedAt:R.receivedAt,source:R.source??A.source??"kv"}:null})}let N=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/mc/manychat/route",pathname:"/api/mc/manychat",filename:"route",bundlePath:"app/api/mc/manychat/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/mc/manychat/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:C,staticGenerationAsyncStorage:S,serverHooks:K}=N,I="/api/mc/manychat/route";function M(){return(0,o.patchFetch)({serverHooks:K,staticGenerationAsyncStorage:S})}},7756:(e,t,a)=>{a.d(t,{$j:()=>p,kg:()=>l,st:()=>o});var r=a(1964);let n=(e,t)=>`${e.replace(/\/+$/,"")}/${t.replace(/^\/+/,"")}`,s=e=>{let t=new Set,a=[];for(let r of e)t.has(r)||(t.add(r),a.push(r));return a},o=e=>{if(!e)return[];let t=e.trim().replace(/\s+/g,""),a=[],r=e=>{e&&a.push(e.replace(/\/+$/,""))},n=(e,t)=>{let a=t.replace(/\/+$/,"");a?(a.startsWith("/")||(a=`/${a}`),/\/api$/i.test(a)?a=`${a}/v1`:/\/v\d+$/i.test(a)||(a=`${a}/v1`)):a="/v1",r(`${e}${a}`),/\/api\/v\d+$/i.test(a)?r(`${e}${a.replace(/\/api(\/v\d+)$/i,"$1")}`):/\/v\d+$/i.test(a)&&r(`${e}/api${a}`)};try{let e=new URL(t);n(e.origin,e.pathname)}catch{try{let e=new URL(`https://${t}`);n(e.origin,e.pathname)}catch{r(`${t.replace(/\/+$/,"")}/v1`),r(`${t.replace(/\/+$/,"")}/api/v1`)}}return s(a)},l=e=>{if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return String(e);if("string"==typeof e){let t=e.trim();return t.length?t:null}return null},i=e=>{let t=Number(e);return Number.isFinite(t)?t:e},u=e=>{let t=Array.isArray(e?.data)?e?.data[0]:e?.data??(Array.isArray(e)?e[0]:e),a=t&&"object"==typeof t&&"attributes"in t?t.attributes:t,r=t&&"object"==typeof t&&"relationships"in t?t.relationships:void 0;return{pipelineId:l(a?.pipeline_id)??l(a?.pipelineId)??l(a?.pipeline?.id)??l(t?.pipeline_id)??l(t?.pipelineId)??l(t?.pipeline?.id)??l(r?.pipeline?.data?.id)??l(r?.pipelines?.data?.id),statusId:l(a?.status_id)??l(a?.pipeline_status_id)??l(a?.statusId)??l(a?.status?.id)??l(t?.status_id)??l(t?.pipeline_status_id)??l(t?.statusId)??l(t?.status?.id)??l(r?.status?.data?.id)??l(r?.pipeline_status?.data?.id)??l(r?.pipeline_statuses?.data?.id),raw:e}},c=async(e,t,a)=>{let r=[`/pipelines/cards/${encodeURIComponent(a)}`,`/crm/deals/${encodeURIComponent(a)}`],s=["with[]=status&with[]=pipeline&include[]=status&include[]=pipeline",""];for(let a of r)for(let r of s){let s=r?`${a}${a.includes("?")?"&":"?"}${r}`:a;try{let a=await fetch(n(e,s),{headers:{Authorization:t,Accept:"application/json"},cache:"no-store"});if(!a.ok)continue;let r=await a.text();if(!r)return{pipelineId:null,statusId:null,raw:null};try{let e=JSON.parse(r);return u(e)}catch{return{pipelineId:null,statusId:null,raw:r}}}catch{continue}}return null},m=e=>new Promise(t=>setTimeout(t,e)),d=(e,t,a,r)=>{e.push({step:t,info:a??null,data:r,timestamp:Date.now()})};async function p({cardId:e,pipelineId:t,statusId:a,pipelineStatusId:s=null,statusAliases:u=[]}){let p=[],h=Error("moveKeycrmCard trace").stack??null;d(p,"moveKeycrmCard:start",null,{cardId:e,pipelineId:t,statusId:a,pipelineStatusId:s,statusAliases:u});let y=(0,r.SJ)("KEYCRM_API_URL","KEYCRM_API_BASE","KEYCRM_BASE_URL")??(0,r.Rv)(),f=(0,r.SJ)("KEYCRM_API_TOKEN","KEYCRM_TOKEN")??(0,r.Ls)(),g=(0,r.SJ)("KEYCRM_BEARER","KEYCRM_API_BEARER")??(0,r.Ls)(),v="";v=g?g.toLowerCase().startsWith("bearer ")?g:`Bearer ${g}`:f?`Bearer ${f}`:(0,r.hC)();let w=o(y);if(d(p,"moveKeycrmCard:credentials",null,{hasBase:!!y,baseCandidates:w,hasToken:!!(f||g),authorizationLength:v.length,authorizationPrefix:v.substring(0,20)+"..."}),!v||0===w.length)throw Object.assign(Error("KeyCRM credentials are missing"),{code:"keycrm_not_configured",details:{base:!!y,token:!!(f||g),baseCandidate:y,tokenCandidate:f?"***":null,bearerCandidate:g?"***":null}});v.includes(r.Nd.API_TOKEN)&&(console.warn("[keycrm-move] ⚠️ Використовується дефолтний токен KeyCRM! Перевірте змінні середовища KEYCRM_API_TOKEN або KEYCRM_BEARER в Vercel"),d(p,"moveKeycrmCard:warning","default_token_used",{message:"Використовується дефолтний токен, який може бути недійсним"}));let k=l(e);if(!k)throw Object.assign(Error("card_id required"),{code:"card_id_missing"});let _=l(t),x=l(a),b=l(s),E=Array.isArray(u)?Array.from(new Set([b,...u.map(e=>l(e))].filter(e=>!!e))):[];if(!_&&!x)throw Object.assign(Error("to_pipeline_id or to_status_id required"),{code:"target_missing"});let T=_?i(_):void 0,A=b?i(b):void 0,R=x?i(x):void 0,N=E.find(e=>e!==x),C=null!=N?i(N):void 0,S=R??C;i(k);let K=[],I=async(e,t)=>{let a=n(t,e.path),r={Authorization:v,Accept:"application/json","Content-Type":e.contentType},s=JSON.stringify(e.body);d(p,"performAttempt:start",e.attempt,{base:t,url:a,method:e.method,headers:r,body:e.body});let o=await fetch(a,{method:e.method,headers:r,body:s,cache:"no-store"}),l=await o.text(),i=null;if(l)try{i=JSON.parse(l)}catch{i=l}let u=[];if(d(p,"performAttempt:response",e.attempt,{status:o.status,ok:o.ok,raw:l}),o.ok)for(let a=0;a<20;a+=1){0===a?await m(300):await m(500);let r=await c(t,v,k),n=!_||r?.pipelineId===_,s=[b,x,...E],o=0===s.length||s.some(e=>r?.statusId===e);if(u.push({snapshot:r,pipelineMatches:n,statusMatches:o}),d(p,"performAttempt:verification",e.attempt,{attempt:a+1,pipelineMatches:n,statusMatches:o,snapshot:r}),n&&o)break}let h=o.ok&&u.some(e=>e.pipelineMatches&&e.statusMatches),y=e.body;return K.push({attempt:e.attempt,status:o.status,ok:h,body:i,sent:y,verification:u,url:a,method:e.method,requestHeaders:r,requestBodyRaw:s,responseRaw:l||null}),{ok:h,status:o.status,body:i,sent:y,verification:u,url:a,method:e.method,requestHeaders:r,requestBodyRaw:s,responseRaw:l||null}},M=[],P={};void 0!==T&&(P.pipeline_id=T,P.to_pipeline_id=T),void 0!==A&&(P.pipeline_status_id=A),void 0!==S&&(P.status_id=S,P.to_status_id=S),M.push({attempt:"pipelines/cards/{id} PUT",method:"PUT",path:`/pipelines/cards/${encodeURIComponent(k)}`,contentType:"application/json",body:P});let $=null;for(let e of w){let t=e.replace(/\/+$/,"");for(let e of M)try{let a=await I(e,t);if($={...a,attemptName:e.attempt,base:t},K.push({attempt:e.attempt,status:a.status,ok:a.ok,body:a.body,sent:e.body,verification:a.verification,url:a.url,method:e.method,requestHeaders:a.requestHeaders,requestBodyRaw:a.requestBodyRaw,responseRaw:a.responseRaw}),a.ok)return d(p,"moveKeycrmCard:success",e.attempt,{status:a.status,base:t}),{ok:!0,status:a.status,response:{attempt:e.attempt,body:a.body,history:K},sent:e.body,attempts:a.verification,requestUrl:a.url,requestMethod:e.method,baseUrl:t,requestHeaders:a.requestHeaders,requestBodyRaw:a.requestBodyRaw,responseRaw:a.responseRaw,trace:p,stack:h};if(401===a.status){d(p,"moveKeycrmCard:unauthorized",e.attempt,{status:a.status,base:t});continue}}catch(a){d(p,"performAttempt:error",e.attempt,{base:t,error:a instanceof Error?a.message:String(a)}),K.push({attempt:e.attempt,status:0,ok:!1,body:null,sent:e.body,verification:[],url:n(t,e.path),method:e.method,error:a instanceof Error?a.message:String(a)})}}let O=$?.base??w[0]?.replace(/\/+$/,"")??"",q=$?.sent??M[0]?.body??P,j=$?.status??0,Y=$?.body??null,V=K.at(-1)?.attempt??$?.attemptName??M[0]?.attempt??"unknown",U=$?.verification??[],F=$?.url??n(O,M[0]?.path??""),J=$?.method??M[0]?.method??"POST",z=$?.requestHeaders??null,B=$?.requestBodyRaw??null,L=$?.responseRaw??null;return d(p,"moveKeycrmCard:failure",V,{status:j,base:O,url:F}),{ok:!1,status:j,response:{attempt:V,body:Y,history:K},sent:q,attempts:U,requestUrl:F,requestMethod:J,baseUrl:O,requestHeaders:z,requestBodyRaw:B,responseRaw:L,trace:p,stack:h}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,242,4332,6550],()=>a(488));module.exports=r})();