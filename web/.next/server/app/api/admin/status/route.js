"use strict";(()=>{var e={};e.id=6763,e.ids=[6763],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},382:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>C,patchFetch:()=>I,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>A});var a={};r.r(a),r.d(a,{GET:()=>E,POST:()=>R,dynamic:()=>d,runtime:()=>p});var s=r(9303),i=r(8716),n=r(670),o=r(7070),l=r(1964),u=r(7756);let p="nodejs",d="force-dynamic",c=["KEYCRM_BASE_URL","KEYCRM_API_URL","KEYCRM_API_BASE"],m=["KEYCRM_BEARER","KEYCRM_API_BEARER","KEYCRM_API_TOKEN","KEYCRM_TOKEN"];async function _(e,t){let r=`${e.replace(/\/+$/,"")}/pipelines?per_page=1`;try{let e=await fetch(r,{method:"GET",headers:{Authorization:t,Accept:"application/json"},cache:"no-store"});if(e.ok)return{attempted:!0,ok:!0,status:e.status,endpoint:r,error:null};let a=null;try{let t=await e.text();a=t?t.slice(0,500):null}catch{a=null}return{attempted:!0,ok:!1,status:e.status,endpoint:r,error:a}}catch(e){return{attempted:!0,ok:!1,status:null,endpoint:r,error:e instanceof Error?e.message:String(e)}}}async function E(){let e=(0,l.SJ)(...c),t=function(e){if(!e)return null;let t=e.trim();return t?t.toLowerCase().startsWith("bearer ")?t:`Bearer ${t}`:null}((0,l.SJ)(...m)),r=(0,u.st)(e),a={attempted:!1,ok:!1,status:null,endpoint:null,error:r.length&&t?null:e&&t?"no_valid_base":"credentials_incomplete"};if(r.length&&t){for(let e of r)if((a=await _(e,t)).ok)break}let s={ok:!!(r.length&&t&&a.ok),timestamp:new Date().toISOString(),keycrm:{hasBaseUrl:!!(e&&e.trim().length),hasToken:!!t,baseUrl:r[0]??e?.trim()??null,ping:a}};return o.NextResponse.json(s,{status:(s.ok,200)})}async function R(){return E()}let h=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/status/route",pathname:"/api/admin/status",filename:"route",bundlePath:"app/api/admin/status/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/admin/status/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:A,serverHooks:y}=h,C="/api/admin/status/route";function I(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:A})}},1964:(e,t,r)=>{r.d(t,{Ls:()=>m,Nd:()=>_,Qv:()=>p,Rv:()=>d,SJ:()=>h,_P:()=>f,hC:()=>c,w6:()=>o,xD:()=>u});let a="https://openapi.keycrm.app/v1",s="M2EwMjAwMGE1ZWY4ODhkMzlkYzRiNTU2MDY4ZjZmZDc3ZGJkZjQ3MA",i={KEYCRM_API_URL:a,KEYCRM_API_BASE:a,KEYCRM_BASE_URL:a,KEYCRM_API_TOKEN:s,KEYCRM_TOKEN:s,KEYCRM_BEARER:s,KEYCRM_API_BEARER:s},n={KEYCRM_API_URL:process.env.KEYCRM_API_URL?.trim()||a,KEYCRM_API_TOKEN:process.env.KEYCRM_API_TOKEN?.trim()||process.env.KEYCRM_BEARER?.trim()||s,KEYCRM_BEARER:process.env.KEYCRM_BEARER?.trim()||process.env.KEYCRM_API_TOKEN?.trim()||s,ALTEGIO_API_URL:process.env.ALTEGIO_API_URL?.trim()||"",ALTEGIO_APPLICATION_ID:process.env.ALTEGIO_APPLICATION_ID?.trim()||"",ALTEGIO_PARTNER_ID:process.env.ALTEGIO_PARTNER_ID?.trim()||"",ALTEGIO_PARTNER_TOKEN:process.env.ALTEGIO_PARTNER_TOKEN?.trim()||"",ALTEGIO_USER_TOKEN:process.env.ALTEGIO_USER_TOKEN?.trim()||"",ALTEGIO_COMPANY_ID:process.env.ALTEGIO_COMPANY_ID?.trim()||""};function o(){if(!n.KEYCRM_API_URL)throw Error("Missing env KEYCRM_API_URL");if(!n.KEYCRM_API_TOKEN)throw Error("Missing env KEYCRM_API_TOKEN")}function l(e){return e.toLowerCase().startsWith("bearer ")?e:`Bearer ${e}`}function u(){return{Accept:"application/json","Content-Type":"application/json",Authorization:l(n.KEYCRM_BEARER)}}function p(e){let t=n.KEYCRM_API_URL.replace(/\/+$/,""),r=e.replace(/^\/+/,"");return`${t}/${r}`}function d(){return n.KEYCRM_API_URL}function c(){return l(n.KEYCRM_BEARER)}function m(){return n.KEYCRM_API_TOKEN}let _={API_URL:a,API_TOKEN:s},E=new Map;for(let[e,t]of Object.entries(process.env))E.set(e.toLowerCase(),t);function R(e){if("string"!=typeof e)return;let t=e.trim();return t.length>0?t:void 0}function h(...e){for(let t of e){let e=R(process.env[t]);if(void 0!==e)return e}for(let t of e){let e=R(E.get(t.toLowerCase()));if(void 0!==e)return e}for(let t of e){let e=i[t.toUpperCase()];if(e)return e}}function f(...e){return void 0!==h(...e)}},7756:(e,t,r)=>{r.d(t,{$j:()=>m,kg:()=>o,st:()=>n});var a=r(1964);let s=(e,t)=>`${e.replace(/\/+$/,"")}/${t.replace(/^\/+/,"")}`,i=e=>{let t=new Set,r=[];for(let a of e)t.has(a)||(t.add(a),r.push(a));return r},n=e=>{if(!e)return[];let t=e.trim().replace(/\s+/g,""),r=[],a=e=>{e&&r.push(e.replace(/\/+$/,""))},s=(e,t)=>{let r=t.replace(/\/+$/,"");r?(r.startsWith("/")||(r=`/${r}`),/\/api$/i.test(r)?r=`${r}/v1`:/\/v\d+$/i.test(r)||(r=`${r}/v1`)):r="/v1",a(`${e}${r}`),/\/api\/v\d+$/i.test(r)?a(`${e}${r.replace(/\/api(\/v\d+)$/i,"$1")}`):/\/v\d+$/i.test(r)&&a(`${e}/api${r}`)};try{let e=new URL(t);s(e.origin,e.pathname)}catch{try{let e=new URL(`https://${t}`);s(e.origin,e.pathname)}catch{a(`${t.replace(/\/+$/,"")}/v1`),a(`${t.replace(/\/+$/,"")}/api/v1`)}}return i(r)},o=e=>{if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return String(e);if("string"==typeof e){let t=e.trim();return t.length?t:null}return null},l=e=>{let t=Number(e);return Number.isFinite(t)?t:e},u=e=>{let t=Array.isArray(e?.data)?e?.data[0]:e?.data??(Array.isArray(e)?e[0]:e),r=t&&"object"==typeof t&&"attributes"in t?t.attributes:t,a=t&&"object"==typeof t&&"relationships"in t?t.relationships:void 0;return{pipelineId:o(r?.pipeline_id)??o(r?.pipelineId)??o(r?.pipeline?.id)??o(t?.pipeline_id)??o(t?.pipelineId)??o(t?.pipeline?.id)??o(a?.pipeline?.data?.id)??o(a?.pipelines?.data?.id),statusId:o(r?.status_id)??o(r?.pipeline_status_id)??o(r?.statusId)??o(r?.status?.id)??o(t?.status_id)??o(t?.pipeline_status_id)??o(t?.statusId)??o(t?.status?.id)??o(a?.status?.data?.id)??o(a?.pipeline_status?.data?.id)??o(a?.pipeline_statuses?.data?.id),raw:e}},p=async(e,t,r)=>{let a=[`/pipelines/cards/${encodeURIComponent(r)}`,`/crm/deals/${encodeURIComponent(r)}`],i=["with[]=status&with[]=pipeline&include[]=status&include[]=pipeline",""];for(let r of a)for(let a of i){let i=a?`${r}${r.includes("?")?"&":"?"}${a}`:r;try{let r=await fetch(s(e,i),{headers:{Authorization:t,Accept:"application/json"},cache:"no-store"});if(!r.ok)continue;let a=await r.text();if(!a)return{pipelineId:null,statusId:null,raw:null};try{let e=JSON.parse(a);return u(e)}catch{return{pipelineId:null,statusId:null,raw:a}}}catch{continue}}return null},d=e=>new Promise(t=>setTimeout(t,e)),c=(e,t,r,a)=>{e.push({step:t,info:r??null,data:a,timestamp:Date.now()})};async function m({cardId:e,pipelineId:t,statusId:r,pipelineStatusId:i=null,statusAliases:u=[]}){let m=[],_=Error("moveKeycrmCard trace").stack??null;c(m,"moveKeycrmCard:start",null,{cardId:e,pipelineId:t,statusId:r,pipelineStatusId:i,statusAliases:u});let E=(0,a.SJ)("KEYCRM_API_URL","KEYCRM_API_BASE","KEYCRM_BASE_URL")??(0,a.Rv)(),R=(0,a.SJ)("KEYCRM_API_TOKEN","KEYCRM_TOKEN")??(0,a.Ls)(),h=(0,a.SJ)("KEYCRM_BEARER","KEYCRM_API_BEARER")??(0,a.Ls)(),f="";f=h?h.toLowerCase().startsWith("bearer ")?h:`Bearer ${h}`:R?`Bearer ${R}`:(0,a.hC)();let A=n(E);if(c(m,"moveKeycrmCard:credentials",null,{hasBase:!!E,baseCandidates:A,hasToken:!!(R||h),authorizationLength:f.length,authorizationPrefix:f.substring(0,20)+"..."}),!f||0===A.length)throw Object.assign(Error("KeyCRM credentials are missing"),{code:"keycrm_not_configured",details:{base:!!E,token:!!(R||h),baseCandidate:E,tokenCandidate:R?"***":null,bearerCandidate:h?"***":null}});f.includes(a.Nd.API_TOKEN)&&(console.warn("[keycrm-move] ⚠️ Використовується дефолтний токен KeyCRM! Перевірте змінні середовища KEYCRM_API_TOKEN або KEYCRM_BEARER в Vercel"),c(m,"moveKeycrmCard:warning","default_token_used",{message:"Використовується дефолтний токен, який може бути недійсним"}));let y=o(e);if(!y)throw Object.assign(Error("card_id required"),{code:"card_id_missing"});let C=o(t),I=o(r),K=o(i),v=Array.isArray(u)?Array.from(new Set([K,...u.map(e=>o(e))].filter(e=>!!e))):[];if(!C&&!I)throw Object.assign(Error("to_pipeline_id or to_status_id required"),{code:"target_missing"});let M=C?l(C):void 0,w=K?l(K):void 0,P=I?l(I):void 0,b=v.find(e=>e!==I),T=null!=b?l(b):void 0,O=P??T;l(y);let g=[],Y=async(e,t)=>{let r=s(t,e.path),a={Authorization:f,Accept:"application/json","Content-Type":e.contentType},i=JSON.stringify(e.body);c(m,"performAttempt:start",e.attempt,{base:t,url:r,method:e.method,headers:a,body:e.body});let n=await fetch(r,{method:e.method,headers:a,body:i,cache:"no-store"}),o=await n.text(),l=null;if(o)try{l=JSON.parse(o)}catch{l=o}let u=[];if(c(m,"performAttempt:response",e.attempt,{status:n.status,ok:n.ok,raw:o}),n.ok)for(let r=0;r<20;r+=1){0===r?await d(300):await d(500);let a=await p(t,f,y),s=!C||a?.pipelineId===C,i=[K,I,...v],n=0===i.length||i.some(e=>a?.statusId===e);if(u.push({snapshot:a,pipelineMatches:s,statusMatches:n}),c(m,"performAttempt:verification",e.attempt,{attempt:r+1,pipelineMatches:s,statusMatches:n,snapshot:a}),s&&n)break}let _=n.ok&&u.some(e=>e.pipelineMatches&&e.statusMatches),E=e.body;return g.push({attempt:e.attempt,status:n.status,ok:_,body:l,sent:E,verification:u,url:r,method:e.method,requestHeaders:a,requestBodyRaw:i,responseRaw:o||null}),{ok:_,status:n.status,body:l,sent:E,verification:u,url:r,method:e.method,requestHeaders:a,requestBodyRaw:i,responseRaw:o||null}},$=[],k={};void 0!==M&&(k.pipeline_id=M,k.to_pipeline_id=M),void 0!==w&&(k.pipeline_status_id=w),void 0!==O&&(k.status_id=O,k.to_status_id=O),$.push({attempt:"pipelines/cards/{id} PUT",method:"PUT",path:`/pipelines/cards/${encodeURIComponent(y)}`,contentType:"application/json",body:k});let L=null;for(let e of A){let t=e.replace(/\/+$/,"");for(let e of $)try{let r=await Y(e,t);if(L={...r,attemptName:e.attempt,base:t},g.push({attempt:e.attempt,status:r.status,ok:r.ok,body:r.body,sent:e.body,verification:r.verification,url:r.url,method:e.method,requestHeaders:r.requestHeaders,requestBodyRaw:r.requestBodyRaw,responseRaw:r.responseRaw}),r.ok)return c(m,"moveKeycrmCard:success",e.attempt,{status:r.status,base:t}),{ok:!0,status:r.status,response:{attempt:e.attempt,body:r.body,history:g},sent:e.body,attempts:r.verification,requestUrl:r.url,requestMethod:e.method,baseUrl:t,requestHeaders:r.requestHeaders,requestBodyRaw:r.requestBodyRaw,responseRaw:r.responseRaw,trace:m,stack:_};if(401===r.status){c(m,"moveKeycrmCard:unauthorized",e.attempt,{status:r.status,base:t});continue}}catch(r){c(m,"performAttempt:error",e.attempt,{base:t,error:r instanceof Error?r.message:String(r)}),g.push({attempt:e.attempt,status:0,ok:!1,body:null,sent:e.body,verification:[],url:s(t,e.path),method:e.method,error:r instanceof Error?r.message:String(r)})}}let N=L?.base??A[0]?.replace(/\/+$/,"")??"",U=L?.sent??$[0]?.body??k,B=L?.status??0,S=L?.body??null,q=g.at(-1)?.attempt??L?.attemptName??$[0]?.attempt??"unknown",j=L?.verification??[],G=L?.url??s(N,$[0]?.path??""),x=L?.method??$[0]?.method??"POST",D=L?.requestHeaders??null,J=L?.requestBodyRaw??null,z=L?.responseRaw??null;return c(m,"moveKeycrmCard:failure",q,{status:B,base:N,url:G}),{ok:!1,status:B,response:{attempt:q,body:S,history:g},sent:U,attempts:j,requestUrl:G,requestMethod:x,baseUrl:N,requestHeaders:D,requestBodyRaw:J,responseRaw:z,trace:m,stack:_}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>r(382));module.exports=a})();