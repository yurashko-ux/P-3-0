"use strict";(()=>{var e={};e.id=5684,e.ids=[5684],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1155:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>_,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>c});var n=r(9303),s=r(8716),o=r(670),u=r(7070),i=r(7582),l=r(4044);let c="force-dynamic";async function d(e){if(!function(e){let t=e.nextUrl.searchParams.get("secret"),r=process.env.CRON_SECRET||"";return r&&t&&r===t}(e))return u.NextResponse.json({error:"Unauthorized"},{status:401});try{let t=e.nextUrl.searchParams.get("year"),r=e.nextUrl.searchParams.get("month"),a=new Date,n=t?parseInt(t,10):a.getFullYear(),s=r?parseInt(r,10):a.getMonth()+1;if(!n||!s||s<1||s>12)return u.NextResponse.json({error:"Invalid year or month"},{status:400});let o=`${n}-${String(s).padStart(2,"0")}-01`,c=new Date(n,s,0).getDate(),d=`${n}-${String(s).padStart(2,"0")}-${String(c).padStart(2,"0")}`,p=function(){let e=process.env.ALTEGIO_COMPANY_ID?.trim(),t=l.B0.PARTNER_ID||l.B0.APPLICATION_ID,r=e||t;if(!r)throw Error("ALTEGIO_COMPANY_ID is required");return r}(),m=new URLSearchParams({start_date:o,end_date:d}),g=`/storages/transactions/${p}?${m.toString()}`,h=await (0,i.B)(g),f=Array.isArray(h)?h:h&&"object"==typeof h&&Array.isArray(h.data)?h.data:[],_=f.filter(e=>1===Number(e.type_id)),y=f.filter(e=>2===Number(e.type_id)),b=_.slice(0,5).map(e=>({id:e.id,type_id:e.type_id,amount:e.amount,cost:e.cost,cost_per_unit:e.cost_per_unit,create_date:e.create_date,good_id:e.good_id,good:e.good,allKeys:Object.keys(e)})),P=y.slice(0,5).map(e=>({id:e.id,type_id:e.type_id,amount:e.amount,cost:e.cost,cost_per_unit:e.cost_per_unit,create_date:e.create_date,good_id:e.good_id,good:e.good,allKeys:Object.keys(e)})),N=null;if(y.length>0){let e=y.reduce((e,t)=>{let r=Number(t.cost_per_unit)||0,a=Math.abs(Number(t.amount)||0);if(r>0&&a>0)return e+r*a;let n=Math.abs(Number(t.cost)||0);return n>0?e+n:e},0);e>0&&(N=e)}let A=null;if(_.length>0){let e=_[0],t=Object.keys(e).filter(e=>e.toLowerCase().includes("wholesale")||e.toLowerCase().includes("purchase")||e.toLowerCase().includes("buy")||e.toLowerCase().includes("cost")&&!e.toLowerCase().includes("per"));if(t.length>0){let e=_.reduce((e,r)=>{for(let a of t){let t=Number(r[a])||0;if(t>0)return e+Math.abs(t)}return e},0);e>0&&(A=e)}if(null===A){let e=_.reduce((e,t)=>{let r=Number(t.cost_per_unit)||0,a=Math.abs(Number(t.amount)||0);return r>0&&a>0?e+r*a:e},0);e>0&&(A=e)}}let w=null;try{let e=`/transactions/${p}?start_date=${o}&end_date=${d}&real_money=1&deleted=0&count=1000`,t=await (0,i.B)(e),r=(Array.isArray(t)?t:t&&"object"==typeof t&&Array.isArray(t.data)?t.data:[]).filter(e=>{let t=e.expense?.title||e.expense?.name||"";return t.toLowerCase().includes("purchase")||t.toLowerCase().includes("product purchase")||t.toLowerCase().includes("закупка")||"purchase"===e.type});if(r.length>0){let e=r.reduce((e,t)=>{let r=Math.abs(Number(t.amount)||0);return e+r},0);e>0&&(w=e)}}catch(e){console.warn("[debug-cost] Failed to fetch from Payments API:",e?.message)}let x=_.reduce((e,t)=>{let r=Math.abs(Number(t.cost)||0);if(r>0)return e+r;{let r=Math.abs(Number(t.amount)||0),a=Number(t.cost_per_unit)||0;return e+r*a}},0);return u.NextResponse.json({period:{year:n,month:s,date_from:o,date_to:d},summary:{totalTransactions:f.length,salesCount:_.length,purchasesCount:y.length,revenue:x},costCalculation:{fromPurchases:N,fromSales:A,fromPayments:w,final:N||A||w||null},sampleSales:b,samplePurchases:P,fullSampleSale:_.length>0?_[0]:null,fullSamplePurchase:y.length>0?y[0]:null})}catch(e){return console.error("[admin/finance-report/debug-cost] GET error:",e),u.NextResponse.json({error:String(e?.message||e)},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/finance-report/debug-cost/route",pathname:"/api/admin/finance-report/debug-cost",filename:"route",bundlePath:"app/api/admin/finance-report/debug-cost/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/admin/finance-report/debug-cost/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:h}=p,f="/api/admin/finance-report/debug-cost/route";function _(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,7582],()=>r(1155));module.exports=a})();