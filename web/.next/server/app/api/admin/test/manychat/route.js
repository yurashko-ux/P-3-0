"use strict";(()=>{var e={};e.id=9075,e.ids=[9075],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},5180:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var n={};a.r(n),a.d(n,{POST:()=>y,dynamic:()=>d,runtime:()=>c});var r=a(9303),s=a(8716),l=a(670),i=a(7070),u=a(6195),o=a(239),m=a(1089);let d="force-dynamic",c="nodejs",p={invalid_json:400,campaign_not_found:404,campaign_base_missing:400,campaign_target_missing:400,identity_missing:400,keycrm_search_failed:502,card_not_found:404,card_match_missing:500,keycrm_move_failed:502,host_header_missing:500},h=(e,t,a)=>i.NextResponse.json({ok:!1,error:t,...a?{details:a}:{}},{status:e});async function y(e){let t;try{t=await e.json()}catch{return h(400,"invalid_json")}let a=t?.message??t??{},n=(0,u.m)({username:a?.username??a?.subscriber?.username??a?.user?.username??a?.handle??t?.username??t?.handle??null,text:a?.text??a?.message?.text??a?.data?.text??a?.message??t?.text??null,full_name:a?.full_name??a?.name??a?.subscriber?.name??a?.user?.full_name??t?.full_name??t?.name??null,first_name:a?.first_name??a?.subscriber?.first_name??a?.user?.first_name??t?.first_name??null,last_name:a?.last_name??a?.subscriber?.last_name??a?.user?.last_name??t?.last_name??null}),r=Date.now(),s={id:`admin-test-${r}`,receivedAt:r,source:"admin:test/manychat",title:"ManyChat Admin Test",handle:n.handle??n.handleRaw??null,fullName:n.fullName||null,text:n.text||"",raw:{payload:t,normalized:n},rawText:(()=>{try{return JSON.stringify({payload:t,normalized:n})}catch{return null}})()},l={receivedAt:r,status:"accepted",handle:s.handle??void 0,fullName:s.fullName??void 0,messagePreview:s.text?s.text.slice(0,180):null,reason:"Записано через /api/admin/test/manychat"};await (0,o.hk)(s,l).catch(()=>{});let d=[{kind:"override",value:t?.needle??null},{kind:"username",value:a?.username??null},{kind:"subscriber",value:a?.subscriber?.username??null},{kind:"handleRaw",value:n.handleRaw??null},{kind:"fullName",value:n.fullName??null}],c=await (0,m.M)({normalized:n,identityCandidates:d,performMove:async({cardId:t,pipelineId:a,statusId:n,pipelineStatusId:r,statusAliases:s})=>{let l=new URL("/api/keycrm/card/move",e.nextUrl.origin),i={card_id:String(t)};null!=a&&(i.to_pipeline_id=a),null!=n&&(i.to_status_id=n),null!=r&&(i.pipeline_status_id=r),s&&s.length&&(i.status_aliases=s);let u=new Headers({"content-type":"application/json",accept:"application/json"}),o=e.headers.get("x-vercel-protection-bypass");o&&u.set("x-vercel-protection-bypass",o);let m=e.headers.get("authorization");m&&u.set("authorization",m);try{let e=await fetch(l,{method:"POST",headers:u,body:JSON.stringify(i),cache:"no-store"}),t=await e.json().catch(()=>null);if(!e.ok||!t?.ok)return{ok:!1,status:e.status,response:t??{error:"unknown"},sent:(t&&"object"==typeof t?t.sent:null)??null,attempts:Array.isArray(t?.attempts)?t?.attempts:void 0,requestUrl:"string"==typeof t?.requestUrl?t?.requestUrl:null,requestMethod:"string"==typeof t?.requestMethod?t?.requestMethod:null};return{ok:!0,status:e.status,response:t,sent:(t&&"object"==typeof t?t.sent:null)??null,attempts:Array.isArray(t?.attempts)?t?.attempts:void 0,requestUrl:"string"==typeof t?.requestUrl?t?.requestUrl:null,requestMethod:"string"==typeof t?.requestMethod?t?.requestMethod:null}}catch(e){return{ok:!1,status:502,response:{error:e instanceof Error?e.message:String(e)}}}}});if(await (0,o.lW)(c).catch(()=>{}),!c.ok){let e=p[c.error]??502;return i.NextResponse.json(c,{status:e})}return i.NextResponse.json(c)}let _=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/test/manychat/route",pathname:"/api/admin/test/manychat",filename:"route",bundlePath:"app/api/admin/test/manychat/route"},resolvedPagePath:"/Users/mykolay/P-3-0/web/app/api/admin/test/manychat/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:v}=_,x="/api/admin/test/manychat/route";function b(){return(0,l.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[8948,5972,242,4332,6550],()=>a(5180));module.exports=n})();