const API=process.env.KEYCRM_API_URL;const BEARER=process.env.KEYCRM_BEARER;async function kc(path:string,init?:RequestInit){const url=API!.replace(/\/$/,'')+path;const res=await fetch(url,{...init,headers:{'Authorization':`Bearer ${BEARER}`,'Content-Type':'application/json',...(init?.headers||{})},cache:'no-store'});if(!res.ok){throw new Error(`KeyCRM ${path} ${res.status}`)}return res.json()}export async function listPipelines(){return kc('/pipelines')}export async function listStatuses(){return kc('/statuses')}export async function findCardIdByUsername(username:string):Promise<string|null>{try{const data=await kc(`/cards/search?title=${encodeURIComponent(username)}`);if(Array.isArray(data)&&data.length)return data[0].id||null;if(data?.items?.length)return data.items[0].id||null;}catch(e){}return null}export async function moveCard(card_id:string,to_pipeline_id:string,to_status_id:string){return kc(`/cards/${card_id}/move`,{method:'POST',body:JSON.stringify({pipeline_id:to_pipeline_id,status_id:to_status_id})})}
