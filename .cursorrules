---
description: 
alwaysApply: true
---

# Правила взаємодії для проекту P-3-0

## Загальні принципи
- Завжди вказувати номер кнопки в AdminToolsModal, коли згадується дія з адмін-панелі
- Не реалізовувати складну логіку без пояснення - спочатку обговорити з користувачем
- При зміні логіки вебхуків - завжди перевіряти, чи не зламається існуюча функціональність
- При додаванні нових кнопок до AdminToolsModal - додавати їх з нумерацією

## Git та коміти
- Завжди виконувати коміт і push в режимі agent після завершення завдань
- Створювати змістовні повідомлення комітів, які описують зроблені зміни

## Endpoint'и та посилання
- Завжди надавати повні, готові до використання URL для браузера
- URL мають бути активними, готовими до копіювання та вставки
- Формат: https://[домен]/api/...
- Сервер проекту: https://p-3-0.vercel.app
- Vercel dashboard: https://vercel.com/mykolays-projects/p-3-0
- При наданні endpoint'ів завжди вказувати повний шлях з доменом: https://p-3-0.vercel.app/api/...

## Стиль коду та коментарі
- Використовувати українську мову для коментарів та логів
- Додавати детальне логування для діагностики проблем
- При обробці вебхуків - завжди перевіряти всі можливі формати даних

## База даних та міграції
- При додаванні нових полів до Prisma schema - завжди створювати міграцію
- Перевіряти сумісність типів (BigInt для telegramChatId)
- Перевіряти індекси та унікальні обмеження

## Telegram та вебхуки
- Логувати всі вихідні повідомлення в KV для відстеження
- При обробці відповідей в Telegram - враховувати всі можливі варіанти відповідей (ні, no, немає)
- При відправці повідомлень через Telegram Bot API - логувати в KV

## Обробка вебхуків Altegio
- Завжди перевіряти всі можливі формати custom_fields (array, object, різні ключі)
- При обробці вебхуків - спочатку використовувати getDirectClientByAltegioId, потім fallback на пошук за іменем
- При встановленні consultationAttended - не перезаписувати true на false, якщо раніше був вебхук з attendance = 1
- При встановленні paidServiceDate - перевіряти, чи це не консультація

## Автоматична синхронізація
- Cron jobs мають працювати автоматично без втручання користувача
- При синхронізації зі старих вебхуків - перевіряти всі типи послуг (консультації, платні послуги)
- При синхронізації станів - використовувати determineStateFromServices

## UI та адмін-панель
- При додаванні нових кнопок до AdminToolsModal - додавати їх в кінець відповідної категорії та оновлювати коментар з кількістю кнопок у файлі AdminToolsModal.tsx
- При відображенні даних в таблиці - перевіряти всі можливі стани та значення
- При діагностиці - показувати детальну інформацію про проблеми та рекомендації

## Тестування та діагностика
- При виявленні проблем - додавати детальне логування для діагностики
- При створенні нових endpoint'ів - додавати перевірку авторизації
- При обробці помилок - показувати зрозумілі повідомлення користувачу
